<p id=p0><span class='token pointer' id='tok-118-0'>In</span><span class='token pointer' id='tok-118-1'>a</span><span class='token pointer' id='tok-118-2'>previous</span><span class='token pointer' id='tok-118-3'>post</span><span class='token pointer' id='tok-118-4'>we</span><span class='token pointer' id='tok-118-5'>discussed</span><span class='token pointer' id='tok-118-6'>the</span><span class='token pointer' id='tok-118-7'>performance</span><span class='token pointer' id='tok-118-8'>limitations</span><span class='token pointer' id='tok-118-9'>of</span><span class='token pointer' id='tok-118-10'>the</span><span class='token pointer' id='tok-118-11'>Linux</span><span class='token pointer' id='tok-118-12'>kernel</span><span class='token pointer' id='tok-118-13'>network</span><span class='token pointer' id='tok-118-14'>stack.</span><span class='token pointer' id='tok-118-15'>We</span><span class='token pointer' id='tok-118-16'>detailed</span><span class='token pointer' id='tok-118-17'>the</span><span class='token pointer' id='tok-118-18'>available</span><span class='token pointer' id='tok-118-19'>kernel</span><span class='token pointer' id='tok-118-20'>bypass</span><span class='token pointer' id='tok-118-21'>techniques</span><span class='token pointer' id='tok-118-22'>allowing</span><span class='token pointer' id='tok-118-23'>user</span><span class='token pointer' id='tok-118-24'>space</span><span class='token pointer' id='tok-118-25'>programs</span><span class='token pointer' id='tok-118-26'>to</span><span class='token pointer' id='tok-118-27'>receive</span><span class='token pointer' id='tok-118-28'>packets</span><span class='token pointer' id='tok-118-29'>with</span><span class='token pointer' id='tok-118-30'>high</span><span class='token pointer' id='tok-118-31'>throughput.</span><span class='token pointer' id='tok-118-32'>Unfortunately,</span><span class='token pointer' id='tok-118-33'>none</span><span class='token pointer' id='tok-118-34'>of</span><span class='token pointer' id='tok-118-35'>the</span><span class='token pointer' id='tok-118-36'>discussed</span><span class='token pointer' id='tok-118-37'>open</span><span class='token pointer' id='tok-118-38'>source</span><span class='token pointer' id='tok-118-39'>solutions</span><span class='token pointer' id='tok-118-40'>supported</span><span class='token pointer' id='tok-118-41'>our</span><span class='token pointer' id='tok-118-42'>needs.</span><span class='token pointer' id='tok-118-43'>To</span><span class='token pointer' id='tok-118-44'>improve</span><span class='token pointer' id='tok-118-45'>the</span><span class='token pointer' id='tok-118-46'>situation</span><span class='token pointer' id='tok-118-47'>we</span><span class='token pointer' id='tok-118-48'>decided</span><span class='token pointer' id='tok-118-49'>to</span><span class='token pointer' id='tok-118-50'>contribute</span><span class='token pointer' id='tok-118-51'>to</span><span class='token pointer' id='tok-118-52'>the</span><span class='token pointer' id='tok-118-53'>Netmap</span><span class='token pointer' id='tok-118-54'>project.</span><span class='token pointer' id='tok-118-55'>In</span><span class='token pointer' id='tok-118-56'>this</span><span class='token pointer' id='tok-118-57'>blog</span><span class='token pointer' id='tok-118-58'>post</span><span class='token pointer' id='tok-118-59'>we'll</span><span class='token pointer' id='tok-118-60'>describe</span><span class='token pointer' id='tok-118-61'>our</span><span class='token pointer' id='tok-118-62'>proposed</span><span class='token pointer' id='tok-118-63'>changes.</span></p>
<p id=p64><span class='token pointer' id='tok-118-64'>CC</span><span class='token pointer' id='tok-118-65'>BY-SA</span><span class='token pointer' id='tok-118-66'>2.0</span><span class='token pointer' id='tok-118-67'>image</span><span class='token pointer' id='tok-118-68'>by</span><span class='token pointer' id='tok-118-69'>Binary</span><span class='token pointer' id='tok-118-70'>Koala</span></p>
<p id=p71><span class='token pointer' id='tok-118-71'>Our</span><span class='token pointer' id='tok-118-72'>needsAt</span><span class='token pointer' id='tok-118-73'>CloudFlare</span><span class='token pointer' id='tok-118-74'>we</span><span class='token pointer' id='tok-118-75'>are</span><span class='token pointer' id='tok-118-76'>constantly</span><span class='token pointer' id='tok-118-77'>dealing</span><span class='token pointer' id='tok-118-78'>with</span><span class='token pointer' id='tok-118-79'>large</span><span class='token pointer' id='tok-118-80'>packet</span><span class='token pointer' id='tok-118-81'>floods.</span><span class='token pointer' id='tok-118-82'>Our</span><span class='token pointer' id='tok-118-83'>network</span><span class='token pointer' id='tok-118-84'>constantly</span><span class='token pointer' id='tok-118-85'>receives</span><span class='token pointer' id='tok-118-86'>a</span><span class='token pointer' id='tok-118-87'>large</span><span class='token pointer' id='tok-118-88'>volume</span><span class='token pointer' id='tok-118-89'>of</span><span class='token pointer' id='tok-118-90'>packets,</span><span class='token pointer' id='tok-118-91'>often</span><span class='token pointer' id='tok-118-92'>coming</span><span class='token pointer' id='tok-118-93'>from</span><span class='token pointer' id='tok-118-94'>many,</span><span class='token pointer' id='tok-118-95'>simultaneous</span><span class='token pointer' id='tok-118-96'>attacks.</span><span class='token pointer' id='tok-118-97'>In</span><span class='token pointer' id='tok-118-98'>fact,</span><span class='token pointer' id='tok-118-99'>it</span><span class='token pointer' id='tok-118-100'>is</span><span class='token pointer' id='tok-118-101'>entirely</span><span class='token pointer' id='tok-118-102'>possible</span><span class='token pointer' id='tok-118-103'>that</span><span class='token pointer' id='tok-118-104'>the</span><span class='token pointer' id='tok-118-105'>server</span><span class='token pointer' id='tok-118-106'>which</span><span class='token pointer' id='tok-118-107'>just</span><span class='token pointer' id='tok-118-108'>served</span><span class='token pointer' id='tok-118-109'>you</span><span class='token pointer' id='tok-118-110'>this</span><span class='token pointer' id='tok-118-111'>blog</span><span class='token pointer' id='tok-118-112'>post</span><span class='token pointer' id='tok-118-113'>is</span><span class='token pointer' id='tok-118-114'>dealing</span><span class='token pointer' id='tok-118-115'>with</span><span class='token pointer' id='tok-118-116'>a</span><span class='token pointer' id='tok-118-117'>many-million</span><span class='token pointer' id='tok-118-118'>packets</span><span class='token pointer' id='tok-118-119'>per</span><span class='token pointer' id='tok-118-120'>second</span><span class='token pointer' id='tok-118-121'>flood</span><span class='token pointer' id='tok-118-122'>right</span><span class='token pointer' id='tok-118-123'>now.</span></p>
<p id=p124><span class='token pointer' id='tok-118-124'>Since</span><span class='token pointer' id='tok-118-125'>the</span><span class='token pointer' id='tok-118-126'>Linux</span><span class='token pointer' id='tok-118-127'>Kernel</span><span class='token pointer' id='tok-118-128'>can't</span><span class='token pointer' id='tok-118-129'>really</span><span class='token pointer' id='tok-118-130'>handle</span><span class='token pointer' id='tok-118-131'>a</span><span class='token pointer' id='tok-118-132'>large</span><span class='token pointer' id='tok-118-133'>volume</span><span class='token pointer' id='tok-118-134'>of</span><span class='token pointer' id='tok-118-135'>packets,</span><span class='token pointer' id='tok-118-136'>we</span><span class='token pointer' id='tok-118-137'>need</span><span class='token pointer' id='tok-118-138'>to</span><span class='token pointer' id='tok-118-139'>work</span><span class='token pointer' id='tok-118-140'>around</span><span class='token pointer' id='tok-118-141'>it.</span><span class='token pointer' id='tok-118-142'>During</span><span class='token pointer' id='tok-118-143'>packet</span><span class='token pointer' id='tok-118-144'>floods</span><span class='token pointer' id='tok-118-145'>we</span><span class='token pointer' id='tok-118-146'>offload</span><span class='token pointer' id='tok-118-147'>selected</span><span class='token pointer' id='tok-118-148'>network</span><span class='token pointer' id='tok-118-149'>flows</span><span class='token pointer' id='tok-118-150'>(belonging</span><span class='token pointer' id='tok-118-151'>to</span><span class='token pointer' id='tok-118-152'>a</span><span class='token pointer' id='tok-118-153'>flood)</span><span class='token pointer' id='tok-118-154'>to</span><span class='token pointer' id='tok-118-155'>a</span><span class='token pointer' id='tok-118-156'>user</span><span class='token pointer' id='tok-118-157'>space</span><span class='token pointer' id='tok-118-158'>application.</span><span class='token pointer' id='tok-118-159'>This</span><span class='token pointer' id='tok-118-160'>application</span><span class='token pointer' id='tok-118-161'>filters</span><span class='token pointer' id='tok-118-162'>the</span><span class='token pointer' id='tok-118-163'>packets</span><span class='token pointer' id='tok-118-164'>at</span><span class='token pointer' id='tok-118-165'>very</span><span class='token pointer' id='tok-118-166'>high</span><span class='token pointer' id='tok-118-167'>speed.</span><span class='token pointer' id='tok-118-168'>Most</span><span class='token pointer' id='tok-118-169'>of</span><span class='token pointer' id='tok-118-170'>the</span><span class='token pointer' id='tok-118-171'>packets</span><span class='token pointer' id='tok-118-172'>are</span><span class='token pointer' id='tok-118-173'>dropped,</span><span class='token pointer' id='tok-118-174'>as</span><span class='token pointer' id='tok-118-175'>they</span><span class='token pointer' id='tok-118-176'></span><span class='token pointer' id='tok-118-177'>belong</span><span class='token pointer' id='tok-118-178'>to</span><span class='token pointer' id='tok-118-179'>a</span><span class='token pointer' id='tok-118-180'>flood.</span><span class='token pointer' id='tok-118-181'>The</span><span class='token pointer' id='tok-118-182'>small</span><span class='token pointer' id='tok-118-183'>number</span><span class='token pointer' id='tok-118-184'>of</span><span class='token pointer' id='tok-118-185'>"valid"</span><span class='token pointer' id='tok-118-186'>packets</span><span class='token pointer' id='tok-118-187'>are</span><span class='token pointer' id='tok-118-188'>injected</span><span class='token pointer' id='tok-118-189'>back</span><span class='token pointer' id='tok-118-190'>to</span><span class='token pointer' id='tok-118-191'>the</span><span class='token pointer' id='tok-118-192'>kernel</span><span class='token pointer' id='tok-118-193'>and</span><span class='token pointer' id='tok-118-194'>handled</span><span class='token pointer' id='tok-118-195'>in</span><span class='token pointer' id='tok-118-196'>the</span><span class='token pointer' id='tok-118-197'>same</span><span class='token pointer' id='tok-118-198'>way</span><span class='token pointer' id='tok-118-199'>as</span><span class='token pointer' id='tok-118-200'>usual</span><span class='token pointer' id='tok-118-201'>traffic.</span></p>
<p id=p202><span class='token pointer' id='tok-118-202'>It's</span><span class='token pointer' id='tok-118-203'>important</span><span class='token pointer' id='tok-118-204'>to</span><span class='token pointer' id='tok-118-205'>emphasize</span><span class='token pointer' id='tok-118-206'>that</span><span class='token pointer' id='tok-118-207'>the</span><span class='token pointer' id='tok-118-208'>kernel</span><span class='token pointer' id='tok-118-209'>bypass</span><span class='token pointer' id='tok-118-210'>is</span><span class='token pointer' id='tok-118-211'>enabled</span><span class='token pointer' id='tok-118-212'>only</span><span class='token pointer' id='tok-118-213'>for</span><span class='token pointer' id='tok-118-214'>selected</span><span class='token pointer' id='tok-118-215'>flows,</span><span class='token pointer' id='tok-118-216'>which</span><span class='token pointer' id='tok-118-217'>means</span><span class='token pointer' id='tok-118-218'>that</span><span class='token pointer' id='tok-118-219'>all</span><span class='token pointer' id='tok-118-220'>other</span><span class='token pointer' id='tok-118-221'>packets</span><span class='token pointer' id='tok-118-222'>go</span><span class='token pointer' id='tok-118-223'>to</span><span class='token pointer' id='tok-118-224'>the</span><span class='token pointer' id='tok-118-225'>kernel</span><span class='token pointer' id='tok-118-226'>as</span><span class='token pointer' id='tok-118-227'>usual.</span></p>
<p id=p228><span class='token pointer' id='tok-118-228'>This</span><span class='token pointer' id='tok-118-229'>setup</span><span class='token pointer' id='tok-118-230'>works</span><span class='token pointer' id='tok-118-231'>perfectly</span><span class='token pointer' id='tok-118-232'>on</span><span class='token pointer' id='tok-118-233'>our</span><span class='token pointer' id='tok-118-234'>servers</span><span class='token pointer' id='tok-118-235'>with</span><span class='token pointer' id='tok-118-236'>Solarflare</span><span class='token pointer' id='tok-118-237'>network</span><span class='token pointer' id='tok-118-238'>cards</span><span class='token pointer' id='tok-118-239'>-</span><span class='token pointer' id='tok-118-240'>we</span><span class='token pointer' id='tok-118-241'>can</span><span class='token pointer' id='tok-118-242'>use</span><span class='token pointer' id='tok-118-243'>the</span><span class='token pointer' id='tok-118-244'>ef_vi</span><span class='token pointer' id='tok-118-245'>API</span><span class='token pointer' id='tok-118-246'>to</span><span class='token pointer' id='tok-118-247'>achieve</span><span class='token pointer' id='tok-118-248'>the</span><span class='token pointer' id='tok-118-249'>kernel</span><span class='token pointer' id='tok-118-250'>bypass.</span><span class='token pointer' id='tok-118-251'>Unfortunately,</span><span class='token pointer' id='tok-118-252'>we</span><span class='token pointer' id='tok-118-253'>don't</span><span class='token pointer' id='tok-118-254'>have</span><span class='token pointer' id='tok-118-255'>this</span><span class='token pointer' id='tok-118-256'>functionality</span><span class='token pointer' id='tok-118-257'>on</span><span class='token pointer' id='tok-118-258'>our</span><span class='token pointer' id='tok-118-259'>servers</span><span class='token pointer' id='tok-118-260'>with</span><span class='token pointer' id='tok-118-261'>Intel</span><span class='token pointer' id='tok-118-262'>IXGBE</span><span class='token pointer' id='tok-118-263'>NIC's.</span></p>
<p id=p264><span class='token pointer' id='tok-118-264'>This</span><span class='token pointer' id='tok-118-265'>is</span><span class='token pointer' id='tok-118-266'>when</span><span class='token pointer' id='tok-118-267'>Netmap</span><span class='token pointer' id='tok-118-268'>comes</span><span class='token pointer' id='tok-118-269'>in.</span></p>
<p id=p270><span class='token pointer' id='tok-118-270'>NetmapOver</span><span class='token pointer' id='tok-118-271'>the</span><span class='token pointer' id='tok-118-272'>last</span><span class='token pointer' id='tok-118-273'>few</span><span class='token pointer' id='tok-118-274'>months</span><span class='token pointer' id='tok-118-275'>we've</span><span class='token pointer' id='tok-118-276'>been</span><span class='token pointer' id='tok-118-277'>thinking</span><span class='token pointer' id='tok-118-278'>hard</span><span class='token pointer' id='tok-118-279'>about</span><span class='token pointer' id='tok-118-280'>how</span><span class='token pointer' id='tok-118-281'>to</span><span class='token pointer' id='tok-118-282'>achieve</span><span class='token pointer' id='tok-118-283'>bypass</span><span class='token pointer' id='tok-118-284'>for</span><span class='token pointer' id='tok-118-285'>selected</span><span class='token pointer' id='tok-118-286'>flows</span><span class='token pointer' id='tok-118-287'>(aka:</span><span class='token pointer' id='tok-118-288'>bifurcated</span><span class='token pointer' id='tok-118-289'>driver)</span><span class='token pointer' id='tok-118-290'>on</span><span class='token pointer' id='tok-118-291'>non-Solarflare</span><span class='token pointer' id='tok-118-292'>network</span><span class='token pointer' id='tok-118-293'>cards.</span></p>
<p id=p294><span class='token pointer' id='tok-118-294'>We've</span><span class='token pointer' id='tok-118-295'>considered</span><span class='token pointer' id='tok-118-296'>PF_RING,</span><span class='token pointer' id='tok-118-297'>DPDK</span><span class='token pointer' id='tok-118-298'>and</span><span class='token pointer' id='tok-118-299'>other</span><span class='token pointer' id='tok-118-300'>custom</span><span class='token pointer' id='tok-118-301'>solutions,</span><span class='token pointer' id='tok-118-302'>but</span><span class='token pointer' id='tok-118-303'>sadly</span><span class='token pointer' id='tok-118-304'>all</span><span class='token pointer' id='tok-118-305'>of</span><span class='token pointer' id='tok-118-306'>them</span><span class='token pointer' id='tok-118-307'>take</span><span class='token pointer' id='tok-118-308'>over</span><span class='token pointer' id='tok-118-309'>the</span><span class='token pointer' id='tok-118-310'>whole</span><span class='token pointer' id='tok-118-311'>network</span><span class='token pointer' id='tok-118-312'>card.</span><span class='token pointer' id='tok-118-313'>Eventually</span><span class='token pointer' id='tok-118-314'>we</span><span class='token pointer' id='tok-118-315'>decided</span><span class='token pointer' id='tok-118-316'>that</span><span class='token pointer' id='tok-118-317'>the</span><span class='token pointer' id='tok-118-318'>best</span><span class='token pointer' id='tok-118-319'>way</span><span class='token pointer' id='tok-118-320'>would</span><span class='token pointer' id='tok-118-321'>be</span><span class='token pointer' id='tok-118-322'>to</span><span class='token pointer' id='tok-118-323'>patch</span><span class='token pointer' id='tok-118-324'>Netmap</span><span class='token pointer' id='tok-118-325'>with</span><span class='token pointer' id='tok-118-326'>the</span><span class='token pointer' id='tok-118-327'>functionality</span><span class='token pointer' id='tok-118-328'>we</span><span class='token pointer' id='tok-118-329'>need.</span></p>
<p id=p330><span class='token pointer' id='tok-118-330'>We</span><span class='token pointer' id='tok-118-331'>chose</span><span class='token pointer' id='tok-118-332'>Netmap</span><span class='token pointer' id='tok-118-333'>because:</span></p>
<p id=p334><span class='token pointer' id='tok-118-334'>It's</span><span class='token pointer' id='tok-118-335'>fully</span><span class='token pointer' id='tok-118-336'>open</span><span class='token pointer' id='tok-118-337'>source</span><span class='token pointer' id='tok-118-338'>and</span><span class='token pointer' id='tok-118-339'>released</span><span class='token pointer' id='tok-118-340'>under</span><span class='token pointer' id='tok-118-341'>a</span><span class='token pointer' id='tok-118-342'>BSD</span><span class='token pointer' id='tok-118-343'>license.It</span><span class='token pointer' id='tok-118-344'>has</span><span class='token pointer' id='tok-118-345'>a</span><span class='token pointer' id='tok-118-346'>great</span><span class='token pointer' id='tok-118-347'>NIC-agnostic</span><span class='token pointer' id='tok-118-348'>API.It's</span><span class='token pointer' id='tok-118-349'>very</span><span class='token pointer' id='tok-118-350'>fast:</span><span class='token pointer' id='tok-118-351'>can</span><span class='token pointer' id='tok-118-352'>reach</span><span class='token pointer' id='tok-118-353'>line</span><span class='token pointer' id='tok-118-354'>rate</span><span class='token pointer' id='tok-118-355'>easily.The</span><span class='token pointer' id='tok-118-356'>project</span><span class='token pointer' id='tok-118-357'>is</span><span class='token pointer' id='tok-118-358'>well</span><span class='token pointer' id='tok-118-359'>maintained</span><span class='token pointer' id='tok-118-360'>and</span><span class='token pointer' id='tok-118-361'>reasonably</span><span class='token pointer' id='tok-118-362'>mature.The</span><span class='token pointer' id='tok-118-363'>code</span><span class='token pointer' id='tok-118-364'>is</span><span class='token pointer' id='tok-118-365'>very</span><span class='token pointer' id='tok-118-366'>high</span><span class='token pointer' id='tok-118-367'>quality.The</span><span class='token pointer' id='tok-118-368'>driver-specific</span><span class='token pointer' id='tok-118-369'>modifications</span><span class='token pointer' id='tok-118-370'>are</span><span class='token pointer' id='tok-118-371'>trivial:</span><span class='token pointer' id='tok-118-372'>most</span><span class='token pointer' id='tok-118-373'>of</span><span class='token pointer' id='tok-118-374'>the</span><span class='token pointer' id='tok-118-375'>magic</span><span class='token pointer' id='tok-118-376'>happens</span><span class='token pointer' id='tok-118-377'>in</span><span class='token pointer' id='tok-118-378'>the</span><span class='token pointer' id='tok-118-379'>shared</span><span class='token pointer' id='tok-118-380'>Netmap</span><span class='token pointer' id='tok-118-381'>module.</span><span class='token pointer' id='tok-118-382'>It's</span><span class='token pointer' id='tok-118-383'>easy</span><span class='token pointer' id='tok-118-384'>to</span><span class='token pointer' id='tok-118-385'>add</span><span class='token pointer' id='tok-118-386'>support</span><span class='token pointer' id='tok-118-387'>for</span><span class='token pointer' id='tok-118-388'>new</span><span class='token pointer' id='tok-118-389'>hardware.Introducing</span><span class='token pointer' id='tok-118-390'>the</span><span class='token pointer' id='tok-118-391'>single</span><span class='token pointer' id='tok-118-392'>RX</span><span class='token pointer' id='tok-118-393'>queue</span><span class='token pointer' id='tok-118-394'>modeUsually,</span><span class='token pointer' id='tok-118-395'>when</span><span class='token pointer' id='tok-118-396'>a</span><span class='token pointer' id='tok-118-397'>network</span><span class='token pointer' id='tok-118-398'>card</span><span class='token pointer' id='tok-118-399'>goes</span><span class='token pointer' id='tok-118-400'>into</span><span class='token pointer' id='tok-118-401'>the</span><span class='token pointer' id='tok-118-402'>Netmap</span><span class='token pointer' id='tok-118-403'>mode,</span><span class='token pointer' id='tok-118-404'>all</span><span class='token pointer' id='tok-118-405'>the</span><span class='token pointer' id='tok-118-406'>RX</span><span class='token pointer' id='tok-118-407'>queues</span><span class='token pointer' id='tok-118-408'>get</span><span class='token pointer' id='tok-118-409'>disconnected</span><span class='token pointer' id='tok-118-410'>from</span><span class='token pointer' id='tok-118-411'>the</span><span class='token pointer' id='tok-118-412'>kernel</span><span class='token pointer' id='tok-118-413'>and</span><span class='token pointer' id='tok-118-414'>are</span><span class='token pointer' id='tok-118-415'>available</span><span class='token pointer' id='tok-118-416'>to</span><span class='token pointer' id='tok-118-417'>the</span><span class='token pointer' id='tok-118-418'>Netmap</span><span class='token pointer' id='tok-118-419'>applications.</span></p>
<p id=p420><span class='token pointer' id='tok-118-420'>We</span><span class='token pointer' id='tok-118-421'>don't</span><span class='token pointer' id='tok-118-422'>want</span><span class='token pointer' id='tok-118-423'>that.</span><span class='token pointer' id='tok-118-424'>We</span><span class='token pointer' id='tok-118-425'>want</span><span class='token pointer' id='tok-118-426'>to</span><span class='token pointer' id='tok-118-427'>keep</span><span class='token pointer' id='tok-118-428'>most</span><span class='token pointer' id='tok-118-429'>of</span><span class='token pointer' id='tok-118-430'>the</span><span class='token pointer' id='tok-118-431'>RX</span><span class='token pointer' id='tok-118-432'>queues</span><span class='token pointer' id='tok-118-433'>back</span><span class='token pointer' id='tok-118-434'>in</span><span class='token pointer' id='tok-118-435'>the</span><span class='token pointer' id='tok-118-436'>kernel</span><span class='token pointer' id='tok-118-437'>mode,</span><span class='token pointer' id='tok-118-438'>and</span><span class='token pointer' id='tok-118-439'>enable</span><span class='token pointer' id='tok-118-440'>Netmap</span><span class='token pointer' id='tok-118-441'>mode</span><span class='token pointer' id='tok-118-442'>only</span><span class='token pointer' id='tok-118-443'>on</span><span class='token pointer' id='tok-118-444'>selected</span><span class='token pointer' id='tok-118-445'>RX</span><span class='token pointer' id='tok-118-446'>queues.</span><span class='token pointer' id='tok-118-447'>We</span><span class='token pointer' id='tok-118-448'>call</span><span class='token pointer' id='tok-118-449'>this</span><span class='token pointer' id='tok-118-450'>functionality:</span><span class='token pointer' id='tok-118-451'>"single</span><span class='token pointer' id='tok-118-452'>RX</span><span class='token pointer' id='tok-118-453'>queue</span><span class='token pointer' id='tok-118-454'>mode".</span></p>
<p id=p455><span class='token pointer' id='tok-118-455'>The</span><span class='token pointer' id='tok-118-456'>intention</span><span class='token pointer' id='tok-118-457'>was</span><span class='token pointer' id='tok-118-458'>to</span><span class='token pointer' id='tok-118-459'>expose</span><span class='token pointer' id='tok-118-460'>a</span><span class='token pointer' id='tok-118-461'>minimal</span><span class='token pointer' id='tok-118-462'>API</span><span class='token pointer' id='tok-118-463'>which</span><span class='token pointer' id='tok-118-464'>could:</span></p>
<p id=p465><span class='token pointer' id='tok-118-465'>Open</span><span class='token pointer' id='tok-118-466'>a</span><span class='token pointer' id='tok-118-467'>network</span><span class='token pointer' id='tok-118-468'>interface</span><span class='token pointer' id='tok-118-469'>in</span><span class='token pointer' id='tok-118-470'>"a</span><span class='token pointer' id='tok-118-471'>single</span><span class='token pointer' id='tok-118-472'>RX</span><span class='token pointer' id='tok-118-473'>queue</span><span class='token pointer' id='tok-118-474'>mode".This</span><span class='token pointer' id='tok-118-475'>would</span><span class='token pointer' id='tok-118-476'>allow</span><span class='token pointer' id='tok-118-477'>netmap</span><span class='token pointer' id='tok-118-478'>applications</span><span class='token pointer' id='tok-118-479'>to</span><span class='token pointer' id='tok-118-480'>receive</span><span class='token pointer' id='tok-118-481'>packets</span><span class='token pointer' id='tok-118-482'>from</span><span class='token pointer' id='tok-118-483'>that</span><span class='token pointer' id='tok-118-484'>specific</span><span class='token pointer' id='tok-118-485'>RX</span><span class='token pointer' id='tok-118-486'>queue.While</span><span class='token pointer' id='tok-118-487'>leaving</span><span class='token pointer' id='tok-118-488'>all</span><span class='token pointer' id='tok-118-489'>the</span><span class='token pointer' id='tok-118-490'>other</span><span class='token pointer' id='tok-118-491'>queues</span><span class='token pointer' id='tok-118-492'>attached</span><span class='token pointer' id='tok-118-493'>to</span><span class='token pointer' id='tok-118-494'>the</span><span class='token pointer' id='tok-118-495'>host</span><span class='token pointer' id='tok-118-496'>network</span><span class='token pointer' id='tok-118-497'>stack.On</span><span class='token pointer' id='tok-118-498'>demand</span><span class='token pointer' id='tok-118-499'>add</span><span class='token pointer' id='tok-118-500'>or</span><span class='token pointer' id='tok-118-501'>remove</span><span class='token pointer' id='tok-118-502'>RX</span><span class='token pointer' id='tok-118-503'>queues</span><span class='token pointer' id='tok-118-504'>from</span><span class='token pointer' id='tok-118-505'>the</span><span class='token pointer' id='tok-118-506'>"single</span><span class='token pointer' id='tok-118-507'>RX</span><span class='token pointer' id='tok-118-508'>queue</span><span class='token pointer' id='tok-118-509'>mode".Eventually</span><span class='token pointer' id='tok-118-510'>remove</span><span class='token pointer' id='tok-118-511'>the</span><span class='token pointer' id='tok-118-512'>interface</span><span class='token pointer' id='tok-118-513'>from</span><span class='token pointer' id='tok-118-514'>the</span><span class='token pointer' id='tok-118-515'>Netmap</span><span class='token pointer' id='tok-118-516'>mode</span><span class='token pointer' id='tok-118-517'>and</span><span class='token pointer' id='tok-118-518'>reattach</span><span class='token pointer' id='tok-118-519'>the</span><span class='token pointer' id='tok-118-520'>RX</span><span class='token pointer' id='tok-118-521'>queues</span><span class='token pointer' id='tok-118-522'>to</span><span class='token pointer' id='tok-118-523'>the</span><span class='token pointer' id='tok-118-524'>host</span><span class='token pointer' id='tok-118-525'>stack.</span></p>
<p id=p526><span class='token pointer' id='tok-118-526'>Indeed</span><span class='token pointer' id='tok-118-527'>the</span><span class='token pointer' id='tok-118-528'>only</span><span class='token pointer' id='tok-118-529'>difference</span><span class='token pointer' id='tok-118-530'>is</span><span class='token pointer' id='tok-118-531'>the</span><span class='token pointer' id='tok-118-532'>nm_open()</span><span class='token pointer' id='tok-118-533'>call,</span><span class='token pointer' id='tok-118-534'>which</span><span class='token pointer' id='tok-118-535'>uses</span><span class='token pointer' id='tok-118-536'>the</span><span class='token pointer' id='tok-118-537'>new</span><span class='token pointer' id='tok-118-538'>syntax</span><span class='token pointer' id='tok-118-539'>netmap:ifname~queue_number.</span></p>
<p id=p540><span class='token pointer' id='tok-118-540'>Once</span><span class='token pointer' id='tok-118-541'>again,</span><span class='token pointer' id='tok-118-542'>when</span><span class='token pointer' id='tok-118-543'>running</span><span class='token pointer' id='tok-118-544'>this</span><span class='token pointer' id='tok-118-545'>code</span><span class='token pointer' id='tok-118-546'>only</span><span class='token pointer' id='tok-118-547'>packets</span><span class='token pointer' id='tok-118-548'>arriving</span><span class='token pointer' id='tok-118-549'>on</span><span class='token pointer' id='tok-118-550'>the</span><span class='token pointer' id='tok-118-551'>RX</span><span class='token pointer' id='tok-118-552'>queue</span><span class='token pointer' id='tok-118-553'>#4</span><span class='token pointer' id='tok-118-554'>will</span><span class='token pointer' id='tok-118-555'>go</span><span class='token pointer' id='tok-118-556'>to</span><span class='token pointer' id='tok-118-557'>the</span><span class='token pointer' id='tok-118-558'>netmap</span><span class='token pointer' id='tok-118-559'>program.</span><span class='token pointer' id='tok-118-560'>All</span><span class='token pointer' id='tok-118-561'>other</span><span class='token pointer' id='tok-118-562'>RX</span><span class='token pointer' id='tok-118-563'>and</span><span class='token pointer' id='tok-118-564'>TX</span><span class='token pointer' id='tok-118-565'>queues</span><span class='token pointer' id='tok-118-566'>will</span><span class='token pointer' id='tok-118-567'>be</span><span class='token pointer' id='tok-118-568'>handled</span><span class='token pointer' id='tok-118-569'>by</span><span class='token pointer' id='tok-118-570'>the</span><span class='token pointer' id='tok-118-571'>Linux</span><span class='token pointer' id='tok-118-572'>kernel</span><span class='token pointer' id='tok-118-573'>network</span><span class='token pointer' id='tok-118-574'>stack.</span></p>
<p id=p575><span class='token pointer' id='tok-118-575'>Isolating</span><span class='token pointer' id='tok-118-576'>a</span><span class='token pointer' id='tok-118-577'>queueIn</span><span class='token pointer' id='tok-118-578'>multiqueue</span><span class='token pointer' id='tok-118-579'>network</span><span class='token pointer' id='tok-118-580'>cards,</span><span class='token pointer' id='tok-118-581'>any</span><span class='token pointer' id='tok-118-582'>packet</span><span class='token pointer' id='tok-118-583'>can</span><span class='token pointer' id='tok-118-584'>end</span><span class='token pointer' id='tok-118-585'>up</span><span class='token pointer' id='tok-118-586'>in</span><span class='token pointer' id='tok-118-587'>almost</span><span class='token pointer' id='tok-118-588'>any</span><span class='token pointer' id='tok-118-589'>RX</span><span class='token pointer' id='tok-118-590'>queue</span><span class='token pointer' id='tok-118-591'>due</span><span class='token pointer' id='tok-118-592'>to</span><span class='token pointer' id='tok-118-593'>RSS.</span><span class='token pointer' id='tok-118-594'>This</span><span class='token pointer' id='tok-118-595'>is</span><span class='token pointer' id='tok-118-596'>why</span><span class='token pointer' id='tok-118-597'>before</span><span class='token pointer' id='tok-118-598'>enabling</span><span class='token pointer' id='tok-118-599'>the</span><span class='token pointer' id='tok-118-600'>single</span><span class='token pointer' id='tok-118-601'>RX</span><span class='token pointer' id='tok-118-602'>mode</span><span class='token pointer' id='tok-118-603'>it</span><span class='token pointer' id='tok-118-604'>is</span><span class='token pointer' id='tok-118-605'>necessary</span><span class='token pointer' id='tok-118-606'>to</span><span class='token pointer' id='tok-118-607'>make</span><span class='token pointer' id='tok-118-608'>sure</span><span class='token pointer' id='tok-118-609'>only</span><span class='token pointer' id='tok-118-610'>the</span><span class='token pointer' id='tok-118-611'>selected</span><span class='token pointer' id='tok-118-612'>flow</span><span class='token pointer' id='tok-118-613'>goes</span><span class='token pointer' id='tok-118-614'>to</span><span class='token pointer' id='tok-118-615'>the</span><span class='token pointer' id='tok-118-616'>Netmap</span><span class='token pointer' id='tok-118-617'>queue.</span></p>
<p id=p618><span class='token pointer' id='tok-118-618'>To</span><span class='token pointer' id='tok-118-619'>do</span><span class='token pointer' id='tok-118-620'>so</span><span class='token pointer' id='tok-118-621'>it</span><span class='token pointer' id='tok-118-622'>is</span><span class='token pointer' id='tok-118-623'>necessary</span><span class='token pointer' id='tok-118-624'>to:</span></p>
<p id=p625><span class='token pointer' id='tok-118-625'>Modify</span><span class='token pointer' id='tok-118-626'>the</span><span class='token pointer' id='tok-118-627'>indirection</span><span class='token pointer' id='tok-118-628'>table</span><span class='token pointer' id='tok-118-629'>to</span><span class='token pointer' id='tok-118-630'>ensure</span><span class='token pointer' id='tok-118-631'>no</span><span class='token pointer' id='tok-118-632'>new</span><span class='token pointer' id='tok-118-633'>RSS-hashed</span><span class='token pointer' id='tok-118-634'>packets</span><span class='token pointer' id='tok-118-635'>will</span><span class='token pointer' id='tok-118-636'>go</span><span class='token pointer' id='tok-118-637'>there.Use</span><span class='token pointer' id='tok-118-638'>flow</span><span class='token pointer' id='tok-118-639'>steering</span><span class='token pointer' id='tok-118-640'>to</span><span class='token pointer' id='tok-118-641'>specifically</span><span class='token pointer' id='tok-118-642'>direct</span><span class='token pointer' id='tok-118-643'>some</span><span class='token pointer' id='tok-118-644'>flows</span><span class='token pointer' id='tok-118-645'>to</span><span class='token pointer' id='tok-118-646'>the</span><span class='token pointer' id='tok-118-647'>isolated</span><span class='token pointer' id='tok-118-648'>queue.Work</span><span class='token pointer' id='tok-118-649'>around</span><span class='token pointer' id='tok-118-650'>RFS</span><span class='token pointer' id='tok-118-651'>-</span><span class='token pointer' id='tok-118-652'>make</span><span class='token pointer' id='tok-118-653'>sure</span><span class='token pointer' id='tok-118-654'>no</span><span class='token pointer' id='tok-118-655'>other</span><span class='token pointer' id='tok-118-656'>application</span><span class='token pointer' id='tok-118-657'>is</span><span class='token pointer' id='tok-118-658'>running</span><span class='token pointer' id='tok-118-659'>on</span><span class='token pointer' id='tok-118-660'>the</span><span class='token pointer' id='tok-118-661'>CPU</span><span class='token pointer' id='tok-118-662'>Netmap</span><span class='token pointer' id='tok-118-663'>will</span><span class='token pointer' id='tok-118-664'>run</span><span class='token pointer' id='tok-118-665'>on.For</span><span class='token pointer' id='tok-118-666'>example:</span></p>
<p id=p667><span class='token pointer' id='tok-118-667'>$</span><span class='token pointer' id='tok-118-668'>ethtool</span><span class='token pointer' id='tok-118-669'>-X</span><span class='token pointer' id='tok-118-670'>eth3</span><span class='token pointer' id='tok-118-671'>weight</span><span class='token pointer' id='tok-118-672'>1</span><span class='token pointer' id='tok-118-673'>1</span><span class='token pointer' id='tok-118-674'>1</span><span class='token pointer' id='tok-118-675'>1</span><span class='token pointer' id='tok-118-676'>0</span><span class='token pointer' id='tok-118-677'>1</span><span class='token pointer' id='tok-118-678'>1</span><span class='token pointer' id='tok-118-679'>1</span><span class='token pointer' id='tok-118-680'>1</span><span class='token pointer' id='tok-118-681'>1$</span><span class='token pointer' id='tok-118-682'>ethtool</span><span class='token pointer' id='tok-118-683'>-K</span><span class='token pointer' id='tok-118-684'>eth3</span><span class='token pointer' id='tok-118-685'>ntuple</span><span class='token pointer' id='tok-118-686'>on$</span><span class='token pointer' id='tok-118-687'>ethtool</span><span class='token pointer' id='tok-118-688'>-N</span><span class='token pointer' id='tok-118-689'>eth3</span><span class='token pointer' id='tok-118-690'>flow-type</span><span class='token pointer' id='tok-118-691'>udp4</span><span class='token pointer' id='tok-118-692'>dst-port</span><span class='token pointer' id='tok-118-693'>53</span><span class='token pointer' id='tok-118-694'>action</span><span class='token pointer' id='tok-118-695'>4Here</span><span class='token pointer' id='tok-118-696'>we</span><span class='token pointer' id='tok-118-697'>are</span><span class='token pointer' id='tok-118-698'>setting</span><span class='token pointer' id='tok-118-699'>the</span><span class='token pointer' id='tok-118-700'>indirection</span><span class='token pointer' id='tok-118-701'>table</span><span class='token pointer' id='tok-118-702'>to</span><span class='token pointer' id='tok-118-703'>prevent</span><span class='token pointer' id='tok-118-704'>traffic</span><span class='token pointer' id='tok-118-705'>from</span><span class='token pointer' id='tok-118-706'>going</span><span class='token pointer' id='tok-118-707'>to</span><span class='token pointer' id='tok-118-708'>RX</span><span class='token pointer' id='tok-118-709'>queue</span><span class='token pointer' id='tok-118-710'>#4.</span><span class='token pointer' id='tok-118-711'>Then</span><span class='token pointer' id='tok-118-712'>we</span><span class='token pointer' id='tok-118-713'>are</span><span class='token pointer' id='tok-118-714'>enabling</span><span class='token pointer' id='tok-118-715'>flow</span><span class='token pointer' id='tok-118-716'>steering</span><span class='token pointer' id='tok-118-717'>to</span><span class='token pointer' id='tok-118-718'>enqueue</span><span class='token pointer' id='tok-118-719'>all</span><span class='token pointer' id='tok-118-720'>UDP</span><span class='token pointer' id='tok-118-721'>traffic</span><span class='token pointer' id='tok-118-722'>with</span><span class='token pointer' id='tok-118-723'>destination</span><span class='token pointer' id='tok-118-724'>port</span><span class='token pointer' id='tok-118-725'>53</span><span class='token pointer' id='tok-118-726'>into</span><span class='token pointer' id='tok-118-727'>queue</span><span class='token pointer' id='tok-118-728'>#4.</span></p>
<p id=p729><span class='token pointer' id='tok-118-729'>Trying</span><span class='token pointer' id='tok-118-730'>it</span><span class='token pointer' id='tok-118-731'>outHere's</span><span class='token pointer' id='tok-118-732'>how</span><span class='token pointer' id='tok-118-733'>to</span><span class='token pointer' id='tok-118-734'>run</span><span class='token pointer' id='tok-118-735'>it</span><span class='token pointer' id='tok-118-736'>with</span><span class='token pointer' id='tok-118-737'>the</span><span class='token pointer' id='tok-118-738'>IXGBE</span><span class='token pointer' id='tok-118-739'>NIC.</span><span class='token pointer' id='tok-118-740'>First</span><span class='token pointer' id='tok-118-741'>grab</span><span class='token pointer' id='tok-118-742'>the</span><span class='token pointer' id='tok-118-743'>sources:</span></p>
<p id=p744><span class='token pointer' id='tok-118-744'>$</span><span class='token pointer' id='tok-118-745'>git</span><span class='token pointer' id='tok-118-746'>clone</span><span class='token pointer' id='tok-118-747'>https://github.com/jibi/netmap.git$</span><span class='token pointer' id='tok-118-748'>cd</span><span class='token pointer' id='tok-118-749'>netmap$</span><span class='token pointer' id='tok-118-750'>git</span><span class='token pointer' id='tok-118-751'>checkout</span><span class='token pointer' id='tok-118-752'>-B</span><span class='token pointer' id='tok-118-753'>single-rx-queue-mode$</span><span class='token pointer' id='tok-118-754'>./configure</span><span class='token pointer' id='tok-118-755'>--drivers=ixgbe</span><span class='token pointer' id='tok-118-756'>--kernel-sources=/path/to/kernelLoad</span><span class='token pointer' id='tok-118-757'>the</span><span class='token pointer' id='tok-118-758'>netmap-patched</span><span class='token pointer' id='tok-118-759'>modules</span><span class='token pointer' id='tok-118-760'>and</span><span class='token pointer' id='tok-118-761'>setup</span><span class='token pointer' id='tok-118-762'>the</span><span class='token pointer' id='tok-118-763'>interface:</span></p>
<p id=p764><span class='token pointer' id='tok-118-764'>$</span><span class='token pointer' id='tok-118-765'>insmod</span><span class='token pointer' id='tok-118-766'>./LINUX/netmap.ko$</span><span class='token pointer' id='tok-118-767'>insmod</span><span class='token pointer' id='tok-118-768'>./LINUX/ixgbe/ixgbe.ko$</span><span class='token pointer' id='tok-118-769'>#</span><span class='token pointer' id='tok-118-770'>Distribute</span><span class='token pointer' id='tok-118-771'>the</span><span class='token pointer' id='tok-118-772'>interrupts:$</span><span class='token pointer' id='tok-118-773'>(let</span><span class='token pointer' id='tok-118-774'>CPU=0;</span><span class='token pointer' id='tok-118-775'>cd</span><span class='token pointer' id='tok-118-776'>/sys/class/net/eth3/device/msi_irqs/;</span><span class='token pointer' id='tok-118-777'>for</span><span class='token pointer' id='tok-118-778'>IRQ</span><span class='token pointer' id='tok-118-779'>in</span><span class='token pointer' id='tok-118-780'>*;</span><span class='token pointer' id='tok-118-781'>do</span><span class='token pointer' id='tok-118-782'>\</span><span class='token pointer' id='tok-118-783'></span><span class='token pointer' id='tok-118-784'>echo</span><span class='token pointer' id='tok-118-785'>$CPU</span><span class='token pointer' id='tok-118-786'>&gt;</span><span class='token pointer' id='tok-118-787'>/proc/irq/$IRQ/smp_affinity_list;</span><span class='token pointer' id='tok-118-788'>let</span><span class='token pointer' id='tok-118-789'>CPU+=1</span><span class='token pointer' id='tok-118-790'></span><span class='token pointer' id='tok-118-791'></span><span class='token pointer' id='tok-118-792'></span><span class='token pointer' id='tok-118-793'></span><span class='token pointer' id='tok-118-794'></span><span class='token pointer' id='tok-118-795'></span><span class='token pointer' id='tok-118-796'></span><span class='token pointer' id='tok-118-797'></span><span class='token pointer' id='tok-118-798'>done)$</span><span class='token pointer' id='tok-118-799'>#</span><span class='token pointer' id='tok-118-800'>Enable</span><span class='token pointer' id='tok-118-801'>RSS:$</span><span class='token pointer' id='tok-118-802'>ethtool</span><span class='token pointer' id='tok-118-803'>-K</span><span class='token pointer' id='tok-118-804'>eth3</span><span class='token pointer' id='tok-118-805'>ntuple</span><span class='token pointer' id='tok-118-806'>onAt</span><span class='token pointer' id='tok-118-807'>this</span><span class='token pointer' id='tok-118-808'>point</span><span class='token pointer' id='tok-118-809'>we</span><span class='token pointer' id='tok-118-810'>started</span><span class='token pointer' id='tok-118-811'>flooding</span><span class='token pointer' id='tok-118-812'>the</span><span class='token pointer' id='tok-118-813'>interface</span><span class='token pointer' id='tok-118-814'>with</span><span class='token pointer' id='tok-118-815'>6M</span><span class='token pointer' id='tok-118-816'>short</span><span class='token pointer' id='tok-118-817'>UDP</span><span class='token pointer' id='tok-118-818'>packets.</span><span class='token pointer' id='tok-118-819'>htop</span><span class='token pointer' id='tok-118-820'>shows</span><span class='token pointer' id='tok-118-821'>the</span><span class='token pointer' id='tok-118-822'>server</span><span class='token pointer' id='tok-118-823'>being</span><span class='token pointer' id='tok-118-824'>totally</span><span class='token pointer' id='tok-118-825'>busy</span><span class='token pointer' id='tok-118-826'>with</span><span class='token pointer' id='tok-118-827'>handling</span><span class='token pointer' id='tok-118-828'>the</span><span class='token pointer' id='tok-118-829'>flood:</span></p>
<p id=p830><span class='token pointer' id='tok-118-830'>To</span><span class='token pointer' id='tok-118-831'>counter</span><span class='token pointer' id='tok-118-832'>the</span><span class='token pointer' id='tok-118-833'>flood</span><span class='token pointer' id='tok-118-834'>we</span><span class='token pointer' id='tok-118-835'>started</span><span class='token pointer' id='tok-118-836'>Netmap.</span><span class='token pointer' id='tok-118-837'>First,</span><span class='token pointer' id='tok-118-838'>we</span><span class='token pointer' id='tok-118-839'>needed</span><span class='token pointer' id='tok-118-840'>to</span><span class='token pointer' id='tok-118-841'>edit</span><span class='token pointer' id='tok-118-842'>the</span><span class='token pointer' id='tok-118-843'>indirection</span><span class='token pointer' id='tok-118-844'>table,</span><span class='token pointer' id='tok-118-845'>to</span><span class='token pointer' id='tok-118-846'>isolate</span><span class='token pointer' id='tok-118-847'>the</span><span class='token pointer' id='tok-118-848'>RX</span><span class='token pointer' id='tok-118-849'>queue</span><span class='token pointer' id='tok-118-850'>#4:</span></p>
<p id=p851><span class='token pointer' id='tok-118-851'>$</span><span class='token pointer' id='tok-118-852'>ethtool</span><span class='token pointer' id='tok-118-853'>-X</span><span class='token pointer' id='tok-118-854'>eth3</span><span class='token pointer' id='tok-118-855'>weight</span><span class='token pointer' id='tok-118-856'>1</span><span class='token pointer' id='tok-118-857'>1</span><span class='token pointer' id='tok-118-858'>1</span><span class='token pointer' id='tok-118-859'>1</span><span class='token pointer' id='tok-118-860'>0</span><span class='token pointer' id='tok-118-861'>1</span><span class='token pointer' id='tok-118-862'>1</span><span class='token pointer' id='tok-118-863'>1</span><span class='token pointer' id='tok-118-864'>1</span><span class='token pointer' id='tok-118-865'>1$</span><span class='token pointer' id='tok-118-866'>ethtool</span><span class='token pointer' id='tok-118-867'>-N</span><span class='token pointer' id='tok-118-868'>eth3</span><span class='token pointer' id='tok-118-869'>flow-type</span><span class='token pointer' id='tok-118-870'>udp4</span><span class='token pointer' id='tok-118-871'>dst-port</span><span class='token pointer' id='tok-118-872'>53</span><span class='token pointer' id='tok-118-873'>action</span><span class='token pointer' id='tok-118-874'>4This</span><span class='token pointer' id='tok-118-875'>caused</span><span class='token pointer' id='tok-118-876'>all</span><span class='token pointer' id='tok-118-877'>the</span><span class='token pointer' id='tok-118-878'>flood</span><span class='token pointer' id='tok-118-879'>packets</span><span class='token pointer' id='tok-118-880'>to</span><span class='token pointer' id='tok-118-881'>go</span><span class='token pointer' id='tok-118-882'>to</span><span class='token pointer' id='tok-118-883'>RX</span><span class='token pointer' id='tok-118-884'>queue</span><span class='token pointer' id='tok-118-885'>#4.</span></p>
<p id=p886><span class='token pointer' id='tok-118-886'>Before</span><span class='token pointer' id='tok-118-887'>putting</span><span class='token pointer' id='tok-118-888'>an</span><span class='token pointer' id='tok-118-889'>interface</span><span class='token pointer' id='tok-118-890'>in</span><span class='token pointer' id='tok-118-891'>Netmap</span><span class='token pointer' id='tok-118-892'>mode</span><span class='token pointer' id='tok-118-893'>it</span><span class='token pointer' id='tok-118-894'>is</span><span class='token pointer' id='tok-118-895'>necessary</span><span class='token pointer' id='tok-118-896'>to</span><span class='token pointer' id='tok-118-897'>turn</span><span class='token pointer' id='tok-118-898'>off</span><span class='token pointer' id='tok-118-899'>hardware</span><span class='token pointer' id='tok-118-900'>offload</span><span class='token pointer' id='tok-118-901'>features:</span></p>
<p id=p902><span class='token pointer' id='tok-118-902'>$</span><span class='token pointer' id='tok-118-903'>ethtool</span><span class='token pointer' id='tok-118-904'>-K</span><span class='token pointer' id='tok-118-905'>eth3</span><span class='token pointer' id='tok-118-906'>lro</span><span class='token pointer' id='tok-118-907'>off</span><span class='token pointer' id='tok-118-908'>gro</span><span class='token pointer' id='tok-118-909'>offFinally</span><span class='token pointer' id='tok-118-910'>we</span><span class='token pointer' id='tok-118-911'>launched</span><span class='token pointer' id='tok-118-912'>the</span><span class='token pointer' id='tok-118-913'>netmap</span><span class='token pointer' id='tok-118-914'>offload:</span></p>
<p id=p915><span class='token pointer' id='tok-118-915'>$</span><span class='token pointer' id='tok-118-916'>sudo</span><span class='token pointer' id='tok-118-917'>taskset</span><span class='token pointer' id='tok-118-918'>-c</span><span class='token pointer' id='tok-118-919'>15</span><span class='token pointer' id='tok-118-920'>./nm_offload</span><span class='token pointer' id='tok-118-921'>eth3</span><span class='token pointer' id='tok-118-922'>4[+]</span><span class='token pointer' id='tok-118-923'>starting</span><span class='token pointer' id='tok-118-924'>test02</span><span class='token pointer' id='tok-118-925'>on</span><span class='token pointer' id='tok-118-926'>interface</span><span class='token pointer' id='tok-118-927'>eth3</span><span class='token pointer' id='tok-118-928'>ring</span><span class='token pointer' id='tok-118-929'>4[+]</span><span class='token pointer' id='tok-118-930'>UDP</span><span class='token pointer' id='tok-118-931'>pps:</span><span class='token pointer' id='tok-118-932'>5844714[+]</span><span class='token pointer' id='tok-118-933'>UDP</span><span class='token pointer' id='tok-118-934'>pps:</span><span class='token pointer' id='tok-118-935'>5996166[+]</span><span class='token pointer' id='tok-118-936'>UDP</span><span class='token pointer' id='tok-118-937'>pps:</span><span class='token pointer' id='tok-118-938'>5863214[+]</span><span class='token pointer' id='tok-118-939'>UDP</span><span class='token pointer' id='tok-118-940'>pps:</span><span class='token pointer' id='tok-118-941'>5986365[+]</span><span class='token pointer' id='tok-118-942'>UDP</span><span class='token pointer' id='tok-118-943'>pps:</span><span class='token pointer' id='tok-118-944'>5867302[+]</span><span class='token pointer' id='tok-118-945'>UDP</span><span class='token pointer' id='tok-118-946'>pps:</span><span class='token pointer' id='tok-118-947'>5964911[+]</span><span class='token pointer' id='tok-118-948'>UDP</span><span class='token pointer' id='tok-118-949'>pps:</span><span class='token pointer' id='tok-118-950'>5909715[+]</span><span class='token pointer' id='tok-118-951'>UDP</span><span class='token pointer' id='tok-118-952'>pps:</span><span class='token pointer' id='tok-118-953'>5865769[+]</span><span class='token pointer' id='tok-118-954'>UDP</span><span class='token pointer' id='tok-118-955'>pps:</span><span class='token pointer' id='tok-118-956'>5906668[+]</span><span class='token pointer' id='tok-118-957'>UDP</span><span class='token pointer' id='tok-118-958'>pps:</span><span class='token pointer' id='tok-118-959'>5875486As</span><span class='token pointer' id='tok-118-960'>you</span><span class='token pointer' id='tok-118-961'>see</span><span class='token pointer' id='tok-118-962'>the</span><span class='token pointer' id='tok-118-963'>netmap</span><span class='token pointer' id='tok-118-964'>program</span><span class='token pointer' id='tok-118-965'>on</span><span class='token pointer' id='tok-118-966'>a</span><span class='token pointer' id='tok-118-967'>single</span><span class='token pointer' id='tok-118-968'>RX</span><span class='token pointer' id='tok-118-969'>queue</span><span class='token pointer' id='tok-118-970'>was</span><span class='token pointer' id='tok-118-971'>able</span><span class='token pointer' id='tok-118-972'>to</span><span class='token pointer' id='tok-118-973'>receive</span><span class='token pointer' id='tok-118-974'>about</span><span class='token pointer' id='tok-118-975'>5.8M</span><span class='token pointer' id='tok-118-976'>packets.</span></p>
<p id=p977><span class='token pointer' id='tok-118-977'>For</span><span class='token pointer' id='tok-118-978'>completeness,</span><span class='token pointer' id='tok-118-979'>here's</span><span class='token pointer' id='tok-118-980'>an</span><span class='token pointer' id='tok-118-981'>htop</span><span class='token pointer' id='tok-118-982'>showing</span><span class='token pointer' id='tok-118-983'>only</span><span class='token pointer' id='tok-118-984'>a</span><span class='token pointer' id='tok-118-985'>single</span><span class='token pointer' id='tok-118-986'>core</span><span class='token pointer' id='tok-118-987'>being</span><span class='token pointer' id='tok-118-988'>busy</span><span class='token pointer' id='tok-118-989'>with</span><span class='token pointer' id='tok-118-990'>Netmap:</span></p>
<p id=p991><span class='token pointer' id='tok-118-991'>ThanksWe</span><span class='token pointer' id='tok-118-992'>would</span><span class='token pointer' id='tok-118-993'>like</span><span class='token pointer' id='tok-118-994'>to</span><span class='token pointer' id='tok-118-995'>thank</span><span class='token pointer' id='tok-118-996'>Pavel</span><span class='token pointer' id='tok-118-997'>Odintsov</span><span class='token pointer' id='tok-118-998'>who</span><span class='token pointer' id='tok-118-999'>suggested</span><span class='token pointer' id='tok-118-1000'>the</span><span class='token pointer' id='tok-118-1001'>possibility</span><span class='token pointer' id='tok-118-1002'>of</span><span class='token pointer' id='tok-118-1003'>using</span><span class='token pointer' id='tok-118-1004'>Netmap</span><span class='token pointer' id='tok-118-1005'>this</span><span class='token pointer' id='tok-118-1006'>way.</span><span class='token pointer' id='tok-118-1007'>He</span><span class='token pointer' id='tok-118-1008'>even</span><span class='token pointer' id='tok-118-1009'>prepared</span><span class='token pointer' id='tok-118-1010'>the</span><span class='token pointer' id='tok-118-1011'>initial</span><span class='token pointer' id='tok-118-1012'>hack</span><span class='token pointer' id='tok-118-1013'>we</span><span class='token pointer' id='tok-118-1014'>based</span><span class='token pointer' id='tok-118-1015'>our</span><span class='token pointer' id='tok-118-1016'>work</span><span class='token pointer' id='tok-118-1017'>on.</span></p>
<p id=p1018><span class='token pointer' id='tok-118-1018'>We</span><span class='token pointer' id='tok-118-1019'>would</span><span class='token pointer' id='tok-118-1020'>also</span><span class='token pointer' id='tok-118-1021'>like</span><span class='token pointer' id='tok-118-1022'>to</span><span class='token pointer' id='tok-118-1023'>thank</span><span class='token pointer' id='tok-118-1024'>Luigi</span><span class='token pointer' id='tok-118-1025'>Rizzo,</span><span class='token pointer' id='tok-118-1026'>for</span><span class='token pointer' id='tok-118-1027'>his</span><span class='token pointer' id='tok-118-1028'>Netmap</span><span class='token pointer' id='tok-118-1029'>work</span><span class='token pointer' id='tok-118-1030'>and</span><span class='token pointer' id='tok-118-1031'>great</span><span class='token pointer' id='tok-118-1032'>feedback</span><span class='token pointer' id='tok-118-1033'>on</span><span class='token pointer' id='tok-118-1034'>our</span><span class='token pointer' id='tok-118-1035'>patches.</span></p>
<p id=p1036><span class='token pointer' id='tok-118-1036'>Final</span><span class='token pointer' id='tok-118-1037'>wordsAt</span><span class='token pointer' id='tok-118-1038'>CloudFlare</span><span class='token pointer' id='tok-118-1039'>our</span><span class='token pointer' id='tok-118-1040'>application</span><span class='token pointer' id='tok-118-1041'>stack</span><span class='token pointer' id='tok-118-1042'>is</span><span class='token pointer' id='tok-118-1043'>based</span><span class='token pointer' id='tok-118-1044'>on</span><span class='token pointer' id='tok-118-1045'>open</span><span class='token pointer' id='tok-118-1046'>source</span><span class='token pointer' id='tok-118-1047'>software.</span><span class='token pointer' id='tok-118-1048'>We're</span><span class='token pointer' id='tok-118-1049'>grateful</span><span class='token pointer' id='tok-118-1050'>to</span><span class='token pointer' id='tok-118-1051'>so</span><span class='token pointer' id='tok-118-1052'>many</span><span class='token pointer' id='tok-118-1053'>open</span><span class='token pointer' id='tok-118-1054'>source</span><span class='token pointer' id='tok-118-1055'>programmers</span><span class='token pointer' id='tok-118-1056'>for</span><span class='token pointer' id='tok-118-1057'>their</span><span class='token pointer' id='tok-118-1058'>awesome</span><span class='token pointer' id='tok-118-1059'>work.</span><span class='token pointer' id='tok-118-1060'>Whenever</span><span class='token pointer' id='tok-118-1061'>we</span><span class='token pointer' id='tok-118-1062'>can</span><span class='token pointer' id='tok-118-1063'>we</span><span class='token pointer' id='tok-118-1064'>try</span><span class='token pointer' id='tok-118-1065'>to</span><span class='token pointer' id='tok-118-1066'>contribute</span><span class='token pointer' id='tok-118-1067'>back</span><span class='token pointer' id='tok-118-1068'>to</span><span class='token pointer' id='tok-118-1069'>the</span><span class='token pointer' id='tok-118-1070'>community</span><span class='token pointer' id='tok-118-1071'>-</span><span class='token pointer' id='tok-118-1072'>we</span><span class='token pointer' id='tok-118-1073'>hope</span><span class='token pointer' id='tok-118-1074'>"the</span><span class='token pointer' id='tok-118-1075'>single</span><span class='token pointer' id='tok-118-1076'>RX</span><span class='token pointer' id='tok-118-1077'>Netmap</span><span class='token pointer' id='tok-118-1078'>mode"</span><span class='token pointer' id='tok-118-1079'>will</span><span class='token pointer' id='tok-118-1080'>be</span><span class='token pointer' id='tok-118-1081'>useful</span><span class='token pointer' id='tok-118-1082'>to</span><span class='token pointer' id='tok-118-1083'>others.</span></p>
<p id=p1084><span class='token pointer' id='tok-118-1084'>You</span><span class='token pointer' id='tok-118-1085'>can</span><span class='token pointer' id='tok-118-1086'>find</span><span class='token pointer' id='tok-118-1087'>more</span><span class='token pointer' id='tok-118-1088'>CloudFlare</span><span class='token pointer' id='tok-118-1089'>open</span><span class='token pointer' id='tok-118-1090'>source</span><span class='token pointer' id='tok-118-1091'>here.
