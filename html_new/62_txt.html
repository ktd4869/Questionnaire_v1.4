<p id=p0><span class='token pointer' id='tok-62-0'>The</span><span class='token pointer' id='tok-62-1'>driver</span><span class='token pointer' id='tok-62-2'>is</span><span class='token pointer' id='tok-62-3'>the</span><span class='token pointer' id='tok-62-4'>first</span><span class='token pointer' id='tok-62-5'>component</span><span class='token pointer' id='tok-62-6'>of</span><span class='token pointer' id='tok-62-7'>Duqu</span><span class='token pointer' id='tok-62-8'>to</span><span class='token pointer' id='tok-62-9'>be</span><span class='token pointer' id='tok-62-10'>loaded</span><span class='token pointer' id='tok-62-11'>in</span><span class='token pointer' id='tok-62-12'>the</span><span class='token pointer' id='tok-62-13'>system.</span><span class='token pointer' id='tok-62-14'>As</span><span class='token pointer' id='tok-62-15'>we</span><span class='token pointer' id='tok-62-16'>discovered,</span><span class='token pointer' id='tok-62-17'>the</span><span class='token pointer' id='tok-62-18'>driver</span><span class='token pointer' id='tok-62-19'>and</span><span class='token pointer' id='tok-62-20'>other</span><span class='token pointer' id='tok-62-21'>components</span><span class='token pointer' id='tok-62-22'>of</span><span class='token pointer' id='tok-62-23'>malware</span><span class='token pointer' id='tok-62-24'>are</span><span class='token pointer' id='tok-62-25'>installed</span><span class='token pointer' id='tok-62-26'>with</span><span class='token pointer' id='tok-62-27'>a</span><span class='token pointer' id='tok-62-28'>dropper</span><span class='token pointer' id='tok-62-29'>exploiting</span><span class='token pointer' id='tok-62-30'>a</span><span class='token pointer' id='tok-62-31'>0-day</span><span class='token pointer' id='tok-62-32'>vulnerability</span><span class='token pointer' id='tok-62-33'>(CVE-2011-3402).</span><span class='token pointer' id='tok-62-34'>The</span><span class='token pointer' id='tok-62-35'>driver</span><span class='token pointer' id='tok-62-36'>is</span><span class='token pointer' id='tok-62-37'>registered</span><span class='token pointer' id='tok-62-38'>in</span><span class='token pointer' id='tok-62-39'>the</span><span class='token pointer' id='tok-62-40'>HKLMSystemCurrentControlSetServices</span><span class='token pointer' id='tok-62-41'>registry</span><span class='token pointer' id='tok-62-42'>path.</span><span class='token pointer' id='tok-62-43'>The</span><span class='token pointer' id='tok-62-44'>exact</span><span class='token pointer' id='tok-62-45'>name</span><span class='token pointer' id='tok-62-46'>of</span><span class='token pointer' id='tok-62-47'>the</span><span class='token pointer' id='tok-62-48'>registry</span><span class='token pointer' id='tok-62-49'>key</span><span class='token pointer' id='tok-62-50'>varies</span><span class='token pointer' id='tok-62-51'>in</span><span class='token pointer' id='tok-62-52'>different</span><span class='token pointer' id='tok-62-53'>versions</span><span class='token pointer' id='tok-62-54'>of</span><span class='token pointer' id='tok-62-55'>Duqu</span><span class='token pointer' id='tok-62-56'>drivers.</span></p>
<p id=p57><span class='token pointer' id='tok-62-57'>Once</span><span class='token pointer' id='tok-62-58'>the</span><span class='token pointer' id='tok-62-59'>driver</span><span class='token pointer' id='tok-62-60'>is</span><span class='token pointer' id='tok-62-61'>loaded,</span><span class='token pointer' id='tok-62-62'>it</span><span class='token pointer' id='tok-62-63'>decrypts</span><span class='token pointer' id='tok-62-64'>a</span><span class='token pointer' id='tok-62-65'>small</span><span class='token pointer' id='tok-62-66'>block</span><span class='token pointer' id='tok-62-67'>that</span><span class='token pointer' id='tok-62-68'>contains</span><span class='token pointer' id='tok-62-69'>its</span><span class='token pointer' id='tok-62-70'>registry</span><span class='token pointer' id='tok-62-71'>key</span><span class='token pointer' id='tok-62-72'>and</span><span class='token pointer' id='tok-62-73'>the</span><span class='token pointer' id='tok-62-74'>name</span><span class='token pointer' id='tok-62-75'>of</span><span class='token pointer' id='tok-62-76'>the</span><span class='token pointer' id='tok-62-77'>registry</span><span class='token pointer' id='tok-62-78'>value</span><span class='token pointer' id='tok-62-79'>to</span><span class='token pointer' id='tok-62-80'>be</span><span class='token pointer' id='tok-62-81'>read</span><span class='token pointer' id='tok-62-82'>from</span><span class='token pointer' id='tok-62-83'>that</span><span class='token pointer' id='tok-62-84'>key.</span><span class='token pointer' id='tok-62-85'>It</span><span class='token pointer' id='tok-62-86'>also</span><span class='token pointer' id='tok-62-87'>contains</span><span class='token pointer' id='tok-62-88'>the</span><span class='token pointer' id='tok-62-89'>name</span><span class='token pointer' id='tok-62-90'>of</span><span class='token pointer' id='tok-62-91'>the</span><span class='token pointer' id='tok-62-92'>driver</span><span class='token pointer' id='tok-62-93'>object</span><span class='token pointer' id='tok-62-94'>to</span><span class='token pointer' id='tok-62-95'>create.</span></p>
<p id=p96><span class='token pointer' id='tok-62-96'>All</span><span class='token pointer' id='tok-62-97'>versions</span><span class='token pointer' id='tok-62-98'>of</span><span class='token pointer' id='tok-62-99'>the</span><span class='token pointer' id='tok-62-100'>driver</span><span class='token pointer' id='tok-62-101'>available</span><span class='token pointer' id='tok-62-102'>at</span><span class='token pointer' id='tok-62-103'>the</span><span class='token pointer' id='tok-62-104'>moment</span><span class='token pointer' id='tok-62-105'>have</span><span class='token pointer' id='tok-62-106'>the</span><span class='token pointer' id='tok-62-107'>same</span><span class='token pointer' id='tok-62-108'>registry</span><span class='token pointer' id='tok-62-109'>value</span><span class='token pointer' id='tok-62-110'>name,</span><span class='token pointer' id='tok-62-111'>"FILTER".</span></p>
<p id=p112><span class='token pointer' id='tok-62-112'>The</span><span class='token pointer' id='tok-62-113'>driver</span><span class='token pointer' id='tok-62-114'>then</span><span class='token pointer' id='tok-62-115'>registers</span><span class='token pointer' id='tok-62-116'>the</span><span class='token pointer' id='tok-62-117'>DriverReinitializationRoutine</span><span class='token pointer' id='tok-62-118'>that</span><span class='token pointer' id='tok-62-119'>queues</span><span class='token pointer' id='tok-62-120'>the</span><span class='token pointer' id='tok-62-121'>WorkerRoutine</span><span class='token pointer' id='tok-62-122'>where</span><span class='token pointer' id='tok-62-123'>actual</span><span class='token pointer' id='tok-62-124'>driver</span><span class='token pointer' id='tok-62-125'>initialization</span><span class='token pointer' id='tok-62-126'>is</span><span class='token pointer' id='tok-62-127'>performed.</span><span class='token pointer' id='tok-62-128'>In</span><span class='token pointer' id='tok-62-129'>the</span><span class='token pointer' id='tok-62-130'>WorkerRoutine</span><span class='token pointer' id='tok-62-131'>the</span><span class='token pointer' id='tok-62-132'>driver</span><span class='token pointer' id='tok-62-133'>reads</span><span class='token pointer' id='tok-62-134'>the</span><span class='token pointer' id='tok-62-135'>"FILTER"</span><span class='token pointer' id='tok-62-136'>value</span><span class='token pointer' id='tok-62-137'>from</span><span class='token pointer' id='tok-62-138'>registry</span><span class='token pointer' id='tok-62-139'>and</span><span class='token pointer' id='tok-62-140'>decrypts</span><span class='token pointer' id='tok-62-141'>it</span><span class='token pointer' id='tok-62-142'>with</span><span class='token pointer' id='tok-62-143'>a</span><span class='token pointer' id='tok-62-144'>hard-coded</span><span class='token pointer' id='tok-62-145'>encryption</span><span class='token pointer' id='tok-62-146'>key.</span><span class='token pointer' id='tok-62-147'>There</span><span class='token pointer' id='tok-62-148'>are</span><span class='token pointer' id='tok-62-149'>two</span><span class='token pointer' id='tok-62-150'>known</span><span class='token pointer' id='tok-62-151'>versions</span><span class='token pointer' id='tok-62-152'>of</span><span class='token pointer' id='tok-62-153'>decryption</span><span class='token pointer' id='tok-62-154'>routine</span><span class='token pointer' id='tok-62-155'>and</span><span class='token pointer' id='tok-62-156'>two</span><span class='token pointer' id='tok-62-157'>corresponding</span><span class='token pointer' id='tok-62-158'>decryption</span><span class='token pointer' id='tok-62-159'>keys.</span><span class='token pointer' id='tok-62-160'>The</span><span class='token pointer' id='tok-62-161'>driver</span><span class='token pointer' id='tok-62-162'>also</span><span class='token pointer' id='tok-62-163'>locates</span><span class='token pointer' id='tok-62-164'>the</span><span class='token pointer' id='tok-62-165'>NTOSKRNL.EXE</span><span class='token pointer' id='tok-62-166'>or</span><span class='token pointer' id='tok-62-167'>NTKRNLPA.EXE</span><span class='token pointer' id='tok-62-168'>module</span><span class='token pointer' id='tok-62-169'>and</span><span class='token pointer' id='tok-62-170'>gets</span><span class='token pointer' id='tok-62-171'>the</span><span class='token pointer' id='tok-62-172'>addresses</span><span class='token pointer' id='tok-62-173'>of</span><span class='token pointer' id='tok-62-174'>API</span><span class='token pointer' id='tok-62-175'>functions</span><span class='token pointer' id='tok-62-176'>for</span><span class='token pointer' id='tok-62-177'>further</span><span class='token pointer' id='tok-62-178'>usage.</span></p>
<p id=p179><span class='token pointer' id='tok-62-179'>The</span><span class='token pointer' id='tok-62-180'>decrypted</span><span class='token pointer' id='tok-62-181'>"FILTER"</span><span class='token pointer' id='tok-62-182'>value</span><span class='token pointer' id='tok-62-183'>from</span><span class='token pointer' id='tok-62-184'>registry</span><span class='token pointer' id='tok-62-185'>contains</span><span class='token pointer' id='tok-62-186'>the</span><span class='token pointer' id='tok-62-187'>list</span><span class='token pointer' id='tok-62-188'>of</span><span class='token pointer' id='tok-62-189'>records</span><span class='token pointer' id='tok-62-190'>that</span><span class='token pointer' id='tok-62-191'>contain</span><span class='token pointer' id='tok-62-192'>the</span><span class='token pointer' id='tok-62-193'>name</span><span class='token pointer' id='tok-62-194'>of</span><span class='token pointer' id='tok-62-195'>the</span><span class='token pointer' id='tok-62-196'>process</span><span class='token pointer' id='tok-62-197'>("services.exe"),</span><span class='token pointer' id='tok-62-198'>the</span><span class='token pointer' id='tok-62-199'>path</span><span class='token pointer' id='tok-62-200'>to</span><span class='token pointer' id='tok-62-201'>corresponding</span><span class='token pointer' id='tok-62-202'>PNF</span><span class='token pointer' id='tok-62-203'>DLL</span><span class='token pointer' id='tok-62-204'>file</span><span class='token pointer' id='tok-62-205'>that</span><span class='token pointer' id='tok-62-206'>will</span><span class='token pointer' id='tok-62-207'>be</span><span class='token pointer' id='tok-62-208'>injected</span><span class='token pointer' id='tok-62-209'>in</span><span class='token pointer' id='tok-62-210'>that</span><span class='token pointer' id='tok-62-211'>process</span><span class='token pointer' id='tok-62-212'>and</span><span class='token pointer' id='tok-62-213'>the</span><span class='token pointer' id='tok-62-214'>decryption</span><span class='token pointer' id='tok-62-215'>key</span><span class='token pointer' id='tok-62-216'>(0xAE240682)</span><span class='token pointer' id='tok-62-217'>that</span><span class='token pointer' id='tok-62-218'>is</span><span class='token pointer' id='tok-62-219'>used</span><span class='token pointer' id='tok-62-220'>to</span><span class='token pointer' id='tok-62-221'>decrypt</span><span class='token pointer' id='tok-62-222'>the</span><span class='token pointer' id='tok-62-223'>PNF</span><span class='token pointer' id='tok-62-224'>DLL</span><span class='token pointer' id='tok-62-225'>file.</span></p>
<p id=p226><span class='token pointer' id='tok-62-226'>After</span><span class='token pointer' id='tok-62-227'>initialization</span><span class='token pointer' id='tok-62-228'>the</span><span class='token pointer' id='tok-62-229'>driver</span><span class='token pointer' id='tok-62-230'>registers</span><span class='token pointer' id='tok-62-231'></span><span class='token pointer' id='tok-62-232'>LoadImageNotifyRoutine</span><span class='token pointer' id='tok-62-233'>that</span><span class='token pointer' id='tok-62-234'>will</span><span class='token pointer' id='tok-62-235'>be</span><span class='token pointer' id='tok-62-236'>then</span><span class='token pointer' id='tok-62-237'>called</span><span class='token pointer' id='tok-62-238'>by</span><span class='token pointer' id='tok-62-239'>Windows</span><span class='token pointer' id='tok-62-240'>each</span><span class='token pointer' id='tok-62-241'>time</span><span class='token pointer' id='tok-62-242'>a</span><span class='token pointer' id='tok-62-243'>new</span><span class='token pointer' id='tok-62-244'>module</span><span class='token pointer' id='tok-62-245'>is</span><span class='token pointer' id='tok-62-246'>loaded.</span><span class='token pointer' id='tok-62-247'>The</span><span class='token pointer' id='tok-62-248'>routine</span><span class='token pointer' id='tok-62-249'>checks</span><span class='token pointer' id='tok-62-250'>if</span><span class='token pointer' id='tok-62-251'>the</span><span class='token pointer' id='tok-62-252'>name</span><span class='token pointer' id='tok-62-253'>of</span><span class='token pointer' id='tok-62-254'>image</span><span class='token pointer' id='tok-62-255'>matches</span><span class='token pointer' id='tok-62-256'>one</span><span class='token pointer' id='tok-62-257'>of</span><span class='token pointer' id='tok-62-258'>these</span><span class='token pointer' id='tok-62-259'>specified</span><span class='token pointer' id='tok-62-260'>in</span><span class='token pointer' id='tok-62-261'>"FILTER"</span><span class='token pointer' id='tok-62-262'>value</span><span class='token pointer' id='tok-62-263'>and</span><span class='token pointer' id='tok-62-264'>if</span><span class='token pointer' id='tok-62-265'>it</span><span class='token pointer' id='tok-62-266'>does,</span><span class='token pointer' id='tok-62-267'>starts</span><span class='token pointer' id='tok-62-268'>the</span><span class='token pointer' id='tok-62-269'>injection:</span><span class='token pointer' id='tok-62-270'>it</span><span class='token pointer' id='tok-62-271'>decrypts</span><span class='token pointer' id='tok-62-272'>and</span><span class='token pointer' id='tok-62-273'>copies</span><span class='token pointer' id='tok-62-274'>the</span><span class='token pointer' id='tok-62-275'>PNF</span><span class='token pointer' id='tok-62-276'>DLL</span><span class='token pointer' id='tok-62-277'>file</span><span class='token pointer' id='tok-62-278'>into</span><span class='token pointer' id='tok-62-279'>an</span><span class='token pointer' id='tok-62-280'>allocate</span><span class='token pointer' id='tok-62-281'>memory</span><span class='token pointer' id='tok-62-282'>region</span><span class='token pointer' id='tok-62-283'>on</span><span class='token pointer' id='tok-62-284'>that</span><span class='token pointer' id='tok-62-285'>process.</span><span class='token pointer' id='tok-62-286'>It</span><span class='token pointer' id='tok-62-287'>also</span><span class='token pointer' id='tok-62-288'>builds</span><span class='token pointer' id='tok-62-289'>an</span><span class='token pointer' id='tok-62-290'>copies</span><span class='token pointer' id='tok-62-291'>a</span><span class='token pointer' id='tok-62-292'>stub</span><span class='token pointer' id='tok-62-293'>EXE</span><span class='token pointer' id='tok-62-294'>file</span><span class='token pointer' id='tok-62-295'>into</span><span class='token pointer' id='tok-62-296'>that</span><span class='token pointer' id='tok-62-297'>process</span><span class='token pointer' id='tok-62-298'>that</span><span class='token pointer' id='tok-62-299'>is</span><span class='token pointer' id='tok-62-300'>then</span><span class='token pointer' id='tok-62-301'>used</span><span class='token pointer' id='tok-62-302'>as</span><span class='token pointer' id='tok-62-303'>a</span><span class='token pointer' id='tok-62-304'>loader</span><span class='token pointer' id='tok-62-305'>for</span><span class='token pointer' id='tok-62-306'>the</span><span class='token pointer' id='tok-62-307'>PNF</span><span class='token pointer' id='tok-62-308'>DLL.</span></p>
<p id=p309><span class='token pointer' id='tok-62-309'>As</span><span class='token pointer' id='tok-62-310'>soon</span><span class='token pointer' id='tok-62-311'>as</span><span class='token pointer' id='tok-62-312'>"KERNEL32.DLL"</span><span class='token pointer' id='tok-62-313'>is</span><span class='token pointer' id='tok-62-314'>loaded</span><span class='token pointer' id='tok-62-315'>in</span><span class='token pointer' id='tok-62-316'>the</span><span class='token pointer' id='tok-62-317'>same</span><span class='token pointer' id='tok-62-318'>process,</span><span class='token pointer' id='tok-62-319'>it</span><span class='token pointer' id='tok-62-320'>locates</span><span class='token pointer' id='tok-62-321'>addresses</span><span class='token pointer' id='tok-62-322'>of</span><span class='token pointer' id='tok-62-323'>API</span><span class='token pointer' id='tok-62-324'>functions</span><span class='token pointer' id='tok-62-325'>required</span><span class='token pointer' id='tok-62-326'>by</span><span class='token pointer' id='tok-62-327'>the</span><span class='token pointer' id='tok-62-328'>loader</span><span class='token pointer' id='tok-62-329'>EXE</span><span class='token pointer' id='tok-62-330'>and</span><span class='token pointer' id='tok-62-331'>modifies</span><span class='token pointer' id='tok-62-332'>the</span><span class='token pointer' id='tok-62-333'>original</span><span class='token pointer' id='tok-62-334'>entry</span><span class='token pointer' id='tok-62-335'>point</span><span class='token pointer' id='tok-62-336'>of</span><span class='token pointer' id='tok-62-337'>the</span><span class='token pointer' id='tok-62-338'>main</span><span class='token pointer' id='tok-62-339'>process</span><span class='token pointer' id='tok-62-340'>module</span><span class='token pointer' id='tok-62-341'>so</span><span class='token pointer' id='tok-62-342'>that</span><span class='token pointer' id='tok-62-343'>it</span><span class='token pointer' id='tok-62-344'>passes</span><span class='token pointer' id='tok-62-345'>execution</span><span class='token pointer' id='tok-62-346'>to</span><span class='token pointer' id='tok-62-347'>the</span><span class='token pointer' id='tok-62-348'>loader</span><span class='token pointer' id='tok-62-349'>EXE</span><span class='token pointer' id='tok-62-350'>code.</span></p>
<p id=p351><span class='token pointer' id='tok-62-351'>The</span><span class='token pointer' id='tok-62-352'>loader</span><span class='token pointer' id='tok-62-353'>EXE</span><span class='token pointer' id='tok-62-354'>module</span><span class='token pointer' id='tok-62-355'>performs</span><span class='token pointer' id='tok-62-356'>initial</span><span class='token pointer' id='tok-62-357'>initialization</span><span class='token pointer' id='tok-62-358'>of</span><span class='token pointer' id='tok-62-359'>the</span><span class='token pointer' id='tok-62-360'>PNF</span><span class='token pointer' id='tok-62-361'>DLL</span><span class='token pointer' id='tok-62-362'>module</span><span class='token pointer' id='tok-62-363'>and</span><span class='token pointer' id='tok-62-364'>then</span><span class='token pointer' id='tok-62-365'>executes</span><span class='token pointer' id='tok-62-366'>the</span><span class='token pointer' id='tok-62-367'>export</span><span class='token pointer' id='tok-62-368'>as</span><span class='token pointer' id='tok-62-369'>specified</span><span class='token pointer' id='tok-62-370'>in</span><span class='token pointer' id='tok-62-371'>the</span><span class='token pointer' id='tok-62-372'>configuration</span><span class='token pointer' id='tok-62-373'>("FILTER").</span><span class='token pointer' id='tok-62-374'>After</span><span class='token pointer' id='tok-62-375'>that</span><span class='token pointer' id='tok-62-376'>it</span><span class='token pointer' id='tok-62-377'>restores</span><span class='token pointer' id='tok-62-378'>the</span><span class='token pointer' id='tok-62-379'>code</span><span class='token pointer' id='tok-62-380'>of</span><span class='token pointer' id='tok-62-381'>the</span><span class='token pointer' id='tok-62-382'>original</span><span class='token pointer' id='tok-62-383'>entry</span><span class='token pointer' id='tok-62-384'>point</span><span class='token pointer' id='tok-62-385'>and</span><span class='token pointer' id='tok-62-386'>returns</span><span class='token pointer' id='tok-62-387'>execution</span><span class='token pointer' id='tok-62-388'>to</span><span class='token pointer' id='tok-62-389'>the</span><span class='token pointer' id='tok-62-390'>original</span><span class='token pointer' id='tok-62-391'>process</span><span class='token pointer' id='tok-62-392'>module.</span><span class='token pointer' id='tok-62-393'>The</span><span class='token pointer' id='tok-62-394'>loader</span><span class='token pointer' id='tok-62-395'>also</span><span class='token pointer' id='tok-62-396'>interacts</span><span class='token pointer' id='tok-62-397'>with</span><span class='token pointer' id='tok-62-398'>the</span><span class='token pointer' id='tok-62-399'>driver</span><span class='token pointer' id='tok-62-400'>module</span><span class='token pointer' id='tok-62-401'>using</span><span class='token pointer' id='tok-62-402'>a</span><span class='token pointer' id='tok-62-403'>custom</span><span class='token pointer' id='tok-62-404'>IOCTL</span><span class='token pointer' id='tok-62-405'>code</span><span class='token pointer' id='tok-62-406'>to</span><span class='token pointer' id='tok-62-407'>change</span><span class='token pointer' id='tok-62-408'>memory</span><span class='token pointer' id='tok-62-409'>protection</span><span class='token pointer' id='tok-62-410'>of</span><span class='token pointer' id='tok-62-411'>the</span><span class='token pointer' id='tok-62-412'>original</span><span class='token pointer' id='tok-62-413'>entry</span><span class='token pointer' id='tok-62-414'>point</span><span class='token pointer' id='tok-62-415'>code.</span></p>
<p id=p416><span class='token pointer' id='tok-62-416'>This</span><span class='token pointer' id='tok-62-417'>module</span><span class='token pointer' id='tok-62-418'>is</span><span class='token pointer' id='tok-62-419'>stored</span><span class='token pointer' id='tok-62-420'>on</span><span class='token pointer' id='tok-62-421'>disk</span><span class='token pointer' id='tok-62-422'>as</span><span class='token pointer' id='tok-62-423'>an</span><span class='token pointer' id='tok-62-424'>encrypted</span><span class='token pointer' id='tok-62-425'>block</span><span class='token pointer' id='tok-62-426'>of</span><span class='token pointer' id='tok-62-427'>data.</span><span class='token pointer' id='tok-62-428'>As</span><span class='token pointer' id='tok-62-429'>soon</span><span class='token pointer' id='tok-62-430'>as</span><span class='token pointer' id='tok-62-431'>it</span><span class='token pointer' id='tok-62-432'>is</span><span class='token pointer' id='tok-62-433'>decrypted,</span><span class='token pointer' id='tok-62-434'>it</span><span class='token pointer' id='tok-62-435'>turns</span><span class='token pointer' id='tok-62-436'>out</span><span class='token pointer' id='tok-62-437'>to</span><span class='token pointer' id='tok-62-438'>be</span><span class='token pointer' id='tok-62-439'>a</span><span class='token pointer' id='tok-62-440'>DLL</span><span class='token pointer' id='tok-62-441'>packed</span><span class='token pointer' id='tok-62-442'>with</span><span class='token pointer' id='tok-62-443'>UPX.</span><span class='token pointer' id='tok-62-444'></span><span class='token pointer' id='tok-62-445'>Known</span><span class='token pointer' id='tok-62-446'>versions</span><span class='token pointer' id='tok-62-447'>of</span><span class='token pointer' id='tok-62-448'>PNF</span><span class='token pointer' id='tok-62-449'>DLL</span><span class='token pointer' id='tok-62-450'>modules</span><span class='token pointer' id='tok-62-451'>export</span><span class='token pointer' id='tok-62-452'>8</span><span class='token pointer' id='tok-62-453'>or</span><span class='token pointer' id='tok-62-454'>6</span><span class='token pointer' id='tok-62-455'>different</span><span class='token pointer' id='tok-62-456'>functions</span><span class='token pointer' id='tok-62-457'>by</span><span class='token pointer' id='tok-62-458'>ordinal</span><span class='token pointer' id='tok-62-459'>numbers.</span></p>
<p id=p460><span class='token pointer' id='tok-62-460'>Export</span><span class='token pointer' id='tok-62-461'>2</span><span class='token pointer' id='tok-62-462'>runs</span><span class='token pointer' id='tok-62-463'>export</span><span class='token pointer' id='tok-62-464'>6</span><span class='token pointer' id='tok-62-465'>in</span><span class='token pointer' id='tok-62-466'>a</span><span class='token pointer' id='tok-62-467'>separate</span><span class='token pointer' id='tok-62-468'>process.</span></p>
<p id=p469><span class='token pointer' id='tok-62-469'>Export</span><span class='token pointer' id='tok-62-470'>4</span><span class='token pointer' id='tok-62-471'>runs</span><span class='token pointer' id='tok-62-472'>export</span><span class='token pointer' id='tok-62-473'>5</span><span class='token pointer' id='tok-62-474'>in</span><span class='token pointer' id='tok-62-475'>a</span><span class='token pointer' id='tok-62-476'>separate</span><span class='token pointer' id='tok-62-477'>process.</span></p>
<p id=p478><span class='token pointer' id='tok-62-478'>Export</span><span class='token pointer' id='tok-62-479'>5</span><span class='token pointer' id='tok-62-480'>starts</span><span class='token pointer' id='tok-62-481'>a</span><span class='token pointer' id='tok-62-482'>thread</span><span class='token pointer' id='tok-62-483'>in</span><span class='token pointer' id='tok-62-484'>"services.exe"</span><span class='token pointer' id='tok-62-485'>process</span><span class='token pointer' id='tok-62-486'>that</span><span class='token pointer' id='tok-62-487'>loaded</span><span class='token pointer' id='tok-62-488'>the</span><span class='token pointer' id='tok-62-489'>302</span><span class='token pointer' id='tok-62-490'>resource</span><span class='token pointer' id='tok-62-491'>(see</span><span class='token pointer' id='tok-62-492'>below)</span><span class='token pointer' id='tok-62-493'>and,</span><span class='token pointer' id='tok-62-494'>if</span><span class='token pointer' id='tok-62-495'>provided</span><span class='token pointer' id='tok-62-496'>with</span><span class='token pointer' id='tok-62-497'>correct</span><span class='token pointer' id='tok-62-498'>information</span><span class='token pointer' id='tok-62-499'>by</span><span class='token pointer' id='tok-62-500'>the</span><span class='token pointer' id='tok-62-501'>callee,</span><span class='token pointer' id='tok-62-502'>installs</span><span class='token pointer' id='tok-62-503'>a</span><span class='token pointer' id='tok-62-504'>complete</span><span class='token pointer' id='tok-62-505'>new</span><span class='token pointer' id='tok-62-506'>set</span><span class='token pointer' id='tok-62-507'>of</span><span class='token pointer' id='tok-62-508'>Duqu</span><span class='token pointer' id='tok-62-509'>components.</span></p>
<p id=p510><span class='token pointer' id='tok-62-510'>Export</span><span class='token pointer' id='tok-62-511'>6</span><span class='token pointer' id='tok-62-512'>stops</span><span class='token pointer' id='tok-62-513'>the</span><span class='token pointer' id='tok-62-514'>driver</span><span class='token pointer' id='tok-62-515'>and</span><span class='token pointer' id='tok-62-516'>completely</span><span class='token pointer' id='tok-62-517'>uninstalls</span><span class='token pointer' id='tok-62-518'>all</span><span class='token pointer' id='tok-62-519'>components</span><span class='token pointer' id='tok-62-520'>of</span><span class='token pointer' id='tok-62-521'>Duqu.</span></p>
<p id=p522><span class='token pointer' id='tok-62-522'>Export</span><span class='token pointer' id='tok-62-523'>8</span><span class='token pointer' id='tok-62-524'>and</span><span class='token pointer' id='tok-62-525'>1</span><span class='token pointer' id='tok-62-526'>initialize</span><span class='token pointer' id='tok-62-527'>the</span><span class='token pointer' id='tok-62-528'>PNF</span><span class='token pointer' id='tok-62-529'>DLL</span><span class='token pointer' id='tok-62-530'>module</span><span class='token pointer' id='tok-62-531'>and</span><span class='token pointer' id='tok-62-532'>start</span><span class='token pointer' id='tok-62-533'>main</span><span class='token pointer' id='tok-62-534'>threads.</span></p>
<p id=p535><span class='token pointer' id='tok-62-535'>It</span><span class='token pointer' id='tok-62-536'>seems</span><span class='token pointer' id='tok-62-537'>that</span><span class='token pointer' id='tok-62-538'>ordinal</span><span class='token pointer' id='tok-62-539'>1</span><span class='token pointer' id='tok-62-540'>is</span><span class='token pointer' id='tok-62-541'>intended</span><span class='token pointer' id='tok-62-542'>to</span><span class='token pointer' id='tok-62-543'>export</span><span class='token pointer' id='tok-62-544'>primary</span><span class='token pointer' id='tok-62-545'>functionality</span><span class='token pointer' id='tok-62-546'>of</span><span class='token pointer' id='tok-62-547'>the</span><span class='token pointer' id='tok-62-548'>DLL.</span><span class='token pointer' id='tok-62-549'>First,</span><span class='token pointer' id='tok-62-550'>it</span><span class='token pointer' id='tok-62-551'>loads</span><span class='token pointer' id='tok-62-552'>the</span><span class='token pointer' id='tok-62-553'>configuration</span><span class='token pointer' id='tok-62-554'>information</span><span class='token pointer' id='tok-62-555'>from</span><span class='token pointer' id='tok-62-556'>another</span><span class='token pointer' id='tok-62-557'>PNF</span><span class='token pointer' id='tok-62-558'>file,</span><span class='token pointer' id='tok-62-559'>the</span><span class='token pointer' id='tok-62-560'>PNF</span><span class='token pointer' id='tok-62-561'>Config</span><span class='token pointer' id='tok-62-562'>file.</span><span class='token pointer' id='tok-62-563'>If</span><span class='token pointer' id='tok-62-564'>the</span><span class='token pointer' id='tok-62-565'>file</span><span class='token pointer' id='tok-62-566'>is</span><span class='token pointer' id='tok-62-567'>not</span><span class='token pointer' id='tok-62-568'>present,</span><span class='token pointer' id='tok-62-569'>it</span><span class='token pointer' id='tok-62-570'>is</span><span class='token pointer' id='tok-62-571'>created</span><span class='token pointer' id='tok-62-572'>from</span><span class='token pointer' id='tok-62-573'>an</span><span class='token pointer' id='tok-62-574'>encrypted</span><span class='token pointer' id='tok-62-575'>hard-coded</span><span class='token pointer' id='tok-62-576'>copy</span><span class='token pointer' id='tok-62-577'>that</span><span class='token pointer' id='tok-62-578'>is</span><span class='token pointer' id='tok-62-579'>stored</span><span class='token pointer' id='tok-62-580'>in</span><span class='token pointer' id='tok-62-581'>the</span><span class='token pointer' id='tok-62-582'>PNF</span><span class='token pointer' id='tok-62-583'>DLL</span><span class='token pointer' id='tok-62-584'>file.</span></p>
<p id=p585><span class='token pointer' id='tok-62-585'>The</span><span class='token pointer' id='tok-62-586'>name</span><span class='token pointer' id='tok-62-587'>of</span><span class='token pointer' id='tok-62-588'>the</span><span class='token pointer' id='tok-62-589'>configuration</span><span class='token pointer' id='tok-62-590'>file</span><span class='token pointer' id='tok-62-591'>is</span><span class='token pointer' id='tok-62-592'>different</span><span class='token pointer' id='tok-62-593'>for</span><span class='token pointer' id='tok-62-594'>every</span><span class='token pointer' id='tok-62-595'>version</span><span class='token pointer' id='tok-62-596'>of</span><span class='token pointer' id='tok-62-597'>Duqu.</span><span class='token pointer' id='tok-62-598'>The</span><span class='token pointer' id='tok-62-599'>PNF</span><span class='token pointer' id='tok-62-600'>Config</span><span class='token pointer' id='tok-62-601'>contains</span><span class='token pointer' id='tok-62-602'>the</span><span class='token pointer' id='tok-62-603'>name</span><span class='token pointer' id='tok-62-604'>and</span><span class='token pointer' id='tok-62-605'>path</span><span class='token pointer' id='tok-62-606'>to</span><span class='token pointer' id='tok-62-607'>the</span><span class='token pointer' id='tok-62-608'>driver</span><span class='token pointer' id='tok-62-609'>component,</span><span class='token pointer' id='tok-62-610'>to</span><span class='token pointer' id='tok-62-611'>the</span><span class='token pointer' id='tok-62-612'>PNF</span><span class='token pointer' id='tok-62-613'>DLL</span><span class='token pointer' id='tok-62-614'>and</span><span class='token pointer' id='tok-62-615'>PNF</span><span class='token pointer' id='tok-62-616'>Config</span><span class='token pointer' id='tok-62-617'>itself.</span></p>
<p id=p618><span class='token pointer' id='tok-62-618'>When</span><span class='token pointer' id='tok-62-619'>the</span><span class='token pointer' id='tok-62-620'>PNF</span><span class='token pointer' id='tok-62-621'>Config</span><span class='token pointer' id='tok-62-622'>is</span><span class='token pointer' id='tok-62-623'>created,</span><span class='token pointer' id='tok-62-624'>the</span><span class='token pointer' id='tok-62-625'>date</span><span class='token pointer' id='tok-62-626'>of</span><span class='token pointer' id='tok-62-627'>creation</span><span class='token pointer' id='tok-62-628'>is</span><span class='token pointer' id='tok-62-629'>written</span><span class='token pointer' id='tok-62-630'>into</span><span class='token pointer' id='tok-62-631'>the</span><span class='token pointer' id='tok-62-632'>file.</span><span class='token pointer' id='tok-62-633'>The</span><span class='token pointer' id='tok-62-634'>file</span><span class='token pointer' id='tok-62-635'>also</span><span class='token pointer' id='tok-62-636'>contains</span><span class='token pointer' id='tok-62-637'>the</span><span class='token pointer' id='tok-62-638'>TTL</span><span class='token pointer' id='tok-62-639'>("time</span><span class='token pointer' id='tok-62-640'>to</span><span class='token pointer' id='tok-62-641'>live")</span><span class='token pointer' id='tok-62-642'>value:</span><span class='token pointer' id='tok-62-643'>a</span><span class='token pointer' id='tok-62-644'>separate</span><span class='token pointer' id='tok-62-645'>thread</span><span class='token pointer' id='tok-62-646'>started</span><span class='token pointer' id='tok-62-647'>by</span><span class='token pointer' id='tok-62-648'>PNF</span><span class='token pointer' id='tok-62-649'>DLL</span><span class='token pointer' id='tok-62-650'>monitors</span><span class='token pointer' id='tok-62-651'>if</span><span class='token pointer' id='tok-62-652'>TTL</span><span class='token pointer' id='tok-62-653'>days</span><span class='token pointer' id='tok-62-654'>passed</span><span class='token pointer' id='tok-62-655'>since</span><span class='token pointer' id='tok-62-656'>the</span><span class='token pointer' id='tok-62-657'>creation</span><span class='token pointer' id='tok-62-658'>date,</span><span class='token pointer' id='tok-62-659'>and</span><span class='token pointer' id='tok-62-660'>after</span><span class='token pointer' id='tok-62-661'>that</span><span class='token pointer' id='tok-62-662'>runs</span><span class='token pointer' id='tok-62-663'>the</span><span class='token pointer' id='tok-62-664'>uninstallation</span><span class='token pointer' id='tok-62-665'>routine.</span></p>
<p id=p666><span class='token pointer' id='tok-62-666'>Some</span><span class='token pointer' id='tok-62-667'>versions</span><span class='token pointer' id='tok-62-668'>of</span><span class='token pointer' id='tok-62-669'>the</span><span class='token pointer' id='tok-62-670'>PNF</span><span class='token pointer' id='tok-62-671'>DLL</span><span class='token pointer' id='tok-62-672'>also</span><span class='token pointer' id='tok-62-673'>start</span><span class='token pointer' id='tok-62-674'>an</span><span class='token pointer' id='tok-62-675'>RPC</span><span class='token pointer' id='tok-62-676'>server</span><span class='token pointer' id='tok-62-677'>similar</span><span class='token pointer' id='tok-62-678'>to</span><span class='token pointer' id='tok-62-679'>the</span><span class='token pointer' id='tok-62-680'>one</span><span class='token pointer' id='tok-62-681'>found</span><span class='token pointer' id='tok-62-682'>in</span><span class='token pointer' id='tok-62-683'>Stuxnet.</span></p>
<p id=p684><span class='token pointer' id='tok-62-684'>The</span><span class='token pointer' id='tok-62-685'>PNF</span><span class='token pointer' id='tok-62-686'>DLL</span><span class='token pointer' id='tok-62-687'>also</span><span class='token pointer' id='tok-62-688'>provides</span><span class='token pointer' id='tok-62-689'>API</span><span class='token pointer' id='tok-62-690'>for</span><span class='token pointer' id='tok-62-691'>manipulating</span><span class='token pointer' id='tok-62-692'>the</span><span class='token pointer' id='tok-62-693'>configuration</span><span class='token pointer' id='tok-62-694'>file</span><span class='token pointer' id='tok-62-695'>from</span><span class='token pointer' id='tok-62-696'>external</span><span class='token pointer' id='tok-62-697'>modules</span><span class='token pointer' id='tok-62-698'>using</span><span class='token pointer' id='tok-62-699'>globally</span><span class='token pointer' id='tok-62-700'>available</span><span class='token pointer' id='tok-62-701'>events.</span></p>
<p id=p702><span class='token pointer' id='tok-62-702'>Depending</span><span class='token pointer' id='tok-62-703'>on</span><span class='token pointer' id='tok-62-704'>the</span><span class='token pointer' id='tok-62-705'>flags</span><span class='token pointer' id='tok-62-706'>in</span><span class='token pointer' id='tok-62-707'>the</span><span class='token pointer' id='tok-62-708'>PNF</span><span class='token pointer' id='tok-62-709'>Config,</span><span class='token pointer' id='tok-62-710'>the</span><span class='token pointer' id='tok-62-711'>PNF</span><span class='token pointer' id='tok-62-712'>DLL</span><span class='token pointer' id='tok-62-713'>code</span><span class='token pointer' id='tok-62-714'>looks</span><span class='token pointer' id='tok-62-715'>for</span><span class='token pointer' id='tok-62-716'>specific</span><span class='token pointer' id='tok-62-717'>processes:</span><span class='token pointer' id='tok-62-718'>the</span><span class='token pointer' id='tok-62-719'>list</span><span class='token pointer' id='tok-62-720'>of</span><span class='token pointer' id='tok-62-721'>process</span><span class='token pointer' id='tok-62-722'>names</span><span class='token pointer' id='tok-62-723'>in</span><span class='token pointer' id='tok-62-724'>the</span><span class='token pointer' id='tok-62-725'>PNF</span><span class='token pointer' id='tok-62-726'>Config,</span><span class='token pointer' id='tok-62-727'>"explorer.exe",</span><span class='token pointer' id='tok-62-728'>"svchost.exe"</span><span class='token pointer' id='tok-62-729'>and</span><span class='token pointer' id='tok-62-730'>then</span><span class='token pointer' id='tok-62-731'>injects</span><span class='token pointer' id='tok-62-732'>code</span><span class='token pointer' id='tok-62-733'>in</span><span class='token pointer' id='tok-62-734'>them.</span><span class='token pointer' id='tok-62-735'>The</span><span class='token pointer' id='tok-62-736'>code</span><span class='token pointer' id='tok-62-737'>to</span><span class='token pointer' id='tok-62-738'>be</span><span class='token pointer' id='tok-62-739'>injected</span><span class='token pointer' id='tok-62-740'>is</span><span class='token pointer' id='tok-62-741'>stored</span><span class='token pointer' id='tok-62-742'>in</span><span class='token pointer' id='tok-62-743'>binary</span><span class='token pointer' id='tok-62-744'>resource</span><span class='token pointer' id='tok-62-745'>302</span><span class='token pointer' id='tok-62-746'>found</span><span class='token pointer' id='tok-62-747'>in</span><span class='token pointer' id='tok-62-748'>PNF</span><span class='token pointer' id='tok-62-749'>DLL.</span></p>
<p id=p750><span class='token pointer' id='tok-62-750'>Depending</span><span class='token pointer' id='tok-62-751'>on</span><span class='token pointer' id='tok-62-752'>the</span><span class='token pointer' id='tok-62-753'>flag</span><span class='token pointer' id='tok-62-754'>in</span><span class='token pointer' id='tok-62-755'>the</span><span class='token pointer' id='tok-62-756'>PNF</span><span class='token pointer' id='tok-62-757'>configuration</span><span class='token pointer' id='tok-62-758'>file,</span><span class='token pointer' id='tok-62-759'>it</span><span class='token pointer' id='tok-62-760'>is</span><span class='token pointer' id='tok-62-761'>either</span><span class='token pointer' id='tok-62-762'>a</span><span class='token pointer' id='tok-62-763'>DLL</span><span class='token pointer' id='tok-62-764'>loader</span><span class='token pointer' id='tok-62-765'>module</span><span class='token pointer' id='tok-62-766'>or</span><span class='token pointer' id='tok-62-767'>a</span><span class='token pointer' id='tok-62-768'>block</span><span class='token pointer' id='tok-62-769'>of</span><span class='token pointer' id='tok-62-770'>data</span><span class='token pointer' id='tok-62-771'>(equivalent</span><span class='token pointer' id='tok-62-772'>of</span><span class='token pointer' id='tok-62-773'>decompressed</span><span class='token pointer' id='tok-62-774'>".zdata",</span><span class='token pointer' id='tok-62-775'>see</span><span class='token pointer' id='tok-62-776'>below).</span><span class='token pointer' id='tok-62-777'>Both</span><span class='token pointer' id='tok-62-778'>configuration</span><span class='token pointer' id='tok-62-779'>have</span><span class='token pointer' id='tok-62-780'>been</span><span class='token pointer' id='tok-62-781'>found</span><span class='token pointer' id='tok-62-782'>in</span><span class='token pointer' id='tok-62-783'>different</span><span class='token pointer' id='tok-62-784'>Duqu</span><span class='token pointer' id='tok-62-785'>versions.</span><span class='token pointer' id='tok-62-786'>The</span><span class='token pointer' id='tok-62-787'>PNF</span><span class='token pointer' id='tok-62-788'>DLL</span><span class='token pointer' id='tok-62-789'>checks</span><span class='token pointer' id='tok-62-790'>a</span><span class='token pointer' id='tok-62-791'>flag</span><span class='token pointer' id='tok-62-792'>in</span><span class='token pointer' id='tok-62-793'>PNF</span><span class='token pointer' id='tok-62-794'>Config</span><span class='token pointer' id='tok-62-795'>and</span><span class='token pointer' id='tok-62-796'>determines</span><span class='token pointer' id='tok-62-797'>whether</span><span class='token pointer' id='tok-62-798'>to</span><span class='token pointer' id='tok-62-799'>pass</span><span class='token pointer' id='tok-62-800'>execution</span><span class='token pointer' id='tok-62-801'>to</span><span class='token pointer' id='tok-62-802'>the</span><span class='token pointer' id='tok-62-803'>DLL</span><span class='token pointer' id='tok-62-804'>loader</span><span class='token pointer' id='tok-62-805'>or</span><span class='token pointer' id='tok-62-806'>to</span><span class='token pointer' id='tok-62-807'>locate</span><span class='token pointer' id='tok-62-808'>the</span><span class='token pointer' id='tok-62-809'>payload</span><span class='token pointer' id='tok-62-810'>DLL</span><span class='token pointer' id='tok-62-811'>and</span><span class='token pointer' id='tok-62-812'>call</span><span class='token pointer' id='tok-62-813'>it</span><span class='token pointer' id='tok-62-814'>directly.</span></p>
<p id=p815><span class='token pointer' id='tok-62-815'>The</span><span class='token pointer' id='tok-62-816'>loader</span><span class='token pointer' id='tok-62-817'>DLL</span><span class='token pointer' id='tok-62-818'>module</span><span class='token pointer' id='tok-62-819'>is</span><span class='token pointer' id='tok-62-820'>similar</span><span class='token pointer' id='tok-62-821'>to</span><span class='token pointer' id='tok-62-822'>PNF</span><span class='token pointer' id='tok-62-823'>DLL.</span><span class='token pointer' id='tok-62-824'>The</span><span class='token pointer' id='tok-62-825'>main</span><span class='token pointer' id='tok-62-826'>purpose</span><span class='token pointer' id='tok-62-827'>of</span><span class='token pointer' id='tok-62-828'>the</span><span class='token pointer' id='tok-62-829'>loader</span><span class='token pointer' id='tok-62-830'>is</span><span class='token pointer' id='tok-62-831'>to</span><span class='token pointer' id='tok-62-832'>decompress</span><span class='token pointer' id='tok-62-833'>its</span><span class='token pointer' id='tok-62-834'>".zdata"</span><span class='token pointer' id='tok-62-835'>section</span><span class='token pointer' id='tok-62-836'>and</span><span class='token pointer' id='tok-62-837'>pass</span><span class='token pointer' id='tok-62-838'>execution</span><span class='token pointer' id='tok-62-839'>to</span><span class='token pointer' id='tok-62-840'>the</span><span class='token pointer' id='tok-62-841'>main</span><span class='token pointer' id='tok-62-842'>payload</span><span class='token pointer' id='tok-62-843'>that</span><span class='token pointer' id='tok-62-844'>is</span><span class='token pointer' id='tok-62-845'>contained</span><span class='token pointer' id='tok-62-846'>in</span><span class='token pointer' id='tok-62-847'>decompressed</span><span class='token pointer' id='tok-62-848'>data.</span></p>
<p id=p849><span class='token pointer' id='tok-62-849'>The</span><span class='token pointer' id='tok-62-850'>.zdata</span><span class='token pointer' id='tok-62-851'>block</span><span class='token pointer' id='tok-62-852'>contains</span><span class='token pointer' id='tok-62-853'>the</span><span class='token pointer' id='tok-62-854'>header</span><span class='token pointer' id='tok-62-855'>that</span><span class='token pointer' id='tok-62-856'>starts</span><span class='token pointer' id='tok-62-857'>with</span><span class='token pointer' id='tok-62-858'>the</span><span class='token pointer' id='tok-62-859'>magic</span><span class='token pointer' id='tok-62-860'>number</span><span class='token pointer' id='tok-62-861'>0x48747193.</span><span class='token pointer' id='tok-62-862'>It</span><span class='token pointer' id='tok-62-863'>contains</span><span class='token pointer' id='tok-62-864'>the</span><span class='token pointer' id='tok-62-865'>offsets</span><span class='token pointer' id='tok-62-866'>and</span><span class='token pointer' id='tok-62-867'>sizes</span><span class='token pointer' id='tok-62-868'>of</span><span class='token pointer' id='tok-62-869'>the</span><span class='token pointer' id='tok-62-870'>DLL</span><span class='token pointer' id='tok-62-871'>loader,</span><span class='token pointer' id='tok-62-872'>the</span><span class='token pointer' id='tok-62-873'>payload</span><span class='token pointer' id='tok-62-874'>configuration</span><span class='token pointer' id='tok-62-875'>block</span><span class='token pointer' id='tok-62-876'>and</span><span class='token pointer' id='tok-62-877'>the</span><span class='token pointer' id='tok-62-878'>payload</span><span class='token pointer' id='tok-62-879'>DLL.</span></p>
<p id=p880><span class='token pointer' id='tok-62-880'>Configuration</span><span class='token pointer' id='tok-62-881'>block</span></p>
<p id=p882><span class='token pointer' id='tok-62-882'>The</span><span class='token pointer' id='tok-62-883'>configuration</span><span class='token pointer' id='tok-62-884'>block</span><span class='token pointer' id='tok-62-885'>contains</span><span class='token pointer' id='tok-62-886'>the</span><span class='token pointer' id='tok-62-887'>name</span><span class='token pointer' id='tok-62-888'>of</span><span class='token pointer' id='tok-62-889'>the</span><span class='token pointer' id='tok-62-890'>temporary</span><span class='token pointer' id='tok-62-891'>file</span><span class='token pointer' id='tok-62-892'>to</span><span class='token pointer' id='tok-62-893'>use</span><span class='token pointer' id='tok-62-894'>%TEMP%~DR0001.tmp,</span><span class='token pointer' id='tok-62-895'>additional</span><span class='token pointer' id='tok-62-896'>binary</span><span class='token pointer' id='tok-62-897'>data</span><span class='token pointer' id='tok-62-898'>controlling</span><span class='token pointer' id='tok-62-899'>the</span><span class='token pointer' id='tok-62-900'>behavior</span><span class='token pointer' id='tok-62-901'>of</span><span class='token pointer' id='tok-62-902'>the</span><span class='token pointer' id='tok-62-903'>payload</span><span class='token pointer' id='tok-62-904'>and</span><span class='token pointer' id='tok-62-905'>information</span><span class='token pointer' id='tok-62-906'>required</span><span class='token pointer' id='tok-62-907'>to</span><span class='token pointer' id='tok-62-908'>connect</span><span class='token pointer' id='tok-62-909'>to</span><span class='token pointer' id='tok-62-910'>the</span><span class='token pointer' id='tok-62-911'>C&amp;C</span><span class='token pointer' id='tok-62-912'>servers.</span><span class='token pointer' id='tok-62-913'>There</span><span class='token pointer' id='tok-62-914'>are</span><span class='token pointer' id='tok-62-915'>two</span><span class='token pointer' id='tok-62-916'>lists</span><span class='token pointer' id='tok-62-917'>of</span><span class='token pointer' id='tok-62-918'>C&amp;C</span><span class='token pointer' id='tok-62-919'>servers,</span><span class='token pointer' id='tok-62-920'>one</span><span class='token pointer' id='tok-62-921'>can</span><span class='token pointer' id='tok-62-922'>contain</span><span class='token pointer' id='tok-62-923'>domain</span><span class='token pointer' id='tok-62-924'>names,</span><span class='token pointer' id='tok-62-925'>IP</span><span class='token pointer' id='tok-62-926'>addresses</span><span class='token pointer' id='tok-62-927'>or</span><span class='token pointer' id='tok-62-928'>names</span><span class='token pointer' id='tok-62-929'>of</span><span class='token pointer' id='tok-62-930'>network</span><span class='token pointer' id='tok-62-931'>shares,</span><span class='token pointer' id='tok-62-932'>and</span><span class='token pointer' id='tok-62-933'>the</span><span class='token pointer' id='tok-62-934'>other</span><span class='token pointer' id='tok-62-935'>contains</span><span class='token pointer' id='tok-62-936'>IP</span><span class='token pointer' id='tok-62-937'>addresses</span><span class='token pointer' id='tok-62-938'>in</span><span class='token pointer' id='tok-62-939'>binary</span><span class='token pointer' id='tok-62-940'>format</span><span class='token pointer' id='tok-62-941'>and</span><span class='token pointer' id='tok-62-942'>is</span><span class='token pointer' id='tok-62-943'>used</span><span class='token pointer' id='tok-62-944'>to</span><span class='token pointer' id='tok-62-945'>connect</span><span class='token pointer' id='tok-62-946'>using</span><span class='token pointer' id='tok-62-947'>Windows</span><span class='token pointer' id='tok-62-948'>HTTP</span><span class='token pointer' id='tok-62-949'>(winhttp)</span><span class='token pointer' id='tok-62-950'>services.</span><span class='token pointer' id='tok-62-951'>Although</span><span class='token pointer' id='tok-62-952'>the</span><span class='token pointer' id='tok-62-953'>configuration</span><span class='token pointer' id='tok-62-954'>blocks</span><span class='token pointer' id='tok-62-955'>we</span><span class='token pointer' id='tok-62-956'>have</span><span class='token pointer' id='tok-62-957'>found</span><span class='token pointer' id='tok-62-958'>so</span><span class='token pointer' id='tok-62-959'>far</span><span class='token pointer' id='tok-62-960'>are</span><span class='token pointer' id='tok-62-961'>similar</span><span class='token pointer' id='tok-62-962'>and</span><span class='token pointer' id='tok-62-963'>are</span><span class='token pointer' id='tok-62-964'>set</span><span class='token pointer' id='tok-62-965'>up</span><span class='token pointer' id='tok-62-966'>to</span><span class='token pointer' id='tok-62-967'>connect</span><span class='token pointer' id='tok-62-968'>to</span><span class='token pointer' id='tok-62-969'>its</span><span class='token pointer' id='tok-62-970'>C&amp;C</span><span class='token pointer' id='tok-62-971'>using</span><span class='token pointer' id='tok-62-972'>HTTP</span><span class='token pointer' id='tok-62-973'>and</span><span class='token pointer' id='tok-62-974'>HTTPS,</span><span class='token pointer' id='tok-62-975'>the</span><span class='token pointer' id='tok-62-976'>payload</span><span class='token pointer' id='tok-62-977'>DLL</span><span class='token pointer' id='tok-62-978'>is</span><span class='token pointer' id='tok-62-979'>able</span><span class='token pointer' id='tok-62-980'>to</span><span class='token pointer' id='tok-62-981'>connect</span><span class='token pointer' id='tok-62-982'>to</span><span class='token pointer' id='tok-62-983'>a</span><span class='token pointer' id='tok-62-984'>network</span><span class='token pointer' id='tok-62-985'>share</span><span class='token pointer' id='tok-62-986'>and</span><span class='token pointer' id='tok-62-987'>even</span><span class='token pointer' id='tok-62-988'>become</span><span class='token pointer' id='tok-62-989'>a</span><span class='token pointer' id='tok-62-990'>server.</span></p>
<p id=p991><span class='token pointer' id='tok-62-991'>We</span><span class='token pointer' id='tok-62-992'>are</span><span class='token pointer' id='tok-62-993'>still</span><span class='token pointer' id='tok-62-994'>analyzing</span><span class='token pointer' id='tok-62-995'>the</span><span class='token pointer' id='tok-62-996'>payload.</span><span class='token pointer' id='tok-62-997'>It</span><span class='token pointer' id='tok-62-998'>contains</span><span class='token pointer' id='tok-62-999'>256K</span><span class='token pointer' id='tok-62-1000'>of</span><span class='token pointer' id='tok-62-1001'>C++</span><span class='token pointer' id='tok-62-1002'>code</span><span class='token pointer' id='tok-62-1003'>with</span><span class='token pointer' id='tok-62-1004'>extensive</span><span class='token pointer' id='tok-62-1005'>use</span><span class='token pointer' id='tok-62-1006'>of</span><span class='token pointer' id='tok-62-1007'>STL</span><span class='token pointer' id='tok-62-1008'>and</span><span class='token pointer' id='tok-62-1009'>its</span><span class='token pointer' id='tok-62-1010'>own</span><span class='token pointer' id='tok-62-1011'>complex</span><span class='token pointer' id='tok-62-1012'>class</span><span class='token pointer' id='tok-62-1013'>hierarchies,</span><span class='token pointer' id='tok-62-1014'>probably</span><span class='token pointer' id='tok-62-1015'>own</span><span class='token pointer' id='tok-62-1016'>framework.</span></p>
<p id=p1017><span class='token pointer' id='tok-62-1017'>The</span><span class='token pointer' id='tok-62-1018'>payload</span><span class='token pointer' id='tok-62-1019'>is</span><span class='token pointer' id='tok-62-1020'>able</span><span class='token pointer' id='tok-62-1021'>to</span><span class='token pointer' id='tok-62-1022'>connect</span><span class='token pointer' id='tok-62-1023'>to</span><span class='token pointer' id='tok-62-1024'>C&amp;C</span><span class='token pointer' id='tok-62-1025'>server</span><span class='token pointer' id='tok-62-1026'>using</span><span class='token pointer' id='tok-62-1027'>either</span><span class='token pointer' id='tok-62-1028'>winhttp</span><span class='token pointer' id='tok-62-1029'>library</span><span class='token pointer' id='tok-62-1030'>or</span><span class='token pointer' id='tok-62-1031'>connection</span><span class='token pointer' id='tok-62-1032'>to</span><span class='token pointer' id='tok-62-1033'>a</span><span class='token pointer' id='tok-62-1034'>network</span><span class='token pointer' id='tok-62-1035'>share</span><span class='token pointer' id='tok-62-1036'>IPC$</span><span class='token pointer' id='tok-62-1037'>endpoint.</span><span class='token pointer' id='tok-62-1038'>It</span><span class='token pointer' id='tok-62-1039'>is</span><span class='token pointer' id='tok-62-1040'>able</span><span class='token pointer' id='tok-62-1041'>to</span><span class='token pointer' id='tok-62-1042'>connect</span><span class='token pointer' id='tok-62-1043'>using</span><span class='token pointer' id='tok-62-1044'>proxy</span><span class='token pointer' id='tok-62-1045'>server</span><span class='token pointer' id='tok-62-1046'>configuration</span><span class='token pointer' id='tok-62-1047'>of</span><span class='token pointer' id='tok-62-1048'>Internet</span><span class='token pointer' id='tok-62-1049'>Explorer.</span><span class='token pointer' id='tok-62-1050'>It</span><span class='token pointer' id='tok-62-1051'>also</span><span class='token pointer' id='tok-62-1052'>contains</span><span class='token pointer' id='tok-62-1053'>code</span><span class='token pointer' id='tok-62-1054'>for</span><span class='token pointer' id='tok-62-1055'>acting</span><span class='token pointer' id='tok-62-1056'>as</span><span class='token pointer' id='tok-62-1057'>a</span><span class='token pointer' id='tok-62-1058'>HTTP</span><span class='token pointer' id='tok-62-1059'>server</span><span class='token pointer' id='tok-62-1060'>and</span><span class='token pointer' id='tok-62-1061'>processing</span><span class='token pointer' id='tok-62-1062'>the</span><span class='token pointer' id='tok-62-1063'>same</span><span class='token pointer' id='tok-62-1064'>requests</span><span class='token pointer' id='tok-62-1065'>as</span><span class='token pointer' id='tok-62-1066'>served</span><span class='token pointer' id='tok-62-1067'>by</span><span class='token pointer' id='tok-62-1068'>the</span><span class='token pointer' id='tok-62-1069'>C&amp;C.</span></p>
<p id=p1070><span class='token pointer' id='tok-62-1070'>The</span><span class='token pointer' id='tok-62-1071'>payload</span><span class='token pointer' id='tok-62-1072'>is</span><span class='token pointer' id='tok-62-1073'>able</span><span class='token pointer' id='tok-62-1074'>to</span><span class='token pointer' id='tok-62-1075'>load</span><span class='token pointer' id='tok-62-1076'>an</span><span class='token pointer' id='tok-62-1077'>external</span><span class='token pointer' id='tok-62-1078'>DLL</span><span class='token pointer' id='tok-62-1079'>module</span><span class='token pointer' id='tok-62-1080'>provided</span><span class='token pointer' id='tok-62-1081'>by</span><span class='token pointer' id='tok-62-1082'>the</span><span class='token pointer' id='tok-62-1083'>C&amp;C</span><span class='token pointer' id='tok-62-1084'>and</span><span class='token pointer' id='tok-62-1085'>interact</span><span class='token pointer' id='tok-62-1086'>with</span><span class='token pointer' id='tok-62-1087'>it</span><span class='token pointer' id='tok-62-1088'>using</span><span class='token pointer' id='tok-62-1089'>a</span><span class='token pointer' id='tok-62-1090'>pre-defined</span><span class='token pointer' id='tok-62-1091'>API.</span><span class='token pointer' id='tok-62-1092'>The</span><span class='token pointer' id='tok-62-1093'>most</span><span class='token pointer' id='tok-62-1094'>noticeable</span><span class='token pointer' id='tok-62-1095'>module</span><span class='token pointer' id='tok-62-1096'>discovered</span><span class='token pointer' id='tok-62-1097'>so</span><span class='token pointer' id='tok-62-1098'>far</span><span class='token pointer' id='tok-62-1099'>is</span><span class='token pointer' id='tok-62-1100'>the</span><span class='token pointer' id='tok-62-1101'>infostealer</span><span class='token pointer' id='tok-62-1102'>module.</span><span class='token pointer' id='tok-62-1103'>There</span><span class='token pointer' id='tok-62-1104'>are</span><span class='token pointer' id='tok-62-1105'>also</span><span class='token pointer' id='tok-62-1106'>modules</span><span class='token pointer' id='tok-62-1107'>for</span><span class='token pointer' id='tok-62-1108'>updating</span><span class='token pointer' id='tok-62-1109'>the</span><span class='token pointer' id='tok-62-1110'>TTL</span><span class='token pointer' id='tok-62-1111'>value</span><span class='token pointer' id='tok-62-1112'>in</span><span class='token pointer' id='tok-62-1113'>the</span><span class='token pointer' id='tok-62-1114'>PNF</span><span class='token pointer' id='tok-62-1115'>DLL</span><span class='token pointer' id='tok-62-1116'>configuration,</span><span class='token pointer' id='tok-62-1117'>for</span><span class='token pointer' id='tok-62-1118'>reading</span><span class='token pointer' id='tok-62-1119'>the</span><span class='token pointer' id='tok-62-1120'>network</span><span class='token pointer' id='tok-62-1121'>and</span><span class='token pointer' id='tok-62-1122'>disk</span><span class='token pointer' id='tok-62-1123'>storage</span><span class='token pointer' id='tok-62-1124'>configuration</span><span class='token pointer' id='tok-62-1125'>from</span><span class='token pointer' id='tok-62-1126'>the</span><span class='token pointer' id='tok-62-1127'>infected</span><span class='token pointer' id='tok-62-1128'>machine.</span></p>
<p id=p1129><span class='token pointer' id='tok-62-1129'>It</span><span class='token pointer' id='tok-62-1130'>also</span><span class='token pointer' id='tok-62-1131'>can</span><span class='token pointer' id='tok-62-1132'>form</span><span class='token pointer' id='tok-62-1133'>a</span><span class='token pointer' id='tok-62-1134'>PNF</span><span class='token pointer' id='tok-62-1135'>DLL</span><span class='token pointer' id='tok-62-1136'>with</span><span class='token pointer' id='tok-62-1137'>a</span><span class='token pointer' id='tok-62-1138'>configuration</span><span class='token pointer' id='tok-62-1139'>block</span><span class='token pointer' id='tok-62-1140'>and</span><span class='token pointer' id='tok-62-1141'>the</span><span class='token pointer' id='tok-62-1142'>payload</span><span class='token pointer' id='tok-62-1143'>DLL</span><span class='token pointer' id='tok-62-1144'>ready</span><span class='token pointer' id='tok-62-1145'>for</span><span class='token pointer' id='tok-62-1146'>distribution</span><span class='token pointer' id='tok-62-1147'>to</span><span class='token pointer' id='tok-62-1148'>other</span><span class='token pointer' id='tok-62-1149'>machines.
