<p id=p0>The OilRig <span class='token pointer' id='tok-80-0' style='color:red'>group</span><span class='token pointer' id='tok-80-1' style='color:red'>remains</span><span class='token pointer' id='tok-80-2' style='color:red'>highly</span>active in their <span class='token pointer' id='tok-80-3' style='color:red'>attack</span><span class='token pointer' id='tok-80-4' style='color:red'>campaigns</span>while they continue to <span class='token pointer' id='tok-80-5' style='color:red'>evolve</span>their <span class='token pointer' id='tok-80-6' style='color:red'>toolset.</span>On January 8, 2018, Unit 42 observed the <span class='token pointer' id='tok-80-7' style='color:red'>OilRig</span><span class='token pointer' id='tok-80-8' style='color:red'>threat group</span>out an attack on an <span class='token pointer' id='tok-80-9' style='color:red'>insurance</span><span class='token pointer' id='tok-80-10' style='color:red'>agency</span>based in the <span class='token pointer' id='tok-80-11' style='color:red'>Middle</span>East. Just over a week later, on January 16, 2018, we observed an attack on a Middle Eastern <span class='token pointer' id='tok-80-12' style='color:red'>financial</span>institution. In both <span class='token pointer' id='tok-80-13' style='color:red'>attacks,</span>the OilRig group <span class='token pointer' id='tok-80-14' style='color:red'>attempted</span>to <span class='token pointer' id='tok-80-15' style='color:red'>deliver</span>a new <span class='token pointer' id='tok-80-16' style='color:red'>Trojan</span>that we are <span class='token pointer' id='tok-80-17' style='color:red'>tracking</span>as <span class='token pointer' id='tok-80-18' style='color:red'>OopsIE.</span></p><p id=p78>The January 8 attack used a variant of the <span class='token pointer' id='tok-80-19' style='color:red'>document,</span><span class='token pointer' id='tok-80-20' style='color:red'>delivery</span>we identified as <span class='token pointer' id='tok-80-21' style='color:red'>part</span>of the OilRig toolset based on attacks that occurred in August 2017. </p><p id=p107>However, the attack on January 16 did not involve ThreeDollars at all. Instead, this attack involved delivering the OopsIE <span class='token pointer' id='tok-80-22' style='color:red'>Trojan directly</span>the <span class='token pointer' id='tok-80-23' style='color:red'>victim,</span>most likely using a <span class='token pointer' id='tok-80-24' style='color:red'>link</span>in a <span class='token pointer' id='tok-80-25' style='color:red'>email.</span><span class='token pointer' id='tok-80-26' style='color:red'>spear phishing</span>the <span class='token pointer' id='tok-80-27' style='color:red'>targeted</span>organization in the January 16 attack had already been targeted by the OilRig group a year ago on January 2017. This repeat attack may suggest that the <span class='token pointer' id='tok-80-28' style='color:red'>adversaries</span>have lost their <span class='token pointer' id='tok-80-29' style='color:red'>foothold</span>in the targeted organization, or that it may be considered a </p><p id=p190>A New Attack </p><p id=p193>On January 8, 2018, the OilRig threat group sent an email with the subject Beirut Insurance Seminar Invitation to an insurance agency in the Middle East. The OilRig group sent two <span class='token pointer' id='tok-80-30' style='color:red'>emails</span>to two different email <span class='token pointer' id='tok-80-31' style='color:red'>addresses</span>at the same organization within a six minutes time span. The recipient email addresses suggest they may be the addresses used for specific <span class='token pointer' id='tok-80-32' style='color:red'>regional branches</span>the targeted organization. </p><p id=p259>Both emails originated from the same <span class='token pointer' id='tok-80-33' style='color:red'>address.</span>The email address is associated with the Lebanese <span class='token pointer' id='tok-80-34' style='color:red'>domain</span>of a major global financial institution. However, based upon the captured <span class='token pointer' id='tok-80-35' style='color:red'>session data,</span>is highly likely the source email address was <span class='token pointer' id='tok-80-36' style='color:red'>spoofed.</span>The email contained an <span class='token pointer' id='tok-80-37' style='color:red'>attachment</span>named Seminar-Invitation.doc, which is a <span class='token pointer' id='tok-80-38' style='color:red'>malicious</span><span class='token pointer' id='tok-80-39' style='color:red'>Microsoft</span>Word document we track as ThreeDollars. Examining this sample of ThreeDollars reveals that it contains a new <span class='token pointer' id='tok-80-40' style='color:red'>payload,</span>which we have named OopsIE. </p><p id=p333>In the January 16, 2018 attack, we observed OilRig attacking an organization it previously targeted in January 2017. In this case, the ThreeDollars delivery document was not used and instead an attempt was made to deliver the OopsIE Trojan directly to the targeted organization, likely via a link within an email. The Trojan was directly <span class='token pointer' id='tok-80-41' style='color:red'>downloaded</span>from the <span class='token pointer' id='tok-80-42' style='color:red'>server</span><span class='token pointer' id='tok-80-43' style='color:red'>command and control</span>OopsIE, signifying that this server was also used for <span class='token pointer' id='tok-80-44' style='color:red'>staging.</span>This suggests that due to the January 2017 attack, the targeted organization may have taken actions to <span class='token pointer' id='tok-80-45' style='color:red'>counter</span>known OilRig <span class='token pointer' id='tok-80-46' style='color:red'>TTPs,</span>in this case delivering malicious <span class='token pointer' id='tok-80-47' style='color:red'>macro documents,</span>the OilRig operators to adopt a different delivery <span class='token pointer' id='tok-80-48' style='color:red'>tactic.</span></p><p id=p444>We also identified another sample of ThreeDollars, created on January 15, 2017 with the <span class='token pointer' id='tok-80-49' style='color:red'>file name</span>preparation.dot. While this sample was very similar to the Seminar-Invitation.doc sample it also had some significant differences. The primary difference was that this sample was <span class='token pointer' id='tok-80-50' style='color:red'>encrypted</span>and <span class='token pointer' id='tok-80-51' style='color:red'>password</span><span class='token pointer' id='tok-80-52' style='color:red'>protected,</span>requiring the victim to enter in a password which was likely provided by the <span class='token pointer' id='tok-80-53' style='color:red'>adversary</span>to view the document. While this is not a new tactic, this is the first instance where we have observed the OilRig using it in their <span class='token pointer' id='tok-80-54' style='color:red'>playbook.</span>Typically, password protected <span class='token pointer' id='tok-80-55' style='color:red'>documents</span>is commonly used by adversaries as an <span class='token pointer' id='tok-80-56' style='color:red'>evasion</span>tactic to <span class='token pointer' id='tok-80-57' style='color:red'>bypass</span><span class='token pointer' id='tok-80-58' style='color:red'>automated analysis</span>due to the password requirement for successful <span class='token pointer' id='tok-80-59' style='color:red'>execution.</span>As we have observed throughout our tracking of the OilRig group, adopting <span class='token pointer' id='tok-80-60' style='color:red'>proven tactics</span>been a common behavior over time. </p><p id=p579>Â  </p><p id=p580>ThreeDollars Document Analysis </p><p id=p583>The samples of ThreeDollars we collected in these attacks are structurally very similar to the first sample we analyzed in October 2017, down to the <span class='token pointer' id='tok-80-61' style='color:red'>lure</span>image used to trick the recipient into <span class='token pointer' id='tok-80-62' style='color:red'>clicking</span>the <span class='token pointer' id='tok-80-63' style='color:red'>Content"</span><span class='token pointer' id='tok-80-64' style='color:red'>button</span><span class='token pointer' id='tok-80-65' style='color:red'>"Enable</span><span class='token pointer' id='tok-80-66' style='color:red'>execute</span>the malicious macro. The images used in the January 2018 attacks were the exact same in each sample, verified by <span class='token pointer' id='tok-80-67' style='color:red'>hash.</span></p><p id=p645><span class='token pointer' id='tok-80-68' style='color:red'>Malicious</span><span class='token pointer' id='tok-80-69' style='color:red'>Macro</span>Analysis </p><p id=p648>When the victim opens the ThreeDollars document they are presented with the lure image and <span class='token pointer' id='tok-80-70' style='color:red'>prompted</span>to <span class='token pointer' id='tok-80-71' style='color:red'>click</span>on the "Enable Content" button. When button is clicked, a malicious macro is silently <span class='token pointer' id='tok-80-72' style='color:red'>run</span>which <span class='token pointer' id='tok-80-73' style='color:red'>installs</span>then <span class='token pointer' id='tok-80-74' style='color:red'>executes</span>a payload on a <span class='token pointer' id='tok-80-75' style='color:red'>system.</span>A <span class='token pointer' id='tok-80-76' style='color:red'>decoy image</span>also displayed to the victim to lower suspicion of <span class='token pointer' id='tok-80-77' style='color:red'>malicious activity.</span><span class='token pointer' id='tok-80-78' style='color:red'>decoy message</span>is eventually presented to the victim does not actually show the expected content of an insurance seminar invitation as presented in the delivery email. Instead, it displays a fake <span class='token pointer' id='tok-80-79' style='color:red'>error message</span><span class='token pointer' id='tok-80-80' style='color:red'>NullRefrencedException!</span>error has occurred in user32.dll by 0x32ef2121 within the <span class='token pointer' id='tok-80-81' style='color:red'>Word</span>document. </p><p id=p753>OopsIE Trojan Analysis </p><p id=p756>The OopsIE Trojan <span class='token pointer' id='tok-80-82' style='color:red'>delivered</span>in these attacks is <span class='token pointer' id='tok-80-83' style='color:red'>packed</span>with SmartAssembly and further <span class='token pointer' id='tok-80-84' style='color:red'>obfuscated</span>with <span class='token pointer' id='tok-80-85' style='color:red'>ConfuserEx</span>v1.0.0. To run <span class='token pointer' id='tok-80-86' style='color:red'>persistently</span>on the system, the Trojan will first create a <span class='token pointer' id='tok-80-87' style='color:red'>VBScript</span>file: </p><p id=p787>SpecialFolder.CommonApplicationData\srvResesponded.vbs </p><p id=p788>that contains: </p><p id=p790>CreateObject("WScript.Shell").Run("%app%") </p><p id=p791>The Trojan replaces the %app% <span class='token pointer' id='tok-80-88' style='color:red'>string</span>in the above VBScript with the <span class='token pointer' id='tok-80-89' style='color:red'>path</span>to its <span class='token pointer' id='tok-80-90' style='color:red'>executable.</span>Finally, the Trojan creates a scheduled <span class='token pointer' id='tok-80-91' style='color:red'>task</span>to run itself every three minutes by running the following <span class='token pointer' id='tok-80-92' style='color:red'>command</span>on the command <span class='token pointer' id='tok-80-93' style='color:red'>prompt</span>after replacing the %path% string with the path to the srvResesponded.vbs VBScript. </p><p id=p841>The Trojan uses <span class='token pointer' id='tok-80-94' style='color:red'>HTTP</span>to communicate with its <span class='token pointer' id='tok-80-95' style='color:red'>C2</span>server, specifically using the <span class='token pointer' id='tok-80-96' style='color:red'>InternetExplorer</span><span class='token pointer' id='tok-80-97' style='color:red'>application</span><span class='token pointer' id='tok-80-98' style='color:red'>object</span>within an <span class='token pointer' id='tok-80-99' style='color:red'>embedded</span><span class='token pointer' id='tok-80-100' style='color:red'>Framework</span><span class='token pointer' id='tok-80-101' style='color:red'>assembly</span><span class='token pointer' id='tok-80-102' style='color:red'>Microsoft .NET</span>Interop.SHDocVw. The Trojan <span class='token pointer' id='tok-80-103' style='color:red'>extracts</span>and <span class='token pointer' id='tok-80-104' style='color:red'>loads</span>this embedded assembly by <span class='token pointer' id='tok-80-105' style='color:red'>concatenating</span>the contents of two <span class='token pointer' id='tok-80-106' style='color:red'>resources</span>named S1 and S2 and <span class='token pointer' id='tok-80-107' style='color:red'>decompresses</span>the resulting <span class='token pointer' id='tok-80-108' style='color:red'>data</span>using the GZipSteam <span class='token pointer' id='tok-80-109' style='color:red'>class.</span>The resulting Interop.SHDocVw .NET assembly is packed with SmartAssembly and further obfuscated using Confuser v1.9.0.0. The <span class='token pointer' id='tok-80-110' style='color:red'>concatenation of</span>to <span class='token pointer' id='tok-80-111' style='color:red'>construct</span>embedded <span class='token pointer' id='tok-80-112' style='color:red'>assemblies</span>is not a new technique for the OilRig group, as they used the very same technique in October 2017 in their <span class='token pointer' id='tok-80-113' style='color:red'>ISMInjector</span><span class='token pointer' id='tok-80-114' style='color:red'>tool</span>to construct its embedded libraries Joiner.dll and Inner.dll. </p><p id=p948>By using the InternetExplorer application object, all C2 related requests will look as if they came from the <span class='token pointer' id='tok-80-115' style='color:red'>legitimate</span><span class='token pointer' id='tok-80-116' style='color:red'>browser</span>and therefore will not contain any anomalous <span class='token pointer' id='tok-80-117' style='color:red'>fields</span>within the request, such as custom <span class='token pointer' id='tok-80-118' style='color:red'>User-Agents.</span>The OopsIE Trojan is <span class='token pointer' id='tok-80-119' style='color:red'>configured</span>to use a C2 server <span class='token pointer' id='tok-80-120' style='color:red'>hosted.</span></p><p id=p994>The Trojan will construct specific <span class='token pointer' id='tok-80-121' style='color:red'>URLs</span>to communicate with the C2 server and <span class='token pointer' id='tok-80-122' style='color:red'>parses</span>the C2 <span class='token pointer' id='tok-80-123' style='color:red'>server's</span>response looking for content within the <span class='token pointer' id='tok-80-124' style='color:red'>tags</span><pre> and </pre>. The initial HTTP request acts as a <span class='token pointer' id='tok-80-125' style='color:red'>beacon,</span>as shown in the image below. </p><p id=p1035>Â  </p><p id=p1036>Conclusion </p><p id=p1037>The OilRig group continues to remain a highly active adversary in the Middle East region. This group has repeatedly shown evidence of a willingness to adapt and evolve their tactics, while also reusing certain aspects as well. We have now observed this adversary deploy a multitude of <span class='token pointer' id='tok-80-126' style='color:red'>tools,</span>with each appearing to be some form of <span class='token pointer' id='tok-80-127' style='color:red'>iterative</span>variation of something used in the past. However, although the tools themselves have <span class='token pointer' id='tok-80-128' style='color:red'>morphed</span>over time, the plays they have <span class='token pointer' id='tok-80-129' style='color:red'>executed</span>in their playbook largely remain the same when <span class='token pointer' id='tok-80-130' style='color:red'>examined</span>over the attack life cycle. We have added this play to the OilRig playbook, which can be viewed <span class='token pointer' id='tok-80-131' style='color:red'>online</span>via our Playbook <span class='token pointer' id='tok-80-132' style='color:red'>Viewer.
</span></p>