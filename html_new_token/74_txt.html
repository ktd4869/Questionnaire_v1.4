<p id=p0>In this article, we will a have a look at <span class='token pointer' id='tok-74-0' style='color:red'>automating</span>certain tasks on windows to <span class='token pointer' id='tok-74-1' style='color:red'>escalate</span>our <span class='token pointer' id='tok-74-2' style='color:red'>privileges</span>and gain <span class='token pointer' id='tok-74-3' style='color:red'>access</span>to the <span class='token pointer' id='tok-74-4' style='color:red'>system.</span></p><p id=p25>Introduction: <span class='token pointer' id='tok-74-5' style='color:red'>Privilege</span><span class='token pointer' id='tok-74-6' style='color:red'>Escalation</span>on any system mainly involves a lot of information gathering about the <span class='token pointer' id='tok-74-7' style='color:red'>host</span><span class='token pointer' id='tok-74-8' style='color:red'>target</span><span class='token pointer' id='tok-74-9' style='color:red'>further</span>includes some of the following set of questions that a <span class='token pointer' id='tok-74-10' style='color:red'>penetration</span><span class='token pointer' id='tok-74-11' style='color:red'>tester</span>needs to cover: </p><p id=p59>What <span class='token pointer' id='tok-74-12' style='color:red'>version</span>of <span class='token pointer' id='tok-74-13' style='color:red'>operating</span>system is being <span class='token pointer' id='tok-74-14' style='color:red'>installed</span>on the <span class='token pointer' id='tok-74-15' style='color:red'>host?Is</span>there any <span class='token pointer' id='tok-74-16' style='color:red'>vulnerable</span><span class='token pointer' id='tok-74-17' style='color:red'>package</span>installed or <span class='token pointer' id='tok-74-18' style='color:red'>running?</span>What type of <span class='token pointer' id='tok-74-19' style='color:red'>services</span>are running on the system and whether they are <span class='token pointer' id='tok-74-20' style='color:red'>configured</span>properly or not from the <span class='token pointer' id='tok-74-21' style='color:red'>security</span>point of view? How the <span class='token pointer' id='tok-74-22' style='color:red'>user</span>roles are being <span class='token pointer' id='tok-74-23' style='color:red'>segregated?How</span>the <span class='token pointer' id='tok-74-24' style='color:red'>permissions</span><span class='token pointer' id='tok-74-25' style='color:red'>file system</span>being assigned to different <span class='token pointer' id='tok-74-26' style='color:red'>user roles?Is</span>is any <span class='token pointer' id='tok-74-27' style='color:red'>configuration/password</span>files stored on the system? Is there any <span class='token pointer' id='tok-74-28' style='color:red'>misconfigured</span><span class='token pointer' id='tok-74-29' style='color:red'>CRON</span>jobs/Scheduled Tasks running on the <span class='token pointer' id='tok-74-30' style='color:red'>system?By</span>answering above and many other questions depending on the situations and availability one can certainly escalate his/her privileges from a <span class='token pointer' id='tok-74-31' style='color:red'>normal user</span><span class='token pointer' id='tok-74-32' style='color:red'>privileged</span><span class='token pointer' id='tok-74-33' style='color:red'>high</span>As we can see, there is a lot of information one needs to gather which directly means there are a lot of manual checks we need to perform to escalate our privileges successfully. So, automating certain tasks will save some time and give an added advantage to any penetration tester. </p><p id=p214>The <span class='token pointer' id='tok-74-34' style='color:red'>test bed/software</span>to test our <span class='token pointer' id='tok-74-35' style='color:red'>tool</span>can be <span class='token pointer' id='tok-74-36' style='color:red'>downloaded</span>from here. Also, the required package for <span class='token pointer' id='tok-74-37' style='color:red'>python</span>can be installed using the following command: </p><p id=p240><span class='token pointer' id='tok-74-38' style='color:red'>pip</span><span class='token pointer' id='tok-74-39' style='color:red'>install</span><span class='token pointer' id='tok-74-40' style='color:red'>wmi</span></p><p id=p243><span class='token pointer' id='tok-74-41' style='color:red'>We</span>will be automating following tasks using <span class='token pointer' id='tok-74-42' style='color:red'>Python</span></p><p id=p253>Unquoted Service <span class='token pointer' id='tok-74-43' style='color:red'>Paths.Misconfigured</span><span class='token pointer' id='tok-74-44' style='color:red'>Permission</span>for Service <span class='token pointer' id='tok-74-45' style='color:red'>Executables.Misconfigured</span><span class='token pointer' id='tok-74-46' style='color:red'>MSI</span><span class='token pointer' id='tok-74-47' style='color:red'>registry</span>entries.Unquoted Service Paths:Before proceeding with understanding the <span class='token pointer' id='tok-74-48' style='color:red'>code</span>use to automate this task, we need to understand how we can <span class='token pointer' id='tok-74-49' style='color:red'>exploit</span><span class='token pointer' id='tok-74-50' style='color:red'>unquoted</span><span class='token pointer' id='tok-74-51' style='color:red'>service</span><span class='token pointer' id='tok-74-52' style='color:red'>path</span><span class='token pointer' id='tok-74-53' style='color:red'>vulnerabilities.</span>This mainly involves how <span class='token pointer' id='tok-74-54' style='color:red'>Windows</span><span class='token pointer' id='tok-74-55' style='color:red'>interpret</span>the <span class='token pointer' id='tok-74-56' style='color:red'>executable</span>path of service before starting it. For example: </p><p id=p303>Let us <span class='token pointer' id='tok-74-57' style='color:red'>execute</span>a test <span class='token pointer' id='tok-74-58' style='color:red'>program/script</span>using command prompt by providing a path to the executable. </p><p id=p319>As we can see that our <span class='token pointer' id='tok-74-59' style='color:red'>helloworld</span><span class='token pointer' id='tok-74-60' style='color:red'>program</span>executes successfully when placed in a folder without space. So, what happen with a folder with space? </p><p id=p344>As can be seen, there is a <span class='token pointer' id='tok-74-61' style='color:red'>helloworld.exe</span>file in the folder with space. So, to execute that we simply change our directory by providing quotes around folder name. Now the question arises how we can exploit this behavior of Windows. </p><p id=p385>As can be seen, in first image window treats the folder name with space as an executable and throws us an error saying "folder is not <span class='token pointer' id='tok-74-62' style='color:red'>recognized</span>as internal or external <span class='token pointer' id='tok-74-63' style='color:red'>command/executable/batch</span>file." So, this means if we put an executable with the name as <span class='token pointer' id='tok-74-64' style='color:red'>folder.exe</span>it should get execute when the user calls the program path without spaces. </p><p id=p444>We first tried to execute our program without space. Further, we copied the same program to desktop folder with name folder.exe and deleted our program from the older path to be sure only planted binary gets executed. </p><p id=p481>Windows <span class='token pointer' id='tok-74-65' style='color:red'>now</span>execute our binary planted with the name of folder.exe. </p><p id=p492>So, we will be automating this process by telling our program to <span class='token pointer' id='tok-74-66' style='color:red'>iterate</span>over the <span class='token pointer' id='tok-74-67' style='color:red'>service paths</span>show us which service paths are unquoted. </p><p id=p517>In our code, we first defined a WMI object, select everything from <span class='token pointer' id='tok-74-68' style='color:red'>Win32_Service</span>class and iterate over it to get all service paths. We further check if the path does not contain any quotes if our condition satisfies we add that path to our dictionary by keeping service name as a key name. </p><p id=p570>We further check if there are any service paths identified and iterate over our dictionary to <span class='token pointer' id='tok-74-69' style='color:red'>display</span>the <span class='token pointer' id='tok-74-70' style='color:red'>values.</span></p><p id=p589>We will be adding the above code <span class='token pointer' id='tok-74-71' style='color:red'>snippets</span>to our final program. </p><p id=p601><span class='token pointer' id='tok-74-72' style='color:red'>Misconfigured</span>Permission for Service ExecutablesThe second part of the program includes checking the permission of <span class='token pointer' id='tok-74-73' style='color:red'>executables.</span><span class='token pointer' id='tok-74-74' style='color:red'>service</span>means if any low privileged user can modify/write/replace the executable with his <span class='token pointer' id='tok-74-75' style='color:red'>code/executable.</span>Next time when the service starts <span class='token pointer' id='tok-74-76' style='color:red'>malicious</span>code will get executed as a system. </p><p id=p646>In this case, we will be using <span class='token pointer' id='tok-74-77' style='color:red'>"icacls"</span><span class='token pointer' id='tok-74-78' style='color:red'>utility</span>of windows to find out permission of all service executables. Moreover, list down the ones in which any user has full access to the executable. </p><p id=p680>As can be seen, we have used the <span class='token pointer' id='tok-74-79' style='color:red'>output</span>of <span class='token pointer' id='tok-74-80' style='color:red'>wmi query</span>our previous section of code and added found executable files in a Python list. </p><p id=p707>We will now feed the executable path to icacls utility to get the permission info of executable and parse the output using the <span class='token pointer' id='tok-74-81' style='color:red'>find_paths</span>function. </p><p id=p732>Ethical Hacking Training – Resources (InfoSec) </p><p id=p738>The find_paths function match the permission info of executable with <span class='token pointer' id='tok-74-82' style='color:red'>predefined</span>values and prints out if any match is found. </p><p id=p758>Misconfigured MSI registry entriesWindows has this <span class='token pointer' id='tok-74-83' style='color:red'>configuration</span>which if set allows any user to run MSI (Microsoft <span class='token pointer' id='tok-74-84' style='color:red'>Installers)</span>with SYSTEM privileges. This involves checking the <span class='token pointer' id='tok-74-85' style='color:red'>true</span>value for a <span class='token pointer' id='tok-74-86' style='color:red'>32-bit</span><span class='token pointer' id='tok-74-87' style='color:red'>dword</span>named "AlwaysInstallElevated". </p><p id=p791>This will be our last addition to the program, in this case, we will be using inbuilt <span class='token pointer' id='tok-74-88' style='color:red'>python's</span>module named <span class='token pointer' id='tok-74-89' style='color:red'>"_winreg"</span>to fetch out the registry entries. </p><p id=p818>We open the registry keys using <span class='token pointer' id='tok-74-90' style='color:red'>OpenKey</span>function and enum the first dword value. We further verify whether both registry keys are set to true. </p><p id=p843>If both registry keys exist and dword values are set, we display the following message to the user. </p><p id=p861>Let's execute our complete script on a vulnerable machine. As can be seen, our script is successfully able to determine the mentioned issues. As our machine is not vulnerable to the third issue, I encourage a diligent reader to manually create those registry entries and execute their own MSI executable using <span class='token pointer' id='tok-74-91' style='color:red'>msiexec</span>utility. </p><p id=p914>Hint: We can generate <span class='token pointer' id='tok-74-92' style='color:red'>msi</span>files using <span class='token pointer' id='tok-74-93' style='color:red'>msfvenom.
</span></p>