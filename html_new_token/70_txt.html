<p id=p0>Often during our <span class='token pointer' id='tok-70-0' style='color:red'>penetration</span>testing engagements, we may have to <span class='token pointer' id='tok-70-1' style='color:red'>applications</span><span class='token pointer' id='tok-70-2' style='color:red'>antivirus</span>especially during the post <span class='token pointer' id='tok-70-3' style='color:red'>exploitation</span>phase to execute certain <span class='token pointer' id='tok-70-4' style='color:red'>files</span>on the target <span class='token pointer' id='tok-70-5' style='color:red'>machines.</span>Sometimes <span class='token pointer' id='tok-70-6' style='color:red'>it</span>is challenging to <span class='token pointer' id='tok-70-7' style='color:red'>bypass</span>certain <span class='token pointer' id='tok-70-8' style='color:red'>antivirus</span>applications, as there is no standard <span class='token pointer' id='tok-70-9' style='color:red'>method/technique</span>available to bypass all the antivirus <span class='token pointer' id='tok-70-10' style='color:red'>software.</span>Thus, we need to try out different methods to bypass them. This article walks the reader through some of the popular <span class='token pointer' id='tok-70-11' style='color:red'>tools</span>available to play with <span class='token pointer' id='tok-70-12' style='color:red'>Antivirus</span>evasion. </p><p id=p78><span class='token pointer' id='tok-70-13' style='color:red'>File Splitters</span><span class='token pointer' id='tok-70-14' style='color:red'>editors</span><span class='token pointer' id='tok-70-15' style='color:red'>Hex</span>first technique that we are going to discuss is using <span class='token pointer' id='tok-70-16' style='color:red'>file splitting</span>to identify the exact signature that is being <span class='token pointer' id='tok-70-17' style='color:red'>detected</span>by the antivirus <span class='token pointer' id='tok-70-18' style='color:red'>application</span>and <span class='token pointer' id='tok-70-19' style='color:red'>modify</span>it. This is one of the oldest ways to bypass AV tools. This technique is efficient if we can locate the exact signature that is being detected. However, there is a limitation with this technique. If we mess the functionality of the application, it becomes useless even if we bypass antivirus. So, as long as the functionality is not modified while we are changing the signatures, we are good to go. </p><p id=p183>This can be achieved by using <span class='token pointer' id='tok-70-20' style='color:red'>tool</span><span class='token pointer' id='tok-70-21' style='color:red'>file-splitting</span><span class='token pointer' id='tok-70-22' style='color:red'>split</span>the <span class='token pointer' id='tok-70-23' style='color:red'>binary</span>into many parts. This <span class='token pointer' id='tok-70-24' style='color:red'>splitting</span>should be done in such a way that each part is larger than the previous one by a fixed amount. Then we need to <span class='token pointer' id='tok-70-25' style='color:red'>run</span>the Antivirus <span class='token pointer' id='tok-70-26' style='color:red'>scan</span>on these parts to identify which part is <span class='token pointer' id='tok-70-27' style='color:red'>flagged</span>first as <span class='token pointer' id='tok-70-28' style='color:red'>malicious.</span>We need to do this process repeatedly until the actual signature is located. Tools such as <span class='token pointer' id='tok-70-29' style='color:red'>"Dsplit"</span>and <span class='token pointer' id='tok-70-30' style='color:red'>"Evade"</span>can be used for file splitting. Once the signature is located, we need to modify it and save the modified binary. </p><p id=p281>Let's have a look at an example of how this really works against Antivirus tools. </p><p id=p296>I <span class='token pointer' id='tok-70-31' style='color:red'>have downloaded</span>from the link given below. This is one of the commonly used tool during post exploitation for dumping <span class='token pointer' id='tok-70-32' style='color:red'>passwords</span>in clear text. </p><p id=p322>When we scan this tool through virustotal.com, it is flagged as malicious by 47 <span class='token pointer' id='tok-70-33' style='color:red'>Antivirus softwares</span>of 56. </p><p id=p341>By using Dsplit, I have noticed that some antivirus software is detecting it as malicious using its welcome text, which is displayed when we run this tool. Therefore, I opened wce.exe in a <span class='token pointer' id='tok-70-34' style='color:red'>hex editor</span>changed this signature from uppercase to lowercase and vice versa. This is shown below. </p><p id=p391>After making the above shown modifications to the binary, I have <span class='token pointer' id='tok-70-35' style='color:red'>scanned</span>through virustotal.com once again and noticed that 42 antivirus <span class='token pointer' id='tok-70-36' style='color:red'>engines</span>out of 56 have flagged it as malicious this time. </p><p id=p423>However, this didn't bypass most of the antivirus applications; it is possible to do that if we can locate the exact signature that is being detected by those AVs. </p><p id=p452>When we use the above-mentioned technique, we should not forget about the functionality of the binary while making changes. </p><p id=p471>As an example, here is the <span class='token pointer' id='tok-70-37' style='color:red'>output</span>of original wce.exe dumping the <span class='token pointer' id='tok-70-38' style='color:red'>password</span>from <span class='token pointer' id='tok-70-39' style='color:red'>memory.</span></p><p id=p486>The functionality remained the same even after making changes to the binary. It is still able to get the password from the memory as shown below. </p><p id=p512><span class='token pointer' id='tok-70-40' style='color:red'>HyperionEncrypting</span>the binary is one of the common ways <span class='token pointer' id='tok-70-41' style='color:red'>to bypass</span><span class='token pointer' id='tok-70-42' style='color:red'>detection.</span>The logic behind using <span class='token pointer' id='tok-70-43' style='color:red'>encrypters</span>is to <span class='token pointer' id='tok-70-44' style='color:red'>obfuscate</span>the binary from antivirus tools by encrypting it. This will be decrypted back when the binary is run. <span class='token pointer' id='tok-70-45' style='color:red'>Kali Linux</span>got an <span class='token pointer' id='tok-70-46' style='color:red'>encrypter</span><span class='token pointer' id='tok-70-47' style='color:red'>open source</span><span class='token pointer' id='tok-70-48' style='color:red'>Hyperion</span>available in it.  </p><p id=p565>I am using the one I have downloaded from the above link. Let us see how we can use this tool. </p><p id=p586>Before we use Hyperion, let's scan the <span class='token pointer' id='tok-70-49' style='color:red'>version</span><span class='token pointer' id='tok-70-50' style='color:red'>32 bit</span>wce.exe <span class='token pointer' id='tok-70-51' style='color:red'>file</span>through virustotal.com first. </p><p id=p602>As we can notice, 44 antivirus applications have flagged this as malicious. </p><p id=p614>Let's <span class='token pointer' id='tok-70-52' style='color:red'>encrypt</span>this file with Hyperion as shown below. </p><p id=p623>Let's scan this newly generated file once again and see the detection ratio. </p><p id=p636>As we can see in the figure above, this has got lesser detection compared to the unencrypted binary. </p><p id=p654><span class='token pointer' id='tok-70-53' style='color:red'>Veil-EvasionVeil-Evasion</span>is another popular <span class='token pointer' id='tok-70-54' style='color:red'>framework</span>written in <span class='token pointer' id='tok-70-55' style='color:red'>python.</span>We can use this framework to generate <span class='token pointer' id='tok-70-56' style='color:red'>payloads</span>that can <span class='token pointer' id='tok-70-57' style='color:red'>evade</span>majority of AVs. </p><p id=p676>First <span class='token pointer' id='tok-70-58' style='color:red'>download</span>and <span class='token pointer' id='tok-70-59' style='color:red'>install</span><span class='token pointer' id='tok-70-60' style='color:red'>Veil-Evasion</span>and run it using the following <span class='token pointer' id='tok-70-61' style='color:red'>command</span></p><p id=p688><span class='token pointer' id='tok-70-62' style='color:red'>"veil-evasion"</span></p><p id=p689>As we can see, 46 payloads have been loaded. To use a specific payload, we can type "use" command. </p><p id=p708>I am going to choose option 31 to create the <span class='token pointer' id='tok-70-63' style='color:red'>executable</span>payload <span class='token pointer' id='tok-70-64' style='color:red'>python/meterpreter/rev_tcp.</span>Infact, it creates a python <span class='token pointer' id='tok-70-65' style='color:red'>script,</span>which in turn will be converted into an executable using tools like <span class='token pointer' id='tok-70-66' style='color:red'>pyinstaller.</span></p><p id=p740>In the above figure, we have set the <span class='token pointer' id='tok-70-67' style='color:red'>LHOST</span>to 192.168.56.101 and typed "generate" command to generate the payload. </p><p id=p759>Next, it will ask us to enter a name for the payload. I named it "backdoor". As mentioned earlier, <span class='token pointer' id='tok-70-68' style='color:red'>Veil</span><span class='token pointer' id='tok-70-69' style='color:red'>converts</span>python files to exe. It asks us to choose which tool we want to use for this process. Personally, I like <span class='token pointer' id='tok-70-70' style='color:red'>Pyinstaller</span>and I am going for it with option 1. These two steps are shown below. </p><p id=p817>Once done, it will create our final payload and gives us the location of it as shown below. </p><p id=p835>As we can see in the figure above, the authors of this framework are suggesting not to submit these samples <span class='token pointer' id='tok-70-71' style='color:red'>online.</span>Therefore, I have checked this payload in <span class='token pointer' id='tok-70-72' style='color:red'>sandboxed</span>environment with <span class='token pointer' id='tok-70-73' style='color:red'>Avast Antivirus</span>it is not detected. </p><p id=p873><span class='token pointer' id='tok-70-74' style='color:red'>Ethical Hacking Training</span>Resources <span class='token pointer' id='tok-70-75' style='color:red'>(InfoSec)</span></p><p id=p879>These payloads also work fine when they are executed on Victim's machines. </p><p id=p891>Following figure shows a meterpreter shell obtained using the payload created above. </p><p id=p903>Try with other payloads that use <span class='token pointer' id='tok-70-76' style='color:red'>encryption</span>to get better output. </p><p id=p914>This script <span class='token pointer' id='tok-70-77' style='color:red'>automates</span>multiple tricks to evade AVs. The author has written this for his own purposes and he released it publicly as a <span class='token pointer' id='tok-70-78' style='color:red'>beta</span>version. This script gives us an idea of how we can write our own <span class='token pointer' id='tok-70-79' style='color:red'>scripts</span>to evade <span class='token pointer' id='tok-70-80' style='color:red'>Antiviruses.</span></p><p id=p957>Let's see this in action. </p><p id=p962>I am going to create a meterpreter payload using msfvenom for this purpose. This is shown below. </p><p id=p979>Let us scan the payload "test.exe" through virustotal.com as shown below. </p><p id=p990>36 out of 56 antivirus engines have flagged this as malicious. </p><p id=p1001>Now, lets run this using peCloak.py script. </p><p id=p1008>I am using the script with the <span class='token pointer' id='tok-70-81' style='color:red'>default</span>options. </p><p id=p1017>It creates a file called "cloaked.exe". </p><p id=p1023>Let's scan this new payload and see how many antivirus engines <span class='token pointer' id='tok-70-82' style='color:red'>detect</span>is as malicious. </p><p id=p1038>Only 26 out of 56 have flagged it as malicious. </p><p id=p1048>Conclusion: Apart from the tools mentioned in this article, there are a couple of other tools out there such as Metasploit's <span class='token pointer' id='tok-70-83' style='color:red'>encoders.</span>It is better to write custom payloads and keep them simple to be away from Antivirus detection rather than creating payloads using popular <span class='token pointer' id='tok-70-84' style='color:red'>frameworks.</span>A side note: The results shown in this article may change when you read this article as Antivirus     </p>