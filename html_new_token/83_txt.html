<p id=p0>7zip is an awesome tool and <span class='token pointer' id='tok-83-0' style='color:red'>recently</span>its new version (15.06 beta) has been released. While most of us typically use it as a handy (and free) replacement for both free and <span class='token pointer' id='tok-83-1' style='color:red'>commercial</span><span class='token pointer' id='tok-83-2' style='color:red'>zip and rar compressors</span>has a lot more to offer to file <span class='token pointer' id='tok-83-3' style='color:red'>carvers and reversers.</span>this post I will demo a few things you can do with 7z that you might have never heard of. </p><p id=p70>If you are curious about the title, it's a reference to an old school song by <span class='token pointer' id='tok-83-4' style='color:red'>OMD.</span></p><p id=p87><span class='token pointer' id='tok-83-5' style='color:red'>files7Zip</span><span class='token pointer' id='tok-83-6' style='color:red'>PE</span><span class='token pointer' id='tok-83-7' style='color:red'>PE files</span><span class='token pointer' id='tok-83-8' style='color:red'>containers</span>and allows us to extract parts of it, including: </p><p id=p103>sections.tlscertificatesappended datathat is, if you want to extract a certificate (signature) from the PE file you just need to run: </p><p id=p123><span class='token pointer' id='tok-83-9' style='color:red'>7z x <filename> CERTIFICATEWhen</span>extract certificate this way, you still need to strip first 8 bytes before it can be parsed to produce meaningful <span class='token pointer' id='tok-83-10' style='color:red'>ASN output, but</span>still very handy f.ex. for extracting strings from it. </p><p id=p161>If you want to extract appended data, you need to type: </p><p id=p172>7z x <filename>Â  [0] Another handy option is 'l' which is listing objects that 7z finds inside a given container. </p><p id=p192>When used on the PE file, it gives not only a list of whats inside (sections, etc.), but also produces some info about PE file characteristics f.ex.: </p><p id=p219>Is it a <span class='token pointer' id='tok-83-11' style='color:red'>32- or 64- bit executableIs</span>CLI or <span class='token pointer' id='tok-83-12' style='color:red'>alignmentsCode,</span><span class='token pointer' id='tok-83-13' style='color:red'>GUI executableSection and File</span>sizeLinker versionOS version required to run the programVersion infoetc.This may come handy if you don't have access to some tools and 7z is available (typical IR function in large companies :). </p><p id=p267>The below is what it shows for notepad.exe (from Windows 7): </p><p id=p278>There is also an option '-slt' that can be added to the 'l' command which will give more information about each object listed with 'l'. </p><p id=p303><span class='token pointer' id='tok-83-14' style='color:red'>Nullsoft</span>InstallersOne of the most interesting functions of 7z is ability to unpack Nullsoft installers. This functionality was present in older versions of 7zip, then if <span class='token pointer' id='tok-83-15' style='color:red'>memory</span>serves me right was removed for quite some time. Now it seems to be back (although extraction of the script doesn't seem to be possible as it was in older versions). </p><p id=p361>Running: </p><p id=p362><span class='token pointer' id='tok-83-16' style='color:red'>7z l Wireshark-win32-1.12.7.exe(on</span>version of 32-bit Nullsoft installer for Wireshark) </p><p id=p373>can give us a nice list of files inside the installer. </p><p id=p384>Running </p><p id=p385>7z x <span class='token pointer' id='tok-83-17' style='color:red'>Wireshark-win32-1.12.7.exeextracts</span>all the files, including Nullsoft plug-ins. </p><p id=p394>This is actually very useful. Let's remember that some installers for malware include not only the payload, but also <span class='token pointer' id='tok-83-18' style='color:red'>malicious plug-ins.</span>can't be found on the file system after the installation as they are extracted to TEMP folder, loaded and immediately deleted after they are no longer needed. If you do manual analysis you need to 'catch' them before they are deleted; with 7z you can extract them directly from the installer and can do analysis. </p><p id=p471>Calculating hashesAnother handy feature of 7z is ability to calculate hashes of files. Again, may come useful in an environment where you can't use other tools. </p><p id=p497>To calculate hashes of the file you need to run the following command: </p><p id=p510>7z h -scrc* <filename> </p><p id=p514>The switch's name is a bit misleading (suggesting CRC), but it basically tells 7z to calculate a <span class='token pointer' id='tok-83-19' style='color:red'>hash, or a checksum.</span>default is CRC32, but the following are available: </p><p id=p544>CRC32SHA1SHA256CRC64BLAKE2spIf you use an asterisk, all of them will be included: </p><p id=p555>Why Md5 is not on the list is a mystery to me. </p><p id=p567>The list of all hash types, as well as file formats and codecs in your version of 7z can be listed using the '7z i' command. </p><p id=p593>Access to raw physical drive and volumesI left this one to the end, as it is pretty cool, but has one caveat. </p><p id=p615>According to the documentation <span class='token pointer' id='tok-83-20' style='color:red'>7Zip Manager</span>to view (and potentially even parse) raw volumes. </p><p id=p630>To access this functionality one needs to open 7Zip Manager as an admin and access the \\.Â  folder. </p><p id=p648>where you should see a list of drives + physical devices: </p><p id=p659>Unfortunately, it doesn't work for C: and you will always receive the following message: </p><p id=p673>If this gets fixed at source it may become a handy raw file extractor. </p><p id=p687>Still, it's pretty cool. </p><p id=p691>Why? </p><p id=p692>Couple of reasons. </p><p id=p695>Reason #1Because it works for other drives which are not in use.Reason #2Because command line tool (7z) also supports it.Reason #3Because I will show you how to make it work with C: ðŸ™‚So, what can we do with it? </p><p id=p734>Let's start with a demo for a drive NOT in use. </p><p id=p745>We can f.ex. list the files on the drive by using the following command </p><p id=p759>7z l \\.\k:This will give us a list of all files on that drive extracted directly from <span class='token pointer' id='tok-83-21' style='color:red'>$MFT:</span></p><p id=p777>Using the file naming convention shown on the screenshot, we can extract the $MFT file using the following command: </p><p id=p796>7z x \\.\k: [SYSTEM]\$MFTPretty useful, isn't? </p><p id=p802>Now, how to make it work for C:? </p><p id=p810>Since it works for other volumes it should for C: a well (principles for all <span class='token pointer' id='tok-83-22' style='color:red'>live $MFT parsers</span>similar). After quick analysis I discovered that the author(s) of 7zip made a mistake in the way they open the volume. They call <span class='token pointer' id='tok-83-23' style='color:red'>CreateFile</span>with the parameters that prevent other applications from accessing the volume for writing and this obviously causes a problem for C: drive which is constantly in use. </p><p id=p880>The parameter in question is <span class='token pointer' id='tok-83-24' style='color:red'>dwShareMode of</span>CreateFile function. In order to open a volume one has to specify both FILE_SHARE_READ and FILE_SHARE_WRITE, basically allowing other processes/system components to access the device. Authors(s) of 7z only use FILE_SHARE_READ. </p><p id=p919>Knowing what's wrong we can fix it. You can either recompile 7z, or just do a quick </p><p id=p938>I will show you the binary patch as it's really quick. </p><p id=p949>FILE_SHARE_READ is equal to 1 and FILE_SHARE_WRITE is equal to 2, so the proper argument for CreateFile needs to be a sum of them:Â FILE_SHARE_READ + FILE_SHARE_WRITE = 3. </p><p id=p977>To locate where the change the binary, the easiest is to make a <span class='token pointer' id='tok-83-25' style='color:red'>breakpoint</span>on CreateFileW in ollydbg, then wait for it to hit on \\.\c:, and then step down to the procedure which actually sets the parameters for the function. </p><p id=p1018>Then you can also go back to IDA Pro to see the actual code of the function which is shown below: </p><p id=p1039>Patching </p><p id=p1040>orÂ al, 1 ;  FILE_SHARE_READlocated at 00406839 to </p><p id=p1048>orÂ al, 3 ;  FILE_SHARE_READ + FILE_SHARE_WRITEallows us to make it work for drive C: as seen on the below screenshot (taken from Windows XP): </p><p id=p1073>You can follow the same process for 64-bit binary.
 </p>