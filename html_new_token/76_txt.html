<p id=p0><span class='token pointer' id='tok-76-0'>The</span><span class='token pointer' id='tok-76-1'>document</span><span class='token pointer' id='tok-76-2'>below</span><span class='token pointer' id='tok-76-3'>is</span><span class='token pointer' id='tok-76-4'>an</span><span class='token pointer' id='tok-76-5'>initial</span><span class='token pointer' id='tok-76-6'>level</span><span class='token pointer' id='tok-76-7'>analysis</span><span class='token pointer' id='tok-76-8'>of</span><span class='token pointer' id='tok-76-9'>the</span><span class='token pointer' id='tok-76-10'>recent</span><span class='token pointer' id='tok-76-12' style='color:red'>Ransomware</span><span class='token pointer' id='tok-76-13' style='color:red'>Petya</span><span class='token pointer' id='tok-76-14'>We</span><span class='token pointer' id='tok-76-15'>will</span><span class='token pointer' id='tok-76-16'>also</span><span class='token pointer' id='tok-76-17'>discuss</span><span class='token pointer' id='tok-76-18'>an</span><span class='token pointer' id='tok-76-19'>analysis</span><span class='token pointer' id='tok-76-20'>of</span><span class='token pointer' id='tok-76-21'>a</span><span class='token pointer' id='tok-76-23' style='color:red'>dll variant</span><span class='token pointer' id='tok-76-24'>the</span><span class='token pointer' id='tok-76-25'>ransomware.</span></p><p id=p26><span class='token pointer' id='tok-76-26' style='color:red'>Ransomware</span><span class='token pointer' id='tok-76-27'>Objective:</span><span class='token pointer' id='tok-76-28'>Encrypt</span><span class='token pointer' id='tok-76-30' style='color:red'>the target machine and</span><span class='token pointer' id='tok-76-32' style='color:red'>for ransom</span><span class='token pointer' id='tok-76-33'>Bitcoins)</span><span class='token pointer' id='tok-76-34'>to</span><span class='token pointer' id='tok-76-35'>decrypt</span><span class='token pointer' id='tok-76-36'>it.</span></p><p id=p37><span class='token pointer' id='tok-76-37'>Analysis</span><span class='token pointer' id='tok-76-38' style='color:red'>Objective:</span><span class='token pointer' id='tok-76-39'>First,</span><span class='token pointer' id='tok-76-40' style='color:red'>this</span><span class='token pointer' id='tok-76-41'>document</span><span class='token pointer' id='tok-76-42'>does</span><span class='token pointer' id='tok-76-43'>not</span><span class='token pointer' id='tok-76-44'>contain</span><span class='token pointer' id='tok-76-45'>all</span><span class='token pointer' id='tok-76-46'>of</span><span class='token pointer' id='tok-76-47'>the</span><span class='token pointer' id='tok-76-48'>indicators</span><span class='token pointer' id='tok-76-49'>but</span><span class='token pointer' id='tok-76-50'>will</span><span class='token pointer' id='tok-76-51'>explain</span><span class='token pointer' id='tok-76-52'>the</span><span class='token pointer' id='tok-76-53'>specimen</span><span class='token pointer' id='tok-76-54'>process.</span><span class='token pointer' id='tok-76-55'>The</span><span class='token pointer' id='tok-76-56'>analysis</span><span class='token pointer' id='tok-76-57'>objective</span><span class='token pointer' id='tok-76-59' style='color:red'>is to</span><span class='token pointer' id='tok-76-60'>some</span><span class='token pointer' id='tok-76-61'>code</span><span class='token pointer' id='tok-76-62'>analysis</span><span class='token pointer' id='tok-76-63'>in</span><span class='token pointer' id='tok-76-64'>a</span><span class='token pointer' id='tok-76-65'>dissembler</span><span class='token pointer' id='tok-76-66'>and</span><span class='token pointer' id='tok-76-68' style='color:red'>then perform a dynamic analysis</span><span class='token pointer' id='tok-76-69'>well</span><span class='token pointer' id='tok-76-70'>to</span><span class='token pointer' id='tok-76-71' style='color:red'>see</span><span class='token pointer' id='tok-76-72'>artifacts</span><span class='token pointer' id='tok-76-73'>while</span><span class='token pointer' id='tok-76-74'>the</span><span class='token pointer' id='tok-76-75'>malware</span><span class='token pointer' id='tok-76-77' style='color:red'>is in</span></p><p id=p78><span class='token pointer' id='tok-76-78'>Certificate</span><span class='token pointer' id='tok-76-79'>InformationThe</span><span class='token pointer' id='tok-76-80'>Petya</span><span class='token pointer' id='tok-76-81'>variant</span><span class='token pointer' id='tok-76-82' style='color:red'>is</span><span class='token pointer' id='tok-76-83'>using</span><span class='token pointer' id='tok-76-84'>an</span><span class='token pointer' id='tok-76-85' style='color:red'>expired</span><span class='token pointer' id='tok-76-86'>Microsoft</span><span class='token pointer' id='tok-76-87'>Certificate.</span></p><p id=p88><span class='token pointer' id='tok-76-88'>Since</span><span class='token pointer' id='tok-76-89' style='color:red'>the</span><span class='token pointer' id='tok-76-90'>objective</span><span class='token pointer' id='tok-76-92' style='color:red'>of this</span><span class='token pointer' id='tok-76-93'>is</span><span class='token pointer' id='tok-76-94'>to</span><span class='token pointer' id='tok-76-95'>encrypt</span><span class='token pointer' id='tok-76-96'>the</span><span class='token pointer' id='tok-76-98' style='color:red'>target machine,</span><span class='token pointer' id='tok-76-99'>prefer</span><span class='token pointer' id='tok-76-100'>to</span><span class='token pointer' id='tok-76-101'>do</span><span class='token pointer' id='tok-76-102'>some</span><span class='token pointer' id='tok-76-103'>static</span><span class='token pointer' id='tok-76-104'>analysis</span><span class='token pointer' id='tok-76-105'>(i.e.</span><span class='token pointer' id='tok-76-106'>to</span><span class='token pointer' id='tok-76-108' style='color:red'>analyze malware without running</span><span class='token pointer' id='tok-76-109'>in</span><span class='token pointer' id='tok-76-110'>IDA</span><span class='token pointer' id='tok-76-111'>Pro</span><span class='token pointer' id='tok-76-112'>and</span><span class='token pointer' id='tok-76-113'>check</span><span class='token pointer' id='tok-76-114'>whether</span><span class='token pointer' id='tok-76-115'>we</span><span class='token pointer' id='tok-76-117' style='color:red'>can see</span><span class='token pointer' id='tok-76-118'>interesting</span><span class='token pointer' id='tok-76-119'>functions.</span></p><p id=p120><span class='token pointer' id='tok-76-120'>Static</span><span class='token pointer' id='tok-76-121'>AnalysisDll</span><span class='token pointer' id='tok-76-122'>is</span><span class='token pointer' id='tok-76-123'>loaded</span><span class='token pointer' id='tok-76-124'>into</span><span class='token pointer' id='tok-76-125'>IDA</span><span class='token pointer' id='tok-76-127' style='color:red'>pro, and</span><span class='token pointer' id='tok-76-128'>expected</span><span class='token pointer' id='tok-76-129'>it</span><span class='token pointer' id='tok-76-130'>stops</span><span class='token pointer' id='tok-76-131'>at</span><span class='token pointer' id='tok-76-132'>dll</span><span class='token pointer' id='tok-76-133'>Entry</span><span class='token pointer' id='tok-76-134'>Point(main()</span><span class='token pointer' id='tok-76-135' style='color:red'>for</span><span class='token pointer' id='tok-76-136'>dll).</span></p><p id=p137><span class='token pointer' id='tok-76-137'>The</span><span class='token pointer' id='tok-76-138'>specimen</span><span class='token pointer' id='tok-76-139'>is</span><span class='token pointer' id='tok-76-140'>using</span><span class='token pointer' id='tok-76-141'>the</span><span class='token pointer' id='tok-76-143' style='color:red'>function below,</span><span class='token pointer' id='tok-76-144'>CreateToolhelp32snapshot</span><span class='token pointer' id='tok-76-145'>followed</span><span class='token pointer' id='tok-76-146'>by</span><span class='token pointer' id='tok-76-147'>Process32First</span><span class='token pointer' id='tok-76-148'>and</span><span class='token pointer' id='tok-76-149'>Process</span><span class='token pointer' id='tok-76-152' style='color:red'>Next. This</span><span class='token pointer' id='tok-76-153'>the</span><span class='token pointer' id='tok-76-154'>specimen</span><span class='token pointer' id='tok-76-155'>is</span><span class='token pointer' id='tok-76-156'>enumerating</span><span class='token pointer' id='tok-76-157'>the</span><span class='token pointer' id='tok-76-158'>victim</span><span class='token pointer' id='tok-76-159'>machine</span><span class='token pointer' id='tok-76-160'>for</span><span class='token pointer' id='tok-76-161'>running</span><span class='token pointer' id='tok-76-162'>processes.</span></p><p id=p163><span class='token pointer' id='tok-76-163' style='color:red'>The</span><span class='token pointer' id='tok-76-164'>authors</span><span class='token pointer' id='tok-76-165'>have</span><span class='token pointer' id='tok-76-166' style='color:red'>XOR'ed</span><span class='token pointer' id='tok-76-167'>the</span><span class='token pointer' id='tok-76-169' style='color:red'>Process Names</span><span class='token pointer' id='tok-76-170'>are</span><span class='token pointer' id='tok-76-171'>reviewing.</span><span class='token pointer' id='tok-76-172'>After</span><span class='token pointer' id='tok-76-173'>a</span><span class='token pointer' id='tok-76-174'>bit</span><span class='token pointer' id='tok-76-175'>of</span><span class='token pointer' id='tok-76-177' style='color:red'>deobfuscation, it turned out</span><span class='token pointer' id='tok-76-179' style='color:red'>they are</span><span class='token pointer' id='tok-76-180'>for</span><span class='token pointer' id='tok-76-182' style='color:red'>the following</span><span class='token pointer' id='tok-76-183'>Norton</span><span class='token pointer' id='tok-76-184'>Security,</span><span class='token pointer' id='tok-76-185'>Symantec.</span><span class='token pointer' id='tok-76-187' style='color:red'>Based on SeDebugPrivilege permissions,</span><span class='token pointer' id='tok-76-189' style='color:red'>malware will</span><span class='token pointer' id='tok-76-190'>three</span><span class='token pointer' id='tok-76-191'>APIs</span><span class='token pointer' id='tok-76-192'>to</span><span class='token pointer' id='tok-76-193'>encrypt</span><span class='token pointer' id='tok-76-194'>the</span><span class='token pointer' id='tok-76-195'>files</span><span class='token pointer' id='tok-76-196'>using</span><span class='token pointer' id='tok-76-197' style='color:red'>AES</span><span class='token pointer' id='tok-76-198'>encryption</span><span class='token pointer' id='tok-76-199'>in</span><span class='token pointer' id='tok-76-200'>memory.</span><span class='token pointer' id='tok-76-201'>FindFileMapViewOfFileFLushViewOfFileAfter</span><span class='token pointer' id='tok-76-202'>that</span><span class='token pointer' id='tok-76-203'>specimen,</span><span class='token pointer' id='tok-76-204'>it</span><span class='token pointer' id='tok-76-205'>deletes</span><span class='token pointer' id='tok-76-206'>its</span><span class='token pointer' id='tok-76-207'>activities</span><span class='token pointer' id='tok-76-210' style='color:red'>deleting Setup,</span><span class='token pointer' id='tok-76-211' style='color:red'>Security</span><span class='token pointer' id='tok-76-212'>and</span><span class='token pointer' id='tok-76-213'>Application</span><span class='token pointer' id='tok-76-215' style='color:red'>Event Logs</span><span class='token pointer' id='tok-76-216'>weutil.</span><span class='token pointer' id='tok-76-217'>It</span><span class='token pointer' id='tok-76-218'>also</span><span class='token pointer' id='tok-76-219'>used</span><span class='token pointer' id='tok-76-220'>fsutil</span><span class='token pointer' id='tok-76-221' style='color:red'>to</span><span class='token pointer' id='tok-76-222'>delete</span><span class='token pointer' id='tok-76-223'>the</span><span class='token pointer' id='tok-76-224'>USN</span><span class='token pointer' id='tok-76-225'>change</span><span class='token pointer' id='tok-76-228' style='color:red'>remove traces</span><span class='token pointer' id='tok-76-229'>any</span><span class='token pointer' id='tok-76-230' style='color:red'>update</span><span class='token pointer' id='tok-76-231' style='color:red'>to</span><span class='token pointer' id='tok-76-232'>volume.)Notice</span><span class='token pointer' id='tok-76-233'>wevutil</span><span class='token pointer' id='tok-76-234'>cl</span><span class='token pointer' id='tok-76-236' style='color:red'>and fsutil /D</span><span class='token pointer' id='tok-76-237'>below</span></p><p id=p238><span class='token pointer' id='tok-76-238'>For</span><span class='token pointer' id='tok-76-239'>lateral</span><span class='token pointer' id='tok-76-240' style='color:red'>movement,</span><span class='token pointer' id='tok-76-241' style='color:red'>Petya</span><span class='token pointer' id='tok-76-242' style='color:red'>does</span><span class='token pointer' id='tok-76-243'>the</span><span class='token pointer' id='tok-76-245' style='color:red'>following:It tries to</span><span class='token pointer' id='tok-76-246'>a</span><span class='token pointer' id='tok-76-247'>connection</span><span class='token pointer' id='tok-76-248' style='color:red'>to</span><span class='token pointer' id='tok-76-249'>admin$</span><span class='token pointer' id='tok-76-250'>with</span><span class='token pointer' id='tok-76-251'>a</span><span class='token pointer' id='tok-76-252' style='color:red'>call</span><span class='token pointer' id='tok-76-253'>to</span><span class='token pointer' id='tok-76-254'>WNetAddConnection</span><span class='token pointer' id='tok-76-255'>with</span><span class='token pointer' id='tok-76-257' style='color:red'>a null username</span><span class='token pointer' id='tok-76-258'>password,</span><span class='token pointer' id='tok-76-259'>which</span><span class='token pointer' id='tok-76-260'>means</span><span class='token pointer' id='tok-76-261'>that</span><span class='token pointer' id='tok-76-262'>specimen</span><span class='token pointer' id='tok-76-263'>is</span><span class='token pointer' id='tok-76-264'>using</span><span class='token pointer' id='tok-76-265'>current</span><span class='token pointer' id='tok-76-266' style='color:red'>user</span><span class='token pointer' id='tok-76-267'>credentials</span><span class='token pointer' id='tok-76-268'>which</span><span class='token pointer' id='tok-76-269'>will</span><span class='token pointer' id='tok-76-270'>exploit</span><span class='token pointer' id='tok-76-271'>shared</span><span class='token pointer' id='tok-76-272'>local</span><span class='token pointer' id='tok-76-273'>administrator</span></p><p id=p275><span class='token pointer' id='tok-76-275'>After</span><span class='token pointer' id='tok-76-276' style='color:red'>the</span><span class='token pointer' id='tok-76-277'>connection</span><span class='token pointer' id='tok-76-278'>is</span><span class='token pointer' id='tok-76-279'>made,</span><span class='token pointer' id='tok-76-280'>the</span><span class='token pointer' id='tok-76-281'>malware</span><span class='token pointer' id='tok-76-283' style='color:red'>will create a copy of</span><span class='token pointer' id='tok-76-284'>using</span><span class='token pointer' id='tok-76-285'>CreateFile()</span><span class='token pointer' id='tok-76-286' style='color:red'>and</span><span class='token pointer' id='tok-76-287'>WriteFile()Then</span><span class='token pointer' id='tok-76-288'>the</span><span class='token pointer' id='tok-76-289'>newly</span><span class='token pointer' id='tok-76-290'>created</span><span class='token pointer' id='tok-76-291' style='color:red'>file</span><span class='token pointer' id='tok-76-292'>is</span><span class='token pointer' id='tok-76-293'>executed</span><span class='token pointer' id='tok-76-295' style='color:red'>using an embedded utility</span><span class='token pointer' id='tok-76-296'>the</span><span class='token pointer' id='tok-76-297'>specimen</span><span class='token pointer' id='tok-76-298'>extracts</span><span class='token pointer' id='tok-76-299'>as</span><span class='token pointer' id='tok-76-300'>dllhost.dat</span><span class='token pointer' id='tok-76-301'>(C:\Windows)</span><span class='token pointer' id='tok-76-302'>on</span><span class='token pointer' id='tok-76-303'>the</span><span class='token pointer' id='tok-76-304'>target</span><span class='token pointer' id='tok-76-306' style='color:red'>system. This</span><span class='token pointer' id='tok-76-307'>file</span><span class='token pointer' id='tok-76-308'>uses</span><span class='token pointer' id='tok-76-310' style='color:red'>%s -acceptula -s, which is</span><span class='token pointer' id='tok-76-311'>silent</span><span class='token pointer' id='tok-76-313' style='color:red'>option for</span><span class='token pointer' id='tok-76-314'>Submitting</span><span class='token pointer' id='tok-76-315'>dllhost.dat</span><span class='token pointer' id='tok-76-316'>files</span><span class='token pointer' id='tok-76-317'>to</span><span class='token pointer' id='tok-76-318'>VirtuTotal</span><span class='token pointer' id='tok-76-319'>reveals</span><span class='token pointer' id='tok-76-320'>it</span><span class='token pointer' id='tok-76-321'>as</span><span class='token pointer' id='tok-76-322'>PSEXEC.If</span><span class='token pointer' id='tok-76-323'>above</span><span class='token pointer' id='tok-76-324'>approach</span><span class='token pointer' id='tok-76-325'>fails,</span><span class='token pointer' id='tok-76-326'>then</span><span class='token pointer' id='tok-76-327'>the</span><span class='token pointer' id='tok-76-329' style='color:red'>malware will try</span><span class='token pointer' id='tok-76-330' style='color:red'>execute</span><span class='token pointer' id='tok-76-331'>the</span><span class='token pointer' id='tok-76-332'>dllhost.dat</span><span class='token pointer' id='tok-76-333'>file</span><span class='token pointer' id='tok-76-334'>using</span><span class='token pointer' id='tok-76-335'>WMIC.exe.</span></p><p id=p336><span class='token pointer' id='tok-76-336'>The</span><span class='token pointer' id='tok-76-337'>specimen</span><span class='token pointer' id='tok-76-338'>also</span><span class='token pointer' id='tok-76-340' style='color:red'>uses DHcpEnumSubnets,</span><span class='token pointer' id='tok-76-341'>DHCPSubnetCLients</span><span class='token pointer' id='tok-76-342'>to</span><span class='token pointer' id='tok-76-343'>enumerate</span><span class='token pointer' id='tok-76-344'>all</span><span class='token pointer' id='tok-76-345'>the</span><span class='token pointer' id='tok-76-347' style='color:red'>in</span><span class='token pointer' id='tok-76-348' style='color:red'>clients</span><span class='token pointer' id='tok-76-349'>domain.</span></p><p id=p350><span class='token pointer' id='tok-76-350'>If</span><span class='token pointer' id='tok-76-351'>the</span><span class='token pointer' id='tok-76-352'>specimen</span><span class='token pointer' id='tok-76-354' style='color:red'>gets SEDebugPrivilege, then</span><span class='token pointer' id='tok-76-355'>specimen</span><span class='token pointer' id='tok-76-357' style='color:red'>also</span><span class='token pointer' id='tok-76-358' style='color:red'>will</span><span class='token pointer' id='tok-76-359'>the</span><span class='token pointer' id='tok-76-360'>physical</span><span class='token pointer' id='tok-76-362' style='color:red'>device. The specimen collects all</span><span class='token pointer' id='tok-76-363'>files</span><span class='token pointer' id='tok-76-364'>as</span><span class='token pointer' id='tok-76-365' style='color:red'>listed</span></p><p id=p367><span class='token pointer' id='tok-76-367'>Below</span><span class='token pointer' id='tok-76-368'>is</span><span class='token pointer' id='tok-76-369'>some</span><span class='token pointer' id='tok-76-370' style='color:red'>of</span><span class='token pointer' id='tok-76-371'>the</span><span class='token pointer' id='tok-76-372'>text</span><span class='token pointer' id='tok-76-373'>of</span><span class='token pointer' id='tok-76-374' style='color:red'>Petya</span><span class='token pointer' id='tok-76-375'>banner</span><span class='token pointer' id='tok-76-376'>that</span><span class='token pointer' id='tok-76-377'>we</span><span class='token pointer' id='tok-76-378'>will</span><span class='token pointer' id='tok-76-379'>see</span><span class='token pointer' id='tok-76-380'>once</span><span class='token pointer' id='tok-76-381'>the</span><span class='token pointer' id='tok-76-382'>target</span><span class='token pointer' id='tok-76-383'>system</span><span class='token pointer' id='tok-76-384'>is</span><span class='token pointer' id='tok-76-385'>encrypted</span></p><p id=p386><span class='token pointer' id='tok-76-386'>Below</span><span class='token pointer' id='tok-76-387'>is</span><span class='token pointer' id='tok-76-388'>the</span><span class='token pointer' id='tok-76-389' style='color:red'>Fake</span><span class='token pointer' id='tok-76-390'>CHKDSK</span><span class='token pointer' id='tok-76-391'>message.</span></p><p id=p392><span class='token pointer' id='tok-76-392'>Ethical</span><span class='token pointer' id='tok-76-393'>Hacking</span><span class='token pointer' id='tok-76-395' style='color:red'>â€“</span><span class='token pointer' id='tok-76-396' style='color:red'>Resources</span><span class='token pointer' id='tok-76-397' style='color:red'>Training</span></p><p id=p398><span class='token pointer' id='tok-76-399' style='color:red'>Dynamic AnalysisSince this is</span><span class='token pointer' id='tok-76-400'>dll,</span><span class='token pointer' id='tok-76-401'>it</span><span class='token pointer' id='tok-76-402'>needs</span><span class='token pointer' id='tok-76-403'>to</span><span class='token pointer' id='tok-76-404' style='color:red'>be</span><span class='token pointer' id='tok-76-405'>run</span><span class='token pointer' id='tok-76-406'>with</span><span class='token pointer' id='tok-76-407'>rundll32</span><span class='token pointer' id='tok-76-408'>like</span><span class='token pointer' id='tok-76-409' style='color:red'>below</span></p><p id=p410><span class='token pointer' id='tok-76-410'>As</span><span class='token pointer' id='tok-76-411'>soon</span><span class='token pointer' id='tok-76-412'>as</span><span class='token pointer' id='tok-76-413'>the</span><span class='token pointer' id='tok-76-414'>task</span><span class='token pointer' id='tok-76-415'>is</span><span class='token pointer' id='tok-76-416'>created,</span><span class='token pointer' id='tok-76-417'>it</span><span class='token pointer' id='tok-76-418'>creates</span><span class='token pointer' id='tok-76-419'>a</span><span class='token pointer' id='tok-76-420'>Scheduled</span><span class='token pointer' id='tok-76-421'>task</span><span class='token pointer' id='tok-76-422'>to</span><span class='token pointer' id='tok-76-423'>shut</span><span class='token pointer' id='tok-76-424'>down</span><span class='token pointer' id='tok-76-425'>the</span><span class='token pointer' id='tok-76-426'>system.</span><span class='token pointer' id='tok-76-427'>I</span><span class='token pointer' id='tok-76-428'>have</span><span class='token pointer' id='tok-76-429'>observed</span><span class='token pointer' id='tok-76-430'>that</span><span class='token pointer' id='tok-76-431'>it</span><span class='token pointer' id='tok-76-432'>gives</span><span class='token pointer' id='tok-76-433'>a</span><span class='token pointer' id='tok-76-434'>buffer</span><span class='token pointer' id='tok-76-435'>of</span><span class='token pointer' id='tok-76-436'>around</span><span class='token pointer' id='tok-76-437'>one</span><span class='token pointer' id='tok-76-438'>hour</span><span class='token pointer' id='tok-76-439'>before</span><span class='token pointer' id='tok-76-440'>the</span><span class='token pointer' id='tok-76-441'>scheduled</span><span class='token pointer' id='tok-76-442'>tasks</span><span class='token pointer' id='tok-76-443'>kick</span><span class='token pointer' id='tok-76-444'>in.</span><span class='token pointer' id='tok-76-445'>In</span><span class='token pointer' id='tok-76-446' style='color:red'>this</span><span class='token pointer' id='tok-76-447'>buffer</span><span class='token pointer' id='tok-76-448'>period,</span><span class='token pointer' id='tok-76-449'>malware</span><span class='token pointer' id='tok-76-451' style='color:red'>get</span><span class='token pointer' id='tok-76-452' style='color:red'>will</span><span class='token pointer' id='tok-76-453'>hold</span><span class='token pointer' id='tok-76-454'>of</span><span class='token pointer' id='tok-76-455'>the</span><span class='token pointer' id='tok-76-456'>whole</span><span class='token pointer' id='tok-76-457'>system</span><span class='token pointer' id='tok-76-458'>and</span><span class='token pointer' id='tok-76-460' style='color:red'>also try</span><span class='token pointer' id='tok-76-461'>enumerate</span><span class='token pointer' id='tok-76-462'>the</span><span class='token pointer' id='tok-76-463'>network,</span><span class='token pointer' id='tok-76-464'>since</span><span class='token pointer' id='tok-76-465'>just</span><span class='token pointer' id='tok-76-466'>before</span><span class='token pointer' id='tok-76-467'>the</span><span class='token pointer' id='tok-76-468'>shutdown,</span><span class='token pointer' id='tok-76-470' style='color:red'>malware will delete</span><span class='token pointer' id='tok-76-471' style='color:red'>and</span><span class='token pointer' id='tok-76-472'>if</span><span class='token pointer' id='tok-76-473'>it</span><span class='token pointer' id='tok-76-474'>immediately</span><span class='token pointer' id='tok-76-475'>shuts</span><span class='token pointer' id='tok-76-476'>itself</span><span class='token pointer' id='tok-76-477'>down,</span><span class='token pointer' id='tok-76-478'>then</span><span class='token pointer' id='tok-76-479'>it</span><span class='token pointer' id='tok-76-480'>misses</span><span class='token pointer' id='tok-76-481'>the</span><span class='token pointer' id='tok-76-482'>chance</span><span class='token pointer' id='tok-76-483'>to</span><span class='token pointer' id='tok-76-485' style='color:red'>spread in</span><span class='token pointer' id='tok-76-486'>network.</span></p><p id=p487><span class='token pointer' id='tok-76-487'>As</span><span class='token pointer' id='tok-76-488'>stated</span><span class='token pointer' id='tok-76-489'>above,</span><span class='token pointer' id='tok-76-490'>the</span><span class='token pointer' id='tok-76-491'>specimen</span><span class='token pointer' id='tok-76-492'>tries</span><span class='token pointer' id='tok-76-493'>to</span><span class='token pointer' id='tok-76-494'>map</span><span class='token pointer' id='tok-76-496' style='color:red'>admin share to other</span><span class='token pointer' id='tok-76-497'>on</span><span class='token pointer' id='tok-76-498'>the</span><span class='token pointer' id='tok-76-499'>network.</span></p><p id=p500><span class='token pointer' id='tok-76-500'>Following</span><span class='token pointer' id='tok-76-501'>are</span><span class='token pointer' id='tok-76-502'>the</span><span class='token pointer' id='tok-76-503'>processes</span><span class='token pointer' id='tok-76-504'>created</span><span class='token pointer' id='tok-76-505'>by</span><span class='token pointer' id='tok-76-506'>the</span><span class='token pointer' id='tok-76-507'>specimen.As</span><span class='token pointer' id='tok-76-508'>mentioned</span><span class='token pointer' id='tok-76-509'>above</span><span class='token pointer' id='tok-76-510'>in</span><span class='token pointer' id='tok-76-511'>static</span><span class='token pointer' id='tok-76-512'>analysisIt</span><span class='token pointer' id='tok-76-513'>creates</span><span class='token pointer' id='tok-76-514'>a</span><span class='token pointer' id='tok-76-515'>scheduled</span><span class='token pointer' id='tok-76-516'>taskCreates</span><span class='token pointer' id='tok-76-517'>a</span><span class='token pointer' id='tok-76-518'>tmp</span><span class='token pointer' id='tok-76-519'>file</span><span class='token pointer' id='tok-76-520'>in</span><span class='token pointer' id='tok-76-521'>AppData</span><span class='token pointer' id='tok-76-522'>local</span><span class='token pointer' id='tok-76-523'>folderCreates</span><span class='token pointer' id='tok-76-524'>dllhost.dat</span><span class='token pointer' id='tok-76-525'>file</span><span class='token pointer' id='tok-76-526'>in</span><span class='token pointer' id='tok-76-527'>C:\WindowsI</span><span class='token pointer' id='tok-76-528' style='color:red'>also</span><span class='token pointer' id='tok-76-529'>noticed</span><span class='token pointer' id='tok-76-530'>that</span><span class='token pointer' id='tok-76-531'>the</span><span class='token pointer' id='tok-76-532'>specimen</span><span class='token pointer' id='tok-76-533'>will</span><span class='token pointer' id='tok-76-534'>delete</span><span class='token pointer' id='tok-76-535'>the</span><span class='token pointer' id='tok-76-536'>malicious</span><span class='token pointer' id='tok-76-537'>file</span><span class='token pointer' id='tok-76-538'>(petya.dll)</span><span class='token pointer' id='tok-76-539'>in</span><span class='token pointer' id='tok-76-540'>this</span><span class='token pointer' id='tok-76-541'>case</span><span class='token pointer' id='tok-76-542'>and</span><span class='token pointer' id='tok-76-543'>will</span><span class='token pointer' id='tok-76-544'>copy</span><span class='token pointer' id='tok-76-545'>to</span><span class='token pointer' id='tok-76-546'>C:\Windows.</span><span class='token pointer' id='tok-76-547'>Those</span><span class='token pointer' id='tok-76-548'>who</span><span class='token pointer' id='tok-76-549'>are</span><span class='token pointer' id='tok-76-550'>still</span><span class='token pointer' id='tok-76-552' style='color:red'>following the document will</span><span class='token pointer' id='tok-76-553'>why</span><span class='token pointer' id='tok-76-554'>I</span><span class='token pointer' id='tok-76-555'>mentioned</span><span class='token pointer' id='tok-76-556'>this</span><span class='token pointer' id='tok-76-557'>point.</span><span class='token pointer' id='tok-76-558'>(Later</span><span class='token pointer' id='tok-76-559'>in</span><span class='token pointer' id='tok-76-560'>Kill</span><span class='token pointer' id='tok-76-561'>Switch)</span></p><p id=p562><span class='token pointer' id='tok-76-563' style='color:red'>There are a whole</span><span class='token pointer' id='tok-76-564'>of</span><span class='token pointer' id='tok-76-565'>CreateFile</span><span class='token pointer' id='tok-76-566'>events</span><span class='token pointer' id='tok-76-567'>by</span><span class='token pointer' id='tok-76-568'>this</span><span class='token pointer' id='tok-76-569'>specimen</span><span class='token pointer' id='tok-76-570'>since</span><span class='token pointer' id='tok-76-571'>it</span><span class='token pointer' id='tok-76-572'>needs</span><span class='token pointer' id='tok-76-573'>to</span><span class='token pointer' id='tok-76-574'>get</span><span class='token pointer' id='tok-76-575'>hold</span><span class='token pointer' id='tok-76-576'>of</span><span class='token pointer' id='tok-76-577'>the</span><span class='token pointer' id='tok-76-578' style='color:red'>files</span><span class='token pointer' id='tok-76-579'>in</span><span class='token pointer' id='tok-76-580'>the</span><span class='token pointer' id='tok-76-581'>system</span><span class='token pointer' id='tok-76-582'>to</span><span class='token pointer' id='tok-76-583'>encrypt.After</span><span class='token pointer' id='tok-76-584'>the</span><span class='token pointer' id='tok-76-585'>scheduled</span><span class='token pointer' id='tok-76-586'>tasks</span><span class='token pointer' id='tok-76-587' style='color:red'>kick</span><span class='token pointer' id='tok-76-588'>in,</span><span class='token pointer' id='tok-76-589'>then</span><span class='token pointer' id='tok-76-590'>as</span><span class='token pointer' id='tok-76-591'>expected</span><span class='token pointer' id='tok-76-592'>the</span><span class='token pointer' id='tok-76-593'>FAKECHKDSK</span></p><p id=p595><span class='token pointer' id='tok-76-595'>Defeating</span><span class='token pointer' id='tok-76-596'>Petya</span><span class='token pointer' id='tok-76-597'>process</span><span class='token pointer' id='tok-76-598'>(trial)</span><span class='token pointer' id='tok-76-599'>I</span><span class='token pointer' id='tok-76-600'>thought</span><span class='token pointer' id='tok-76-601'>to</span><span class='token pointer' id='tok-76-602'>try</span><span class='token pointer' id='tok-76-603'>a</span><span class='token pointer' id='tok-76-604'>couple</span><span class='token pointer' id='tok-76-606' style='color:red'>of techniques to avoid either</span><span class='token pointer' id='tok-76-607'>encryption</span><span class='token pointer' id='tok-76-608'>process</span><span class='token pointer' id='tok-76-609' style='color:red'>or</span><span class='token pointer' id='tok-76-610'>to</span><span class='token pointer' id='tok-76-611'>stop</span><span class='token pointer' id='tok-76-612'>the</span><span class='token pointer' id='tok-76-613'>malware</span><span class='token pointer' id='tok-76-614'>from</span></p><p id=p616><span class='token pointer' id='tok-76-616'>I</span><span class='token pointer' id='tok-76-617'>tried</span><span class='token pointer' id='tok-76-618'>using</span><span class='token pointer' id='tok-76-619'>the</span><span class='token pointer' id='tok-76-620'>Cisco</span><span class='token pointer' id='tok-76-621'>MBRFilter</span><span class='token pointer' id='tok-76-622'>driver</span><span class='token pointer' id='tok-76-623'>utility</span><span class='token pointer' id='tok-76-624'>which</span><span class='token pointer' id='tok-76-625'>per</span><span class='token pointer' id='tok-76-626'>Cisco</span><span class='token pointer' id='tok-76-627'>will</span><span class='token pointer' id='tok-76-628'>prevent</span><span class='token pointer' id='tok-76-629'>any</span><span class='token pointer' id='tok-76-630'>attempts</span><span class='token pointer' id='tok-76-631'>to</span><span class='token pointer' id='tok-76-632'>overwrite</span><span class='token pointer' id='tok-76-633'>MBR</span><span class='token pointer' id='tok-76-634'>record.</span></p><p id=p635><span class='token pointer' id='tok-76-635'>This</span><span class='token pointer' id='tok-76-636'>did</span><span class='token pointer' id='tok-76-637'>not</span><span class='token pointer' id='tok-76-638'>work</span><span class='token pointer' id='tok-76-639'>for</span><span class='token pointer' id='tok-76-640'>me,</span><span class='token pointer' id='tok-76-641'>and</span><span class='token pointer' id='tok-76-642'>Petya</span><span class='token pointer' id='tok-76-643'>successfully</span><span class='token pointer' id='tok-76-644'>encrypted</span><span class='token pointer' id='tok-76-645'>my</span><span class='token pointer' id='tok-76-646'>system</span><span class='token pointer' id='tok-76-647'>even</span><span class='token pointer' id='tok-76-648'>with</span><span class='token pointer' id='tok-76-649'>this</span><span class='token pointer' id='tok-76-650'>driver</span><span class='token pointer' id='tok-76-651'>running</span><span class='token pointer' id='tok-76-652'>L.</span></p><p id=p653><span class='token pointer' id='tok-76-653'>There</span><span class='token pointer' id='tok-76-654'>is</span><span class='token pointer' id='tok-76-655'>some</span><span class='token pointer' id='tok-76-656'>news</span><span class='token pointer' id='tok-76-657'>of</span><span class='token pointer' id='tok-76-658'>a</span><span class='token pointer' id='tok-76-659'>Kill</span><span class='token pointer' id='tok-76-660' style='color:red'>Switch</span><span class='token pointer' id='tok-76-661'>of</span><span class='token pointer' id='tok-76-662'>Petya</span><span class='token pointer' id='tok-76-663'>of</span><span class='token pointer' id='tok-76-664'>including</span><span class='token pointer' id='tok-76-665'>perfc</span><span class='token pointer' id='tok-76-666'>file</span><span class='token pointer' id='tok-76-667'>in</span><span class='token pointer' id='tok-76-668'>C:\Windows\</span><span class='token pointer' id='tok-76-669'>directory.</span><span class='token pointer' id='tok-76-670'>I</span><span class='token pointer' id='tok-76-671'>blindly</span><span class='token pointer' id='tok-76-672'>followed</span><span class='token pointer' id='tok-76-673'>the</span><span class='token pointer' id='tok-76-675' style='color:red'>news and created following</span><span class='token pointer' id='tok-76-676'>app</span><span class='token pointer' id='tok-76-677'>files</span><span class='token pointer' id='tok-76-678'>in</span><span class='token pointer' id='tok-76-679'>read</span><span class='token pointer' id='tok-76-680'>only</span><span class='token pointer' id='tok-76-681'>mode.But</span><span class='token pointer' id='tok-76-682'>it</span><span class='token pointer' id='tok-76-683'>did</span><span class='token pointer' id='tok-76-684'>not</span><span class='token pointer' id='tok-76-685'>work,</span><span class='token pointer' id='tok-76-686'>and</span><span class='token pointer' id='tok-76-687'>Petya</span><span class='token pointer' id='tok-76-688'>again</span><span class='token pointer' id='tok-76-689'>encrypted</span><span class='token pointer' id='tok-76-690'>my</span><span class='token pointer' id='tok-76-691'>device.</span><span class='token pointer' id='tok-76-692'>Reading</span><span class='token pointer' id='tok-76-693'>the</span><span class='token pointer' id='tok-76-694'>code</span><span class='token pointer' id='tok-76-695'>reveals</span><span class='token pointer' id='tok-76-696'>that</span><span class='token pointer' id='tok-76-697'>the</span><span class='token pointer' id='tok-76-698'>specimen</span><span class='token pointer' id='tok-76-699'>is</span><span class='token pointer' id='tok-76-700'>looking</span><span class='token pointer' id='tok-76-701'>for</span><span class='token pointer' id='tok-76-702'>the</span><span class='token pointer' id='tok-76-703'>exact</span><span class='token pointer' id='tok-76-705' style='color:red'>same file which is</span><span class='token pointer' id='tok-76-706'>as</span><span class='token pointer' id='tok-76-707'>a</span><span class='token pointer' id='tok-76-708'>specimen.</span><span class='token pointer' id='tok-76-709'>In</span><span class='token pointer' id='tok-76-710' style='color:red'>our</span><span class='token pointer' id='tok-76-711'>case</span><span class='token pointer' id='tok-76-712'>it</span><span class='token pointer' id='tok-76-713'>is</span><span class='token pointer' id='tok-76-715' style='color:red'>petya.dll. So I created a</span><span class='token pointer' id='tok-76-716'>Petya.dll</span><span class='token pointer' id='tok-76-717'>app</span><span class='token pointer' id='tok-76-718'>file</span><span class='token pointer' id='tok-76-719'>and</span><span class='token pointer' id='tok-76-720'>make</span><span class='token pointer' id='tok-76-721'>it</span><span class='token pointer' id='tok-76-722'>read</span><span class='token pointer' id='tok-76-723'>only.</span></p><p id=p724><span class='token pointer' id='tok-76-724'>And</span><span class='token pointer' id='tok-76-725'>this</span><span class='token pointer' id='tok-76-726'>time</span><span class='token pointer' id='tok-76-727'>it</span><span class='token pointer' id='tok-76-728'>worked.</span><span class='token pointer' id='tok-76-729'>I</span><span class='token pointer' id='tok-76-730'>could</span><span class='token pointer' id='tok-76-731'>see</span><span class='token pointer' id='tok-76-732'>the</span><span class='token pointer' id='tok-76-733'>malware</span><span class='token pointer' id='tok-76-735' style='color:red'>process created but</span><span class='token pointer' id='tok-76-736'>deleted</span><span class='token pointer' id='tok-76-737'>itself</span><span class='token pointer' id='tok-76-738'>after</span><span class='token pointer' id='tok-76-739'>it</span><span class='token pointer' id='tok-76-740'>saw</span><span class='token pointer' id='tok-76-741'>the</span><span class='token pointer' id='tok-76-742'>existence</span><span class='token pointer' id='tok-76-743'>of</span><span class='token pointer' id='tok-76-744'>petya.dll.</span><span class='token pointer' id='tok-76-745'>There</span><span class='token pointer' id='tok-76-746'>was</span><span class='token pointer' id='tok-76-747'>no</span><span class='token pointer' id='tok-76-748'>creation</span><span class='token pointer' id='tok-76-750' style='color:red'>of a scheduled task as</span><span class='token pointer' id='tok-76-751'>mentioned</span><span class='token pointer' id='tok-76-752'>above.</span></p><p id=p753><span class='token pointer' id='tok-76-753'>To</span><span class='token pointer' id='tok-76-754'>be</span><span class='token pointer' id='tok-76-755'>on</span><span class='token pointer' id='tok-76-756'>the</span><span class='token pointer' id='tok-76-757'>safe</span><span class='token pointer' id='tok-76-758'>side,</span><span class='token pointer' id='tok-76-759'>I</span><span class='token pointer' id='tok-76-760'>restarted</span><span class='token pointer' id='tok-76-761'>my</span><span class='token pointer' id='tok-76-763' style='color:red'>system, and it</span><span class='token pointer' id='tok-76-764'>back</span><span class='token pointer' id='tok-76-765'>in</span></p><p id=p767><span class='token pointer' id='tok-76-767'>So,</span><span class='token pointer' id='tok-76-768'>this</span><span class='token pointer' id='tok-76-769'>is</span><span class='token pointer' id='tok-76-770'>the</span><span class='token pointer' id='tok-76-771'>initial</span><span class='token pointer' id='tok-76-772'>Analysis.</span><span class='token pointer' id='tok-76-773'>I</span><span class='token pointer' id='tok-76-774'>will</span><span class='token pointer' id='tok-76-775'>work</span><span class='token pointer' id='tok-76-776'>on</span><span class='token pointer' id='tok-76-777'>the</span><span class='token pointer' id='tok-76-778'>credential</span><span class='token pointer' id='tok-76-779'>extraction</span><span class='token pointer' id='tok-76-780'>process</span><span class='token pointer' id='tok-76-781'>in</span><span class='token pointer' id='tok-76-782'>this</span><span class='token pointer' id='tok-76-783'>malware</span><span class='token pointer' id='tok-76-784'>and</span><span class='token pointer' id='tok-76-785'>will</span><span class='token pointer' id='tok-76-786'>also</span><span class='token pointer' id='tok-76-787'>review</span><span class='token pointer' id='tok-76-788'>what</span><span class='token pointer' id='tok-76-789'>stack</span><span class='token pointer' id='tok-76-790'>parameters</span><span class='token pointer' id='tok-76-791'>can</span><span class='token pointer' id='tok-76-792'>be</span><span class='token pointer' id='tok-76-793'>seen</span><span class='token pointer' id='tok-76-794'>in</span><span class='token pointer' id='tok-76-795'>the</span><span class='token pointer' id='tok-76-796'>debugger.</span></p><p id=p797><span class='token pointer' id='tok-76-797'></span><span class='token pointer' id='tok-76-798'></span><span class='token pointer' id='tok-76-799'></span><span class='token pointer' id='tok-76-800'></span><span class='token pointer' id='tok-76-801'></span><span class='token pointer' id='tok-76-802'></span></p>