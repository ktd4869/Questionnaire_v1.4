<p id=p0>The document below is an initial level analysis of the recent <span class='token pointer' id='tok-76-0' style='color:red'>Ransomware</span><span class='token pointer' id='tok-76-1' style='color:red'>Petya</span>We will also discuss an analysis of a <span class='token pointer' id='tok-76-2' style='color:red'>dll variant</span>the <span class='token pointer' id='tok-76-3' style='color:red'>ransomware.</span></p><p id=p27>Ransomware Objective: <span class='token pointer' id='tok-76-4' style='color:red'>target machine</span>ask for ransom (in <span class='token pointer' id='tok-76-5' style='color:red'>Bitcoins)</span>to <span class='token pointer' id='tok-76-6' style='color:red'>decrypt</span>it. </p><p id=p42>Analysis Objective: First, this document does not contain all of the indicators but will explain the <span class='token pointer' id='tok-76-7' style='color:red'>specimen process.</span>analysis objective is to do some <span class='token pointer' id='tok-76-8' style='color:red'>dissembler</span><span class='token pointer' id='tok-76-9' style='color:red'>code analysis in a</span>then perform a <span class='token pointer' id='tok-76-10' style='color:red'>dynamic analysis</span>well to see <span class='token pointer' id='tok-76-11' style='color:red'>artifacts</span>while the <span class='token pointer' id='tok-76-12' style='color:red'>malware</span>is in action. </p><p id=p89><span class='token pointer' id='tok-76-13' style='color:red'>Certificate</span>InformationThe <span class='token pointer' id='tok-76-14' style='color:red'>Petya variant</span>using an expired </p><p id=p99>Since the objective of this ransomware is to <span class='token pointer' id='tok-76-15' style='color:red'>encrypt the target machine,</span>prefer to do some <span class='token pointer' id='tok-76-16' style='color:red'>static analysis</span>to analyze malware without running it) in <span class='token pointer' id='tok-76-17' style='color:red'>IDA Pro</span>check whether we can see any <span class='token pointer' id='tok-76-18' style='color:red'>interesting</span>functions. </p><p id=p137>Static AnalysisDll is loaded into <span class='token pointer' id='tok-76-19' style='color:red'>IDA pro,</span>as expected it stops at <span class='token pointer' id='tok-76-20' style='color:red'>Entry Point(main()</span>dll). </p><p id=p155>The specimen is using the function below, calling <span class='token pointer' id='tok-76-21' style='color:red'>CreateToolhelp32snapshot</span>followed by <span class='token pointer' id='tok-76-22' style='color:red'>Process32First</span>and <span class='token pointer' id='tok-76-23' style='color:red'>Process 32</span>This means the specimen is <span class='token pointer' id='tok-76-24' style='color:red'>victim machine</span></p><p id=p183>The authors have <span class='token pointer' id='tok-76-25' style='color:red'>Process Names</span>are reviewing. After a bit of <span class='token pointer' id='tok-76-26' style='color:red'>deobfuscation,</span>it turned out that they are checking for the following <span class='token pointer' id='tok-76-27' style='color:red'>Symantec.</span><span class='token pointer' id='tok-76-28' style='color:red'>Norton Security,</span>on <span class='token pointer' id='tok-76-29' style='color:red'>SeDebugPrivilege permissions,</span>malware will call three <span class='token pointer' id='tok-76-30' style='color:red'>APIs</span>to encrypt the files <span class='token pointer' id='tok-76-31' style='color:red'>AES encryption</span><span class='token pointer' id='tok-76-32' style='color:red'>memory.</span><span class='token pointer' id='tok-76-33' style='color:red'>FindFileMapViewOfFileFLushViewOfFileAfter</span>that specimen, it <span class='token pointer' id='tok-76-34' style='color:red'>deletes its activities</span>deleting <span class='token pointer' id='tok-76-35' style='color:red'>Setup,</span><span class='token pointer' id='tok-76-36' style='color:red'>System,</span><span class='token pointer' id='tok-76-37' style='color:red'>Security</span>and <span class='token pointer' id='tok-76-38' style='color:red'>Application Event Logs</span><span class='token pointer' id='tok-76-39' style='color:red'>weutil.</span>It also used <span class='token pointer' id='tok-76-40' style='color:red'>fsutil</span>to delete the <span class='token pointer' id='tok-76-41' style='color:red'>USN change journal(to</span>traces of any update to volume.)Notice <span class='token pointer' id='tok-76-42' style='color:red'>wevutil</span>cl and fsutil /D command below </p><p id=p273>For <span class='token pointer' id='tok-76-43' style='color:red'>Petya</span><span class='token pointer' id='tok-76-44' style='color:red'>lateral movement,</span>the following:It tries to <span class='token pointer' id='tok-76-45' style='color:red'>admin$</span><span class='token pointer' id='tok-76-46' style='color:red'>make a connection to</span>a call to <span class='token pointer' id='tok-76-47' style='color:red'>WNetAddConnection</span>with a <span class='token pointer' id='tok-76-48' style='color:red'>null username and password,</span>means that specimen is using current <span class='token pointer' id='tok-76-49' style='color:red'>user credentials</span>will </p><p id=p314>After the connection is made, the malware will create a copy of itself using <span class='token pointer' id='tok-76-50' style='color:red'>WriteFile()Then</span><span class='token pointer' id='tok-76-51' style='color:red'>CreateFile() and</span>newly created file is executed using an <span class='token pointer' id='tok-76-52' style='color:red'>embedded utility</span>the specimen extracts as <span class='token pointer' id='tok-76-53' style='color:red'>(C:\Windows)</span><span class='token pointer' id='tok-76-54' style='color:red'>dllhost.dat</span>the target system. This <span class='token pointer' id='tok-76-55' style='color:red'>-acceptula</span><span class='token pointer' id='tok-76-56' style='color:red'>%s</span>which is <span class='token pointer' id='tok-76-57' style='color:red'>PSEXEC.</span><span class='token pointer' id='tok-76-58' style='color:red'>Submitting dllhost.dat files</span><span class='token pointer' id='tok-76-59' style='color:red'>VirtuTotal</span>reveals it as <span class='token pointer' id='tok-76-60' style='color:red'>PSEXEC.If</span>above approach fails, then the malware will try to execute the dllhost.dat file using <span class='token pointer' id='tok-76-61' style='color:red'>WMIC.exe.</span></p><p id=p390>The specimen also uses <span class='token pointer' id='tok-76-62' style='color:red'>DHCPSubnetINfo,</span><span class='token pointer' id='tok-76-63' style='color:red'>DHCPSubnetCLients</span><span class='token pointer' id='tok-76-64' style='color:red'>DHcpEnumSubnets,</span><span class='token pointer' id='tok-76-65' style='color:red'>enumerate all the clients</span>the <span class='token pointer' id='tok-76-66' style='color:red'>domain.</span></p><p id=p405>If the specimen gets <span class='token pointer' id='tok-76-67' style='color:red'>SEDebugPrivilege,</span>then the specimen will also access the physical device. The specimen collects all the files as listed below. </p><p id=p428>Below is some of the text of Petya banner that we will see once the target system is <span class='token pointer' id='tok-76-68' style='color:red'>encrypted</span></p><p id=p447>Below is the <span class='token pointer' id='tok-76-69' style='color:red'>CHKDSK</span><span class='token pointer' id='tok-76-70' style='color:red'>Fake</span></p><p id=p453>Ethical Hacking Training â€“ Resources (InfoSec) </p><p id=p459><span class='token pointer' id='tok-76-71' style='color:red'>Dynamic AnalysisSince</span>is a dll, it needs to be <span class='token pointer' id='tok-76-72' style='color:red'>rundll32</span><span class='token pointer' id='tok-76-73' style='color:red'>run with</span>below </p><p id=p474>As soon as the task is created, it creates a <span class='token pointer' id='tok-76-74' style='color:red'>Scheduled task</span>shut down the system. I have observed that <span class='token pointer' id='tok-76-75' style='color:red'>it gives a buffer</span>around one hour before the scheduled tasks kick in. In this buffer period, malware will get a hold of the whole system and also try to enumerate the <span class='token pointer' id='tok-76-76' style='color:red'>network,</span>since just before the shutdown, malware will delete itself and if it immediately shuts itself down, then it misses the chance to </p><p id=p555>As stated above, the specimen tries to <span class='token pointer' id='tok-76-77' style='color:red'>map admin share to</span>machines on the network. </p><p id=p571>Following are the processes created by the <span class='token pointer' id='tok-76-78' style='color:red'>specimen.As</span>mentioned above in static analysisIt creates a scheduled <span class='token pointer' id='tok-76-79' style='color:red'>taskCreates</span>a tmp file in AppData local <span class='token pointer' id='tok-76-80' style='color:red'>folderCreates dllhost.dat file in C:\WindowsI</span>noticed that the specimen will <span class='token pointer' id='tok-76-81' style='color:red'>(petya.dll)</span><span class='token pointer' id='tok-76-82' style='color:red'>delete the malicious file</span>this case and will <span class='token pointer' id='tok-76-83' style='color:red'>copy to C:\Windows.</span>who are still following the document will know why I mentioned this point. (Later in Kill Switch) </p><p id=p636>There are a whole lot of CreateFile events by this specimen since it needs to get hold of the files in the system to <span class='token pointer' id='tok-76-84' style='color:red'>encrypt.After</span>the scheduled tasks kick in, then as expected the FAKECHKDSK message will appear. </p><p id=p674><span class='token pointer' id='tok-76-85' style='color:red'>Defeating Petya process (trial)</span>thought to try a couple of techniques to avoid either the encryption process or to stop the malware from running altogether. </p><p id=p700>I tried using the <span class='token pointer' id='tok-76-86' style='color:red'>Cisco MBRFilter driver utility</span>per <span class='token pointer' id='tok-76-87' style='color:red'>Cisco</span>will prevent any </p><p id=p719>This did not work for me, and Petya successfully encrypted my system even with this </p><p id=p737>There is some news of a Kill Switch of Petya of including <span class='token pointer' id='tok-76-88' style='color:red'>perfc file in C:\Windows\ directory.</span>blindly followed the news and created following <span class='token pointer' id='tok-76-89' style='color:red'>perfc* app files</span><span class='token pointer' id='tok-76-90' style='color:red'>read only</span>it did not work, and Petya again encrypted my device. Reading the code reveals that the specimen is looking for the exact same file which is run as a specimen. In our case it is petya.dll. So I created a new <span class='token pointer' id='tok-76-91' style='color:red'>Petya.dll</span>app file and make it read only. </p><p id=p818>And this time it worked. I could see the malware process created but then deleted itself after it saw the existence of petya.dll. There was no <span class='token pointer' id='tok-76-92' style='color:red'>creation of a scheduled task</span>is mentioned above. </p><p id=p853>To be on the safe side, I restarted my system, and it came back in good shape. </p><p id=p870>So, this is the initial Analysis. I will work on the <span class='token pointer' id='tok-76-93' style='color:red'>credential extraction process</span>this malware and will also review what <span class='token pointer' id='tok-76-94' style='color:red'>stack parameters</span>be seen in the <span class='token pointer' id='tok-76-95' style='color:red'>debugger.</span></p><p id=p900>      </p>