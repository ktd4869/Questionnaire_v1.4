<p id=p0><span class='token pointer' id='tok-76-0'>The</span><span class='token pointer' id='tok-76-1'>document</span><span class='token pointer' id='tok-76-2'>below</span><span class='token pointer' id='tok-76-3'>is</span><span class='token pointer' id='tok-76-4'>an</span><span class='token pointer' id='tok-76-5'>initial</span><span class='token pointer' id='tok-76-6'>level</span><span class='token pointer' id='tok-76-7'>analysis</span><span class='token pointer' id='tok-76-8'>of</span><span class='token pointer' id='tok-76-9'>the</span><span class='token pointer' id='tok-76-10'>recent</span><span class='token pointer' id='tok-76-11' style='color:red'>Petya Ransomware (2017).</span><span class='token pointer' id='tok-76-12'>will</span><span class='token pointer' id='tok-76-13'>also</span><span class='token pointer' id='tok-76-14'>discuss</span><span class='token pointer' id='tok-76-15'>an</span><span class='token pointer' id='tok-76-16'>analysis</span><span class='token pointer' id='tok-76-17'>of</span><span class='token pointer' id='tok-76-18'>a</span><span class='token pointer' id='tok-76-19' style='color:red'>dll variant</span><span class='token pointer' id='tok-76-20'>the</span><span class='token pointer' id='tok-76-21' style='color:red'>ransomware.</span></p><p id=p22><span class='token pointer' id='tok-76-22'>Ransomware</span><span class='token pointer' id='tok-76-23'>Objective:</span><span class='token pointer' id='tok-76-24' style='color:red'>Encrypt the target machine</span><span class='token pointer' id='tok-76-25'>ask</span><span class='token pointer' id='tok-76-26'>for</span><span class='token pointer' id='tok-76-27'>ransom</span><span class='token pointer' id='tok-76-28'>(in</span><span class='token pointer' id='tok-76-29' style='color:red'>Bitcoins)</span><span class='token pointer' id='tok-76-30'>to</span><span class='token pointer' id='tok-76-31' style='color:red'>decrypt</span><span class='token pointer' id='tok-76-32'>it.</span></p><p id=p33><span class='token pointer' id='tok-76-33'>Analysis</span><span class='token pointer' id='tok-76-34'>Objective:</span><span class='token pointer' id='tok-76-35'>First,</span><span class='token pointer' id='tok-76-36'>this</span><span class='token pointer' id='tok-76-37'>document</span><span class='token pointer' id='tok-76-38'>does</span><span class='token pointer' id='tok-76-39'>not</span><span class='token pointer' id='tok-76-40'>contain</span><span class='token pointer' id='tok-76-41'>all</span><span class='token pointer' id='tok-76-42'>of</span><span class='token pointer' id='tok-76-43'>the</span><span class='token pointer' id='tok-76-44'>indicators</span><span class='token pointer' id='tok-76-45'>but</span><span class='token pointer' id='tok-76-46'>will</span><span class='token pointer' id='tok-76-47'>explain</span><span class='token pointer' id='tok-76-48'>the</span><span class='token pointer' id='tok-76-49' style='color:red'>specimen process.</span><span class='token pointer' id='tok-76-50'>analysis</span><span class='token pointer' id='tok-76-51'>objective</span><span class='token pointer' id='tok-76-52'>is</span><span class='token pointer' id='tok-76-53'>to</span><span class='token pointer' id='tok-76-54'>do</span><span class='token pointer' id='tok-76-55'>some</span><span class='token pointer' id='tok-76-56' style='color:red'>code analysis in a dissembler</span><span class='token pointer' id='tok-76-57'>then</span><span class='token pointer' id='tok-76-58'>perform</span><span class='token pointer' id='tok-76-59'>a</span><span class='token pointer' id='tok-76-60' style='color:red'>dynamic analysis</span><span class='token pointer' id='tok-76-61'>well</span><span class='token pointer' id='tok-76-62'>to</span><span class='token pointer' id='tok-76-63'>see</span><span class='token pointer' id='tok-76-64' style='color:red'>artifacts</span><span class='token pointer' id='tok-76-65'>while</span><span class='token pointer' id='tok-76-66'>the</span><span class='token pointer' id='tok-76-67' style='color:red'>malware</span><span class='token pointer' id='tok-76-68'>is</span><span class='token pointer' id='tok-76-69'>in</span><span class='token pointer' id='tok-76-70'>action.</span></p><p id=p71><span class='token pointer' id='tok-76-71' style='color:red'>Certificate</span><span class='token pointer' id='tok-76-72'>InformationThe</span><span class='token pointer' id='tok-76-73' style='color:red'>Petya variant</span><span class='token pointer' id='tok-76-74'>using</span><span class='token pointer' id='tok-76-75'>an</span><span class='token pointer' id='tok-76-76'>expired</span></p><p id=p77><span class='token pointer' id='tok-76-77'>Since</span><span class='token pointer' id='tok-76-78'>the</span><span class='token pointer' id='tok-76-79'>objective</span><span class='token pointer' id='tok-76-80'>of</span><span class='token pointer' id='tok-76-81'>this</span><span class='token pointer' id='tok-76-82'>ransomware</span><span class='token pointer' id='tok-76-83'>is</span><span class='token pointer' id='tok-76-84'>to</span><span class='token pointer' id='tok-76-85' style='color:red'>encrypt the target machine,</span><span class='token pointer' id='tok-76-86'>prefer</span><span class='token pointer' id='tok-76-87'>to</span><span class='token pointer' id='tok-76-88'>do</span><span class='token pointer' id='tok-76-89'>some</span><span class='token pointer' id='tok-76-90' style='color:red'>static analysis</span><span class='token pointer' id='tok-76-91'>to</span><span class='token pointer' id='tok-76-92'>analyze</span><span class='token pointer' id='tok-76-93'>malware</span><span class='token pointer' id='tok-76-94'>without</span><span class='token pointer' id='tok-76-95'>running</span><span class='token pointer' id='tok-76-96'>it)</span><span class='token pointer' id='tok-76-97'>in</span><span class='token pointer' id='tok-76-98' style='color:red'>IDA Pro</span><span class='token pointer' id='tok-76-99'>check</span><span class='token pointer' id='tok-76-100'>whether</span><span class='token pointer' id='tok-76-101'>we</span><span class='token pointer' id='tok-76-102'>can</span><span class='token pointer' id='tok-76-103'>see</span><span class='token pointer' id='tok-76-104'>any</span><span class='token pointer' id='tok-76-105' style='color:red'>interesting</span><span class='token pointer' id='tok-76-106'>functions.</span></p><p id=p107><span class='token pointer' id='tok-76-107'>Static</span><span class='token pointer' id='tok-76-108'>AnalysisDll</span><span class='token pointer' id='tok-76-109'>is</span><span class='token pointer' id='tok-76-110'>loaded</span><span class='token pointer' id='tok-76-111'>into</span><span class='token pointer' id='tok-76-112' style='color:red'>IDA pro,</span><span class='token pointer' id='tok-76-113'>as</span><span class='token pointer' id='tok-76-114'>expected</span><span class='token pointer' id='tok-76-115'>it</span><span class='token pointer' id='tok-76-116'>stops</span><span class='token pointer' id='tok-76-117'>at</span><span class='token pointer' id='tok-76-118' style='color:red'>dll Entry Point(main()</span><span class='token pointer' id='tok-76-119'>dll).</span></p><p id=p120><span class='token pointer' id='tok-76-120'>The</span><span class='token pointer' id='tok-76-121'>specimen</span><span class='token pointer' id='tok-76-122'>is</span><span class='token pointer' id='tok-76-123'>using</span><span class='token pointer' id='tok-76-124'>the</span><span class='token pointer' id='tok-76-125'>function</span><span class='token pointer' id='tok-76-126'>below,</span><span class='token pointer' id='tok-76-127'>calling</span><span class='token pointer' id='tok-76-128' style='color:red'>CreateToolhelp32snapshot</span><span class='token pointer' id='tok-76-129'>followed</span><span class='token pointer' id='tok-76-130'>by</span><span class='token pointer' id='tok-76-131' style='color:red'>Process32First</span><span class='token pointer' id='tok-76-132'>and</span><span class='token pointer' id='tok-76-133' style='color:red'>Process 32</span><span class='token pointer' id='tok-76-134'>This</span><span class='token pointer' id='tok-76-135'>means</span><span class='token pointer' id='tok-76-136'>the</span><span class='token pointer' id='tok-76-137'>specimen</span><span class='token pointer' id='tok-76-138'>is</span><span class='token pointer' id='tok-76-139' style='color:red'>enumerating the victim machine</span></p><p id=p140><span class='token pointer' id='tok-76-140'>The</span><span class='token pointer' id='tok-76-141'>authors</span><span class='token pointer' id='tok-76-142'>have</span><span class='token pointer' id='tok-76-143' style='color:red'>XOR'ed the Process Names</span><span class='token pointer' id='tok-76-144'>are</span><span class='token pointer' id='tok-76-145'>reviewing.</span><span class='token pointer' id='tok-76-146'>After</span><span class='token pointer' id='tok-76-147'>a</span><span class='token pointer' id='tok-76-148'>bit</span><span class='token pointer' id='tok-76-149'>of</span><span class='token pointer' id='tok-76-150' style='color:red'>deobfuscation,</span><span class='token pointer' id='tok-76-151'>it</span><span class='token pointer' id='tok-76-152'>turned</span><span class='token pointer' id='tok-76-153'>out</span><span class='token pointer' id='tok-76-154'>that</span><span class='token pointer' id='tok-76-155'>they</span><span class='token pointer' id='tok-76-156'>are</span><span class='token pointer' id='tok-76-157'>checking</span><span class='token pointer' id='tok-76-158'>for</span><span class='token pointer' id='tok-76-159'>the</span><span class='token pointer' id='tok-76-160'>following</span><span class='token pointer' id='tok-76-161' style='color:red'>AVKaspersky, Norton Security, Symantec.</span><span class='token pointer' id='tok-76-162'>on</span><span class='token pointer' id='tok-76-163' style='color:red'>SeDebugPrivilege permissions,</span><span class='token pointer' id='tok-76-164'>malware</span><span class='token pointer' id='tok-76-165'>will</span><span class='token pointer' id='tok-76-166'>call</span><span class='token pointer' id='tok-76-167'>three</span><span class='token pointer' id='tok-76-168' style='color:red'>APIs</span><span class='token pointer' id='tok-76-169'>to</span><span class='token pointer' id='tok-76-170'>encrypt</span><span class='token pointer' id='tok-76-171'>the</span><span class='token pointer' id='tok-76-172'>files</span><span class='token pointer' id='tok-76-173' style='color:red'>FindFileMapViewOfFileFLushViewOfFileAfter</span><span class='token pointer' id='tok-76-174' style='color:red'>using AES encryption in memory.</span><span class='token pointer' id='tok-76-175'>specimen,</span><span class='token pointer' id='tok-76-176'>it</span><span class='token pointer' id='tok-76-177' style='color:red'>deletes its activities</span><span class='token pointer' id='tok-76-178'>deleting</span><span class='token pointer' id='tok-76-179' style='color:red'>Setup,</span><span class='token pointer' id='tok-76-180' style='color:red'>System,</span><span class='token pointer' id='tok-76-181' style='color:red'>Security</span><span class='token pointer' id='tok-76-182'>and</span><span class='token pointer' id='tok-76-183' style='color:red'>Application Event Logs</span><span class='token pointer' id='tok-76-184' style='color:red'>weutil.</span><span class='token pointer' id='tok-76-185'>It</span><span class='token pointer' id='tok-76-186'>also</span><span class='token pointer' id='tok-76-187'>used</span><span class='token pointer' id='tok-76-188' style='color:red'>fsutil</span><span class='token pointer' id='tok-76-189'>to</span><span class='token pointer' id='tok-76-190'>delete</span><span class='token pointer' id='tok-76-191'>the</span><span class='token pointer' id='tok-76-192' style='color:red'>USN change journal(to</span><span class='token pointer' id='tok-76-193'>traces</span><span class='token pointer' id='tok-76-194'>of</span><span class='token pointer' id='tok-76-195'>any</span><span class='token pointer' id='tok-76-196'>update</span><span class='token pointer' id='tok-76-197'>to</span><span class='token pointer' id='tok-76-198'>volume.)Notice</span><span class='token pointer' id='tok-76-199' style='color:red'>wevutil</span><span class='token pointer' id='tok-76-200'>cl</span><span class='token pointer' id='tok-76-201'>and</span><span class='token pointer' id='tok-76-202'>fsutil</span><span class='token pointer' id='tok-76-203'>/D</span><span class='token pointer' id='tok-76-204'>command</span><span class='token pointer' id='tok-76-205'>below</span></p><p id=p206><span class='token pointer' id='tok-76-206'>For</span><span class='token pointer' id='tok-76-207' style='color:red'>Petya</span><span class='token pointer' id='tok-76-208' style='color:red'>lateral movement,</span><span class='token pointer' id='tok-76-209'>the</span><span class='token pointer' id='tok-76-210'>following:It</span><span class='token pointer' id='tok-76-211'>tries</span><span class='token pointer' id='tok-76-212'>to</span><span class='token pointer' id='tok-76-213' style='color:red'>make a connection to admin$</span><span class='token pointer' id='tok-76-214'>a</span><span class='token pointer' id='tok-76-215'>call</span><span class='token pointer' id='tok-76-216'>to</span><span class='token pointer' id='tok-76-217' style='color:red'>WNetAddConnection</span><span class='token pointer' id='tok-76-218'>with</span><span class='token pointer' id='tok-76-219'>a</span><span class='token pointer' id='tok-76-220' style='color:red'>null username and password,</span><span class='token pointer' id='tok-76-221'>means</span><span class='token pointer' id='tok-76-222'>that</span><span class='token pointer' id='tok-76-223'>specimen</span><span class='token pointer' id='tok-76-224'>is</span><span class='token pointer' id='tok-76-225'>using</span><span class='token pointer' id='tok-76-226'>current</span><span class='token pointer' id='tok-76-227' style='color:red'>user credentials</span><span class='token pointer' id='tok-76-228'>will</span></p><p id=p229><span class='token pointer' id='tok-76-229'>After</span><span class='token pointer' id='tok-76-230'>the</span><span class='token pointer' id='tok-76-231'>connection</span><span class='token pointer' id='tok-76-232'>is</span><span class='token pointer' id='tok-76-233'>made,</span><span class='token pointer' id='tok-76-234'>the</span><span class='token pointer' id='tok-76-235'>malware</span><span class='token pointer' id='tok-76-236'>will</span><span class='token pointer' id='tok-76-237'>create</span><span class='token pointer' id='tok-76-238'>a</span><span class='token pointer' id='tok-76-239'>copy</span><span class='token pointer' id='tok-76-240'>of</span><span class='token pointer' id='tok-76-241'>itself</span><span class='token pointer' id='tok-76-242'>using</span><span class='token pointer' id='tok-76-243' style='color:red'>CreateFile() and WriteFile()Then</span><span class='token pointer' id='tok-76-244'>newly</span><span class='token pointer' id='tok-76-245'>created</span><span class='token pointer' id='tok-76-246'>file</span><span class='token pointer' id='tok-76-247'>is</span><span class='token pointer' id='tok-76-248'>executed</span><span class='token pointer' id='tok-76-249'>using</span><span class='token pointer' id='tok-76-250'>an</span><span class='token pointer' id='tok-76-251' style='color:red'>embedded utility</span><span class='token pointer' id='tok-76-252'>the</span><span class='token pointer' id='tok-76-253'>specimen</span><span class='token pointer' id='tok-76-254'>extracts</span><span class='token pointer' id='tok-76-255'>as</span><span class='token pointer' id='tok-76-256' style='color:red'>dllhost.dat (C:\Windows) on the target</span><span class='token pointer' id='tok-76-257'>This</span><span class='token pointer' id='tok-76-258' style='color:red'>%s -acceptula -s,</span><span class='token pointer' id='tok-76-259'>is</span><span class='token pointer' id='tok-76-260' style='color:red'>Submitting dllhost.dat files</span><span class='token pointer' id='tok-76-261' style='color:red'>VirtuTotal</span><span class='token pointer' id='tok-76-262'>reveals</span><span class='token pointer' id='tok-76-263'>it</span><span class='token pointer' id='tok-76-264'>as</span><span class='token pointer' id='tok-76-265' style='color:red'>PSEXEC.If</span><span class='token pointer' id='tok-76-266'>above</span><span class='token pointer' id='tok-76-267'>approach</span><span class='token pointer' id='tok-76-268'>fails,</span><span class='token pointer' id='tok-76-269'>then</span><span class='token pointer' id='tok-76-270'>the</span><span class='token pointer' id='tok-76-271'>malware</span><span class='token pointer' id='tok-76-272'>will</span><span class='token pointer' id='tok-76-273'>try</span><span class='token pointer' id='tok-76-274'>to</span><span class='token pointer' id='tok-76-275'>execute</span><span class='token pointer' id='tok-76-276'>the</span><span class='token pointer' id='tok-76-277'>dllhost.dat</span><span class='token pointer' id='tok-76-278'>file</span><span class='token pointer' id='tok-76-279'>using</span><span class='token pointer' id='tok-76-280' style='color:red'>WMIC.exe.</span></p><p id=p281><span class='token pointer' id='tok-76-281'>The</span><span class='token pointer' id='tok-76-282'>specimen</span><span class='token pointer' id='tok-76-283'>also</span><span class='token pointer' id='tok-76-284'>uses</span><span class='token pointer' id='tok-76-285' style='color:red'>DHcpEnumSubnets, DHCPSubnetINfo, DHCPSubnetCLients</span><span class='token pointer' id='tok-76-286' style='color:red'>enumerate all the clients</span><span class='token pointer' id='tok-76-287'>the</span><span class='token pointer' id='tok-76-288' style='color:red'>domain.</span></p><p id=p289><span class='token pointer' id='tok-76-289'>If</span><span class='token pointer' id='tok-76-290'>the</span><span class='token pointer' id='tok-76-291'>specimen</span><span class='token pointer' id='tok-76-292'>gets</span><span class='token pointer' id='tok-76-293' style='color:red'>SEDebugPrivilege,</span><span class='token pointer' id='tok-76-294'>then</span><span class='token pointer' id='tok-76-295'>the</span><span class='token pointer' id='tok-76-296'>specimen</span><span class='token pointer' id='tok-76-297'>will</span><span class='token pointer' id='tok-76-298'>also</span><span class='token pointer' id='tok-76-299'>access</span><span class='token pointer' id='tok-76-300'>the</span><span class='token pointer' id='tok-76-301'>physical</span><span class='token pointer' id='tok-76-302'>device.</span><span class='token pointer' id='tok-76-303'>The</span><span class='token pointer' id='tok-76-304'>specimen</span><span class='token pointer' id='tok-76-305'>collects</span><span class='token pointer' id='tok-76-306'>all</span><span class='token pointer' id='tok-76-307'>the</span><span class='token pointer' id='tok-76-308'>files</span><span class='token pointer' id='tok-76-309'>as</span><span class='token pointer' id='tok-76-310'>listed</span><span class='token pointer' id='tok-76-311'>below.</span></p><p id=p312><span class='token pointer' id='tok-76-312'>Below</span><span class='token pointer' id='tok-76-313'>is</span><span class='token pointer' id='tok-76-314'>some</span><span class='token pointer' id='tok-76-315'>of</span><span class='token pointer' id='tok-76-316'>the</span><span class='token pointer' id='tok-76-317'>text</span><span class='token pointer' id='tok-76-318'>of</span><span class='token pointer' id='tok-76-319'>Petya</span><span class='token pointer' id='tok-76-320'>banner</span><span class='token pointer' id='tok-76-321'>that</span><span class='token pointer' id='tok-76-322'>we</span><span class='token pointer' id='tok-76-323'>will</span><span class='token pointer' id='tok-76-324'>see</span><span class='token pointer' id='tok-76-325'>once</span><span class='token pointer' id='tok-76-326'>the</span><span class='token pointer' id='tok-76-327'>target</span><span class='token pointer' id='tok-76-328'>system</span><span class='token pointer' id='tok-76-329'>is</span><span class='token pointer' id='tok-76-330' style='color:red'>encrypted</span></p><p id=p331><span class='token pointer' id='tok-76-331'>Below</span><span class='token pointer' id='tok-76-332'>is</span><span class='token pointer' id='tok-76-333'>the</span></p><p id=p334><span class='token pointer' id='tok-76-334'>Ethical</span><span class='token pointer' id='tok-76-335'>Hacking</span><span class='token pointer' id='tok-76-336'>Training</span><span class='token pointer' id='tok-76-337'>â€“</span><span class='token pointer' id='tok-76-338'>Resources</span><span class='token pointer' id='tok-76-339'>(InfoSec)</span></p><p id=p340><span class='token pointer' id='tok-76-340' style='color:red'>Dynamic AnalysisSince</span><span class='token pointer' id='tok-76-341'>is</span><span class='token pointer' id='tok-76-342'>a</span><span class='token pointer' id='tok-76-343'>dll,</span><span class='token pointer' id='tok-76-344'>it</span><span class='token pointer' id='tok-76-345'>needs</span><span class='token pointer' id='tok-76-346'>to</span><span class='token pointer' id='tok-76-347'>be</span><span class='token pointer' id='tok-76-348' style='color:red'>run with rundll32</span><span class='token pointer' id='tok-76-349'>below</span></p><p id=p350><span class='token pointer' id='tok-76-350'>As</span><span class='token pointer' id='tok-76-351'>soon</span><span class='token pointer' id='tok-76-352'>as</span><span class='token pointer' id='tok-76-353'>the</span><span class='token pointer' id='tok-76-354'>task</span><span class='token pointer' id='tok-76-355'>is</span><span class='token pointer' id='tok-76-356'>created,</span><span class='token pointer' id='tok-76-357'>it</span><span class='token pointer' id='tok-76-358'>creates</span><span class='token pointer' id='tok-76-359'>a</span><span class='token pointer' id='tok-76-360' style='color:red'>Scheduled task</span><span class='token pointer' id='tok-76-361'>shut</span><span class='token pointer' id='tok-76-362'>down</span><span class='token pointer' id='tok-76-363'>the</span><span class='token pointer' id='tok-76-364'>system.</span><span class='token pointer' id='tok-76-365'>I</span><span class='token pointer' id='tok-76-366'>have</span><span class='token pointer' id='tok-76-367'>observed</span><span class='token pointer' id='tok-76-368'>that</span><span class='token pointer' id='tok-76-369' style='color:red'>it gives a buffer</span><span class='token pointer' id='tok-76-370'>around</span><span class='token pointer' id='tok-76-371'>one</span><span class='token pointer' id='tok-76-372'>hour</span><span class='token pointer' id='tok-76-373'>before</span><span class='token pointer' id='tok-76-374'>the</span><span class='token pointer' id='tok-76-375'>scheduled</span><span class='token pointer' id='tok-76-376'>tasks</span><span class='token pointer' id='tok-76-377'>kick</span><span class='token pointer' id='tok-76-378'>in.</span><span class='token pointer' id='tok-76-379'>In</span><span class='token pointer' id='tok-76-380'>this</span><span class='token pointer' id='tok-76-381'>buffer</span><span class='token pointer' id='tok-76-382'>period,</span><span class='token pointer' id='tok-76-383'>malware</span><span class='token pointer' id='tok-76-384'>will</span><span class='token pointer' id='tok-76-385'>get</span><span class='token pointer' id='tok-76-386'>a</span><span class='token pointer' id='tok-76-387'>hold</span><span class='token pointer' id='tok-76-388'>of</span><span class='token pointer' id='tok-76-389'>the</span><span class='token pointer' id='tok-76-390'>whole</span><span class='token pointer' id='tok-76-391'>system</span><span class='token pointer' id='tok-76-392'>and</span><span class='token pointer' id='tok-76-393'>also</span><span class='token pointer' id='tok-76-394'>try</span><span class='token pointer' id='tok-76-395'>to</span><span class='token pointer' id='tok-76-396'>enumerate</span><span class='token pointer' id='tok-76-397'>the</span><span class='token pointer' id='tok-76-398' style='color:red'>network,</span><span class='token pointer' id='tok-76-399'>since</span><span class='token pointer' id='tok-76-400'>just</span><span class='token pointer' id='tok-76-401'>before</span><span class='token pointer' id='tok-76-402'>the</span><span class='token pointer' id='tok-76-403'>shutdown,</span><span class='token pointer' id='tok-76-404'>malware</span><span class='token pointer' id='tok-76-405'>will</span><span class='token pointer' id='tok-76-406'>delete</span><span class='token pointer' id='tok-76-407'>itself</span><span class='token pointer' id='tok-76-408'>and</span><span class='token pointer' id='tok-76-409'>if</span><span class='token pointer' id='tok-76-410'>it</span><span class='token pointer' id='tok-76-411'>immediately</span><span class='token pointer' id='tok-76-412'>shuts</span><span class='token pointer' id='tok-76-413'>itself</span><span class='token pointer' id='tok-76-414'>down,</span><span class='token pointer' id='tok-76-415'>then</span><span class='token pointer' id='tok-76-416'>it</span><span class='token pointer' id='tok-76-417'>misses</span><span class='token pointer' id='tok-76-418'>the</span><span class='token pointer' id='tok-76-419'>chance</span><span class='token pointer' id='tok-76-420'>to</span></p><p id=p421><span class='token pointer' id='tok-76-421'>As</span><span class='token pointer' id='tok-76-422'>stated</span><span class='token pointer' id='tok-76-423'>above,</span><span class='token pointer' id='tok-76-424'>the</span><span class='token pointer' id='tok-76-425'>specimen</span><span class='token pointer' id='tok-76-426'>tries</span><span class='token pointer' id='tok-76-427'>to</span><span class='token pointer' id='tok-76-428' style='color:red'>map admin share to</span><span class='token pointer' id='tok-76-429'>machines</span><span class='token pointer' id='tok-76-430'>on</span><span class='token pointer' id='tok-76-431'>the</span><span class='token pointer' id='tok-76-432'>network.</span></p><p id=p433><span class='token pointer' id='tok-76-433'>Following</span><span class='token pointer' id='tok-76-434'>are</span><span class='token pointer' id='tok-76-435'>the</span><span class='token pointer' id='tok-76-436'>processes</span><span class='token pointer' id='tok-76-437'>created</span><span class='token pointer' id='tok-76-438'>by</span><span class='token pointer' id='tok-76-439'>the</span><span class='token pointer' id='tok-76-440' style='color:red'>specimen.As</span><span class='token pointer' id='tok-76-441'>mentioned</span><span class='token pointer' id='tok-76-442'>above</span><span class='token pointer' id='tok-76-443'>in</span><span class='token pointer' id='tok-76-444'>static</span><span class='token pointer' id='tok-76-445'>analysisIt</span><span class='token pointer' id='tok-76-446'>creates</span><span class='token pointer' id='tok-76-447'>a</span><span class='token pointer' id='tok-76-448'>scheduled</span><span class='token pointer' id='tok-76-449' style='color:red'>taskCreates</span><span class='token pointer' id='tok-76-450'>a</span><span class='token pointer' id='tok-76-451'>tmp</span><span class='token pointer' id='tok-76-452'>file</span><span class='token pointer' id='tok-76-453'>in</span><span class='token pointer' id='tok-76-454'>AppData</span><span class='token pointer' id='tok-76-455'>local</span><span class='token pointer' id='tok-76-456' style='color:red'>folderCreates dllhost.dat file in C:\WindowsI</span><span class='token pointer' id='tok-76-457'>noticed</span><span class='token pointer' id='tok-76-458'>that</span><span class='token pointer' id='tok-76-459'>the</span><span class='token pointer' id='tok-76-460'>specimen</span><span class='token pointer' id='tok-76-461'>will</span><span class='token pointer' id='tok-76-462' style='color:red'>delete the malicious file (petya.dll)</span><span class='token pointer' id='tok-76-463'>this</span><span class='token pointer' id='tok-76-464'>case</span><span class='token pointer' id='tok-76-465'>and</span><span class='token pointer' id='tok-76-466'>will</span><span class='token pointer' id='tok-76-467' style='color:red'>copy to C:\Windows.</span><span class='token pointer' id='tok-76-468'>who</span><span class='token pointer' id='tok-76-469'>are</span><span class='token pointer' id='tok-76-470'>still</span><span class='token pointer' id='tok-76-471'>following</span><span class='token pointer' id='tok-76-472'>the</span><span class='token pointer' id='tok-76-473'>document</span><span class='token pointer' id='tok-76-474'>will</span><span class='token pointer' id='tok-76-475'>know</span><span class='token pointer' id='tok-76-476'>why</span><span class='token pointer' id='tok-76-477'>I</span><span class='token pointer' id='tok-76-478'>mentioned</span><span class='token pointer' id='tok-76-479'>this</span><span class='token pointer' id='tok-76-480'>point.</span><span class='token pointer' id='tok-76-481'>(Later</span><span class='token pointer' id='tok-76-482'>in</span><span class='token pointer' id='tok-76-483'>Kill</span><span class='token pointer' id='tok-76-484'>Switch)</span></p><p id=p485><span class='token pointer' id='tok-76-485'>There</span><span class='token pointer' id='tok-76-486'>are</span><span class='token pointer' id='tok-76-487'>a</span><span class='token pointer' id='tok-76-488'>whole</span><span class='token pointer' id='tok-76-489'>lot</span><span class='token pointer' id='tok-76-490'>of</span><span class='token pointer' id='tok-76-491'>CreateFile</span><span class='token pointer' id='tok-76-492'>events</span><span class='token pointer' id='tok-76-493'>by</span><span class='token pointer' id='tok-76-494'>this</span><span class='token pointer' id='tok-76-495'>specimen</span><span class='token pointer' id='tok-76-496'>since</span><span class='token pointer' id='tok-76-497'>it</span><span class='token pointer' id='tok-76-498'>needs</span><span class='token pointer' id='tok-76-499'>to</span><span class='token pointer' id='tok-76-500'>get</span><span class='token pointer' id='tok-76-501'>hold</span><span class='token pointer' id='tok-76-502'>of</span><span class='token pointer' id='tok-76-503'>the</span><span class='token pointer' id='tok-76-504'>files</span><span class='token pointer' id='tok-76-505'>in</span><span class='token pointer' id='tok-76-506'>the</span><span class='token pointer' id='tok-76-507'>system</span><span class='token pointer' id='tok-76-508'>to</span><span class='token pointer' id='tok-76-509' style='color:red'>encrypt.After</span><span class='token pointer' id='tok-76-510'>the</span><span class='token pointer' id='tok-76-511'>scheduled</span><span class='token pointer' id='tok-76-512'>tasks</span><span class='token pointer' id='tok-76-513'>kick</span><span class='token pointer' id='tok-76-514'>in,</span><span class='token pointer' id='tok-76-515'>then</span><span class='token pointer' id='tok-76-516'>as</span><span class='token pointer' id='tok-76-517'>expected</span><span class='token pointer' id='tok-76-518'>the</span><span class='token pointer' id='tok-76-519'>FAKECHKDSK</span><span class='token pointer' id='tok-76-520'>message</span><span class='token pointer' id='tok-76-521'>will</span><span class='token pointer' id='tok-76-522'>appear.</span></p><p id=p523><span class='token pointer' id='tok-76-523' style='color:red'>Defeating Petya process (trial)</span><span class='token pointer' id='tok-76-524'>thought</span><span class='token pointer' id='tok-76-525'>to</span><span class='token pointer' id='tok-76-526'>try</span><span class='token pointer' id='tok-76-527'>a</span><span class='token pointer' id='tok-76-528'>couple</span><span class='token pointer' id='tok-76-529'>of</span><span class='token pointer' id='tok-76-530'>techniques</span><span class='token pointer' id='tok-76-531'>to</span><span class='token pointer' id='tok-76-532'>avoid</span><span class='token pointer' id='tok-76-533'>either</span><span class='token pointer' id='tok-76-534'>the</span><span class='token pointer' id='tok-76-535'>encryption</span><span class='token pointer' id='tok-76-536'>process</span><span class='token pointer' id='tok-76-537'>or</span><span class='token pointer' id='tok-76-538'>to</span><span class='token pointer' id='tok-76-539'>stop</span><span class='token pointer' id='tok-76-540'>the</span><span class='token pointer' id='tok-76-541'>malware</span><span class='token pointer' id='tok-76-542'>from</span><span class='token pointer' id='tok-76-543'>running</span><span class='token pointer' id='tok-76-544'>altogether.</span></p><p id=p545><span class='token pointer' id='tok-76-545'>I</span><span class='token pointer' id='tok-76-546'>tried</span><span class='token pointer' id='tok-76-547'>using</span><span class='token pointer' id='tok-76-548'>the</span><span class='token pointer' id='tok-76-549' style='color:red'>Cisco MBRFilter driver utility</span><span class='token pointer' id='tok-76-550'>per</span><span class='token pointer' id='tok-76-551' style='color:red'>Cisco</span><span class='token pointer' id='tok-76-552'>will</span><span class='token pointer' id='tok-76-553'>prevent</span><span class='token pointer' id='tok-76-554'>any</span></p><p id=p555><span class='token pointer' id='tok-76-555'>This</span><span class='token pointer' id='tok-76-556'>did</span><span class='token pointer' id='tok-76-557'>not</span><span class='token pointer' id='tok-76-558'>work</span><span class='token pointer' id='tok-76-559'>for</span><span class='token pointer' id='tok-76-560'>me,</span><span class='token pointer' id='tok-76-561'>and</span><span class='token pointer' id='tok-76-562'>Petya</span><span class='token pointer' id='tok-76-563'>successfully</span><span class='token pointer' id='tok-76-564'>encrypted</span><span class='token pointer' id='tok-76-565'>my</span><span class='token pointer' id='tok-76-566'>system</span><span class='token pointer' id='tok-76-567'>even</span><span class='token pointer' id='tok-76-568'>with</span><span class='token pointer' id='tok-76-569'>this</span></p><p id=p570><span class='token pointer' id='tok-76-570'>There</span><span class='token pointer' id='tok-76-571'>is</span><span class='token pointer' id='tok-76-572'>some</span><span class='token pointer' id='tok-76-573'>news</span><span class='token pointer' id='tok-76-574'>of</span><span class='token pointer' id='tok-76-575'>a</span><span class='token pointer' id='tok-76-576'>Kill</span><span class='token pointer' id='tok-76-577'>Switch</span><span class='token pointer' id='tok-76-578'>of</span><span class='token pointer' id='tok-76-579'>Petya</span><span class='token pointer' id='tok-76-580'>of</span><span class='token pointer' id='tok-76-581'>including</span><span class='token pointer' id='tok-76-582' style='color:red'>perfc file in C:\Windows\ directory.</span><span class='token pointer' id='tok-76-583'>blindly</span><span class='token pointer' id='tok-76-584'>followed</span><span class='token pointer' id='tok-76-585'>the</span><span class='token pointer' id='tok-76-586'>news</span><span class='token pointer' id='tok-76-587'>and</span><span class='token pointer' id='tok-76-588'>created</span><span class='token pointer' id='tok-76-589'>following</span><span class='token pointer' id='tok-76-590' style='color:red'>perfc* app files</span><span class='token pointer' id='tok-76-591' style='color:red'>read only</span><span class='token pointer' id='tok-76-592'>it</span><span class='token pointer' id='tok-76-593'>did</span><span class='token pointer' id='tok-76-594'>not</span><span class='token pointer' id='tok-76-595'>work,</span><span class='token pointer' id='tok-76-596'>and</span><span class='token pointer' id='tok-76-597'>Petya</span><span class='token pointer' id='tok-76-598'>again</span><span class='token pointer' id='tok-76-599'>encrypted</span><span class='token pointer' id='tok-76-600'>my</span><span class='token pointer' id='tok-76-601'>device.</span><span class='token pointer' id='tok-76-602'>Reading</span><span class='token pointer' id='tok-76-603'>the</span><span class='token pointer' id='tok-76-604'>code</span><span class='token pointer' id='tok-76-605'>reveals</span><span class='token pointer' id='tok-76-606'>that</span><span class='token pointer' id='tok-76-607'>the</span><span class='token pointer' id='tok-76-608'>specimen</span><span class='token pointer' id='tok-76-609'>is</span><span class='token pointer' id='tok-76-610'>looking</span><span class='token pointer' id='tok-76-611'>for</span><span class='token pointer' id='tok-76-612'>the</span><span class='token pointer' id='tok-76-613'>exact</span><span class='token pointer' id='tok-76-614'>same</span><span class='token pointer' id='tok-76-615'>file</span><span class='token pointer' id='tok-76-616'>which</span><span class='token pointer' id='tok-76-617'>is</span><span class='token pointer' id='tok-76-618'>run</span><span class='token pointer' id='tok-76-619'>as</span><span class='token pointer' id='tok-76-620'>a</span><span class='token pointer' id='tok-76-621'>specimen.</span><span class='token pointer' id='tok-76-622'>In</span><span class='token pointer' id='tok-76-623'>our</span><span class='token pointer' id='tok-76-624'>case</span><span class='token pointer' id='tok-76-625'>it</span><span class='token pointer' id='tok-76-626'>is</span><span class='token pointer' id='tok-76-627'>petya.dll.</span><span class='token pointer' id='tok-76-628'>So</span><span class='token pointer' id='tok-76-629'>I</span><span class='token pointer' id='tok-76-630'>created</span><span class='token pointer' id='tok-76-631'>a</span><span class='token pointer' id='tok-76-632'>new</span><span class='token pointer' id='tok-76-633' style='color:red'>Petya.dll</span><span class='token pointer' id='tok-76-634'>app</span><span class='token pointer' id='tok-76-635'>file</span><span class='token pointer' id='tok-76-636'>and</span><span class='token pointer' id='tok-76-637'>make</span><span class='token pointer' id='tok-76-638'>it</span><span class='token pointer' id='tok-76-639'>read</span><span class='token pointer' id='tok-76-640'>only.</span></p><p id=p641><span class='token pointer' id='tok-76-641'>And</span><span class='token pointer' id='tok-76-642'>this</span><span class='token pointer' id='tok-76-643'>time</span><span class='token pointer' id='tok-76-644'>it</span><span class='token pointer' id='tok-76-645'>worked.</span><span class='token pointer' id='tok-76-646'>I</span><span class='token pointer' id='tok-76-647'>could</span><span class='token pointer' id='tok-76-648'>see</span><span class='token pointer' id='tok-76-649'>the</span><span class='token pointer' id='tok-76-650'>malware</span><span class='token pointer' id='tok-76-651'>process</span><span class='token pointer' id='tok-76-652'>created</span><span class='token pointer' id='tok-76-653'>but</span><span class='token pointer' id='tok-76-654'>then</span><span class='token pointer' id='tok-76-655'>deleted</span><span class='token pointer' id='tok-76-656'>itself</span><span class='token pointer' id='tok-76-657'>after</span><span class='token pointer' id='tok-76-658'>it</span><span class='token pointer' id='tok-76-659'>saw</span><span class='token pointer' id='tok-76-660'>the</span><span class='token pointer' id='tok-76-661'>existence</span><span class='token pointer' id='tok-76-662'>of</span><span class='token pointer' id='tok-76-663'>petya.dll.</span><span class='token pointer' id='tok-76-664'>There</span><span class='token pointer' id='tok-76-665'>was</span><span class='token pointer' id='tok-76-666'>no</span><span class='token pointer' id='tok-76-667' style='color:red'>creation of a scheduled task</span><span class='token pointer' id='tok-76-668'>is</span><span class='token pointer' id='tok-76-669'>mentioned</span><span class='token pointer' id='tok-76-670'>above.</span></p><p id=p671><span class='token pointer' id='tok-76-671'>To</span><span class='token pointer' id='tok-76-672'>be</span><span class='token pointer' id='tok-76-673'>on</span><span class='token pointer' id='tok-76-674'>the</span><span class='token pointer' id='tok-76-675'>safe</span><span class='token pointer' id='tok-76-676'>side,</span><span class='token pointer' id='tok-76-677'>I</span><span class='token pointer' id='tok-76-678'>restarted</span><span class='token pointer' id='tok-76-679'>my</span><span class='token pointer' id='tok-76-680'>system,</span><span class='token pointer' id='tok-76-681'>and</span><span class='token pointer' id='tok-76-682'>it</span><span class='token pointer' id='tok-76-683'>came</span><span class='token pointer' id='tok-76-684'>back</span><span class='token pointer' id='tok-76-685'>in</span><span class='token pointer' id='tok-76-686'>good</span><span class='token pointer' id='tok-76-687'>shape.</span></p><p id=p688><span class='token pointer' id='tok-76-688'>So,</span><span class='token pointer' id='tok-76-689'>this</span><span class='token pointer' id='tok-76-690'>is</span><span class='token pointer' id='tok-76-691'>the</span><span class='token pointer' id='tok-76-692'>initial</span><span class='token pointer' id='tok-76-693'>Analysis.</span><span class='token pointer' id='tok-76-694'>I</span><span class='token pointer' id='tok-76-695'>will</span><span class='token pointer' id='tok-76-696'>work</span><span class='token pointer' id='tok-76-697'>on</span><span class='token pointer' id='tok-76-698'>the</span><span class='token pointer' id='tok-76-699' style='color:red'>credential extraction process</span><span class='token pointer' id='tok-76-700'>this</span><span class='token pointer' id='tok-76-701'>malware</span><span class='token pointer' id='tok-76-702'>and</span><span class='token pointer' id='tok-76-703'>will</span><span class='token pointer' id='tok-76-704'>also</span><span class='token pointer' id='tok-76-705'>review</span><span class='token pointer' id='tok-76-706'>what</span><span class='token pointer' id='tok-76-707' style='color:red'>stack parameters</span><span class='token pointer' id='tok-76-708'>be</span><span class='token pointer' id='tok-76-709'>seen</span><span class='token pointer' id='tok-76-710'>in</span><span class='token pointer' id='tok-76-711'>the</span><span class='token pointer' id='tok-76-712' style='color:red'>debugger.</span></p><p id=p713><span class='token pointer' id='tok-76-713'></span><span class='token pointer' id='tok-76-714'></span><span class='token pointer' id='tok-76-715'></span><span class='token pointer' id='tok-76-716'></span><span class='token pointer' id='tok-76-717'></span><span class='token pointer' id='tok-76-718'></span></p>