<p id=p0>The recently-patched <span class='token pointer' id='tok-50-0' style='color:red'>flaw</span>could corrupt memory in such a way that an attacker could execute <span class='token pointer' id='tok-50-1' style='color:red'>arbitrary</span>code in the context of the current user. </p><p id=p24>Researchers have discovered that the <span class='token pointer' id='tok-50-2' style='color:red'>Darkhotel</span>APT is exploiting a recently-patched zero-day vulnerability impacting Microsoft <span class='token pointer' id='tok-50-3' style='color:red'>VBScript.</span></p><p id=p40>Researchers at Trend Micro recently disclosed the flaw in <span class='token pointer' id='tok-50-4' style='color:red'>Microsoft Visual Basic Scripting Engine</span>an active scripting language developed by Microsoft modeled on Visual Basic. The flaw is a <span class='token pointer' id='tok-50-5' style='color:red'>remote code-execution</span><span class='token pointer' id='tok-50-6' style='color:red'>(CVE-2018-8373)</span>existing in the way that the scripting engine handles objects in memory in Internet Explorer. </p><p id=p89>Microsoft patched the flaw during last week's Patch Tuesday – but soon after, researchers with Trend Micro and Qihoo 360 both linked the attack with the Darkhotel APT gang. </p><p id=p118>"It can be seen from this incident that the [Darkhotel] attack gang has maintained a relatively high level of activity in recent years, and will even use the 0-day vulnerability for the purpose of attack," Qihoo 360 researchers said in their recent post about the campaign. </p><p id=p163>CVE-2018-8373Elliot Cao of Trend Micro Security Research (working with Trend Micro's Zero Day Initiative) first discovered the flaw July 11. The vulnerability could corrupt memory in such a way that an attacker could execute arbitrary code in the context of the current user. </p><p id=p205>An attacker who successfully exploited the vulnerability could gain the same user rights as the current user – so if the current user is logged on with administrative-user rights, an attacker who successfully exploited the vulnerability could take control of an affected system, according to Microsoft. <span class='token pointer' id='tok-50-7' style='color:red'>Attackers</span>could then install programs; view, change or delete data; or create new accounts with full user rights. </p><p id=p269>"It could result in remote code-execution and grants the same privileges as the logged-in user, including administrative rights," said Chris Goettl, director of product management, security, for Ivanti, in an email. "Because this vulnerability exists in IE 9, 10 and 11, it affects all Windows operating systems from Server 2008 to Windows 10." </p><p id=p322>In a web-based attack scenario, an attacker could host a specially crafted website that is designed to exploit the vulnerability through Internet Explorer and then convince a user to view the website. </p><p id=p354>The flaw impacts the VBSCript engine in the latest versions of Windows as well as Internet Explorer versions IE 9 and 10. Microsoft recently disabled VBScript in IE 11, meaning that this version of Internet Explorer is not impacted. </p><p id=p393>Microsoft has given the flaw a "2" on the Exploitability Index for the latest software release, meaning exploitation is less likely; however, exploitation has been detected on older releases, including the latest Darkhotel effort. </p><p id=p427>DarkhotelAfter discovering an exploit for CVE-2018-8373, Trend Micro researchers found that the sample used the same <span class='token pointer' id='tok-50-8' style='color:red'>obfuscation</span>technique as exploits for <span class='token pointer' id='tok-50-9' style='color:red'>CVE-2018-8174,</span>a VBScript engine remote code-execution vulnerability patched back in May. </p><p id=p459>"This is similar to CVE-2018-8174, which has been circulating since before May's patch Tuesday, primarily in Asia… The same techniques were used by both exploits. Both were leveraging [use-after-frees] within VBScript Engine, were hitting similar functions within the engine, and had a similar method for running <span class='token pointer' id='tok-50-10' style='color:red'>shellcode," Dustin</span>Childs, with Trend Micro's ZDI, told Threatpost. </p><p id=p513>As the flaw was similar to the use-after-free (UAF) vulnerability in vbscript.dll, called Double Kill, which remained unpatched in the latest VBScript engine, researchers suspected that this exploit sample came from the same creator.  Researchers were also able to obtain the domain name used by the exploit, and found that it was the same one used in May for Darkhotel APT. </p><p id=p573>Darkhotel was first identified in 2014 by Kaspersky Lab researchers, who said the group had been active since at least 2007. The group was known for targeting diplomats and corporate executives via Wi-Fi networks at luxury hotels – and has since then continued accessing zero-day vulnerabilities and exploits. </p><p id=p621>ExploitThe original exploit was heavily <span class='token pointer' id='tok-50-11' style='color:red'>obfuscated,</span>but researchers were able to demonstrate a proof of concept (PoC) to explain how the flaw could be exploited. </p><p id=p646>"Based on our analysis, this vulnerability can be steadily exploited," Cao said in the analysis of the exploit. "Moreover, since it is the second Visual Basic engine exploit found in the wild this year, it is not far-fetched to expect other vulnerability findings in the VB engine in the future." </p><p id=p696>There are three parts to the PoC exploit used to trigger use-after-free memory corruption, thus enabling attackers to run <span class='token pointer' id='tok-50-12' style='color:red'>shellcode</span>on the system: Using the vulnerability to modify a two-dimensional array's structure's length (to <span class='token pointer' id='tok-50-13' style='color:red'>0x0FFFFFFF),</span>implementing read/write primitives and faking CONTEXT structure to execute shellcode. </p><p id=p741>Childs told us that, while not widespread at this time, the exploit "certainly has the chance of broader use since it's a reliable attack." </p><p id=p765>He added, "For this to succeed, the attacker must convince the user to click a link or open a <span class='token pointer' id='tok-50-14' style='color:red'>malicious</span>file. This is usually done through spear <span class='token pointer' id='tok-50-15' style='color:red'>phishing,</span>but it could be links sent through messenger apps, too." </p><p id=p803>Cao recommended that users update their systems as soon as possible: "As a first line of defense, we recommend applying the latest security patches once they're available to prevent exploits," he said.
 </p>