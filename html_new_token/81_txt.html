<p id=p0>The <span class='token pointer' id='tok-81-0' style='color:red'>Sofacy</span>group remains a persistent global threat. Unit 42 and others have shown in the first half of 2018 how this threat actor group continues to target multiple organizations throughout the world with a strong emphasis on government, diplomatic and other strategic organizations primarily in North America and Europe. </p><p id=p50>Following up our most recent Sofacy research in February and March of 2018, we have found a new campaign that uses a lesser known <span class='token pointer' id='tok-81-1' style='color:red'>tool</span>widely attributed to the Sofacy group called <span class='token pointer' id='tok-81-2' style='color:red'>Zebrocy.</span>Zebrocy is delivered primarily via <span class='token pointer' id='tok-81-3' style='color:red'>phishing</span><span class='token pointer' id='tok-81-4' style='color:red'>attacks</span>that contain <span class='token pointer' id='tok-81-5' style='color:red'>malicious</span><span class='token pointer' id='tok-81-6' style='color:red'>Microsoft</span><span class='token pointer' id='tok-81-7' style='color:red'>Office</span>documents with <span class='token pointer' id='tok-81-8' style='color:red'>macros</span>as well as simple <span class='token pointer' id='tok-81-9' style='color:red'>executable</span><span class='token pointer' id='tok-81-10' style='color:red'>file</span><span class='token pointer' id='tok-81-11' style='color:red'>attachments.</span>This third campaign is consistent with two <span class='token pointer' id='tok-81-12' style='color:red'>previously</span>reported attack campaigns in terms of targeting: the targets were government organizations dealing with foreign affairs. In this case however the targets were in different geopolitical regions. </p><p id=p140>An interesting difference we found in this newest campaign was that the attacks using Zebrocy cast a far wider net within the target organization: the attackers sent phishing <span class='token pointer' id='tok-81-13' style='color:red'>emails</span>to a an exponentially larger number of individuals. The targeted individuals did not follow any significant pattern, and the <span class='token pointer' id='tok-81-14' style='color:red'>email addresses were</span>easily using <span class='token pointer' id='tok-81-15' style='color:red'>web</span><span class='token pointer' id='tok-81-16' style='color:red'>search engines.</span>is a stark contrast with other attacks commonly associated with the Sofacy group where generally no more than a handful of victims are targeted within a single organization in a focus-fire style of attack. </p><p id=p232>In addition to the large number of Zebrocy attacks we discovered, we also observed instances of the Sofacy group leveraging the <span class='token pointer' id='tok-81-17' style='color:red'>(DDE)</span><span class='token pointer' id='tok-81-18' style='color:red'>exploit</span><span class='token pointer' id='tok-81-19' style='color:red'>Dynamic Data Exchange</span>previously documented by <span class='token pointer' id='tok-81-20' style='color:red'>McAfee.</span>The instances we observed, however, used the DDE exploit to deliver different <span class='token pointer' id='tok-81-21' style='color:red'>payloads</span>than what was observed previously. In one instance the DDE attack was used to deliver and install Zebrocy. In another instance, the DDE attack was used to deliver an <span class='token pointer' id='tok-81-22' style='color:red'>open-source</span><span class='token pointer' id='tok-81-23' style='color:red'>toolkit</span><span class='token pointer' id='tok-81-24' style='color:red'>penetration testing</span><span class='token pointer' id='tok-81-25' style='color:red'>Koadic.</span>The Sofacy group has leveraged open source or freely available tools and exploits in the past but this is the first time that Unit 42 has observed them leveraging the Koadic toolkit. </p><p id=p343>Links to <span class='token pointer' id='tok-81-26' style='color:red'>previous</span>attacks </p><p id=p347>In our February report, we discovered the Sofacy group using Microsoft Office documents with malicious macros to deliver the SofacyCarberp <span class='token pointer' id='tok-81-27' style='color:red'>payload</span>to multiple government entities. In that report, we documented our observation that the Sofacy group appeared to use conventional <span class='token pointer' id='tok-81-28' style='color:red'>obfuscation</span>techniques to mask their infrastructure attribution by using random registrant and service provider information for each of their attacks. In particular, we noted that the Sofacy group deployed a <span class='token pointer' id='tok-81-29' style='color:red'>webpage</span>on each of the <span class='token pointer' id='tok-81-30' style='color:red'>domains.</span>This is odd because attackers almost never set up an actual webpage on adversary <span class='token pointer' id='tok-81-31' style='color:red'>C2</span>infrastructure. Even stranger, each webpage contained the same content within the body. Since that report, we continued our research into this oddity. Using this artifact, we were able to pivot and discover another attack campaign using the DealersChoice exploit kit with similar victimology to what we saw in February. Continuing to use this artifact, we discovered another <span class='token pointer' id='tok-81-32' style='color:red'>domain</span>with the same <span class='token pointer' id='tok-81-33' style='color:red'>content body,</span>This domain was registered on December 20, 2017 and within a few days was resolving to 92.222.136[.]105, which belonged to a well-known <span class='token pointer' id='tok-81-34' style='color:red'>VPS</span>provider often used by the Sofacy group. </p><p id=p532>Unfortunately, at the time of collection, the C2 domain had been <span class='token pointer' id='tok-81-35' style='color:red'>sinkholed</span>by a third party. Based on dynamic and static analysis of the <span class='token pointer' id='tok-81-36' style='color:red'>malware</span>sample associated with the supservermgr[.]com domain however, we were able to determine several unique artifacts which allowed us to expand our <span class='token pointer' id='tok-81-37' style='color:red'>dataset</span>and discover additional findings. First, we determined the sample we collected, d697160ae… was attempting to <span class='token pointer' id='tok-81-38' style='color:red'>communicate</span>to its C2 at hxxp://supservermgr[.]com/sys/upd/pageupd.php to retrieve a Zebrocy AutoIT <span class='token pointer' id='tok-81-39' style='color:red'>downloader.</span>Because the domain had been sinkholed, this activity could not be completed. However, we were able determine a unique, <span class='token pointer' id='tok-81-40' style='color:red'>hard-coded</span><span class='token pointer' id='tok-81-41' style='color:red'>user agent</span>for the C2 communications. </p><p id=p633>  </p><p id=p634>Using AutoFocus, we pivoted from the user agent string to expand our data set to three additional Zebrocy samples using the exact same user agent. This led us to additional infrastructure for Zebrocy at 185.25.51[.]198 and 185.25.50[.]93. At this point we had collected nearly thirty samples of Zebrocy in relation to the original sample and its associated C2 domain. Additional pivoting based on artifacts unique to this malware family expanded our dataset to hundreds of samples used over the last several years. Most of the additional samples were the <span class='token pointer' id='tok-81-42' style='color:red'>Delphi</span>and AutoIT variants as reported by ESET. However, several of the collected samples were a <span class='token pointer' id='tok-81-43' style='color:red'>C++</span>variant of <span class='token pointer' id='tok-81-44' style='color:red'>the Zebrocy</span>downloader tool. In addition, we discovered evidence of a completely different payload in Koadic being delivered as well. Also, we found the IP address 185.25.50[.]93 <span class='token pointer' id='tok-81-45' style='color:red'>hosting</span>C2 services for a Delphi backdoor that ESET's report states is the final stage payload for these attacks. </p><p id=p787>A malware sample using two separate unique user agent strings is uncommon. A closer examination of the tool revealed the second user agent string was from a secondary payload that was retrieved by the <span class='token pointer' id='tok-81-46' style='color:red'>cba5ab65a…</span>sample. Pivoting from the <span class='token pointer' id='tok-81-47' style='color:red'>Mozilla</span>v5.1 user agent revealed over forty additional Zebrocy samples, with several again targeting the same Central Asian nation. Two samples specifically, 25f0d1cbc… and 115fd8c61… provided additional artifacts we were able to pivot from to discover <span class='token pointer' id='tok-81-48' style='color:red'>weaponized documents</span>deliver Zebrocy as well as a Koadic. </p><p id=p872>DDE <span class='token pointer' id='tok-81-49' style='color:red'>Documents</span></p><p id=p874>The two weaponized documents we discovered leveraging DDE were of particular interest due to victimology and a change in tactics. </p><p id=p894>While examining 25f0d1cbc…, we were able to pivot from its C2 220.158.216[.]127 to gather additional Zebrocy samples as well as a <span class='token pointer' id='tok-81-50' style='color:red'>weaponized document.</span>document (85da72c7d…) appears to have been targeting a North American government organization dealing with foreign affairs. It leveraged DDE to retrieve and install a payload onto the victim <span class='token pointer' id='tok-81-51' style='color:red'>host.</span>A <span class='token pointer' id='tok-81-52' style='color:red'>decoy</span>document is deployed in this attack, with the contents purporting be a publicly available document from the <span class='token pointer' id='tok-81-53' style='color:red'>United Nations</span>the Republic of Uzbekistan. </p><p id=p973>The creator of the weaponized document appended their DDE <span class='token pointer' id='tok-81-54' style='color:red'>instructions</span>to the end of the document after all of the decoy contents. When the document is opened in <span class='token pointer' id='tok-81-55' style='color:red'>Word,</span>the instructions are not immediately visible, as Word does not display these <span class='token pointer' id='tok-81-56' style='color:red'>fields</span>contents by default. As you can see in the following <span class='token pointer' id='tok-81-57' style='color:red'>screenshot,</span>simply attempting to highlight the lines in which the DDE instructions reside does not display them. </p><p id=p1042>Conclusion </p><p id=p1043>The Sofacy group continues their targeted attack campaigns in 2018. As mentioned in this blog, Sofacy is carrying out parallel campaigns to attack similar targets around the world but with different toolsets. The Zebrocy tool associated with this current strain of attacks is constructed in several different forms based on the <span class='token pointer' id='tok-81-58' style='color:red'>programming</span><span class='token pointer' id='tok-81-59' style='color:red'>language</span>the <span class='token pointer' id='tok-81-60' style='color:red'>developer</span>chose to create the tool. We have observed Delphi, <span class='token pointer' id='tok-81-61' style='color:red'>AutoIt,</span>and C++ variants of Zebrocy, all of which are related not only in their functionality, but also at times by chaining the variants together in a single attack. These attacks are still largely perpetrated via spear phishing campaigns, whether via simple executable attachments in hopes that a victim will launch the file to using a previously observed DDE exploitation technique.
 </p>