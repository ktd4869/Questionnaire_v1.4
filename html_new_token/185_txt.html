<p id=p0>During the first half of this year, <span class='token pointer' id='tok-185-0' style='color:red'>ESET</span>has observed an increase in the number of <span class='token pointer' id='tok-185-1' style='color:red'>detections</span>of <span class='token pointer' id='tok-185-2' style='color:red'>Nymaim,</span>a long-known <span class='token pointer' id='tok-185-3' style='color:red'>malware</span>family whose prevalence has fallen markedly since 2014. </p><p id=p30>During the first half of this year, ESET has observed an increase in the number of detections of Nymaim, a long-known malware family whose prevalence has fallen markedly since 2014. Back in 2013, WeLiveSecurity published a series of articles about this malware, in which we described its <span class='token pointer' id='tok-185-4' style='color:red'>kill</span><span class='token pointer' id='tok-185-5' style='color:red'>chain</span>and <span class='token pointer' id='tok-185-6' style='color:red'>evasion</span><span class='token pointer' id='tok-185-7' style='color:red'>techniques,</span>as well as the extent of this <span class='token pointer' id='tok-185-8' style='color:red'>threat,</span>which has resulted in more than 2.8 million <span class='token pointer' id='tok-185-9' style='color:red'>infections.</span></p><p id=p99>In 2016, the number of detections observed has already increased by 63% compared to the first half of 2015, appearing mostly in Poland (54% of all Nymaim detections this year), Germany (16%) and in the US (12%). It has increased so much that if this growth trend continues, we will already have seen more detections by the end of June 2016 than in the whole of 2015. </p><p id=p166><span class='token pointer' id='tok-185-10' style='color:red'>Phishing</span><span class='token pointer' id='tok-185-11' style='color:red'>workflowUnlike</span>the 2013 <span class='token pointer' id='tok-185-12' style='color:red'>version,</span>which was being disseminated through <span class='token pointer' id='tok-185-13' style='color:red'>drive-by-downloads</span>as the victims visited <span class='token pointer' id='tok-185-14' style='color:red'>compromised</span><span class='token pointer' id='tok-185-15' style='color:red'>websites,</span>the new <span class='token pointer' id='tok-185-16' style='color:red'>Nymaim's</span>attack <span class='token pointer' id='tok-185-17' style='color:red'>vector</span>has shifted to <span class='token pointer' id='tok-185-18' style='color:red'>spearphishing</span>campaigns, with <span class='token pointer' id='tok-185-19' style='color:red'>emails</span>containing a <span class='token pointer' id='tok-185-20' style='color:red'>malicious</span>Microsoft Word <span class='token pointer' id='tok-185-21' style='color:red'>.DOC</span><span class='token pointer' id='tok-185-22' style='color:red'>file</span>as an <span class='token pointer' id='tok-185-23' style='color:red'>attachment.</span></p><p id=p205>This malicious document contains a <span class='token pointer' id='tok-185-24' style='color:red'>macro</span>to do its dirty work. Because default Microsoft Word <span class='token pointer' id='tok-185-25' style='color:red'>security</span><span class='token pointer' id='tok-185-26' style='color:red'>settings</span>will prevent the macro from running, the document contains a couple of "tricks" to hopefully work around this. </p><p id=p240>First, the document contains a <span class='token pointer' id='tok-185-27' style='color:red'>block</span>of "garbled text", presumably suggesting to the likely victim that something needs to be done to <span class='token pointer' id='tok-185-28' style='color:red'>decode</span>or <span class='token pointer' id='tok-185-29' style='color:red'>decrypt</span>it. Second, at the very top of the document is the message "Enable Content to run in compatibility mode". This message is <span class='token pointer' id='tok-185-30' style='color:red'>formatted</span>very similarly to the warning bar of recent Microsoft Word <span class='token pointer' id='tok-185-31' style='color:red'>versions,</span>which warns users that <span class='token pointer' id='tok-185-32' style='color:red'>macros</span>in the current document have been disabled. </p><p id=p311>While this may work well to convince users of English versions of Microsoft Word to enable macros, if the document is opened in a different language version of Microsoft Word, this social engineering attempt may be much less compelling, as seen in Figure 2. </p><p id=p355>With respect to this <span class='token pointer' id='tok-185-33' style='color:red'>cyber</span>kill chain, it starts with the execution of the malicious macros contained in this document. If the malicious macro – detected (and blocked) by ESET as <span class='token pointer' id='tok-185-34' style='color:red'>VBA/TrojanDownloader.Agent.BCX</span>– runs successfully, it downloads the Nymaim <span class='token pointer' id='tok-185-35' style='color:red'>payload</span>from the <span class='token pointer' id='tok-185-36' style='color:red'>hosting</span><span class='token pointer' id='tok-185-37' style='color:red'>website</span>creating a new executable file in the temporary <span class='token pointer' id='tok-185-38' style='color:red'>folder</span>(%temp%), which it then <span class='token pointer' id='tok-185-39' style='color:red'>executes.</span></p><p id=p413>Nymaim analysisThe advanced evasion techniques, combining <span class='token pointer' id='tok-185-40' style='color:red'>obfuscation,</span><span class='token pointer' id='tok-185-41' style='color:red'>anti-VM,</span><span class='token pointer' id='tok-185-42' style='color:red'>anti-debugging</span>and control flow capabilities of this family are well known. It consists of a two-stage <span class='token pointer' id='tok-185-43' style='color:red'>downloader</span>usually associated with <span class='token pointer' id='tok-185-44' style='color:red'>file-encoding</span><span class='token pointer' id='tok-185-45' style='color:red'>ransomware</span>as the final payload. </p><p id=p447>Nonetheless, in April 2016, a hybrid <span class='token pointer' id='tok-185-46' style='color:red'>variant</span>of Nymaim and <span class='token pointer' id='tok-185-47' style='color:red'>Gozi</span>was uncovered, <span class='token pointer' id='tok-185-48' style='color:red'>targeting</span>financial institutions in North America, and providing the attacker with <span class='token pointer' id='tok-185-49' style='color:red'>remote</span>control over the compromised <span class='token pointer' id='tok-185-50' style='color:red'>computer</span>instead of <span class='token pointer' id='tok-185-51' style='color:red'>encrypting</span><span class='token pointer' id='tok-185-52' style='color:red'>files</span>or locking out the computer in exchange for money. </p><p id=p490>Although it is possible to forge the relevant PE <span class='token pointer' id='tok-185-53' style='color:red'>metadata,</span>for this new variant they suggest that the sample dates from 17th May 2016, whereas the variant family was first detected in October 2015 as <span class='token pointer' id='tok-185-54' style='color:red'>Win32/TrojanDownloader.Nymaim.BA.</span>The malicious .DOC attachment was supposedly generated on the following day, which suggests that Nymaim was repackaged into this sample to be used in this specific spearphishing campaign. </p><p id=p554>Nymaim in BrazilIn Brazil we also observed highly targeted Nymaim attacks directed against financial institutions. Despite the relatively low number of detections, which is to be expected due to the very specific <span class='token pointer' id='tok-185-55' style='color:red'>target</span>selection, Brazil accounts for 0.07% of all <span class='token pointer' id='tok-185-56' style='color:red'>detection</span>incidents involving this variant, placing it 11th in the list of countries where this variant was most often detected. In contrast, considering detection statistics for all Nymaim <span class='token pointer' id='tok-185-57' style='color:red'>variants</span>since 2015, Brazil is in 39th place. </p><p id=p630>In brief, this spearphishing campaign seems to have been specifically intended to target selected victims soon after Nymaim was rebuilt/repacked into <span class='token pointer' id='tok-185-58' style='color:red'>Nymaim.BA,</span>when both the downloader and Nymaim.BA payload were detected by very few <span class='token pointer' id='tok-185-59' style='color:red'>antivirus</span><span class='token pointer' id='tok-185-60' style='color:red'>engines.</span></p><p id=p665><span class='token pointer' id='tok-185-61' style='color:red'>Detection</span>and countermeasuresA comment at VirusTotal by member @matthewm provides potentially useful information to assist with detection and <span class='token pointer' id='tok-185-62' style='color:red'>mitigation</span>of this threat. </p><p id=p687>In his comment, he properly identified the payload as Nymaim and provided <span class='token pointer' id='tok-185-63' style='color:red'>URLs</span>where the initial downloader was found hosted until June 2nd: </p><p id=p710>He also provided a URL that was being resolved into <span class='token pointer' id='tok-185-64' style='color:red'>IP</span>by a fast flux <span class='token pointer' id='tok-185-65' style='color:red'>DNS</span>and supposedly hosted a final payload downloaded by Nymaim: </p><p id=p735>Below you will find a full list of <span class='token pointer' id='tok-185-66' style='color:red'>IPs</span>resolved from DNS <span class='token pointer' id='tok-185-67' style='color:red'>queries</span>of gafbqvx.com since its first appearance on May 16th through to June 2nd, 2016, which includes new IPs observed since @matthewm's comment. </p><p id=p770>According to @matthewm, the last stage consists of a VNC connection to a remote <span class='token pointer' id='tok-185-68' style='color:red'>host.</span></p><p id=p785>Thus, if you suspect that your computer or <span class='token pointer' id='tok-185-69' style='color:red'>network</span>has been compromised, we recommend you check that the IPs and URLs provided by @matthewm are not to be found in your <span class='token pointer' id='tok-185-70' style='color:red'>firewall</span>and <span class='token pointer' id='tok-185-71' style='color:red'>proxy</span><span class='token pointer' id='tok-185-72' style='color:red'>logs.</span></p><p id=p820>A prevention strategy for this threat can be put in place by blacklisting the IPs contacted by this malware at the firewall and the URLs at a proxy, so long as your network supports this kind of <span class='token pointer' id='tok-185-73' style='color:red'>filtering.</span></p><p id=p858>Furthermore, it is important to make use of <span class='token pointer' id='tok-185-74' style='color:red'>antimalware</span>protection on your endpoints, along with <span class='token pointer' id='tok-185-75' style='color:red'>anti-phishing</span>and web control capabilities, and of course to keep it all up-to-date. </p><p id=p886>Indicators of CompromiseHashesThreatHash <span class='token pointer' id='tok-185-76' style='color:red'>(SHA-1)VBA/TrojanDownloader.Agent.BCX87b47aa1d421679bc1200dd3b61f48cc8991e421Win32/TrojanDownloader.Nymaim.BAd983920eee2fc7306e500ee3df7791a612a6ba4bNetworkConnections</span>to some IPs and URLs.
 </p>