<p id=p0>When building a <span class='token pointer' id='tok-120-0' style='color:red'>DDoS</span><span class='token pointer' id='tok-120-1' style='color:red'>mitigation</span>service it's incredibly tempting to think that the solution is <span class='token pointer' id='tok-120-2' style='color:red'>scrubbing</span>centers or <span class='token pointer' id='tok-120-3' style='color:red'>scrubbing servers.</span>too, thought that was a good idea in the beginning, but experience has shown that there are serious pitfalls to this approach. </p><p id=p43>A scrubbing server is a dedicated machine that receives all <span class='token pointer' id='tok-120-4' style='color:red'>network traffic</span>for an <span class='token pointer' id='tok-120-5' style='color:red'>IP</span>address and attempts to filter good traffic from bad. Ideally, the scrubbing server will only forward <span class='token pointer' id='tok-120-6' style='color:red'>non-DDoS</span>packets to the Internet application being attacked. A scrubbing center is a dedicated location filled with scrubbing servers. </p><p id=p94>Three Problems With ScrubbersThe three most pressing problems with scrubbing are: <span class='token pointer' id='tok-120-7' style='color:red'>bandwidth,</span>cost, <span class='token pointer' id='tok-120-8' style='color:red'>knowledge.</span></p><p id=p108>The bandwidth problem is easy to see. As DDoS attacks have scaled to >1Tbps having that much network capacity available is problematic. Provisioning and maintaining multiple-Tbps of bandwidth for DDoS mitigation is expensive and complicated. And it needs to be located in the right place on the Internet to receive and absorb an attack. If it's not then attack traffic will need to be received at one location, scrubbed, and then clean traffic forwarded to the real server: that can introduce enormous delays with a limited number of locations. </p><p id=p197>Imagine for a moment you've built a small number of scrubbing centers, and each center is connected to the Internet with many <span class='token pointer' id='tok-120-9' style='color:red'>Gbps</span>of connectivity. When a DDoS attack occurs that center needs to be able to handle potentially 100s of Gbps of attack traffic at line rate. That means exotic network and server hardware. Everything from the line cards in routers, to the network adapter cards in the servers, to the servers themselves is going to be very expensive. </p><p id=p277>This (and bandwidth above) is one of the reasons DDoS mitigation has traditionally cost so much and been billed by attack size. </p><p id=p299>The final problem, knowledge, is the most easily overlooked. When you set out to build a scrubbing server you are building something that has to separate good packets from bad. </p><p id=p329>At first this seems easy (let's filter out all TCP ACK packets for non-established connections, for example), and low level engineers are easy to excite about writing high-performance code to do that. But attackers are not stupid and they'll throw <span class='token pointer' id='tok-120-10' style='color:red'>legitimate</span>looking traffic at a scrubbing server and it gets harder and harder to distinguish good from bad. </p><p id=p387>At that point, scrubbing engineers need to become protocol experts at all levels of the stack. That means you have to build a <span class='token pointer' id='tok-120-11' style='color:red'>competency</span>in all levels of <span class='token pointer' id='tok-120-12' style='color:red'>TCP/IP,</span>DNS, HTTP, TLS, etc. And that's hard. </p><p id=p423>CC BY-SA 2.0 image by Lisa Stevens </p><p id=p430>The bottom line is scrubbing centers and exotic hardware are great marketing. But, like <span class='token pointer' id='tok-120-13' style='color:red'>citadels of medieval times,</span>are <span class='token pointer' id='tok-120-14' style='color:red'>monumentally</span>expensive and outdated, overwhelmed by better weapons and warfighting techniques. </p><p id=p461>And many DDoS mitigation services that use scrubbing centers operate in an offline mode. They are only enabled when a DDoS occurs. This typically means that an Internet application will succumb to the DDoS attack before its traffic is diverted to the scrubbing center. </p><p id=p505>Just imagine citizens fleeing to hide behind the walls of the citadel under fire from an approaching army. </p><p id=p523>Better, Cheaper, SmarterThere's a subtler point about not having dedicated scrubbers: it forces us to build better software. If a scrubbing server becomes overwhelmed or fails then only the customer being scrubbed is affected, but when the mitigation happens on the very servers running the core service it has to work and be effective. </p><p id=p577>I spoke above about the 'knowledge gap' that comes about with dedicated DDoS scrubbing. The <span class='token pointer' id='tok-120-15' style='color:red'>Cloudflare</span>approach means that if bad traffic gets through, say a flood of bad DNS packets, then it reaches a service owned and operated by people who are experts in that domain. If a DNS flood gets through our DDoS protection it hits our custom DNS server, RRDNS, the engineers who work on it can bring their expertise to bear. </p><p id=p652>This makes an enormous difference because the result is either improved DDoS scrubbing or a change to the software (e.g. the DNS stack) that improves its performance under load. We've lived that story many, many times and the entire software stack has improved because of it. </p><p id=p698>The approach Cloudflare took to DDoS mitigation is rather simple: make every single server in Cloudflare participate in mitigation, load balance DDoS attacks across the data centers and servers within them and then apply smarts to the handling of packets. These are the same servers, processors and cores handling our entire service. </p><p id=p750>Eliminating scrubbing centers and hardware completely changes the cost of building a DDoS mitigation service. </p><p id=p765>We currently have around 15 Tbps of network capacity worldwide but this capacity doesn't require exotic network hardware. We are able to use low cost or <span class='token pointer' id='tok-120-16' style='color:red'>commodity</span>networking equipment bound together using network automation to handle normal and DDoS traffic. Just as Google originally built its service by writing software that tied together commodity servers into a super (search) computer; our architecture binds commodity servers together into one giant network device. </p><p id=p836>By building the world's most peered network we've built this capacity at reasonable cost and more importantly are able to handle attack traffic globally wherever it originates with low latency links. No scrubbing solution is able to say the same. </p><p id=p876>And because Cloudflare manages DNS for our customers and uses an Anycasted network attack traffic originating from botnets is automatically distributed across our global network. Each data center deals with a portion of DDoS traffic. </p><p id=p911>Within each data center DDoS traffic is load balanced across multiple servers running our service. Each server handles a portion of the DDoS traffic. This spreading of DDoS traffic means that a single DDoS attack will be handled by a large number of individual servers across the world. </p><p id=p959>And as Cloudflare grows our DDoS mitigation capacity grows automatically, and because our DDoS mitigation is built into our stack it is always on. We mitigate a new DDoS attack every three minutes with no downtime for Internet applications and have no need to 'switch over' to a scrubbing center. </p><p id=p1009>Inside a ServerOnce all this global and local load balancing has occurred packets do finally hit a network adapter card in a server. It's here that <span class='token pointer' id='tok-120-17' style='color:red'>Cloudflare's</span>custom DDoS mitigation stack comes into play. </p><p id=p1043>Over the years we've learned how to automatically detect and mitigate anything the internet can throw at us. For most of the attacks, we rely on dynamically managing <span class='token pointer' id='tok-120-18' style='color:red'>iptables:</span>the standard Linux firewall. We've spoken about the most effective techniques in past. iptables has a number of very powerful features which we select depending on specific attack vector. From our experience <span class='token pointer' id='tok-120-19' style='color:red'>xt_bpf,</span>ipset, hashlimits and connlimits are the most useful iptables modules. </p><p id=p1115>For very large attacks the Linux Kernel is not fast enough though. To relieve the <span class='token pointer' id='tok-120-20' style='color:red'>kernel</span>from processing excessive number of packets, we experimented with various kernel bypass techniques. We've settled on a partial kernel bypass interface - <span class='token pointer' id='tok-120-21' style='color:red'>Solarflare</span>specific EFVI. </p><p id=p1156>Conclusion: Cloudflare's DDoS mitigation architecture and custom software makes Unmetered Mitigation possible. With it we can withstand the largest DDoS attacks and as our network grows our DDoS mitigation capability grows with it.
 </p>