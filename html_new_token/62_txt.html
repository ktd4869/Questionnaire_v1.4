<p id=p0><span id='tok'>The</span><span class='token pointer' id='tok-62-0' style='color:red'>driver</span><span id='tok'>is</span><span id='tok'>the</span><span id='tok'>first</span><span class='token pointer' id='tok-62-1' style='color:red'>Duqu</span><span class='token pointer' id='tok-62-2' style='color:red'>component of</span><span id='tok'>be</span><span id='tok'>loaded</span><span id='tok'>in</span><span id='tok'>the</span><span id='tok'>system.</span><span id='tok'>As</span><span id='tok'>we</span><span id='tok'>discovered,</span><span id='tok'>the</span><span id='tok'>driver</span><span id='tok'>and</span><span id='tok'>other</span><span id='tok'>components</span><span id='tok'>of</span><span class='token pointer' id='tok-62-3' style='color:red'>malware</span><span id='tok'>are</span><span id='tok'>installed</span><span id='tok'>with</span><span id='tok'>a</span><span class='token pointer' id='tok-62-4' style='color:red'>dropper</span><span id='tok'>exploiting</span><span id='tok'>a</span><span id='tok'>0-day</span><span id='tok'>vulnerability</span><span class='token pointer' id='tok-62-5' style='color:red'>(CVE-2011-3402).</span><span id='tok'>The</span><span id='tok'>driver</span><span id='tok'>is</span><span id='tok'>registered</span><span id='tok'>in</span><span id='tok'>the</span><span class='token pointer' id='tok-62-6' style='color:red'>registry path.</span><span id='tok'>exact</span><span id='tok'>name</span><span id='tok'>of</span><span id='tok'>the</span><span class='token pointer' id='tok-62-7' style='color:red'>registry key</span><span id='tok'>in</span><span id='tok'>different</span><span id='tok'>versions</span><span id='tok'>of</span><span id='tok'>Duqu</span><span id='tok'>drivers.</span></p><p id=p57><span id='tok'>Once</span><span id='tok'>the</span><span id='tok'>driver</span><span id='tok'>is</span><span id='tok'>loaded,</span><span id='tok'>it</span><span class='token pointer' id='tok-62-8' style='color:red'>decrypts</span><span id='tok'>a</span><span id='tok'>small</span><span id='tok'>block</span><span id='tok'>that</span><span id='tok'>contains</span><span id='tok'>its</span><span id='tok'>registry</span><span id='tok'>key</span><span id='tok'>and</span><span id='tok'>the</span><span id='tok'>name</span><span id='tok'>of</span><span id='tok'>the</span><span class='token pointer' id='tok-62-9' style='color:red'>registry value</span><span id='tok'>be</span><span id='tok'>read</span><span id='tok'>from</span><span id='tok'>that</span><span id='tok'>key.</span><span id='tok'>It</span><span id='tok'>also</span><span id='tok'>contains</span><span id='tok'>the</span><span id='tok'>name</span><span id='tok'>of</span><span id='tok'>the</span><span id='tok'>driver</span><span id='tok'>object</span><span id='tok'>to</span><span id='tok'>create.</span></p><p id=p96><span id='tok'>All</span><span id='tok'>versions</span><span id='tok'>of</span><span id='tok'>the</span><span id='tok'>driver</span><span id='tok'>available</span><span id='tok'>at</span><span id='tok'>the</span><span id='tok'>moment</span><span id='tok'>have</span><span id='tok'>the</span><span id='tok'>same</span><span id='tok'>registry</span><span id='tok'>value</span><span id='tok'>name,</span><span id='tok'>"FILTER".</span></p><p id=p112><span id='tok'>The</span><span id='tok'>driver</span><span id='tok'>then</span><span id='tok'>registers</span><span id='tok'>the</span><span class='token pointer' id='tok-62-10' style='color:red'>DriverReinitializationRoutine</span><span id='tok'>that</span><span id='tok'>queues</span><span id='tok'>the</span><span class='token pointer' id='tok-62-11' style='color:red'>WorkerRoutine</span><span id='tok'>where</span><span id='tok'>actual</span><span class='token pointer' id='tok-62-12' style='color:red'>driver initialization</span><span id='tok'>performed.</span><span id='tok'>In</span><span id='tok'>the</span><span id='tok'>WorkerRoutine</span><span id='tok'>the</span><span id='tok'>driver</span><span id='tok'>reads</span><span id='tok'>the</span><span id='tok'>"FILTER"</span><span id='tok'>value</span><span id='tok'>from</span><span id='tok'>registry</span><span id='tok'>and</span><span id='tok'>decrypts</span><span id='tok'>it</span><span id='tok'>with</span><span id='tok'>a</span><span class='token pointer' id='tok-62-13' style='color:red'>hard-coded encryption key.</span><span id='tok'>are</span><span id='tok'>two</span><span id='tok'>known</span><span id='tok'>versions</span><span id='tok'>of</span><span class='token pointer' id='tok-62-14' style='color:red'>decryption routine</span><span id='tok'>two</span><span id='tok'>corresponding</span><span class='token pointer' id='tok-62-15' style='color:red'>decryption keys.</span><span id='tok'>driver</span><span id='tok'>also</span><span id='tok'>locates</span><span id='tok'>the</span><span class='token pointer' id='tok-62-16' style='color:red'>NTOSKRNL.EXE</span><span id='tok'>or</span><span class='token pointer' id='tok-62-17' style='color:red'>module</span><span class='token pointer' id='tok-62-18' style='color:red'>NTKRNLPA.EXE</span><span id='tok'>gets</span><span id='tok'>the</span><span id='tok'>addresses</span><span id='tok'>of</span><span class='token pointer' id='tok-62-19' style='color:red'>API functions</span><span id='tok'>further</span><span id='tok'>usage.</span></p><p id=p179><span id='tok'>The</span><span class='token pointer' id='tok-62-20' style='color:red'>decrypted</span><span id='tok'>"FILTER"</span><span id='tok'>value</span><span id='tok'>from</span><span id='tok'>registry</span><span id='tok'>contains</span><span id='tok'>the</span><span id='tok'>list</span><span id='tok'>of</span><span id='tok'>records</span><span id='tok'>that</span><span id='tok'>contain</span><span id='tok'>the</span><span id='tok'>name</span><span id='tok'>of</span><span id='tok'>the</span><span id='tok'>process</span><span id='tok'>("services.exe"),</span><span id='tok'>the</span><span id='tok'>path</span><span id='tok'>to</span><span id='tok'>corresponding</span><span class='token pointer' id='tok-62-21' style='color:red'>PNF DLL file</span><span id='tok'>will</span><span id='tok'>be</span><span id='tok'>injected</span><span id='tok'>in</span><span id='tok'>that</span><span id='tok'>process</span><span id='tok'>and</span><span id='tok'>the</span><span id='tok'>decryption</span><span id='tok'>key</span><span id='tok'>(0xAE240682)</span><span id='tok'>that</span><span id='tok'>is</span><span id='tok'>used</span><span id='tok'>to</span><span id='tok'>decrypt</span><span id='tok'>the</span><span id='tok'>PNF</span><span id='tok'>DLL</span><span id='tok'>file.</span></p><p id=p226><span id='tok'>After</span><span id='tok'>initialization</span><span id='tok'>the</span><span id='tok'>driver</span><span id='tok'>registers</span><span id='tok'></span><span class='token pointer' id='tok-62-22' style='color:red'>LoadImageNotifyRoutine</span><span id='tok'>that</span><span id='tok'>will</span><span id='tok'>be</span><span id='tok'>then</span><span id='tok'>called</span><span id='tok'>by</span><span id='tok'>Windows</span><span id='tok'>each</span><span id='tok'>time</span><span id='tok'>a</span><span id='tok'>new</span><span id='tok'>module</span><span id='tok'>is</span><span id='tok'>loaded.</span><span id='tok'>The</span><span id='tok'>routine</span><span id='tok'>checks</span><span id='tok'>if</span><span id='tok'>the</span><span id='tok'>name</span><span id='tok'>of</span><span id='tok'>image</span><span id='tok'>matches</span><span id='tok'>one</span><span id='tok'>of</span><span id='tok'>these</span><span id='tok'>specified</span><span id='tok'>in</span><span id='tok'>"FILTER"</span><span id='tok'>value</span><span id='tok'>and</span><span id='tok'>if</span><span id='tok'>it</span><span id='tok'>does,</span><span id='tok'>starts</span><span id='tok'>the</span><span id='tok'>injection:</span><span id='tok'>it</span><span id='tok'>decrypts</span><span id='tok'>and</span><span id='tok'>copies</span><span id='tok'>the</span><span id='tok'>PNF</span><span id='tok'>DLL</span><span id='tok'>file</span><span id='tok'>into</span><span id='tok'>an</span><span class='token pointer' id='tok-62-23' style='color:red'>allocate memory region</span><span id='tok'>that</span><span id='tok'>process.</span><span id='tok'>It</span><span id='tok'>also</span><span id='tok'>builds</span><span id='tok'>an</span><span id='tok'>copies</span><span id='tok'>a</span><span class='token pointer' id='tok-62-24' style='color:red'>stub EXE file</span><span id='tok'>that</span><span id='tok'>process</span><span id='tok'>that</span><span id='tok'>is</span><span id='tok'>then</span><span id='tok'>used</span><span id='tok'>as</span><span id='tok'>a</span><span class='token pointer' id='tok-62-25' style='color:red'>loader</span><span id='tok'>for</span><span id='tok'>the</span><span class='token pointer' id='tok-62-26' style='color:red'>PNF</span><span class='token pointer' id='tok-62-27' style='color:red'>DLL.</span></p><p id=p309><span id='tok'>As</span><span id='tok'>soon</span><span id='tok'>as</span><span class='token pointer' id='tok-62-28' style='color:red'>"KERNEL32.DLL"</span><span id='tok'>is</span><span id='tok'>loaded</span><span id='tok'>in</span><span id='tok'>the</span><span id='tok'>same</span><span id='tok'>process,</span><span id='tok'>it</span><span id='tok'>locates</span><span id='tok'>addresses</span><span id='tok'>of</span><span id='tok'>API</span><span id='tok'>functions</span><span id='tok'>required</span><span id='tok'>by</span><span id='tok'>the</span><span id='tok'>loader</span><span id='tok'>EXE</span><span id='tok'>and</span><span id='tok'>modifies</span><span id='tok'>the</span><span id='tok'>original</span><span id='tok'>entry</span><span id='tok'>point</span><span id='tok'>of</span><span id='tok'>the</span><span id='tok'>main</span><span id='tok'>process</span><span id='tok'>module</span><span id='tok'>so</span><span id='tok'>that</span><span id='tok'>it</span><span id='tok'>passes</span><span id='tok'>execution</span><span id='tok'>to</span><span id='tok'>the</span><span id='tok'>loader</span></p><p id=p351><span id='tok'>The</span><span id='tok'>loader</span><span class='token pointer' id='tok-62-29' style='color:red'>EXE module</span><span id='tok'>initial</span><span id='tok'>initialization</span><span id='tok'>of</span><span id='tok'>the</span><span class='token pointer' id='tok-62-30' style='color:red'>PNF DLL module</span><span id='tok'>then</span><span id='tok'>executes</span><span id='tok'>the</span><span id='tok'>export</span><span id='tok'>as</span><span id='tok'>specified</span><span id='tok'>in</span><span id='tok'>the</span><span id='tok'>configuration</span><span id='tok'>("FILTER").</span><span id='tok'>After</span><span id='tok'>that</span><span id='tok'>it</span><span id='tok'>restores</span><span id='tok'>the</span><span id='tok'>code</span><span id='tok'>of</span><span id='tok'>the</span><span id='tok'>original</span><span id='tok'>entry</span><span id='tok'>point</span><span id='tok'>and</span><span id='tok'>returns</span><span id='tok'>execution</span><span id='tok'>to</span><span id='tok'>the</span><span id='tok'>original</span><span id='tok'>process</span><span id='tok'>module.</span><span id='tok'>The</span><span id='tok'>loader</span><span id='tok'>also</span><span id='tok'>interacts</span><span id='tok'>with</span><span id='tok'>the</span><span id='tok'>driver</span><span id='tok'>module</span><span id='tok'>using</span><span id='tok'>a</span><span class='token pointer' id='tok-62-31' style='color:red'>custom IOCTL code</span><span id='tok'>change</span><span class='token pointer' id='tok-62-32' style='color:red'>memory protection</span><span id='tok'>the</span><span id='tok'>original</span><span id='tok'>entry</span><span id='tok'>point</span><span id='tok'>code.</span></p><p id=p416><span id='tok'>This</span><span id='tok'>module</span><span id='tok'>is</span><span id='tok'>stored</span><span id='tok'>on</span><span id='tok'>disk</span><span id='tok'>as</span><span id='tok'>an</span><span class='token pointer' id='tok-62-33' style='color:red'>encrypted block of data.</span><span id='tok'>soon</span><span id='tok'>as</span><span id='tok'>it</span><span id='tok'>is</span><span id='tok'>decrypted,</span><span id='tok'>it</span><span id='tok'>turns</span><span id='tok'>out</span><span id='tok'>to</span><span id='tok'>be</span><span id='tok'>a</span><span id='tok'>DLL</span><span id='tok'>packed</span><span id='tok'>with</span><span class='token pointer' id='tok-62-34' style='color:red'>UPX.</span><span id='tok'></span><span id='tok'>Known</span><span id='tok'>versions</span><span id='tok'>of</span><span id='tok'>PNF</span><span id='tok'>DLL</span><span id='tok'>modules</span><span id='tok'>export</span><span id='tok'>8</span><span id='tok'>or</span><span id='tok'>6</span><span id='tok'>different</span><span id='tok'>functions</span><span id='tok'>by</span><span id='tok'>ordinal</span><span id='tok'>numbers.</span></p><p id=p460><span class='token pointer' id='tok-62-35' style='color:red'>Export 2</span><span id='tok'>export</span><span id='tok'>6</span><span id='tok'>in</span><span id='tok'>a</span><span id='tok'>separate</span><span id='tok'>process.</span></p><p id=p469><span id='tok'>Export</span><span id='tok'>4</span><span id='tok'>runs</span><span id='tok'>export</span><span id='tok'>5</span><span id='tok'>in</span><span id='tok'>a</span><span id='tok'>separate</span><span id='tok'>process.</span></p><p id=p478><span id='tok'>Export</span><span id='tok'>5</span><span id='tok'>starts</span><span id='tok'>a</span><span id='tok'>thread</span><span id='tok'>in</span><span id='tok'>"services.exe"</span><span id='tok'>process</span><span id='tok'>that</span><span id='tok'>loaded</span><span id='tok'>the</span><span class='token pointer' id='tok-62-36' style='color:red'>302 resource</span><span id='tok'>below)</span><span id='tok'>and,</span><span id='tok'>if</span><span id='tok'>provided</span><span id='tok'>with</span><span id='tok'>correct</span><span id='tok'>information</span><span id='tok'>by</span><span id='tok'>the</span><span id='tok'>callee,</span><span id='tok'>installs</span><span id='tok'>a</span><span id='tok'>complete</span><span id='tok'>new</span><span id='tok'>set</span><span id='tok'>of</span><span id='tok'>Duqu</span><span id='tok'>components.</span></p><p id=p510><span id='tok'>Export</span><span id='tok'>6</span><span id='tok'>stops</span><span id='tok'>the</span><span id='tok'>driver</span><span id='tok'>and</span><span id='tok'>completely</span><span id='tok'>uninstalls</span><span id='tok'>all</span><span id='tok'>components</span><span id='tok'>of</span><span id='tok'>Duqu.</span></p><p id=p522><span id='tok'>Export</span><span id='tok'>8</span><span id='tok'>and</span><span id='tok'>1</span><span id='tok'>initialize</span><span id='tok'>the</span><span id='tok'>PNF</span><span id='tok'>DLL</span><span id='tok'>module</span><span id='tok'>and</span><span id='tok'>start</span><span id='tok'>main</span><span id='tok'>threads.</span></p><p id=p535><span id='tok'>It</span><span id='tok'>seems</span><span id='tok'>that</span><span id='tok'>ordinal</span><span id='tok'>1</span><span class='token pointer' id='tok-62-37' style='color:red'>is</span><span id='tok'>intended</span><span id='tok'>to</span><span id='tok'>export</span><span id='tok'>primary</span><span id='tok'>functionality</span><span id='tok'>of</span><span id='tok'>the</span><span id='tok'>DLL.</span><span id='tok'>First,</span><span id='tok'>it</span><span id='tok'>loads</span><span id='tok'>the</span><span id='tok'>configuration</span><span id='tok'>information</span><span id='tok'>from</span><span id='tok'>another</span><span id='tok'>PNF</span><span id='tok'>file,</span><span id='tok'>the</span><span id='tok'>PNF</span><span class='token pointer' id='tok-62-38' style='color:red'>Config</span><span id='tok'>file.</span><span id='tok'>If</span><span id='tok'>the</span><span id='tok'>file</span><span id='tok'>is</span><span id='tok'>not</span><span id='tok'>present,</span><span id='tok'>it</span><span id='tok'>is</span><span id='tok'>created</span><span id='tok'>from</span><span id='tok'>an</span><span id='tok'>encrypted</span><span id='tok'>hard-coded</span><span id='tok'>copy</span><span id='tok'>that</span><span id='tok'>is</span><span id='tok'>stored</span><span id='tok'>in</span><span id='tok'>the</span><span id='tok'>PNF</span><span id='tok'>DLL</span><span id='tok'>file.</span></p><p id=p585><span id='tok'>The</span><span id='tok'>name</span><span id='tok'>of</span><span id='tok'>the</span><span id='tok'>configuration</span><span id='tok'>file</span><span id='tok'>is</span><span id='tok'>different</span><span id='tok'>for</span><span id='tok'>every</span><span id='tok'>version</span><span id='tok'>of</span><span id='tok'>Duqu.</span><span id='tok'>The</span><span id='tok'>PNF</span><span id='tok'>Config</span><span id='tok'>contains</span><span id='tok'>the</span><span id='tok'>name</span><span id='tok'>and</span><span id='tok'>path</span><span id='tok'>to</span><span id='tok'>the</span><span id='tok'>driver</span><span class='token pointer' id='tok-62-39' style='color:red'>component,</span><span id='tok'>to</span><span id='tok'>the</span><span id='tok'>PNF</span><span id='tok'>DLL</span><span id='tok'>and</span><span id='tok'>PNF</span><span id='tok'>Config</span><span id='tok'>itself.</span></p><p id=p618><span id='tok'>When</span><span id='tok'>the</span><span id='tok'>PNF</span><span id='tok'>Config</span><span id='tok'>is</span><span id='tok'>created,</span><span id='tok'>the</span><span id='tok'>date</span><span id='tok'>of</span><span id='tok'>creation</span><span id='tok'>is</span><span id='tok'>written</span><span id='tok'>into</span><span id='tok'>the</span><span id='tok'>file.</span><span id='tok'>The</span><span id='tok'>file</span><span id='tok'>also</span><span id='tok'>contains</span><span id='tok'>the</span><span class='token pointer' id='tok-62-40' style='color:red'>TTL</span><span id='tok'>("time</span><span id='tok'>to</span><span id='tok'>live")</span><span id='tok'>value:</span><span id='tok'>a</span><span id='tok'>separate</span><span id='tok'>thread</span><span id='tok'>started</span><span id='tok'>by</span><span id='tok'>PNF</span><span id='tok'>DLL</span><span id='tok'>monitors</span><span id='tok'>if</span><span id='tok'>TTL</span><span id='tok'>days</span><span id='tok'>passed</span><span id='tok'>since</span><span id='tok'>the</span><span id='tok'>creation</span><span id='tok'>date,</span><span id='tok'>and</span><span id='tok'>after</span><span id='tok'>that</span><span id='tok'>runs</span><span id='tok'>the</span><span id='tok'>uninstallation</span><span id='tok'>routine.</span></p><p id=p666><span id='tok'>Some</span><span id='tok'>versions</span><span id='tok'>of</span><span id='tok'>the</span><span id='tok'>PNF</span><span id='tok'>DLL</span><span id='tok'>also</span><span id='tok'>start</span><span id='tok'>an</span><span class='token pointer' id='tok-62-41' style='color:red'>RPC server</span><span id='tok'>to</span><span id='tok'>the</span><span id='tok'>one</span><span id='tok'>found</span><span id='tok'>in</span><span class='token pointer' id='tok-62-42' style='color:red'>Stuxnet.</span></p><p id=p684><span id='tok'>The</span><span id='tok'>PNF</span><span id='tok'>DLL</span><span id='tok'>also</span><span id='tok'>provides</span><span class='token pointer' id='tok-62-43' style='color:red'>API</span><span id='tok'>for</span><span id='tok'>manipulating</span><span id='tok'>the</span><span id='tok'>configuration</span><span id='tok'>file</span><span id='tok'>from</span><span class='token pointer' id='tok-62-44' style='color:red'>external modules</span></p><p id=p702><span id='tok'>Depending</span><span id='tok'>on</span><span id='tok'>the</span><span id='tok'>flags</span><span id='tok'>in</span><span id='tok'>the</span><span id='tok'>PNF</span><span id='tok'>Config,</span><span id='tok'>the</span><span id='tok'>PNF</span><span id='tok'>DLL</span><span id='tok'>code</span><span id='tok'>looks</span><span id='tok'>for</span><span id='tok'>specific</span><span id='tok'>processes:</span><span id='tok'>the</span><span id='tok'>list</span><span id='tok'>of</span><span id='tok'>process</span><span id='tok'>names</span><span id='tok'>in</span><span id='tok'>the</span><span id='tok'>PNF</span><span id='tok'>Config,</span><span id='tok'>"explorer.exe",</span><span id='tok'>"svchost.exe"</span><span id='tok'>and</span><span id='tok'>then</span><span id='tok'>injects</span><span id='tok'>code</span><span id='tok'>in</span><span id='tok'>them.</span><span id='tok'>The</span><span id='tok'>code</span><span id='tok'>to</span><span id='tok'>be</span><span id='tok'>injected</span><span id='tok'>is</span><span id='tok'>stored</span><span id='tok'>in</span><span class='token pointer' id='tok-62-45' style='color:red'>binary resource 302</span><span id='tok'>in</span><span id='tok'>PNF</span><span id='tok'>DLL.</span></p><p id=p750><span id='tok'>Depending</span><span id='tok'>on</span><span id='tok'>the</span><span id='tok'>flag</span><span id='tok'>in</span><span id='tok'>the</span><span id='tok'>PNF</span><span id='tok'>configuration</span><span id='tok'>file,</span><span id='tok'>it</span><span id='tok'>is</span><span id='tok'>either</span><span id='tok'>a</span><span id='tok'>DLL</span><span id='tok'>loader</span><span id='tok'>module</span><span id='tok'>or</span><span id='tok'>a</span><span id='tok'>block</span><span id='tok'>of</span><span id='tok'>data</span><span id='tok'>(equivalent</span><span id='tok'>of</span><span class='token pointer' id='tok-62-46' style='color:red'>decompressed ".zdata",</span><span id='tok'>below).</span><span id='tok'>Both</span><span id='tok'>configuration</span><span id='tok'>have</span><span id='tok'>been</span><span id='tok'>found</span><span id='tok'>in</span><span id='tok'>different</span><span id='tok'>Duqu</span><span id='tok'>versions.</span><span id='tok'>The</span><span id='tok'>PNF</span><span id='tok'>DLL</span><span id='tok'>checks</span><span id='tok'>a</span><span id='tok'>flag</span><span id='tok'>in</span><span id='tok'>PNF</span><span id='tok'>Config</span><span id='tok'>and</span><span id='tok'>determines</span><span id='tok'>whether</span><span id='tok'>to</span><span id='tok'>pass</span><span id='tok'>execution</span><span id='tok'>to</span><span id='tok'>the</span><span id='tok'>DLL</span><span id='tok'>loader</span><span id='tok'>or</span><span id='tok'>to</span><span id='tok'>locate</span><span id='tok'>the</span><span class='token pointer' id='tok-62-47' style='color:red'>payload</span><span id='tok'>DLL</span><span id='tok'>and</span><span id='tok'>call</span><span id='tok'>it</span><span id='tok'>directly.</span></p><p id=p815><span id='tok'>The</span><span id='tok'>loader</span><span id='tok'>DLL</span><span id='tok'>module</span><span id='tok'>is</span><span id='tok'>similar</span><span id='tok'>to</span><span id='tok'>PNF</span><span id='tok'>DLL.</span><span id='tok'>The</span><span id='tok'>main</span><span id='tok'>purpose</span><span id='tok'>of</span><span id='tok'>the</span><span id='tok'>loader</span><span id='tok'>is</span><span id='tok'>to</span><span id='tok'>decompress</span><span id='tok'>its</span><span id='tok'>".zdata"</span><span id='tok'>section</span><span id='tok'>and</span><span id='tok'>pass</span><span id='tok'>execution</span><span id='tok'>to</span><span id='tok'>the</span><span id='tok'>main</span><span id='tok'>payload</span><span id='tok'>that</span><span id='tok'>is</span><span id='tok'>contained</span><span id='tok'>in</span><span id='tok'>decompressed</span><span id='tok'>data.</span></p><p id=p849><span id='tok'>The</span><span class='token pointer' id='tok-62-48' style='color:red'>.zdata block</span><span id='tok'>the</span><span id='tok'>header</span><span id='tok'>that</span><span id='tok'>starts</span><span id='tok'>with</span><span id='tok'>the</span><span id='tok'>magic</span><span id='tok'>number</span><span id='tok'>0x48747193.</span><span id='tok'>It</span><span id='tok'>contains</span><span id='tok'>the</span><span id='tok'>offsets</span><span id='tok'>and</span><span id='tok'>sizes</span><span id='tok'>of</span><span id='tok'>the</span><span id='tok'>DLL</span><span id='tok'>loader,</span><span id='tok'>the</span><span id='tok'>payload</span><span id='tok'>configuration</span><span id='tok'>block</span><span id='tok'>and</span><span id='tok'>the</span><span id='tok'>payload</span><span id='tok'>DLL.</span></p><p id=p880></p><p id=p882><span id='tok'>The</span><span id='tok'>configuration</span><span id='tok'>block</span><span id='tok'>contains</span><span id='tok'>the</span><span id='tok'>name</span><span id='tok'>of</span><span id='tok'>the</span><span id='tok'>temporary</span><span id='tok'>file</span><span id='tok'>to</span><span id='tok'>use</span><span id='tok'>%TEMP%~DR0001.tmp,</span><span id='tok'>additional</span><span id='tok'>binary</span><span id='tok'>data</span><span id='tok'>controlling</span><span id='tok'>the</span><span id='tok'>behavior</span><span id='tok'>of</span><span id='tok'>the</span><span id='tok'>payload</span><span id='tok'>and</span><span id='tok'>information</span><span id='tok'>required</span><span id='tok'>to</span><span id='tok'>connect</span><span id='tok'>to</span><span id='tok'>the</span><span class='token pointer' id='tok-62-49' style='color:red'>C&C servers.</span><span id='tok'>are</span><span id='tok'>two</span><span id='tok'>lists</span><span id='tok'>of</span><span class='token pointer' id='tok-62-50' style='color:red'>C&C</span><span id='tok'>servers,</span><span id='tok'>one</span><span id='tok'>can</span><span id='tok'>contain</span><span id='tok'>domain</span><span id='tok'>names,</span><span class='token pointer' id='tok-62-51' style='color:red'>IP addresses</span><span id='tok'>names</span><span id='tok'>of</span><span class='token pointer' id='tok-62-52' style='color:red'>network shares,</span><span id='tok'>the</span><span id='tok'>other</span><span id='tok'>contains</span><span id='tok'>IP</span><span id='tok'>addresses</span><span id='tok'>in</span><span id='tok'>binary</span><span id='tok'>format</span><span id='tok'>and</span><span id='tok'>is</span><span id='tok'>used</span><span id='tok'>to</span><span id='tok'>connect</span><span id='tok'>using</span><span id='tok'>Windows</span><span class='token pointer' id='tok-62-53' style='color:red'>HTTP</span><span class='token pointer' id='tok-62-54' style='color:red'>(winhttp)</span><span id='tok'>services.</span><span id='tok'>Although</span><span id='tok'>the</span><span id='tok'>configuration</span><span id='tok'>blocks</span><span id='tok'>we</span><span id='tok'>have</span><span id='tok'>found</span><span id='tok'>so</span><span id='tok'>far</span><span id='tok'>are</span><span id='tok'>similar</span><span id='tok'>and</span><span id='tok'>are</span><span id='tok'>set</span><span id='tok'>up</span><span id='tok'>to</span><span id='tok'>connect</span><span id='tok'>to</span><span id='tok'>its</span><span id='tok'>C&C</span><span id='tok'>using</span><span id='tok'>HTTP</span><span id='tok'>and</span><span id='tok'>HTTPS,</span><span id='tok'>the</span><span id='tok'>payload</span><span id='tok'>DLL</span><span id='tok'>is</span><span id='tok'>able</span><span id='tok'>to</span><span id='tok'>connect</span><span id='tok'>to</span><span id='tok'>a</span><span id='tok'>network</span><span id='tok'>share</span><span id='tok'>and</span><span id='tok'>even</span><span id='tok'>become</span><span id='tok'>a</span><span id='tok'>server.</span></p><p id=p991><span id='tok'>We</span><span id='tok'>are</span><span id='tok'>still</span><span id='tok'>analyzing</span><span id='tok'>the</span><span id='tok'>payload.</span><span id='tok'>It</span><span id='tok'>contains</span><span id='tok'>256K</span><span id='tok'>of</span><span class='token pointer' id='tok-62-55' style='color:red'>C++ code</span><span id='tok'>extensive</span><span id='tok'>use</span><span id='tok'>of</span><span class='token pointer' id='tok-62-56' style='color:red'>STL</span><span id='tok'>and</span><span id='tok'>its</span><span id='tok'>own</span><span id='tok'>complex</span><span id='tok'>class</span><span id='tok'>hierarchies,</span><span id='tok'>probably</span><span id='tok'>own</span><span id='tok'>framework.</span></p><p id=p1017><span id='tok'>The</span><span id='tok'>payload</span><span id='tok'>is</span><span id='tok'>able</span><span id='tok'>to</span><span id='tok'>connect</span><span id='tok'>to</span><span id='tok'>C&C</span><span id='tok'>server</span><span id='tok'>using</span><span id='tok'>either</span><span id='tok'>winhttp</span><span id='tok'>library</span><span id='tok'>or</span><span id='tok'>connection</span><span id='tok'>to</span><span id='tok'>a</span><span id='tok'>network</span><span id='tok'>share</span><span class='token pointer' id='tok-62-57' style='color:red'>IPC$ endpoint.</span><span id='tok'>is</span><span id='tok'>able</span><span id='tok'>to</span><span id='tok'>connect</span><span id='tok'>using</span><span id='tok'>proxy</span><span id='tok'>server</span><span id='tok'>configuration</span><span id='tok'>of</span><span id='tok'>Internet</span><span id='tok'>Explorer.</span><span id='tok'>It</span><span id='tok'>also</span><span id='tok'>contains</span><span id='tok'>code</span><span id='tok'>for</span><span id='tok'>acting</span><span id='tok'>as</span><span id='tok'>a</span><span id='tok'>HTTP</span><span id='tok'>server</span><span id='tok'>and</span><span id='tok'>processing</span><span id='tok'>the</span><span id='tok'>same</span><span id='tok'>requests</span><span id='tok'>as</span><span id='tok'>served</span><span id='tok'>by</span><span id='tok'>the</span><span id='tok'>C&C.</span></p><p id=p1070><span id='tok'>The</span><span id='tok'>payload</span><span id='tok'>is</span><span id='tok'>able</span><span id='tok'>to</span><span id='tok'>load</span><span id='tok'>an</span><span id='tok'>external</span><span id='tok'>DLL</span><span id='tok'>module</span><span id='tok'>provided</span><span id='tok'>by</span><span id='tok'>the</span><span id='tok'>C&C</span><span id='tok'>and</span><span id='tok'>interact</span><span id='tok'>with</span><span id='tok'>it</span><span id='tok'>using</span><span id='tok'>a</span><span id='tok'>pre-defined</span><span id='tok'>API.</span><span id='tok'>The</span><span id='tok'>most</span><span id='tok'>noticeable</span><span id='tok'>module</span><span id='tok'>discovered</span><span id='tok'>so</span><span id='tok'>far</span><span id='tok'>is</span><span id='tok'>the</span><span class='token pointer' id='tok-62-58' style='color:red'>infostealer module.</span><span id='tok'>are</span><span id='tok'>also</span><span id='tok'>modules</span><span id='tok'>for</span><span id='tok'>updating</span><span id='tok'>the</span><span id='tok'>TTL</span><span id='tok'>value</span><span id='tok'>in</span><span id='tok'>the</span><span id='tok'>PNF</span><span id='tok'>DLL</span><span id='tok'>configuration,</span><span id='tok'>for</span><span id='tok'>reading</span><span id='tok'>the</span><span id='tok'>network</span><span id='tok'>and</span><span id='tok'>disk</span><span id='tok'>storage</span><span id='tok'>configuration</span><span id='tok'>from</span><span id='tok'>the</span><span id='tok'>infected</span><span id='tok'>machine.</span></p><p id=p1129><span id='tok'>It</span><span id='tok'>also</span><span id='tok'>can</span><span id='tok'>form</span><span id='tok'>a</span><span id='tok'>PNF</span><span id='tok'>DLL</span><span id='tok'>with</span><span id='tok'>a</span><span id='tok'>configuration</span><span id='tok'>block</span><span id='tok'>and</span><span id='tok'>the</span><span id='tok'>payload</span><span id='tok'>DLL</span><span id='tok'>ready</span><span id='tok'>for</span><span id='tok'>distribution</span><span id='tok'>to</span><span id='tok'>other</span><span id='tok'>machines.
</span></p>