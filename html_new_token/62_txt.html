<p id=p0><span class='token pointer' id='tok-62-0'>The</span><span class='token pointer' id='tok-62-1' style='color:red'>driver</span><span class='token pointer' id='tok-62-2'>is</span><span class='token pointer' id='tok-62-3'>the</span><span class='token pointer' id='tok-62-4'>first</span><span class='token pointer' id='tok-62-6' style='color:red'>component of</span><span class='token pointer' id='tok-62-7' style='color:red'>to</span><span class='token pointer' id='tok-62-8'>be</span><span class='token pointer' id='tok-62-9'>loaded</span><span class='token pointer' id='tok-62-10'>in</span><span class='token pointer' id='tok-62-11'>the</span><span class='token pointer' id='tok-62-12'>system.</span><span class='token pointer' id='tok-62-13'>As</span><span class='token pointer' id='tok-62-14'>we</span><span class='token pointer' id='tok-62-15'>discovered,</span><span class='token pointer' id='tok-62-16'>the</span><span class='token pointer' id='tok-62-17'>driver</span><span class='token pointer' id='tok-62-18'>and</span><span class='token pointer' id='tok-62-19'>other</span><span class='token pointer' id='tok-62-20'>components</span><span class='token pointer' id='tok-62-21'>of</span><span class='token pointer' id='tok-62-22'>malware</span><span class='token pointer' id='tok-62-23' style='color:red'>are</span><span class='token pointer' id='tok-62-24'>installed</span><span class='token pointer' id='tok-62-25'>with</span><span class='token pointer' id='tok-62-26'>a</span><span class='token pointer' id='tok-62-27'>dropper</span><span class='token pointer' id='tok-62-28' style='color:red'>exploiting</span><span class='token pointer' id='tok-62-29'>a</span><span class='token pointer' id='tok-62-30'>0-day</span><span class='token pointer' id='tok-62-31'>vulnerability</span><span class='token pointer' id='tok-62-32'>(CVE-2011-3402).</span><span class='token pointer' id='tok-62-33' style='color:red'>The</span><span class='token pointer' id='tok-62-34'>driver</span><span class='token pointer' id='tok-62-35'>is</span><span class='token pointer' id='tok-62-36'>registered</span><span class='token pointer' id='tok-62-37'>in</span><span class='token pointer' id='tok-62-38'>the</span><span class='token pointer' id='tok-62-39'>HKLMSystemCurrentControlSetServices</span><span class='token pointer' id='tok-62-42' style='color:red'>path. The</span><span class='token pointer' id='tok-62-43'>name</span><span class='token pointer' id='tok-62-44'>of</span><span class='token pointer' id='tok-62-45'>the</span><span class='token pointer' id='tok-62-46'>registry</span><span class='token pointer' id='tok-62-47'>key</span><span class='token pointer' id='tok-62-49' style='color:red'>varies in</span><span class='token pointer' id='tok-62-50'>versions</span><span class='token pointer' id='tok-62-51'>of</span><span class='token pointer' id='tok-62-52'>Duqu</span><span class='token pointer' id='tok-62-53'>drivers.</span></p><p id=p54><span class='token pointer' id='tok-62-54'>Once</span><span class='token pointer' id='tok-62-55'>the</span><span class='token pointer' id='tok-62-56'>driver</span><span class='token pointer' id='tok-62-57'>is</span><span class='token pointer' id='tok-62-58'>loaded,</span><span class='token pointer' id='tok-62-59'>it</span><span class='token pointer' id='tok-62-60'>decrypts</span><span class='token pointer' id='tok-62-61'>a</span><span class='token pointer' id='tok-62-62'>small</span><span class='token pointer' id='tok-62-63' style='color:red'>block</span><span class='token pointer' id='tok-62-64'>that</span><span class='token pointer' id='tok-62-65'>contains</span><span class='token pointer' id='tok-62-66'>its</span><span class='token pointer' id='tok-62-67'>registry</span><span class='token pointer' id='tok-62-68'>key</span><span class='token pointer' id='tok-62-69'>and</span><span class='token pointer' id='tok-62-70'>the</span><span class='token pointer' id='tok-62-71'>name</span><span class='token pointer' id='tok-62-72'>of</span><span class='token pointer' id='tok-62-73'>the</span><span class='token pointer' id='tok-62-74'>registry</span><span class='token pointer' id='tok-62-75'>value</span><span class='token pointer' id='tok-62-76'>to</span><span class='token pointer' id='tok-62-78' style='color:red'>be read</span><span class='token pointer' id='tok-62-79'>that</span><span class='token pointer' id='tok-62-80'>key.</span><span class='token pointer' id='tok-62-81'>It</span><span class='token pointer' id='tok-62-82'>also</span><span class='token pointer' id='tok-62-83'>contains</span><span class='token pointer' id='tok-62-84'>the</span><span class='token pointer' id='tok-62-85'>name</span><span class='token pointer' id='tok-62-86'>of</span><span class='token pointer' id='tok-62-87'>the</span><span class='token pointer' id='tok-62-88'>driver</span><span class='token pointer' id='tok-62-89'>object</span><span class='token pointer' id='tok-62-90'>to</span><span class='token pointer' id='tok-62-91'>create.</span></p><p id=p92><span class='token pointer' id='tok-62-92'>All</span><span class='token pointer' id='tok-62-93'>versions</span><span class='token pointer' id='tok-62-94'>of</span><span class='token pointer' id='tok-62-95'>the</span><span class='token pointer' id='tok-62-96'>driver</span><span class='token pointer' id='tok-62-97'>available</span><span class='token pointer' id='tok-62-98'>at</span><span class='token pointer' id='tok-62-99'>the</span><span class='token pointer' id='tok-62-100'>moment</span><span class='token pointer' id='tok-62-101'>have</span><span class='token pointer' id='tok-62-102'>the</span><span class='token pointer' id='tok-62-103'>same</span><span class='token pointer' id='tok-62-104'>registry</span><span class='token pointer' id='tok-62-105'>value</span><span class='token pointer' id='tok-62-106'>name,</span><span class='token pointer' id='tok-62-107'>"FILTER".</span></p><p id=p108><span class='token pointer' id='tok-62-108'>The</span><span class='token pointer' id='tok-62-109'>driver</span><span class='token pointer' id='tok-62-110'>then</span><span class='token pointer' id='tok-62-111'>registers</span><span class='token pointer' id='tok-62-112'>the</span><span class='token pointer' id='tok-62-113'>DriverReinitializationRoutine</span><span class='token pointer' id='tok-62-114'>that</span><span class='token pointer' id='tok-62-115'>queues</span><span class='token pointer' id='tok-62-116'>the</span><span class='token pointer' id='tok-62-117' style='color:red'>WorkerRoutine</span><span class='token pointer' id='tok-62-118'>where</span><span class='token pointer' id='tok-62-119'>actual</span><span class='token pointer' id='tok-62-120'>driver</span><span class='token pointer' id='tok-62-121' style='color:red'>initialization</span><span class='token pointer' id='tok-62-122'>is</span><span class='token pointer' id='tok-62-123'>performed.</span><span class='token pointer' id='tok-62-125' style='color:red'>In the</span><span class='token pointer' id='tok-62-126'>the</span><span class='token pointer' id='tok-62-127'>driver</span><span class='token pointer' id='tok-62-128'>reads</span><span class='token pointer' id='tok-62-129'>the</span><span class='token pointer' id='tok-62-130'>"FILTER"</span><span class='token pointer' id='tok-62-131'>value</span><span class='token pointer' id='tok-62-132'>from</span><span class='token pointer' id='tok-62-133'>registry</span><span class='token pointer' id='tok-62-134'>and</span><span class='token pointer' id='tok-62-135'>decrypts</span><span class='token pointer' id='tok-62-136'>it</span><span class='token pointer' id='tok-62-137'>with</span><span class='token pointer' id='tok-62-138'>a</span><span class='token pointer' id='tok-62-139'>hard-coded</span><span class='token pointer' id='tok-62-140'>encryption</span><span class='token pointer' id='tok-62-141'>key.</span><span class='token pointer' id='tok-62-142'>There</span><span class='token pointer' id='tok-62-143'>are</span><span class='token pointer' id='tok-62-145' style='color:red'>two known versions</span><span class='token pointer' id='tok-62-146'>decryption</span><span class='token pointer' id='tok-62-147'>routine</span><span class='token pointer' id='tok-62-148'>and</span><span class='token pointer' id='tok-62-149'>two</span><span class='token pointer' id='tok-62-150'>corresponding</span><span class='token pointer' id='tok-62-151'>decryption</span><span class='token pointer' id='tok-62-152'>keys.</span><span class='token pointer' id='tok-62-154' style='color:red'>The driver</span><span class='token pointer' id='tok-62-155'>locates</span><span class='token pointer' id='tok-62-156'>the</span><span class='token pointer' id='tok-62-157'>NTOSKRNL.EXE</span><span class='token pointer' id='tok-62-159' style='color:red'>or NTKRNLPA.EXE</span><span class='token pointer' id='tok-62-160'>and</span><span class='token pointer' id='tok-62-161'>gets</span><span class='token pointer' id='tok-62-162'>the</span><span class='token pointer' id='tok-62-163'>addresses</span><span class='token pointer' id='tok-62-164'>of</span><span class='token pointer' id='tok-62-165' style='color:red'>API</span><span class='token pointer' id='tok-62-166'>functions</span><span class='token pointer' id='tok-62-168' style='color:red'>further</span><span class='token pointer' id='tok-62-169' style='color:red'>for</span></p><p id=p170><span class='token pointer' id='tok-62-170'>The</span><span class='token pointer' id='tok-62-171'>decrypted</span><span class='token pointer' id='tok-62-172'>"FILTER"</span><span class='token pointer' id='tok-62-173'>value</span><span class='token pointer' id='tok-62-175' style='color:red'>from registry</span><span class='token pointer' id='tok-62-176'>the</span><span class='token pointer' id='tok-62-177'>list</span><span class='token pointer' id='tok-62-178'>of</span><span class='token pointer' id='tok-62-179'>records</span><span class='token pointer' id='tok-62-180' style='color:red'>that</span><span class='token pointer' id='tok-62-181'>contain</span><span class='token pointer' id='tok-62-182'>the</span><span class='token pointer' id='tok-62-183'>name</span><span class='token pointer' id='tok-62-184'>of</span><span class='token pointer' id='tok-62-185'>the</span><span class='token pointer' id='tok-62-186'>process</span><span class='token pointer' id='tok-62-187'>("services.exe"),</span><span class='token pointer' id='tok-62-188'>the</span><span class='token pointer' id='tok-62-189'>path</span><span class='token pointer' id='tok-62-190'>to</span><span class='token pointer' id='tok-62-191'>corresponding</span><span class='token pointer' id='tok-62-192'>PNF</span><span class='token pointer' id='tok-62-193'>DLL</span><span class='token pointer' id='tok-62-194'>file</span><span class='token pointer' id='tok-62-195'>that</span><span class='token pointer' id='tok-62-196'>will</span><span class='token pointer' id='tok-62-197'>be</span><span class='token pointer' id='tok-62-198'>injected</span><span class='token pointer' id='tok-62-199'>in</span><span class='token pointer' id='tok-62-200'>that</span><span class='token pointer' id='tok-62-201'>process</span><span class='token pointer' id='tok-62-203' style='color:red'>and the decryption</span><span class='token pointer' id='tok-62-204'>(0xAE240682)</span><span class='token pointer' id='tok-62-205'>that</span><span class='token pointer' id='tok-62-206'>is</span><span class='token pointer' id='tok-62-207'>used</span><span class='token pointer' id='tok-62-208'>to</span><span class='token pointer' id='tok-62-209'>decrypt</span><span class='token pointer' id='tok-62-210'>the</span><span class='token pointer' id='tok-62-211'>PNF</span><span class='token pointer' id='tok-62-212'>DLL</span><span class='token pointer' id='tok-62-213'>file.</span></p><p id=p214><span class='token pointer' id='tok-62-214'>After</span><span class='token pointer' id='tok-62-215'>initialization</span><span class='token pointer' id='tok-62-216'>the</span><span class='token pointer' id='tok-62-217'>driver</span><span class='token pointer' id='tok-62-218'>registers</span><span class='token pointer' id='tok-62-219'></span><span class='token pointer' id='tok-62-220'>LoadImageNotifyRoutine</span><span class='token pointer' id='tok-62-221'>that</span><span class='token pointer' id='tok-62-222'>will</span><span class='token pointer' id='tok-62-223'>be</span><span class='token pointer' id='tok-62-224'>then</span><span class='token pointer' id='tok-62-225'>called</span><span class='token pointer' id='tok-62-226'>by</span><span class='token pointer' id='tok-62-227'>Windows</span><span class='token pointer' id='tok-62-228'>each</span><span class='token pointer' id='tok-62-229'>time</span><span class='token pointer' id='tok-62-230'>a</span><span class='token pointer' id='tok-62-231'>new</span><span class='token pointer' id='tok-62-232' style='color:red'>module</span><span class='token pointer' id='tok-62-233'>is</span><span class='token pointer' id='tok-62-234'>loaded.</span><span class='token pointer' id='tok-62-235'>The</span><span class='token pointer' id='tok-62-236'>routine</span><span class='token pointer' id='tok-62-237'>checks</span><span class='token pointer' id='tok-62-238'>if</span><span class='token pointer' id='tok-62-239'>the</span><span class='token pointer' id='tok-62-240'>name</span><span class='token pointer' id='tok-62-241'>of</span><span class='token pointer' id='tok-62-242'>image</span><span class='token pointer' id='tok-62-243'>matches</span><span class='token pointer' id='tok-62-244'>one</span><span class='token pointer' id='tok-62-245'>of</span><span class='token pointer' id='tok-62-246'>these</span><span class='token pointer' id='tok-62-247'>specified</span><span class='token pointer' id='tok-62-248'>in</span><span class='token pointer' id='tok-62-249'>"FILTER"</span><span class='token pointer' id='tok-62-250'>value</span><span class='token pointer' id='tok-62-251'>and</span><span class='token pointer' id='tok-62-252'>if</span><span class='token pointer' id='tok-62-253'>it</span><span class='token pointer' id='tok-62-254'>does,</span><span class='token pointer' id='tok-62-255'>starts</span><span class='token pointer' id='tok-62-256'>the</span><span class='token pointer' id='tok-62-257'>injection:</span><span class='token pointer' id='tok-62-258'>it</span><span class='token pointer' id='tok-62-259'>decrypts</span><span class='token pointer' id='tok-62-260'>and</span><span class='token pointer' id='tok-62-261'>copies</span><span class='token pointer' id='tok-62-262'>the</span><span class='token pointer' id='tok-62-263'>PNF</span><span class='token pointer' id='tok-62-264'>DLL</span><span class='token pointer' id='tok-62-265'>file</span><span class='token pointer' id='tok-62-266'>into</span><span class='token pointer' id='tok-62-267'>an</span><span class='token pointer' id='tok-62-268'>allocate</span><span class='token pointer' id='tok-62-269'>memory</span><span class='token pointer' id='tok-62-270'>region</span><span class='token pointer' id='tok-62-271'>on</span><span class='token pointer' id='tok-62-272'>that</span><span class='token pointer' id='tok-62-273'>process.</span><span class='token pointer' id='tok-62-274'>It</span><span class='token pointer' id='tok-62-275'>also</span><span class='token pointer' id='tok-62-276'>builds</span><span class='token pointer' id='tok-62-277'>an</span><span class='token pointer' id='tok-62-278'>copies</span><span class='token pointer' id='tok-62-279'>a</span><span class='token pointer' id='tok-62-281' style='color:red'>stub EXE file</span><span class='token pointer' id='tok-62-282'>that</span><span class='token pointer' id='tok-62-283'>process</span><span class='token pointer' id='tok-62-284'>that</span><span class='token pointer' id='tok-62-285'>is</span><span class='token pointer' id='tok-62-286'>then</span><span class='token pointer' id='tok-62-287'>used</span><span class='token pointer' id='tok-62-288'>as</span><span class='token pointer' id='tok-62-289'>a</span><span class='token pointer' id='tok-62-290'>loader</span><span class='token pointer' id='tok-62-291'>for</span></p><p id=p293><span class='token pointer' id='tok-62-293'>As</span><span class='token pointer' id='tok-62-294'>soon</span><span class='token pointer' id='tok-62-295'>as</span><span class='token pointer' id='tok-62-296'>"KERNEL32.DLL"</span><span class='token pointer' id='tok-62-297'>is</span><span class='token pointer' id='tok-62-298'>loaded</span><span class='token pointer' id='tok-62-299'>in</span><span class='token pointer' id='tok-62-300'>the</span><span class='token pointer' id='tok-62-301'>same</span><span class='token pointer' id='tok-62-302'>process,</span><span class='token pointer' id='tok-62-303'>it</span><span class='token pointer' id='tok-62-304' style='color:red'>locates</span><span class='token pointer' id='tok-62-305'>addresses</span><span class='token pointer' id='tok-62-306'>of</span><span class='token pointer' id='tok-62-307' style='color:red'>API</span><span class='token pointer' id='tok-62-308' style='color:red'>functions</span><span class='token pointer' id='tok-62-309'>required</span><span class='token pointer' id='tok-62-310'>by</span><span class='token pointer' id='tok-62-311'>the</span><span class='token pointer' id='tok-62-312' style='color:red'>loader</span><span class='token pointer' id='tok-62-313'>EXE</span><span class='token pointer' id='tok-62-314'>and</span><span class='token pointer' id='tok-62-315'>modifies</span><span class='token pointer' id='tok-62-316'>the</span><span class='token pointer' id='tok-62-317'>original</span><span class='token pointer' id='tok-62-318'>entry</span><span class='token pointer' id='tok-62-319'>point</span><span class='token pointer' id='tok-62-320'>of</span><span class='token pointer' id='tok-62-321'>the</span><span class='token pointer' id='tok-62-322'>main</span><span class='token pointer' id='tok-62-323'>process</span><span class='token pointer' id='tok-62-324'>module</span><span class='token pointer' id='tok-62-325'>so</span><span class='token pointer' id='tok-62-326'>that</span><span class='token pointer' id='tok-62-327'>it</span><span class='token pointer' id='tok-62-328'>passes</span><span class='token pointer' id='tok-62-329'>execution</span><span class='token pointer' id='tok-62-330'>to</span><span class='token pointer' id='tok-62-331'>the</span><span class='token pointer' id='tok-62-332'>loader</span><span class='token pointer' id='tok-62-333'>EXE</span><span class='token pointer' id='tok-62-334'>code.</span></p><p id=p335><span class='token pointer' id='tok-62-335'>The</span><span class='token pointer' id='tok-62-336'>loader</span><span class='token pointer' id='tok-62-337'>EXE</span><span class='token pointer' id='tok-62-338'>module</span><span class='token pointer' id='tok-62-339'>performs</span><span class='token pointer' id='tok-62-340'>initial</span><span class='token pointer' id='tok-62-341'>initialization</span><span class='token pointer' id='tok-62-342'>of</span><span class='token pointer' id='tok-62-343'>the</span><span class='token pointer' id='tok-62-344'>PNF</span><span class='token pointer' id='tok-62-345'>DLL</span><span class='token pointer' id='tok-62-346'>module</span><span class='token pointer' id='tok-62-347'>and</span><span class='token pointer' id='tok-62-348'>then</span><span class='token pointer' id='tok-62-350' style='color:red'>executes the</span><span class='token pointer' id='tok-62-351'>as</span><span class='token pointer' id='tok-62-352'>specified</span><span class='token pointer' id='tok-62-354' style='color:red'>in the</span><span class='token pointer' id='tok-62-355'>("FILTER").</span><span class='token pointer' id='tok-62-356'>After</span><span class='token pointer' id='tok-62-357'>that</span><span class='token pointer' id='tok-62-358'>it</span><span class='token pointer' id='tok-62-359'>restores</span><span class='token pointer' id='tok-62-361' style='color:red'>the code of</span><span class='token pointer' id='tok-62-362'>original</span><span class='token pointer' id='tok-62-363'>entry</span><span class='token pointer' id='tok-62-364'>point</span><span class='token pointer' id='tok-62-365'>and</span><span class='token pointer' id='tok-62-366'>returns</span><span class='token pointer' id='tok-62-367'>execution</span><span class='token pointer' id='tok-62-368'>to</span><span class='token pointer' id='tok-62-369'>the</span><span class='token pointer' id='tok-62-370'>original</span><span class='token pointer' id='tok-62-371'>process</span><span class='token pointer' id='tok-62-372'>module.</span><span class='token pointer' id='tok-62-373'>The</span><span class='token pointer' id='tok-62-374'>loader</span><span class='token pointer' id='tok-62-375'>also</span><span class='token pointer' id='tok-62-376'>interacts</span><span class='token pointer' id='tok-62-377'>with</span><span class='token pointer' id='tok-62-378'>the</span><span class='token pointer' id='tok-62-379'>driver</span><span class='token pointer' id='tok-62-380'>module</span><span class='token pointer' id='tok-62-381'>using</span><span class='token pointer' id='tok-62-382'>a</span><span class='token pointer' id='tok-62-383'>custom</span><span class='token pointer' id='tok-62-384'>IOCTL</span><span class='token pointer' id='tok-62-385'>code</span><span class='token pointer' id='tok-62-386'>to</span><span class='token pointer' id='tok-62-387'>change</span><span class='token pointer' id='tok-62-388'>memory</span><span class='token pointer' id='tok-62-389'>protection</span><span class='token pointer' id='tok-62-390'>of</span><span class='token pointer' id='tok-62-391'>the</span><span class='token pointer' id='tok-62-392'>original</span><span class='token pointer' id='tok-62-393'>entry</span><span class='token pointer' id='tok-62-394'>point</span><span class='token pointer' id='tok-62-395'>code.</span></p><p id=p396><span class='token pointer' id='tok-62-396'>This</span><span class='token pointer' id='tok-62-397'>module</span><span class='token pointer' id='tok-62-398'>is</span><span class='token pointer' id='tok-62-399'>stored</span><span class='token pointer' id='tok-62-400'>on</span><span class='token pointer' id='tok-62-401'>disk</span><span class='token pointer' id='tok-62-402'>as</span><span class='token pointer' id='tok-62-404' style='color:red'>an encrypted block</span><span class='token pointer' id='tok-62-405'>data.</span><span class='token pointer' id='tok-62-406'>As</span><span class='token pointer' id='tok-62-407'>soon</span><span class='token pointer' id='tok-62-409' style='color:red'>as it</span><span class='token pointer' id='tok-62-410'>decrypted,</span><span class='token pointer' id='tok-62-411'>it</span><span class='token pointer' id='tok-62-412'>turns</span><span class='token pointer' id='tok-62-413'>out</span><span class='token pointer' id='tok-62-414'>to</span><span class='token pointer' id='tok-62-415'>be</span><span class='token pointer' id='tok-62-416'>a</span><span class='token pointer' id='tok-62-417'>DLL</span><span class='token pointer' id='tok-62-418'>packed</span><span class='token pointer' id='tok-62-419'>with</span><span class='token pointer' id='tok-62-420'>UPX.</span><span class='token pointer' id='tok-62-421'></span><span class='token pointer' id='tok-62-422'>Known</span><span class='token pointer' id='tok-62-423'>versions</span><span class='token pointer' id='tok-62-425' style='color:red'>of PNF DLL modules</span><span class='token pointer' id='tok-62-426'>8</span><span class='token pointer' id='tok-62-427'>or</span><span class='token pointer' id='tok-62-428'>6</span><span class='token pointer' id='tok-62-429'>different</span><span class='token pointer' id='tok-62-430'>functions</span><span class='token pointer' id='tok-62-431'>by</span><span class='token pointer' id='tok-62-432'>ordinal</span><span class='token pointer' id='tok-62-433'>numbers.</span></p><p id=p434><span class='token pointer' id='tok-62-434'>Export</span><span class='token pointer' id='tok-62-435'>2</span><span class='token pointer' id='tok-62-436'>runs</span><span class='token pointer' id='tok-62-437'>export</span><span class='token pointer' id='tok-62-438'>6</span><span class='token pointer' id='tok-62-439'>in</span><span class='token pointer' id='tok-62-440'>a</span><span class='token pointer' id='tok-62-441'>separate</span><span class='token pointer' id='tok-62-442'>process.</span></p><p id=p443><span class='token pointer' id='tok-62-443' style='color:red'>Export</span><span class='token pointer' id='tok-62-444'>4</span><span class='token pointer' id='tok-62-445'>runs</span><span class='token pointer' id='tok-62-446'>export</span><span class='token pointer' id='tok-62-447'>5</span><span class='token pointer' id='tok-62-448'>in</span><span class='token pointer' id='tok-62-449'>a</span><span class='token pointer' id='tok-62-450'>separate</span><span class='token pointer' id='tok-62-451'>process.</span></p><p id=p452><span class='token pointer' id='tok-62-452'>Export</span><span class='token pointer' id='tok-62-453'>5</span><span class='token pointer' id='tok-62-454'>starts</span><span class='token pointer' id='tok-62-455'>a</span><span class='token pointer' id='tok-62-456'>thread</span><span class='token pointer' id='tok-62-457'>in</span><span class='token pointer' id='tok-62-458'>"services.exe"</span><span class='token pointer' id='tok-62-459'>process</span><span class='token pointer' id='tok-62-461' style='color:red'>that loaded</span><span class='token pointer' id='tok-62-462'>302</span><span class='token pointer' id='tok-62-463'>resource</span><span class='token pointer' id='tok-62-464'>(see</span><span class='token pointer' id='tok-62-465'>below)</span><span class='token pointer' id='tok-62-466'>and,</span><span class='token pointer' id='tok-62-467'>if</span><span class='token pointer' id='tok-62-468'>provided</span><span class='token pointer' id='tok-62-469'>with</span><span class='token pointer' id='tok-62-470'>correct</span><span class='token pointer' id='tok-62-471'>information</span><span class='token pointer' id='tok-62-472'>by</span><span class='token pointer' id='tok-62-473'>the</span><span class='token pointer' id='tok-62-474'>callee,</span><span class='token pointer' id='tok-62-475'>installs</span><span class='token pointer' id='tok-62-476'>a</span><span class='token pointer' id='tok-62-477'>complete</span><span class='token pointer' id='tok-62-478'>new</span><span class='token pointer' id='tok-62-479'>set</span><span class='token pointer' id='tok-62-480'>of</span><span class='token pointer' id='tok-62-481'>Duqu</span><span class='token pointer' id='tok-62-482'>components.</span></p><p id=p483><span class='token pointer' id='tok-62-483'>Export</span><span class='token pointer' id='tok-62-484'>6</span><span class='token pointer' id='tok-62-485'>stops</span><span class='token pointer' id='tok-62-486'>the</span><span class='token pointer' id='tok-62-487'>driver</span><span class='token pointer' id='tok-62-488'>and</span><span class='token pointer' id='tok-62-490' style='color:red'>completely uninstalls</span><span class='token pointer' id='tok-62-491'>components</span><span class='token pointer' id='tok-62-492'>of</span><span class='token pointer' id='tok-62-493'>Duqu.</span></p><p id=p494><span class='token pointer' id='tok-62-494'>Export</span><span class='token pointer' id='tok-62-495'>8</span><span class='token pointer' id='tok-62-496'>and</span><span class='token pointer' id='tok-62-497'>1</span><span class='token pointer' id='tok-62-498'>initialize</span><span class='token pointer' id='tok-62-499'>the</span><span class='token pointer' id='tok-62-500'>PNF</span><span class='token pointer' id='tok-62-501'>DLL</span><span class='token pointer' id='tok-62-502'>module</span><span class='token pointer' id='tok-62-503'>and</span><span class='token pointer' id='tok-62-504'>start</span><span class='token pointer' id='tok-62-505'>main</span><span class='token pointer' id='tok-62-506'>threads.</span></p><p id=p507><span class='token pointer' id='tok-62-507'>It</span><span class='token pointer' id='tok-62-508'>seems</span><span class='token pointer' id='tok-62-509'>that</span><span class='token pointer' id='tok-62-510'>ordinal</span><span class='token pointer' id='tok-62-511'>1</span><span class='token pointer' id='tok-62-512'>is</span><span class='token pointer' id='tok-62-513'>intended</span><span class='token pointer' id='tok-62-514'>to</span><span class='token pointer' id='tok-62-515'>export</span><span class='token pointer' id='tok-62-516'>primary</span><span class='token pointer' id='tok-62-517'>functionality</span><span class='token pointer' id='tok-62-518'>of</span><span class='token pointer' id='tok-62-519'>the</span><span class='token pointer' id='tok-62-520'>DLL.</span><span class='token pointer' id='tok-62-521'>First,</span><span class='token pointer' id='tok-62-522'>it</span><span class='token pointer' id='tok-62-523'>loads</span><span class='token pointer' id='tok-62-524'>the</span><span class='token pointer' id='tok-62-525'>configuration</span><span class='token pointer' id='tok-62-526'>information</span><span class='token pointer' id='tok-62-527'>from</span><span class='token pointer' id='tok-62-528'>another</span><span class='token pointer' id='tok-62-529'>PNF</span><span class='token pointer' id='tok-62-530'>file,</span><span class='token pointer' id='tok-62-531'>the</span><span class='token pointer' id='tok-62-532'>PNF</span><span class='token pointer' id='tok-62-533'>Config</span><span class='token pointer' id='tok-62-534'>file.</span><span class='token pointer' id='tok-62-535'>If</span><span class='token pointer' id='tok-62-536'>the</span><span class='token pointer' id='tok-62-537'>file</span><span class='token pointer' id='tok-62-538'>is</span><span class='token pointer' id='tok-62-539'>not</span><span class='token pointer' id='tok-62-540' style='color:red'>present,</span><span class='token pointer' id='tok-62-541'>it</span><span class='token pointer' id='tok-62-542'>is</span><span class='token pointer' id='tok-62-543'>created</span><span class='token pointer' id='tok-62-544'>from</span><span class='token pointer' id='tok-62-545'>an</span><span class='token pointer' id='tok-62-546'>encrypted</span><span class='token pointer' id='tok-62-547'>hard-coded</span><span class='token pointer' id='tok-62-548'>copy</span><span class='token pointer' id='tok-62-549'>that</span><span class='token pointer' id='tok-62-550'>is</span><span class='token pointer' id='tok-62-551'>stored</span><span class='token pointer' id='tok-62-552'>in</span><span class='token pointer' id='tok-62-553'>the</span><span class='token pointer' id='tok-62-554'>PNF</span><span class='token pointer' id='tok-62-555'>DLL</span><span class='token pointer' id='tok-62-556'>file.</span></p><p id=p557><span class='token pointer' id='tok-62-557'>The</span><span class='token pointer' id='tok-62-558'>name</span><span class='token pointer' id='tok-62-559'>of</span><span class='token pointer' id='tok-62-560'>the</span><span class='token pointer' id='tok-62-561' style='color:red'>configuration</span><span class='token pointer' id='tok-62-562'>file</span><span class='token pointer' id='tok-62-563'>is</span><span class='token pointer' id='tok-62-564'>different</span><span class='token pointer' id='tok-62-565'>for</span><span class='token pointer' id='tok-62-566'>every</span><span class='token pointer' id='tok-62-567'>version</span><span class='token pointer' id='tok-62-568'>of</span><span class='token pointer' id='tok-62-569'>Duqu.</span><span class='token pointer' id='tok-62-570'>The</span><span class='token pointer' id='tok-62-571'>PNF</span><span class='token pointer' id='tok-62-572'>Config</span><span class='token pointer' id='tok-62-573'>contains</span><span class='token pointer' id='tok-62-574'>the</span><span class='token pointer' id='tok-62-575'>name</span><span class='token pointer' id='tok-62-576'>and</span><span class='token pointer' id='tok-62-577'>path</span><span class='token pointer' id='tok-62-578'>to</span><span class='token pointer' id='tok-62-579'>the</span><span class='token pointer' id='tok-62-580'>driver</span><span class='token pointer' id='tok-62-581'>component,</span><span class='token pointer' id='tok-62-582'>to</span><span class='token pointer' id='tok-62-583'>the</span><span class='token pointer' id='tok-62-584'>PNF</span><span class='token pointer' id='tok-62-585'>DLL</span><span class='token pointer' id='tok-62-586'>and</span><span class='token pointer' id='tok-62-587'>PNF</span><span class='token pointer' id='tok-62-588'>Config</span><span class='token pointer' id='tok-62-589'>itself.</span></p><p id=p590><span class='token pointer' id='tok-62-590'>When</span><span class='token pointer' id='tok-62-591'>the</span><span class='token pointer' id='tok-62-592'>PNF</span><span class='token pointer' id='tok-62-593'>Config</span><span class='token pointer' id='tok-62-594'>is</span><span class='token pointer' id='tok-62-595'>created,</span><span class='token pointer' id='tok-62-596'>the</span><span class='token pointer' id='tok-62-597'>date</span><span class='token pointer' id='tok-62-598'>of</span><span class='token pointer' id='tok-62-599'>creation</span><span class='token pointer' id='tok-62-600'>is</span><span class='token pointer' id='tok-62-601'>written</span><span class='token pointer' id='tok-62-602'>into</span><span class='token pointer' id='tok-62-603'>the</span><span class='token pointer' id='tok-62-604'>file.</span><span class='token pointer' id='tok-62-605'>The</span><span class='token pointer' id='tok-62-606'>file</span><span class='token pointer' id='tok-62-607'>also</span><span class='token pointer' id='tok-62-608'>contains</span><span class='token pointer' id='tok-62-609' style='color:red'>the</span><span class='token pointer' id='tok-62-610'>TTL</span><span class='token pointer' id='tok-62-611'>("time</span><span class='token pointer' id='tok-62-612'>to</span><span class='token pointer' id='tok-62-613'>live")</span><span class='token pointer' id='tok-62-614'>value:</span><span class='token pointer' id='tok-62-615'>a</span><span class='token pointer' id='tok-62-616'>separate</span><span class='token pointer' id='tok-62-617'>thread</span><span class='token pointer' id='tok-62-618'>started</span><span class='token pointer' id='tok-62-619'>by</span><span class='token pointer' id='tok-62-620'>PNF</span><span class='token pointer' id='tok-62-621'>DLL</span><span class='token pointer' id='tok-62-622'>monitors</span><span class='token pointer' id='tok-62-623'>if</span><span class='token pointer' id='tok-62-624'>TTL</span><span class='token pointer' id='tok-62-625'>days</span><span class='token pointer' id='tok-62-626'>passed</span><span class='token pointer' id='tok-62-627'>since</span><span class='token pointer' id='tok-62-628'>the</span><span class='token pointer' id='tok-62-629'>creation</span><span class='token pointer' id='tok-62-630'>date,</span><span class='token pointer' id='tok-62-631'>and</span><span class='token pointer' id='tok-62-632'>after</span><span class='token pointer' id='tok-62-633'>that</span><span class='token pointer' id='tok-62-634'>runs</span><span class='token pointer' id='tok-62-635'>the</span><span class='token pointer' id='tok-62-636'>uninstallation</span><span class='token pointer' id='tok-62-637'>routine.</span></p><p id=p638><span class='token pointer' id='tok-62-638' style='color:red'>Some</span><span class='token pointer' id='tok-62-639'>versions</span><span class='token pointer' id='tok-62-640'>of</span><span class='token pointer' id='tok-62-641'>the</span><span class='token pointer' id='tok-62-642'>PNF</span><span class='token pointer' id='tok-62-643'>DLL</span><span class='token pointer' id='tok-62-644'>also</span><span class='token pointer' id='tok-62-645'>start</span><span class='token pointer' id='tok-62-646'>an</span><span class='token pointer' id='tok-62-647'>RPC</span><span class='token pointer' id='tok-62-648'>server</span><span class='token pointer' id='tok-62-649'>similar</span><span class='token pointer' id='tok-62-650'>to</span><span class='token pointer' id='tok-62-651'>the</span><span class='token pointer' id='tok-62-652'>one</span><span class='token pointer' id='tok-62-653'>found</span><span class='token pointer' id='tok-62-654'>in</span><span class='token pointer' id='tok-62-655'>Stuxnet.</span></p><p id=p656><span class='token pointer' id='tok-62-656'>The</span><span class='token pointer' id='tok-62-657'>PNF</span><span class='token pointer' id='tok-62-658'>DLL</span><span class='token pointer' id='tok-62-659'>also</span><span class='token pointer' id='tok-62-660'>provides</span><span class='token pointer' id='tok-62-661'>API</span><span class='token pointer' id='tok-62-662'>for</span><span class='token pointer' id='tok-62-663'>manipulating</span><span class='token pointer' id='tok-62-664'>the</span><span class='token pointer' id='tok-62-665'>configuration</span><span class='token pointer' id='tok-62-666'>file</span><span class='token pointer' id='tok-62-667'>from</span><span class='token pointer' id='tok-62-668'>external</span><span class='token pointer' id='tok-62-669'>modules</span><span class='token pointer' id='tok-62-670'>using</span><span class='token pointer' id='tok-62-671'>globally</span><span class='token pointer' id='tok-62-672'>available</span><span class='token pointer' id='tok-62-673'>events.</span></p><p id=p674><span class='token pointer' id='tok-62-674'>Depending</span><span class='token pointer' id='tok-62-676' style='color:red'>on the</span><span class='token pointer' id='tok-62-677'>in</span><span class='token pointer' id='tok-62-678'>the</span><span class='token pointer' id='tok-62-679'>PNF</span><span class='token pointer' id='tok-62-680'>Config,</span><span class='token pointer' id='tok-62-681'>the</span><span class='token pointer' id='tok-62-682'>PNF</span><span class='token pointer' id='tok-62-683' style='color:red'>DLL</span><span class='token pointer' id='tok-62-684'>code</span><span class='token pointer' id='tok-62-685'>looks</span><span class='token pointer' id='tok-62-686'>for</span><span class='token pointer' id='tok-62-687'>specific</span><span class='token pointer' id='tok-62-688'>processes:</span><span class='token pointer' id='tok-62-689' style='color:red'>the</span><span class='token pointer' id='tok-62-690'>list</span><span class='token pointer' id='tok-62-691'>of</span><span class='token pointer' id='tok-62-692'>process</span><span class='token pointer' id='tok-62-693'>names</span><span class='token pointer' id='tok-62-694'>in</span><span class='token pointer' id='tok-62-695'>the</span><span class='token pointer' id='tok-62-697' style='color:red'>PNF Config,</span><span class='token pointer' id='tok-62-698'>"svchost.exe"</span><span class='token pointer' id='tok-62-700' style='color:red'>and then injects</span><span class='token pointer' id='tok-62-701'>in</span><span class='token pointer' id='tok-62-702'>them.</span><span class='token pointer' id='tok-62-703'>The</span><span class='token pointer' id='tok-62-704'>code</span><span class='token pointer' id='tok-62-705'>to</span><span class='token pointer' id='tok-62-706'>be</span><span class='token pointer' id='tok-62-707'>injected</span><span class='token pointer' id='tok-62-708'>is</span><span class='token pointer' id='tok-62-709'>stored</span><span class='token pointer' id='tok-62-710'>in</span><span class='token pointer' id='tok-62-711'>binary</span><span class='token pointer' id='tok-62-712'>resource</span><span class='token pointer' id='tok-62-713'>302</span><span class='token pointer' id='tok-62-714'>found</span><span class='token pointer' id='tok-62-715'>in</span><span class='token pointer' id='tok-62-716'>PNF</span><span class='token pointer' id='tok-62-717'>DLL.</span></p><p id=p718><span class='token pointer' id='tok-62-718'>Depending</span><span class='token pointer' id='tok-62-719'>on</span><span class='token pointer' id='tok-62-720'>the</span><span class='token pointer' id='tok-62-721'>flag</span><span class='token pointer' id='tok-62-722'>in</span><span class='token pointer' id='tok-62-723'>the</span><span class='token pointer' id='tok-62-724'>PNF</span><span class='token pointer' id='tok-62-725'>configuration</span><span class='token pointer' id='tok-62-726'>file,</span><span class='token pointer' id='tok-62-727'>it</span><span class='token pointer' id='tok-62-728'>is</span><span class='token pointer' id='tok-62-729'>either</span><span class='token pointer' id='tok-62-730'>a</span><span class='token pointer' id='tok-62-731'>DLL</span><span class='token pointer' id='tok-62-732'>loader</span><span class='token pointer' id='tok-62-733'>module</span><span class='token pointer' id='tok-62-734'>or</span><span class='token pointer' id='tok-62-735'>a</span><span class='token pointer' id='tok-62-736'>block</span><span class='token pointer' id='tok-62-737'>of</span><span class='token pointer' id='tok-62-738'>data</span><span class='token pointer' id='tok-62-739'>(equivalent</span><span class='token pointer' id='tok-62-740'>of</span><span class='token pointer' id='tok-62-741'>decompressed</span><span class='token pointer' id='tok-62-742'>".zdata",</span><span class='token pointer' id='tok-62-744' style='color:red'>see below). Both</span><span class='token pointer' id='tok-62-745'>have</span><span class='token pointer' id='tok-62-746'>been</span><span class='token pointer' id='tok-62-747'>found</span><span class='token pointer' id='tok-62-748'>in</span><span class='token pointer' id='tok-62-749'>different</span><span class='token pointer' id='tok-62-750'>Duqu</span><span class='token pointer' id='tok-62-751'>versions.</span><span class='token pointer' id='tok-62-752'>The</span><span class='token pointer' id='tok-62-753'>PNF</span><span class='token pointer' id='tok-62-754'>DLL</span><span class='token pointer' id='tok-62-755'>checks</span><span class='token pointer' id='tok-62-756'>a</span><span class='token pointer' id='tok-62-757'>flag</span><span class='token pointer' id='tok-62-758'>in</span><span class='token pointer' id='tok-62-759'>PNF</span><span class='token pointer' id='tok-62-760'>Config</span><span class='token pointer' id='tok-62-761'>and</span><span class='token pointer' id='tok-62-762'>determines</span><span class='token pointer' id='tok-62-763'>whether</span><span class='token pointer' id='tok-62-764'>to</span><span class='token pointer' id='tok-62-765'>pass</span><span class='token pointer' id='tok-62-766'>execution</span><span class='token pointer' id='tok-62-767'>to</span><span class='token pointer' id='tok-62-768'>the</span><span class='token pointer' id='tok-62-769'>DLL</span><span class='token pointer' id='tok-62-770'>loader</span><span class='token pointer' id='tok-62-771'>or</span><span class='token pointer' id='tok-62-772'>to</span><span class='token pointer' id='tok-62-774' style='color:red'>locate the</span><span class='token pointer' id='tok-62-775'>DLL</span><span class='token pointer' id='tok-62-776'>and</span><span class='token pointer' id='tok-62-777'>call</span><span class='token pointer' id='tok-62-778'>it</span><span class='token pointer' id='tok-62-779'>directly.</span></p><p id=p780><span class='token pointer' id='tok-62-780'>The</span><span class='token pointer' id='tok-62-781'>loader</span><span class='token pointer' id='tok-62-782'>DLL</span><span class='token pointer' id='tok-62-783'>module</span><span class='token pointer' id='tok-62-784'>is</span><span class='token pointer' id='tok-62-785'>similar</span><span class='token pointer' id='tok-62-786'>to</span><span class='token pointer' id='tok-62-787'>PNF</span><span class='token pointer' id='tok-62-788'>DLL.</span><span class='token pointer' id='tok-62-789'>The</span><span class='token pointer' id='tok-62-790'>main</span><span class='token pointer' id='tok-62-791'>purpose</span><span class='token pointer' id='tok-62-792'>of</span><span class='token pointer' id='tok-62-793'>the</span><span class='token pointer' id='tok-62-794'>loader</span><span class='token pointer' id='tok-62-795'>is</span><span class='token pointer' id='tok-62-796'>to</span><span class='token pointer' id='tok-62-797'>decompress</span><span class='token pointer' id='tok-62-798'>its</span><span class='token pointer' id='tok-62-799'>".zdata"</span><span class='token pointer' id='tok-62-800'>section</span><span class='token pointer' id='tok-62-801'>and</span><span class='token pointer' id='tok-62-802'>pass</span><span class='token pointer' id='tok-62-803'>execution</span><span class='token pointer' id='tok-62-804'>to</span><span class='token pointer' id='tok-62-805'>the</span><span class='token pointer' id='tok-62-806'>main</span><span class='token pointer' id='tok-62-807'>payload</span><span class='token pointer' id='tok-62-808'>that</span><span class='token pointer' id='tok-62-809' style='color:red'>is</span><span class='token pointer' id='tok-62-810'>contained</span><span class='token pointer' id='tok-62-811'>in</span><span class='token pointer' id='tok-62-812'>decompressed</span><span class='token pointer' id='tok-62-813'>data.</span></p><p id=p814><span class='token pointer' id='tok-62-814'>The</span><span class='token pointer' id='tok-62-815'>.zdata</span><span class='token pointer' id='tok-62-816'>block</span><span class='token pointer' id='tok-62-817'>contains</span><span class='token pointer' id='tok-62-818'>the</span><span class='token pointer' id='tok-62-819'>header</span><span class='token pointer' id='tok-62-820'>that</span><span class='token pointer' id='tok-62-821'>starts</span><span class='token pointer' id='tok-62-822'>with</span><span class='token pointer' id='tok-62-823'>the</span><span class='token pointer' id='tok-62-824'>magic</span><span class='token pointer' id='tok-62-825'>number</span><span class='token pointer' id='tok-62-826'>0x48747193.</span><span class='token pointer' id='tok-62-827'>It</span><span class='token pointer' id='tok-62-828'>contains</span><span class='token pointer' id='tok-62-829'>the</span><span class='token pointer' id='tok-62-830'>offsets</span><span class='token pointer' id='tok-62-831'>and</span><span class='token pointer' id='tok-62-832'>sizes</span><span class='token pointer' id='tok-62-833'>of</span><span class='token pointer' id='tok-62-834'>the</span><span class='token pointer' id='tok-62-835'>DLL</span><span class='token pointer' id='tok-62-836'>loader,</span><span class='token pointer' id='tok-62-837'>the</span><span class='token pointer' id='tok-62-838'>payload</span><span class='token pointer' id='tok-62-839'>configuration</span><span class='token pointer' id='tok-62-840'>block</span><span class='token pointer' id='tok-62-841'>and</span><span class='token pointer' id='tok-62-842'>the</span><span class='token pointer' id='tok-62-843'>payload</span><span class='token pointer' id='tok-62-844'>DLL.</span></p><p id=p845><span class='token pointer' id='tok-62-845'>Configuration</span><span class='token pointer' id='tok-62-846'>block</span></p><p id=p847><span class='token pointer' id='tok-62-847'>The</span><span class='token pointer' id='tok-62-848'>configuration</span><span class='token pointer' id='tok-62-849'>block</span><span class='token pointer' id='tok-62-851' style='color:red'>contains the</span><span class='token pointer' id='tok-62-852'>of</span><span class='token pointer' id='tok-62-853'>the</span><span class='token pointer' id='tok-62-854'>temporary</span><span class='token pointer' id='tok-62-855'>file</span><span class='token pointer' id='tok-62-856'>to</span><span class='token pointer' id='tok-62-857'>use</span><span class='token pointer' id='tok-62-858'>%TEMP%~DR0001.tmp,</span><span class='token pointer' id='tok-62-859'>additional</span><span class='token pointer' id='tok-62-860'>binary</span><span class='token pointer' id='tok-62-861'>data</span><span class='token pointer' id='tok-62-862'>controlling</span><span class='token pointer' id='tok-62-863'>the</span><span class='token pointer' id='tok-62-864'>behavior</span><span class='token pointer' id='tok-62-865'>of</span><span class='token pointer' id='tok-62-866'>the</span><span class='token pointer' id='tok-62-867'>payload</span><span class='token pointer' id='tok-62-868'>and</span><span class='token pointer' id='tok-62-869'>information</span><span class='token pointer' id='tok-62-870'>required</span><span class='token pointer' id='tok-62-871'>to</span><span class='token pointer' id='tok-62-872'>connect</span><span class='token pointer' id='tok-62-873'>to</span><span class='token pointer' id='tok-62-874'>the</span><span class='token pointer' id='tok-62-875'>C&C</span><span class='token pointer' id='tok-62-876'>servers.</span><span class='token pointer' id='tok-62-877'>There</span><span class='token pointer' id='tok-62-878'>are</span><span class='token pointer' id='tok-62-879'>two</span><span class='token pointer' id='tok-62-881' style='color:red'>lists of</span><span class='token pointer' id='tok-62-882'>servers,</span><span class='token pointer' id='tok-62-883'>one</span><span class='token pointer' id='tok-62-884'>can</span><span class='token pointer' id='tok-62-885'>contain</span><span class='token pointer' id='tok-62-886'>domain</span><span class='token pointer' id='tok-62-887'>names,</span><span class='token pointer' id='tok-62-888'>IP</span><span class='token pointer' id='tok-62-889'>addresses</span><span class='token pointer' id='tok-62-890'>or</span><span class='token pointer' id='tok-62-891'>names</span><span class='token pointer' id='tok-62-892'>of</span><span class='token pointer' id='tok-62-893'>network</span><span class='token pointer' id='tok-62-894'>shares,</span><span class='token pointer' id='tok-62-895'>and</span><span class='token pointer' id='tok-62-896'>the</span><span class='token pointer' id='tok-62-897'>other</span><span class='token pointer' id='tok-62-898'>contains</span><span class='token pointer' id='tok-62-899'>IP</span><span class='token pointer' id='tok-62-900'>addresses</span><span class='token pointer' id='tok-62-901'>in</span><span class='token pointer' id='tok-62-902'>binary</span><span class='token pointer' id='tok-62-903'>format</span><span class='token pointer' id='tok-62-904'>and</span><span class='token pointer' id='tok-62-905'>is</span><span class='token pointer' id='tok-62-906'>used</span><span class='token pointer' id='tok-62-907'>to</span><span class='token pointer' id='tok-62-908'>connect</span><span class='token pointer' id='tok-62-909'>using</span><span class='token pointer' id='tok-62-910'>Windows</span><span class='token pointer' id='tok-62-912' style='color:red'>HTTP (winhttp)</span><span class='token pointer' id='tok-62-913'>Although</span><span class='token pointer' id='tok-62-914'>the</span><span class='token pointer' id='tok-62-915'>configuration</span><span class='token pointer' id='tok-62-916'>blocks</span><span class='token pointer' id='tok-62-917'>we</span><span class='token pointer' id='tok-62-918' style='color:red'>have</span><span class='token pointer' id='tok-62-919'>found</span><span class='token pointer' id='tok-62-920'>so</span><span class='token pointer' id='tok-62-921'>far</span><span class='token pointer' id='tok-62-922'>are</span><span class='token pointer' id='tok-62-923'>similar</span><span class='token pointer' id='tok-62-924'>and</span><span class='token pointer' id='tok-62-926' style='color:red'>are set</span><span class='token pointer' id='tok-62-927'>to</span><span class='token pointer' id='tok-62-928'>connect</span><span class='token pointer' id='tok-62-929'>to</span><span class='token pointer' id='tok-62-931' style='color:red'>its C&C</span><span class='token pointer' id='tok-62-932'>HTTP</span><span class='token pointer' id='tok-62-933'>and</span><span class='token pointer' id='tok-62-934'>HTTPS,</span><span class='token pointer' id='tok-62-935'>the</span><span class='token pointer' id='tok-62-936'>payload</span><span class='token pointer' id='tok-62-937'>DLL</span><span class='token pointer' id='tok-62-938'>is</span><span class='token pointer' id='tok-62-939'>able</span><span class='token pointer' id='tok-62-940'>to</span><span class='token pointer' id='tok-62-941'>connect</span><span class='token pointer' id='tok-62-942'>to</span><span class='token pointer' id='tok-62-943'>a</span><span class='token pointer' id='tok-62-944'>network</span><span class='token pointer' id='tok-62-945'>share</span><span class='token pointer' id='tok-62-946'>and</span><span class='token pointer' id='tok-62-947'>even</span><span class='token pointer' id='tok-62-948' style='color:red'>become</span><span class='token pointer' id='tok-62-949' style='color:red'>a</span><span class='token pointer' id='tok-62-950'>server.</span></p><p id=p951><span class='token pointer' id='tok-62-951'>We</span><span class='token pointer' id='tok-62-952'>are</span><span class='token pointer' id='tok-62-953'>still</span><span class='token pointer' id='tok-62-954'>analyzing</span><span class='token pointer' id='tok-62-955'>the</span><span class='token pointer' id='tok-62-956'>payload.</span><span class='token pointer' id='tok-62-957'>It</span><span class='token pointer' id='tok-62-958'>contains</span><span class='token pointer' id='tok-62-959'>256K</span><span class='token pointer' id='tok-62-960'>of</span><span class='token pointer' id='tok-62-961'>C++</span><span class='token pointer' id='tok-62-962'>code</span><span class='token pointer' id='tok-62-963'>with</span><span class='token pointer' id='tok-62-964'>extensive</span><span class='token pointer' id='tok-62-965'>use</span><span class='token pointer' id='tok-62-966'>of</span><span class='token pointer' id='tok-62-967'>STL</span><span class='token pointer' id='tok-62-968'>and</span><span class='token pointer' id='tok-62-969'>its</span><span class='token pointer' id='tok-62-970'>own</span><span class='token pointer' id='tok-62-971'>complex</span><span class='token pointer' id='tok-62-972'>class</span><span class='token pointer' id='tok-62-973'>hierarchies,</span><span class='token pointer' id='tok-62-974'>probably</span><span class='token pointer' id='tok-62-975'>own</span><span class='token pointer' id='tok-62-976'>framework.</span></p><p id=p977><span class='token pointer' id='tok-62-977'>The</span><span class='token pointer' id='tok-62-978'>payload</span><span class='token pointer' id='tok-62-979'>is</span><span class='token pointer' id='tok-62-980'>able</span><span class='token pointer' id='tok-62-981'>to</span><span class='token pointer' id='tok-62-982'>connect</span><span class='token pointer' id='tok-62-983'>to</span><span class='token pointer' id='tok-62-984'>C&C</span><span class='token pointer' id='tok-62-985'>server</span><span class='token pointer' id='tok-62-986'>using</span><span class='token pointer' id='tok-62-987'>either</span><span class='token pointer' id='tok-62-988'>winhttp</span><span class='token pointer' id='tok-62-989'>library</span><span class='token pointer' id='tok-62-990'>or</span><span class='token pointer' id='tok-62-991'>connection</span><span class='token pointer' id='tok-62-992'>to</span><span class='token pointer' id='tok-62-993'>a</span><span class='token pointer' id='tok-62-994'>network</span><span class='token pointer' id='tok-62-995'>share</span><span class='token pointer' id='tok-62-996'>IPC$</span><span class='token pointer' id='tok-62-997'>endpoint.</span><span class='token pointer' id='tok-62-998'>It</span><span class='token pointer' id='tok-62-999'>is</span><span class='token pointer' id='tok-62-1000'>able</span><span class='token pointer' id='tok-62-1002' style='color:red'>to connect</span><span class='token pointer' id='tok-62-1003'>proxy</span><span class='token pointer' id='tok-62-1004'>server</span><span class='token pointer' id='tok-62-1005'>configuration</span><span class='token pointer' id='tok-62-1006'>of</span><span class='token pointer' id='tok-62-1007' style='color:red'>Internet</span><span class='token pointer' id='tok-62-1008'>Explorer.</span><span class='token pointer' id='tok-62-1009'>It</span><span class='token pointer' id='tok-62-1010'>also</span><span class='token pointer' id='tok-62-1011'>contains</span><span class='token pointer' id='tok-62-1012'>code</span><span class='token pointer' id='tok-62-1013'>for</span><span class='token pointer' id='tok-62-1014'>acting</span><span class='token pointer' id='tok-62-1015'>as</span><span class='token pointer' id='tok-62-1016'>a</span><span class='token pointer' id='tok-62-1017'>HTTP</span><span class='token pointer' id='tok-62-1018'>server</span><span class='token pointer' id='tok-62-1019'>and</span><span class='token pointer' id='tok-62-1020'>processing</span><span class='token pointer' id='tok-62-1021'>the</span><span class='token pointer' id='tok-62-1022'>same</span><span class='token pointer' id='tok-62-1023'>requests</span><span class='token pointer' id='tok-62-1024'>as</span><span class='token pointer' id='tok-62-1025'>served</span><span class='token pointer' id='tok-62-1026'>by</span><span class='token pointer' id='tok-62-1027'>the</span><span class='token pointer' id='tok-62-1028'>C&C.</span></p><p id=p1029><span class='token pointer' id='tok-62-1029'>The</span><span class='token pointer' id='tok-62-1030'>payload</span><span class='token pointer' id='tok-62-1031'>is</span><span class='token pointer' id='tok-62-1032'>able</span><span class='token pointer' id='tok-62-1033'>to</span><span class='token pointer' id='tok-62-1034'>load</span><span class='token pointer' id='tok-62-1035'>an</span><span class='token pointer' id='tok-62-1037' style='color:red'>external DLL</span><span class='token pointer' id='tok-62-1038'>provided</span><span class='token pointer' id='tok-62-1039'>by</span><span class='token pointer' id='tok-62-1040'>the</span><span class='token pointer' id='tok-62-1041'>C&C</span><span class='token pointer' id='tok-62-1042'>and</span><span class='token pointer' id='tok-62-1043'>interact</span><span class='token pointer' id='tok-62-1044'>with</span><span class='token pointer' id='tok-62-1045'>it</span><span class='token pointer' id='tok-62-1046'>using</span><span class='token pointer' id='tok-62-1047'>a</span><span class='token pointer' id='tok-62-1048'>pre-defined</span><span class='token pointer' id='tok-62-1049'>API.</span><span class='token pointer' id='tok-62-1050'>The</span><span class='token pointer' id='tok-62-1051'>most</span><span class='token pointer' id='tok-62-1052'>noticeable</span><span class='token pointer' id='tok-62-1053'>module</span><span class='token pointer' id='tok-62-1054'>discovered</span><span class='token pointer' id='tok-62-1055'>so</span><span class='token pointer' id='tok-62-1056'>far</span><span class='token pointer' id='tok-62-1057'>is</span><span class='token pointer' id='tok-62-1058'>the</span><span class='token pointer' id='tok-62-1059'>infostealer</span><span class='token pointer' id='tok-62-1060'>module.</span><span class='token pointer' id='tok-62-1061'>There</span><span class='token pointer' id='tok-62-1062'>are</span><span class='token pointer' id='tok-62-1063'>also</span><span class='token pointer' id='tok-62-1064'>modules</span><span class='token pointer' id='tok-62-1065'>for</span><span class='token pointer' id='tok-62-1066'>updating</span><span class='token pointer' id='tok-62-1067'>the</span><span class='token pointer' id='tok-62-1068'>TTL</span><span class='token pointer' id='tok-62-1069'>value</span><span class='token pointer' id='tok-62-1070'>in</span><span class='token pointer' id='tok-62-1071'>the</span><span class='token pointer' id='tok-62-1072'>PNF</span><span class='token pointer' id='tok-62-1073'>DLL</span><span class='token pointer' id='tok-62-1074'>configuration,</span><span class='token pointer' id='tok-62-1075'>for</span><span class='token pointer' id='tok-62-1076'>reading</span><span class='token pointer' id='tok-62-1077'>the</span><span class='token pointer' id='tok-62-1078'>network</span><span class='token pointer' id='tok-62-1079'>and</span><span class='token pointer' id='tok-62-1080'>disk</span><span class='token pointer' id='tok-62-1081'>storage</span><span class='token pointer' id='tok-62-1082'>configuration</span><span class='token pointer' id='tok-62-1083'>from</span><span class='token pointer' id='tok-62-1084'>the</span><span class='token pointer' id='tok-62-1085'>infected</span><span class='token pointer' id='tok-62-1086'>machine.</span></p><p id=p1087><span class='token pointer' id='tok-62-1087'>It</span><span class='token pointer' id='tok-62-1088'>also</span><span class='token pointer' id='tok-62-1089'>can</span><span class='token pointer' id='tok-62-1090'>form</span><span class='token pointer' id='tok-62-1091'>a</span><span class='token pointer' id='tok-62-1092'>PNF</span><span class='token pointer' id='tok-62-1093'>DLL</span><span class='token pointer' id='tok-62-1094'>with</span><span class='token pointer' id='tok-62-1095'>a</span><span class='token pointer' id='tok-62-1096'>configuration</span><span class='token pointer' id='tok-62-1097'>block</span><span class='token pointer' id='tok-62-1098'>and</span><span class='token pointer' id='tok-62-1099'>the</span><span class='token pointer' id='tok-62-1100'>payload</span><span class='token pointer' id='tok-62-1102' style='color:red'>DLL ready</span><span class='token pointer' id='tok-62-1103'>distribution</span><span class='token pointer' id='tok-62-1104'>to</span><span class='token pointer' id='tok-62-1105'>other</span><span class='token pointer' id='tok-62-1106'>machines.
</span></p>