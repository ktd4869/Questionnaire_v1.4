<p id=p0><span class='token pointer' id='tok-62-0'>The</span><span class='token pointer' id='tok-62-1' style='color:red'>driver</span><span class='token pointer' id='tok-62-2'>is</span><span class='token pointer' id='tok-62-3'>the</span><span class='token pointer' id='tok-62-4'>first</span><span class='token pointer' id='tok-62-5' style='color:red'>Duqu</span><span class='token pointer' id='tok-62-6' style='color:red'>component of</span><span class='token pointer' id='tok-62-7'>be</span><span class='token pointer' id='tok-62-8'>loaded</span><span class='token pointer' id='tok-62-9'>in</span><span class='token pointer' id='tok-62-10'>the</span><span class='token pointer' id='tok-62-11'>system.</span><span class='token pointer' id='tok-62-12'>As</span><span class='token pointer' id='tok-62-13'>we</span><span class='token pointer' id='tok-62-14'>discovered,</span><span class='token pointer' id='tok-62-15'>the</span><span class='token pointer' id='tok-62-16'>driver</span><span class='token pointer' id='tok-62-17'>and</span><span class='token pointer' id='tok-62-18'>other</span><span class='token pointer' id='tok-62-19'>components</span><span class='token pointer' id='tok-62-20'>of</span><span class='token pointer' id='tok-62-21' style='color:red'>malware</span><span class='token pointer' id='tok-62-22'>are</span><span class='token pointer' id='tok-62-23'>installed</span><span class='token pointer' id='tok-62-24'>with</span><span class='token pointer' id='tok-62-25'>a</span><span class='token pointer' id='tok-62-26' style='color:red'>dropper</span><span class='token pointer' id='tok-62-27'>exploiting</span><span class='token pointer' id='tok-62-28'>a</span><span class='token pointer' id='tok-62-29'>0-day</span><span class='token pointer' id='tok-62-30'>vulnerability</span><span class='token pointer' id='tok-62-31' style='color:red'>(CVE-2011-3402).</span><span class='token pointer' id='tok-62-32'>The</span><span class='token pointer' id='tok-62-33'>driver</span><span class='token pointer' id='tok-62-34'>is</span><span class='token pointer' id='tok-62-35'>registered</span><span class='token pointer' id='tok-62-36'>in</span><span class='token pointer' id='tok-62-37'>the</span><span class='token pointer' id='tok-62-38' style='color:red'>HKLMSystemCurrentControlSetServices registry path.</span><span class='token pointer' id='tok-62-39'>exact</span><span class='token pointer' id='tok-62-40'>name</span><span class='token pointer' id='tok-62-41'>of</span><span class='token pointer' id='tok-62-42'>the</span><span class='token pointer' id='tok-62-43' style='color:red'>registry key</span><span class='token pointer' id='tok-62-44'>in</span><span class='token pointer' id='tok-62-45'>different</span><span class='token pointer' id='tok-62-46'>versions</span><span class='token pointer' id='tok-62-47'>of</span><span class='token pointer' id='tok-62-48'>Duqu</span><span class='token pointer' id='tok-62-49'>drivers.</span></p><p id=p50><span class='token pointer' id='tok-62-50'>Once</span><span class='token pointer' id='tok-62-51'>the</span><span class='token pointer' id='tok-62-52'>driver</span><span class='token pointer' id='tok-62-53'>is</span><span class='token pointer' id='tok-62-54'>loaded,</span><span class='token pointer' id='tok-62-55'>it</span><span class='token pointer' id='tok-62-56' style='color:red'>decrypts</span><span class='token pointer' id='tok-62-57'>a</span><span class='token pointer' id='tok-62-58'>small</span><span class='token pointer' id='tok-62-59'>block</span><span class='token pointer' id='tok-62-60'>that</span><span class='token pointer' id='tok-62-61'>contains</span><span class='token pointer' id='tok-62-62'>its</span><span class='token pointer' id='tok-62-63'>registry</span><span class='token pointer' id='tok-62-64'>key</span><span class='token pointer' id='tok-62-65'>and</span><span class='token pointer' id='tok-62-66'>the</span><span class='token pointer' id='tok-62-67'>name</span><span class='token pointer' id='tok-62-68'>of</span><span class='token pointer' id='tok-62-69'>the</span><span class='token pointer' id='tok-62-70' style='color:red'>registry value</span><span class='token pointer' id='tok-62-71'>be</span><span class='token pointer' id='tok-62-72'>read</span><span class='token pointer' id='tok-62-73'>from</span><span class='token pointer' id='tok-62-74'>that</span><span class='token pointer' id='tok-62-75'>key.</span><span class='token pointer' id='tok-62-76'>It</span><span class='token pointer' id='tok-62-77'>also</span><span class='token pointer' id='tok-62-78'>contains</span><span class='token pointer' id='tok-62-79'>the</span><span class='token pointer' id='tok-62-80'>name</span><span class='token pointer' id='tok-62-81'>of</span><span class='token pointer' id='tok-62-82'>the</span><span class='token pointer' id='tok-62-83'>driver</span><span class='token pointer' id='tok-62-84'>object</span><span class='token pointer' id='tok-62-85'>to</span><span class='token pointer' id='tok-62-86'>create.</span></p><p id=p87><span class='token pointer' id='tok-62-87'>All</span><span class='token pointer' id='tok-62-88'>versions</span><span class='token pointer' id='tok-62-89'>of</span><span class='token pointer' id='tok-62-90'>the</span><span class='token pointer' id='tok-62-91'>driver</span><span class='token pointer' id='tok-62-92'>available</span><span class='token pointer' id='tok-62-93'>at</span><span class='token pointer' id='tok-62-94'>the</span><span class='token pointer' id='tok-62-95'>moment</span><span class='token pointer' id='tok-62-96'>have</span><span class='token pointer' id='tok-62-97'>the</span><span class='token pointer' id='tok-62-98'>same</span><span class='token pointer' id='tok-62-99'>registry</span><span class='token pointer' id='tok-62-100'>value</span><span class='token pointer' id='tok-62-101'>name,</span><span class='token pointer' id='tok-62-102'>"FILTER".</span></p><p id=p103><span class='token pointer' id='tok-62-103'>The</span><span class='token pointer' id='tok-62-104'>driver</span><span class='token pointer' id='tok-62-105'>then</span><span class='token pointer' id='tok-62-106'>registers</span><span class='token pointer' id='tok-62-107'>the</span><span class='token pointer' id='tok-62-108' style='color:red'>DriverReinitializationRoutine</span><span class='token pointer' id='tok-62-109'>that</span><span class='token pointer' id='tok-62-110'>queues</span><span class='token pointer' id='tok-62-111'>the</span><span class='token pointer' id='tok-62-112' style='color:red'>WorkerRoutine</span><span class='token pointer' id='tok-62-113'>where</span><span class='token pointer' id='tok-62-114'>actual</span><span class='token pointer' id='tok-62-115' style='color:red'>driver initialization</span><span class='token pointer' id='tok-62-116'>performed.</span><span class='token pointer' id='tok-62-117'>In</span><span class='token pointer' id='tok-62-118'>the</span><span class='token pointer' id='tok-62-119'>WorkerRoutine</span><span class='token pointer' id='tok-62-120'>the</span><span class='token pointer' id='tok-62-121'>driver</span><span class='token pointer' id='tok-62-122'>reads</span><span class='token pointer' id='tok-62-123'>the</span><span class='token pointer' id='tok-62-124'>"FILTER"</span><span class='token pointer' id='tok-62-125'>value</span><span class='token pointer' id='tok-62-126'>from</span><span class='token pointer' id='tok-62-127'>registry</span><span class='token pointer' id='tok-62-128'>and</span><span class='token pointer' id='tok-62-129'>decrypts</span><span class='token pointer' id='tok-62-130'>it</span><span class='token pointer' id='tok-62-131'>with</span><span class='token pointer' id='tok-62-132'>a</span><span class='token pointer' id='tok-62-133' style='color:red'>hard-coded encryption key.</span><span class='token pointer' id='tok-62-134'>are</span><span class='token pointer' id='tok-62-135'>two</span><span class='token pointer' id='tok-62-136'>known</span><span class='token pointer' id='tok-62-137'>versions</span><span class='token pointer' id='tok-62-138'>of</span><span class='token pointer' id='tok-62-139' style='color:red'>decryption routine</span><span class='token pointer' id='tok-62-140'>two</span><span class='token pointer' id='tok-62-141'>corresponding</span><span class='token pointer' id='tok-62-142' style='color:red'>decryption keys.</span><span class='token pointer' id='tok-62-143'>driver</span><span class='token pointer' id='tok-62-144'>also</span><span class='token pointer' id='tok-62-145'>locates</span><span class='token pointer' id='tok-62-146'>the</span><span class='token pointer' id='tok-62-147' style='color:red'>NTOSKRNL.EXE</span><span class='token pointer' id='tok-62-148'>or</span><span class='token pointer' id='tok-62-149' style='color:red'>NTKRNLPA.EXE module</span><span class='token pointer' id='tok-62-150'>gets</span><span class='token pointer' id='tok-62-151'>the</span><span class='token pointer' id='tok-62-152'>addresses</span><span class='token pointer' id='tok-62-153'>of</span><span class='token pointer' id='tok-62-154' style='color:red'>API functions</span><span class='token pointer' id='tok-62-155'>further</span><span class='token pointer' id='tok-62-156'>usage.</span></p><p id=p157><span class='token pointer' id='tok-62-157'>The</span><span class='token pointer' id='tok-62-158' style='color:red'>decrypted</span><span class='token pointer' id='tok-62-159'>"FILTER"</span><span class='token pointer' id='tok-62-160'>value</span><span class='token pointer' id='tok-62-161'>from</span><span class='token pointer' id='tok-62-162'>registry</span><span class='token pointer' id='tok-62-163'>contains</span><span class='token pointer' id='tok-62-164'>the</span><span class='token pointer' id='tok-62-165'>list</span><span class='token pointer' id='tok-62-166'>of</span><span class='token pointer' id='tok-62-167'>records</span><span class='token pointer' id='tok-62-168'>that</span><span class='token pointer' id='tok-62-169'>contain</span><span class='token pointer' id='tok-62-170'>the</span><span class='token pointer' id='tok-62-171'>name</span><span class='token pointer' id='tok-62-172'>of</span><span class='token pointer' id='tok-62-173'>the</span><span class='token pointer' id='tok-62-174'>process</span><span class='token pointer' id='tok-62-175'>("services.exe"),</span><span class='token pointer' id='tok-62-176'>the</span><span class='token pointer' id='tok-62-177'>path</span><span class='token pointer' id='tok-62-178'>to</span><span class='token pointer' id='tok-62-179'>corresponding</span><span class='token pointer' id='tok-62-180' style='color:red'>PNF DLL file</span><span class='token pointer' id='tok-62-181'>will</span><span class='token pointer' id='tok-62-182'>be</span><span class='token pointer' id='tok-62-183'>injected</span><span class='token pointer' id='tok-62-184'>in</span><span class='token pointer' id='tok-62-185'>that</span><span class='token pointer' id='tok-62-186'>process</span><span class='token pointer' id='tok-62-187'>and</span><span class='token pointer' id='tok-62-188'>the</span><span class='token pointer' id='tok-62-189'>decryption</span><span class='token pointer' id='tok-62-190'>key</span><span class='token pointer' id='tok-62-191'>(0xAE240682)</span><span class='token pointer' id='tok-62-192'>that</span><span class='token pointer' id='tok-62-193'>is</span><span class='token pointer' id='tok-62-194'>used</span><span class='token pointer' id='tok-62-195'>to</span><span class='token pointer' id='tok-62-196'>decrypt</span><span class='token pointer' id='tok-62-197'>the</span><span class='token pointer' id='tok-62-198'>PNF</span><span class='token pointer' id='tok-62-199'>DLL</span><span class='token pointer' id='tok-62-200'>file.</span></p><p id=p201><span class='token pointer' id='tok-62-201'>After</span><span class='token pointer' id='tok-62-202'>initialization</span><span class='token pointer' id='tok-62-203'>the</span><span class='token pointer' id='tok-62-204'>driver</span><span class='token pointer' id='tok-62-205'>registers</span><span class='token pointer' id='tok-62-206'></span><span class='token pointer' id='tok-62-207' style='color:red'>LoadImageNotifyRoutine</span><span class='token pointer' id='tok-62-208'>that</span><span class='token pointer' id='tok-62-209'>will</span><span class='token pointer' id='tok-62-210'>be</span><span class='token pointer' id='tok-62-211'>then</span><span class='token pointer' id='tok-62-212'>called</span><span class='token pointer' id='tok-62-213'>by</span><span class='token pointer' id='tok-62-214'>Windows</span><span class='token pointer' id='tok-62-215'>each</span><span class='token pointer' id='tok-62-216'>time</span><span class='token pointer' id='tok-62-217'>a</span><span class='token pointer' id='tok-62-218'>new</span><span class='token pointer' id='tok-62-219'>module</span><span class='token pointer' id='tok-62-220'>is</span><span class='token pointer' id='tok-62-221'>loaded.</span><span class='token pointer' id='tok-62-222'>The</span><span class='token pointer' id='tok-62-223'>routine</span><span class='token pointer' id='tok-62-224'>checks</span><span class='token pointer' id='tok-62-225'>if</span><span class='token pointer' id='tok-62-226'>the</span><span class='token pointer' id='tok-62-227'>name</span><span class='token pointer' id='tok-62-228'>of</span><span class='token pointer' id='tok-62-229'>image</span><span class='token pointer' id='tok-62-230'>matches</span><span class='token pointer' id='tok-62-231'>one</span><span class='token pointer' id='tok-62-232'>of</span><span class='token pointer' id='tok-62-233'>these</span><span class='token pointer' id='tok-62-234'>specified</span><span class='token pointer' id='tok-62-235'>in</span><span class='token pointer' id='tok-62-236'>"FILTER"</span><span class='token pointer' id='tok-62-237'>value</span><span class='token pointer' id='tok-62-238'>and</span><span class='token pointer' id='tok-62-239'>if</span><span class='token pointer' id='tok-62-240'>it</span><span class='token pointer' id='tok-62-241'>does,</span><span class='token pointer' id='tok-62-242'>starts</span><span class='token pointer' id='tok-62-243'>the</span><span class='token pointer' id='tok-62-244'>injection:</span><span class='token pointer' id='tok-62-245'>it</span><span class='token pointer' id='tok-62-246'>decrypts</span><span class='token pointer' id='tok-62-247'>and</span><span class='token pointer' id='tok-62-248'>copies</span><span class='token pointer' id='tok-62-249'>the</span><span class='token pointer' id='tok-62-250'>PNF</span><span class='token pointer' id='tok-62-251'>DLL</span><span class='token pointer' id='tok-62-252'>file</span><span class='token pointer' id='tok-62-253'>into</span><span class='token pointer' id='tok-62-254'>an</span><span class='token pointer' id='tok-62-255' style='color:red'>allocate memory region</span><span class='token pointer' id='tok-62-256'>that</span><span class='token pointer' id='tok-62-257'>process.</span><span class='token pointer' id='tok-62-258'>It</span><span class='token pointer' id='tok-62-259'>also</span><span class='token pointer' id='tok-62-260'>builds</span><span class='token pointer' id='tok-62-261'>an</span><span class='token pointer' id='tok-62-262'>copies</span><span class='token pointer' id='tok-62-263'>a</span><span class='token pointer' id='tok-62-264' style='color:red'>stub EXE file</span><span class='token pointer' id='tok-62-265'>that</span><span class='token pointer' id='tok-62-266'>process</span><span class='token pointer' id='tok-62-267'>that</span><span class='token pointer' id='tok-62-268'>is</span><span class='token pointer' id='tok-62-269'>then</span><span class='token pointer' id='tok-62-270'>used</span><span class='token pointer' id='tok-62-271'>as</span><span class='token pointer' id='tok-62-272'>a</span><span class='token pointer' id='tok-62-273' style='color:red'>loader</span><span class='token pointer' id='tok-62-274'>for</span><span class='token pointer' id='tok-62-275'>the</span><span class='token pointer' id='tok-62-276' style='color:red'>PNF</span><span class='token pointer' id='tok-62-277' style='color:red'>DLL.</span></p><p id=p278><span class='token pointer' id='tok-62-278'>As</span><span class='token pointer' id='tok-62-279'>soon</span><span class='token pointer' id='tok-62-280'>as</span><span class='token pointer' id='tok-62-281' style='color:red'>"KERNEL32.DLL"</span><span class='token pointer' id='tok-62-282'>is</span><span class='token pointer' id='tok-62-283'>loaded</span><span class='token pointer' id='tok-62-284'>in</span><span class='token pointer' id='tok-62-285'>the</span><span class='token pointer' id='tok-62-286'>same</span><span class='token pointer' id='tok-62-287'>process,</span><span class='token pointer' id='tok-62-288'>it</span><span class='token pointer' id='tok-62-289'>locates</span><span class='token pointer' id='tok-62-290'>addresses</span><span class='token pointer' id='tok-62-291'>of</span><span class='token pointer' id='tok-62-292'>API</span><span class='token pointer' id='tok-62-293'>functions</span><span class='token pointer' id='tok-62-294'>required</span><span class='token pointer' id='tok-62-295'>by</span><span class='token pointer' id='tok-62-296'>the</span><span class='token pointer' id='tok-62-297'>loader</span><span class='token pointer' id='tok-62-298'>EXE</span><span class='token pointer' id='tok-62-299'>and</span><span class='token pointer' id='tok-62-300'>modifies</span><span class='token pointer' id='tok-62-301'>the</span><span class='token pointer' id='tok-62-302'>original</span><span class='token pointer' id='tok-62-303'>entry</span><span class='token pointer' id='tok-62-304'>point</span><span class='token pointer' id='tok-62-305'>of</span><span class='token pointer' id='tok-62-306'>the</span><span class='token pointer' id='tok-62-307'>main</span><span class='token pointer' id='tok-62-308'>process</span><span class='token pointer' id='tok-62-309'>module</span><span class='token pointer' id='tok-62-310'>so</span><span class='token pointer' id='tok-62-311'>that</span><span class='token pointer' id='tok-62-312'>it</span><span class='token pointer' id='tok-62-313'>passes</span><span class='token pointer' id='tok-62-314'>execution</span><span class='token pointer' id='tok-62-315'>to</span><span class='token pointer' id='tok-62-316'>the</span><span class='token pointer' id='tok-62-317'>loader</span></p><p id=p318><span class='token pointer' id='tok-62-318'>The</span><span class='token pointer' id='tok-62-319'>loader</span><span class='token pointer' id='tok-62-320' style='color:red'>EXE module</span><span class='token pointer' id='tok-62-321'>initial</span><span class='token pointer' id='tok-62-322'>initialization</span><span class='token pointer' id='tok-62-323'>of</span><span class='token pointer' id='tok-62-324'>the</span><span class='token pointer' id='tok-62-325' style='color:red'>PNF DLL module</span><span class='token pointer' id='tok-62-326'>then</span><span class='token pointer' id='tok-62-327'>executes</span><span class='token pointer' id='tok-62-328'>the</span><span class='token pointer' id='tok-62-329'>export</span><span class='token pointer' id='tok-62-330'>as</span><span class='token pointer' id='tok-62-331'>specified</span><span class='token pointer' id='tok-62-332'>in</span><span class='token pointer' id='tok-62-333'>the</span><span class='token pointer' id='tok-62-334'>configuration</span><span class='token pointer' id='tok-62-335'>("FILTER").</span><span class='token pointer' id='tok-62-336'>After</span><span class='token pointer' id='tok-62-337'>that</span><span class='token pointer' id='tok-62-338'>it</span><span class='token pointer' id='tok-62-339'>restores</span><span class='token pointer' id='tok-62-340'>the</span><span class='token pointer' id='tok-62-341'>code</span><span class='token pointer' id='tok-62-342'>of</span><span class='token pointer' id='tok-62-343'>the</span><span class='token pointer' id='tok-62-344'>original</span><span class='token pointer' id='tok-62-345'>entry</span><span class='token pointer' id='tok-62-346'>point</span><span class='token pointer' id='tok-62-347'>and</span><span class='token pointer' id='tok-62-348'>returns</span><span class='token pointer' id='tok-62-349'>execution</span><span class='token pointer' id='tok-62-350'>to</span><span class='token pointer' id='tok-62-351'>the</span><span class='token pointer' id='tok-62-352'>original</span><span class='token pointer' id='tok-62-353'>process</span><span class='token pointer' id='tok-62-354'>module.</span><span class='token pointer' id='tok-62-355'>The</span><span class='token pointer' id='tok-62-356'>loader</span><span class='token pointer' id='tok-62-357'>also</span><span class='token pointer' id='tok-62-358'>interacts</span><span class='token pointer' id='tok-62-359'>with</span><span class='token pointer' id='tok-62-360'>the</span><span class='token pointer' id='tok-62-361'>driver</span><span class='token pointer' id='tok-62-362'>module</span><span class='token pointer' id='tok-62-363'>using</span><span class='token pointer' id='tok-62-364'>a</span><span class='token pointer' id='tok-62-365' style='color:red'>custom IOCTL code</span><span class='token pointer' id='tok-62-366'>change</span><span class='token pointer' id='tok-62-367' style='color:red'>memory protection</span><span class='token pointer' id='tok-62-368'>the</span><span class='token pointer' id='tok-62-369'>original</span><span class='token pointer' id='tok-62-370'>entry</span><span class='token pointer' id='tok-62-371'>point</span><span class='token pointer' id='tok-62-372'>code.</span></p><p id=p373><span class='token pointer' id='tok-62-373'>This</span><span class='token pointer' id='tok-62-374'>module</span><span class='token pointer' id='tok-62-375'>is</span><span class='token pointer' id='tok-62-376'>stored</span><span class='token pointer' id='tok-62-377'>on</span><span class='token pointer' id='tok-62-378'>disk</span><span class='token pointer' id='tok-62-379'>as</span><span class='token pointer' id='tok-62-380'>an</span><span class='token pointer' id='tok-62-381' style='color:red'>encrypted block of data.</span><span class='token pointer' id='tok-62-382'>soon</span><span class='token pointer' id='tok-62-383'>as</span><span class='token pointer' id='tok-62-384'>it</span><span class='token pointer' id='tok-62-385'>is</span><span class='token pointer' id='tok-62-386'>decrypted,</span><span class='token pointer' id='tok-62-387'>it</span><span class='token pointer' id='tok-62-388'>turns</span><span class='token pointer' id='tok-62-389'>out</span><span class='token pointer' id='tok-62-390'>to</span><span class='token pointer' id='tok-62-391'>be</span><span class='token pointer' id='tok-62-392'>a</span><span class='token pointer' id='tok-62-393'>DLL</span><span class='token pointer' id='tok-62-394'>packed</span><span class='token pointer' id='tok-62-395'>with</span><span class='token pointer' id='tok-62-396' style='color:red'>UPX.</span><span class='token pointer' id='tok-62-397'></span><span class='token pointer' id='tok-62-398'>Known</span><span class='token pointer' id='tok-62-399'>versions</span><span class='token pointer' id='tok-62-400'>of</span><span class='token pointer' id='tok-62-401'>PNF</span><span class='token pointer' id='tok-62-402'>DLL</span><span class='token pointer' id='tok-62-403'>modules</span><span class='token pointer' id='tok-62-404'>export</span><span class='token pointer' id='tok-62-405'>8</span><span class='token pointer' id='tok-62-406'>or</span><span class='token pointer' id='tok-62-407'>6</span><span class='token pointer' id='tok-62-408'>different</span><span class='token pointer' id='tok-62-409'>functions</span><span class='token pointer' id='tok-62-410'>by</span><span class='token pointer' id='tok-62-411'>ordinal</span><span class='token pointer' id='tok-62-412'>numbers.</span></p><p id=p413><span class='token pointer' id='tok-62-413' style='color:red'>Export 2</span><span class='token pointer' id='tok-62-414'>export</span><span class='token pointer' id='tok-62-415'>6</span><span class='token pointer' id='tok-62-416'>in</span><span class='token pointer' id='tok-62-417'>a</span><span class='token pointer' id='tok-62-418'>separate</span><span class='token pointer' id='tok-62-419'>process.</span></p><p id=p420><span class='token pointer' id='tok-62-420'>Export</span><span class='token pointer' id='tok-62-421'>4</span><span class='token pointer' id='tok-62-422'>runs</span><span class='token pointer' id='tok-62-423'>export</span><span class='token pointer' id='tok-62-424'>5</span><span class='token pointer' id='tok-62-425'>in</span><span class='token pointer' id='tok-62-426'>a</span><span class='token pointer' id='tok-62-427'>separate</span><span class='token pointer' id='tok-62-428'>process.</span></p><p id=p429><span class='token pointer' id='tok-62-429'>Export</span><span class='token pointer' id='tok-62-430'>5</span><span class='token pointer' id='tok-62-431'>starts</span><span class='token pointer' id='tok-62-432'>a</span><span class='token pointer' id='tok-62-433'>thread</span><span class='token pointer' id='tok-62-434'>in</span><span class='token pointer' id='tok-62-435'>"services.exe"</span><span class='token pointer' id='tok-62-436'>process</span><span class='token pointer' id='tok-62-437'>that</span><span class='token pointer' id='tok-62-438'>loaded</span><span class='token pointer' id='tok-62-439'>the</span><span class='token pointer' id='tok-62-440' style='color:red'>302 resource</span><span class='token pointer' id='tok-62-441'>below)</span><span class='token pointer' id='tok-62-442'>and,</span><span class='token pointer' id='tok-62-443'>if</span><span class='token pointer' id='tok-62-444'>provided</span><span class='token pointer' id='tok-62-445'>with</span><span class='token pointer' id='tok-62-446'>correct</span><span class='token pointer' id='tok-62-447'>information</span><span class='token pointer' id='tok-62-448'>by</span><span class='token pointer' id='tok-62-449'>the</span><span class='token pointer' id='tok-62-450'>callee,</span><span class='token pointer' id='tok-62-451'>installs</span><span class='token pointer' id='tok-62-452'>a</span><span class='token pointer' id='tok-62-453'>complete</span><span class='token pointer' id='tok-62-454'>new</span><span class='token pointer' id='tok-62-455'>set</span><span class='token pointer' id='tok-62-456'>of</span><span class='token pointer' id='tok-62-457'>Duqu</span><span class='token pointer' id='tok-62-458'>components.</span></p><p id=p459><span class='token pointer' id='tok-62-459'>Export</span><span class='token pointer' id='tok-62-460'>6</span><span class='token pointer' id='tok-62-461'>stops</span><span class='token pointer' id='tok-62-462'>the</span><span class='token pointer' id='tok-62-463'>driver</span><span class='token pointer' id='tok-62-464'>and</span><span class='token pointer' id='tok-62-465'>completely</span><span class='token pointer' id='tok-62-466'>uninstalls</span><span class='token pointer' id='tok-62-467'>all</span><span class='token pointer' id='tok-62-468'>components</span><span class='token pointer' id='tok-62-469'>of</span><span class='token pointer' id='tok-62-470'>Duqu.</span></p><p id=p471><span class='token pointer' id='tok-62-471'>Export</span><span class='token pointer' id='tok-62-472'>8</span><span class='token pointer' id='tok-62-473'>and</span><span class='token pointer' id='tok-62-474'>1</span><span class='token pointer' id='tok-62-475'>initialize</span><span class='token pointer' id='tok-62-476'>the</span><span class='token pointer' id='tok-62-477'>PNF</span><span class='token pointer' id='tok-62-478'>DLL</span><span class='token pointer' id='tok-62-479'>module</span><span class='token pointer' id='tok-62-480'>and</span><span class='token pointer' id='tok-62-481'>start</span><span class='token pointer' id='tok-62-482'>main</span><span class='token pointer' id='tok-62-483'>threads.</span></p><p id=p484><span class='token pointer' id='tok-62-484'>It</span><span class='token pointer' id='tok-62-485'>seems</span><span class='token pointer' id='tok-62-486'>that</span><span class='token pointer' id='tok-62-487'>ordinal</span><span class='token pointer' id='tok-62-488'>1</span><span class='token pointer' id='tok-62-489' style='color:red'>is</span><span class='token pointer' id='tok-62-490'>intended</span><span class='token pointer' id='tok-62-491'>to</span><span class='token pointer' id='tok-62-492'>export</span><span class='token pointer' id='tok-62-493'>primary</span><span class='token pointer' id='tok-62-494'>functionality</span><span class='token pointer' id='tok-62-495'>of</span><span class='token pointer' id='tok-62-496'>the</span><span class='token pointer' id='tok-62-497'>DLL.</span><span class='token pointer' id='tok-62-498'>First,</span><span class='token pointer' id='tok-62-499'>it</span><span class='token pointer' id='tok-62-500'>loads</span><span class='token pointer' id='tok-62-501'>the</span><span class='token pointer' id='tok-62-502'>configuration</span><span class='token pointer' id='tok-62-503'>information</span><span class='token pointer' id='tok-62-504'>from</span><span class='token pointer' id='tok-62-505'>another</span><span class='token pointer' id='tok-62-506'>PNF</span><span class='token pointer' id='tok-62-507'>file,</span><span class='token pointer' id='tok-62-508'>the</span><span class='token pointer' id='tok-62-509'>PNF</span><span class='token pointer' id='tok-62-510' style='color:red'>Config</span><span class='token pointer' id='tok-62-511'>file.</span><span class='token pointer' id='tok-62-512'>If</span><span class='token pointer' id='tok-62-513'>the</span><span class='token pointer' id='tok-62-514'>file</span><span class='token pointer' id='tok-62-515'>is</span><span class='token pointer' id='tok-62-516'>not</span><span class='token pointer' id='tok-62-517'>present,</span><span class='token pointer' id='tok-62-518'>it</span><span class='token pointer' id='tok-62-519'>is</span><span class='token pointer' id='tok-62-520'>created</span><span class='token pointer' id='tok-62-521'>from</span><span class='token pointer' id='tok-62-522'>an</span><span class='token pointer' id='tok-62-523'>encrypted</span><span class='token pointer' id='tok-62-524'>hard-coded</span><span class='token pointer' id='tok-62-525'>copy</span><span class='token pointer' id='tok-62-526'>that</span><span class='token pointer' id='tok-62-527'>is</span><span class='token pointer' id='tok-62-528'>stored</span><span class='token pointer' id='tok-62-529'>in</span><span class='token pointer' id='tok-62-530'>the</span><span class='token pointer' id='tok-62-531'>PNF</span><span class='token pointer' id='tok-62-532'>DLL</span><span class='token pointer' id='tok-62-533'>file.</span></p><p id=p534><span class='token pointer' id='tok-62-534'>The</span><span class='token pointer' id='tok-62-535'>name</span><span class='token pointer' id='tok-62-536'>of</span><span class='token pointer' id='tok-62-537'>the</span><span class='token pointer' id='tok-62-538'>configuration</span><span class='token pointer' id='tok-62-539'>file</span><span class='token pointer' id='tok-62-540'>is</span><span class='token pointer' id='tok-62-541'>different</span><span class='token pointer' id='tok-62-542'>for</span><span class='token pointer' id='tok-62-543'>every</span><span class='token pointer' id='tok-62-544'>version</span><span class='token pointer' id='tok-62-545'>of</span><span class='token pointer' id='tok-62-546'>Duqu.</span><span class='token pointer' id='tok-62-547'>The</span><span class='token pointer' id='tok-62-548'>PNF</span><span class='token pointer' id='tok-62-549'>Config</span><span class='token pointer' id='tok-62-550'>contains</span><span class='token pointer' id='tok-62-551'>the</span><span class='token pointer' id='tok-62-552'>name</span><span class='token pointer' id='tok-62-553'>and</span><span class='token pointer' id='tok-62-554'>path</span><span class='token pointer' id='tok-62-555'>to</span><span class='token pointer' id='tok-62-556'>the</span><span class='token pointer' id='tok-62-557'>driver</span><span class='token pointer' id='tok-62-558' style='color:red'>component,</span><span class='token pointer' id='tok-62-559'>to</span><span class='token pointer' id='tok-62-560'>the</span><span class='token pointer' id='tok-62-561'>PNF</span><span class='token pointer' id='tok-62-562'>DLL</span><span class='token pointer' id='tok-62-563'>and</span><span class='token pointer' id='tok-62-564'>PNF</span><span class='token pointer' id='tok-62-565'>Config</span><span class='token pointer' id='tok-62-566'>itself.</span></p><p id=p567><span class='token pointer' id='tok-62-567'>When</span><span class='token pointer' id='tok-62-568'>the</span><span class='token pointer' id='tok-62-569'>PNF</span><span class='token pointer' id='tok-62-570'>Config</span><span class='token pointer' id='tok-62-571'>is</span><span class='token pointer' id='tok-62-572'>created,</span><span class='token pointer' id='tok-62-573'>the</span><span class='token pointer' id='tok-62-574'>date</span><span class='token pointer' id='tok-62-575'>of</span><span class='token pointer' id='tok-62-576'>creation</span><span class='token pointer' id='tok-62-577'>is</span><span class='token pointer' id='tok-62-578'>written</span><span class='token pointer' id='tok-62-579'>into</span><span class='token pointer' id='tok-62-580'>the</span><span class='token pointer' id='tok-62-581'>file.</span><span class='token pointer' id='tok-62-582'>The</span><span class='token pointer' id='tok-62-583'>file</span><span class='token pointer' id='tok-62-584'>also</span><span class='token pointer' id='tok-62-585'>contains</span><span class='token pointer' id='tok-62-586'>the</span><span class='token pointer' id='tok-62-587' style='color:red'>TTL</span><span class='token pointer' id='tok-62-588'>("time</span><span class='token pointer' id='tok-62-589'>to</span><span class='token pointer' id='tok-62-590'>live")</span><span class='token pointer' id='tok-62-591'>value:</span><span class='token pointer' id='tok-62-592'>a</span><span class='token pointer' id='tok-62-593'>separate</span><span class='token pointer' id='tok-62-594'>thread</span><span class='token pointer' id='tok-62-595'>started</span><span class='token pointer' id='tok-62-596'>by</span><span class='token pointer' id='tok-62-597'>PNF</span><span class='token pointer' id='tok-62-598'>DLL</span><span class='token pointer' id='tok-62-599'>monitors</span><span class='token pointer' id='tok-62-600'>if</span><span class='token pointer' id='tok-62-601'>TTL</span><span class='token pointer' id='tok-62-602'>days</span><span class='token pointer' id='tok-62-603'>passed</span><span class='token pointer' id='tok-62-604'>since</span><span class='token pointer' id='tok-62-605'>the</span><span class='token pointer' id='tok-62-606'>creation</span><span class='token pointer' id='tok-62-607'>date,</span><span class='token pointer' id='tok-62-608'>and</span><span class='token pointer' id='tok-62-609'>after</span><span class='token pointer' id='tok-62-610'>that</span><span class='token pointer' id='tok-62-611'>runs</span><span class='token pointer' id='tok-62-612'>the</span><span class='token pointer' id='tok-62-613'>uninstallation</span><span class='token pointer' id='tok-62-614'>routine.</span></p><p id=p615><span class='token pointer' id='tok-62-615'>Some</span><span class='token pointer' id='tok-62-616'>versions</span><span class='token pointer' id='tok-62-617'>of</span><span class='token pointer' id='tok-62-618'>the</span><span class='token pointer' id='tok-62-619'>PNF</span><span class='token pointer' id='tok-62-620'>DLL</span><span class='token pointer' id='tok-62-621'>also</span><span class='token pointer' id='tok-62-622'>start</span><span class='token pointer' id='tok-62-623'>an</span><span class='token pointer' id='tok-62-624' style='color:red'>RPC server</span><span class='token pointer' id='tok-62-625'>to</span><span class='token pointer' id='tok-62-626'>the</span><span class='token pointer' id='tok-62-627'>one</span><span class='token pointer' id='tok-62-628'>found</span><span class='token pointer' id='tok-62-629'>in</span><span class='token pointer' id='tok-62-630' style='color:red'>Stuxnet.</span></p><p id=p631><span class='token pointer' id='tok-62-631'>The</span><span class='token pointer' id='tok-62-632'>PNF</span><span class='token pointer' id='tok-62-633'>DLL</span><span class='token pointer' id='tok-62-634'>also</span><span class='token pointer' id='tok-62-635'>provides</span><span class='token pointer' id='tok-62-636' style='color:red'>API</span><span class='token pointer' id='tok-62-637'>for</span><span class='token pointer' id='tok-62-638'>manipulating</span><span class='token pointer' id='tok-62-639'>the</span><span class='token pointer' id='tok-62-640'>configuration</span><span class='token pointer' id='tok-62-641'>file</span><span class='token pointer' id='tok-62-642'>from</span><span class='token pointer' id='tok-62-643' style='color:red'>external modules</span></p><p id=p644><span class='token pointer' id='tok-62-644'>Depending</span><span class='token pointer' id='tok-62-645'>on</span><span class='token pointer' id='tok-62-646'>the</span><span class='token pointer' id='tok-62-647'>flags</span><span class='token pointer' id='tok-62-648'>in</span><span class='token pointer' id='tok-62-649'>the</span><span class='token pointer' id='tok-62-650'>PNF</span><span class='token pointer' id='tok-62-651'>Config,</span><span class='token pointer' id='tok-62-652'>the</span><span class='token pointer' id='tok-62-653'>PNF</span><span class='token pointer' id='tok-62-654'>DLL</span><span class='token pointer' id='tok-62-655'>code</span><span class='token pointer' id='tok-62-656'>looks</span><span class='token pointer' id='tok-62-657'>for</span><span class='token pointer' id='tok-62-658'>specific</span><span class='token pointer' id='tok-62-659'>processes:</span><span class='token pointer' id='tok-62-660'>the</span><span class='token pointer' id='tok-62-661'>list</span><span class='token pointer' id='tok-62-662'>of</span><span class='token pointer' id='tok-62-663'>process</span><span class='token pointer' id='tok-62-664'>names</span><span class='token pointer' id='tok-62-665'>in</span><span class='token pointer' id='tok-62-666'>the</span><span class='token pointer' id='tok-62-667'>PNF</span><span class='token pointer' id='tok-62-668'>Config,</span><span class='token pointer' id='tok-62-669'>"explorer.exe",</span><span class='token pointer' id='tok-62-670'>"svchost.exe"</span><span class='token pointer' id='tok-62-671'>and</span><span class='token pointer' id='tok-62-672'>then</span><span class='token pointer' id='tok-62-673'>injects</span><span class='token pointer' id='tok-62-674'>code</span><span class='token pointer' id='tok-62-675'>in</span><span class='token pointer' id='tok-62-676'>them.</span><span class='token pointer' id='tok-62-677'>The</span><span class='token pointer' id='tok-62-678'>code</span><span class='token pointer' id='tok-62-679'>to</span><span class='token pointer' id='tok-62-680'>be</span><span class='token pointer' id='tok-62-681'>injected</span><span class='token pointer' id='tok-62-682'>is</span><span class='token pointer' id='tok-62-683'>stored</span><span class='token pointer' id='tok-62-684'>in</span><span class='token pointer' id='tok-62-685' style='color:red'>binary resource 302</span><span class='token pointer' id='tok-62-686'>in</span><span class='token pointer' id='tok-62-687'>PNF</span><span class='token pointer' id='tok-62-688'>DLL.</span></p><p id=p689><span class='token pointer' id='tok-62-689'>Depending</span><span class='token pointer' id='tok-62-690'>on</span><span class='token pointer' id='tok-62-691'>the</span><span class='token pointer' id='tok-62-692'>flag</span><span class='token pointer' id='tok-62-693'>in</span><span class='token pointer' id='tok-62-694'>the</span><span class='token pointer' id='tok-62-695'>PNF</span><span class='token pointer' id='tok-62-696'>configuration</span><span class='token pointer' id='tok-62-697'>file,</span><span class='token pointer' id='tok-62-698'>it</span><span class='token pointer' id='tok-62-699'>is</span><span class='token pointer' id='tok-62-700'>either</span><span class='token pointer' id='tok-62-701'>a</span><span class='token pointer' id='tok-62-702'>DLL</span><span class='token pointer' id='tok-62-703'>loader</span><span class='token pointer' id='tok-62-704'>module</span><span class='token pointer' id='tok-62-705'>or</span><span class='token pointer' id='tok-62-706'>a</span><span class='token pointer' id='tok-62-707'>block</span><span class='token pointer' id='tok-62-708'>of</span><span class='token pointer' id='tok-62-709'>data</span><span class='token pointer' id='tok-62-710'>(equivalent</span><span class='token pointer' id='tok-62-711'>of</span><span class='token pointer' id='tok-62-712' style='color:red'>decompressed ".zdata",</span><span class='token pointer' id='tok-62-713'>below).</span><span class='token pointer' id='tok-62-714'>Both</span><span class='token pointer' id='tok-62-715'>configuration</span><span class='token pointer' id='tok-62-716'>have</span><span class='token pointer' id='tok-62-717'>been</span><span class='token pointer' id='tok-62-718'>found</span><span class='token pointer' id='tok-62-719'>in</span><span class='token pointer' id='tok-62-720'>different</span><span class='token pointer' id='tok-62-721'>Duqu</span><span class='token pointer' id='tok-62-722'>versions.</span><span class='token pointer' id='tok-62-723'>The</span><span class='token pointer' id='tok-62-724'>PNF</span><span class='token pointer' id='tok-62-725'>DLL</span><span class='token pointer' id='tok-62-726'>checks</span><span class='token pointer' id='tok-62-727'>a</span><span class='token pointer' id='tok-62-728'>flag</span><span class='token pointer' id='tok-62-729'>in</span><span class='token pointer' id='tok-62-730'>PNF</span><span class='token pointer' id='tok-62-731'>Config</span><span class='token pointer' id='tok-62-732'>and</span><span class='token pointer' id='tok-62-733'>determines</span><span class='token pointer' id='tok-62-734'>whether</span><span class='token pointer' id='tok-62-735'>to</span><span class='token pointer' id='tok-62-736'>pass</span><span class='token pointer' id='tok-62-737'>execution</span><span class='token pointer' id='tok-62-738'>to</span><span class='token pointer' id='tok-62-739'>the</span><span class='token pointer' id='tok-62-740'>DLL</span><span class='token pointer' id='tok-62-741'>loader</span><span class='token pointer' id='tok-62-742'>or</span><span class='token pointer' id='tok-62-743'>to</span><span class='token pointer' id='tok-62-744'>locate</span><span class='token pointer' id='tok-62-745'>the</span><span class='token pointer' id='tok-62-746' style='color:red'>payload</span><span class='token pointer' id='tok-62-747'>DLL</span><span class='token pointer' id='tok-62-748'>and</span><span class='token pointer' id='tok-62-749'>call</span><span class='token pointer' id='tok-62-750'>it</span><span class='token pointer' id='tok-62-751'>directly.</span></p><p id=p752><span class='token pointer' id='tok-62-752'>The</span><span class='token pointer' id='tok-62-753'>loader</span><span class='token pointer' id='tok-62-754'>DLL</span><span class='token pointer' id='tok-62-755'>module</span><span class='token pointer' id='tok-62-756'>is</span><span class='token pointer' id='tok-62-757'>similar</span><span class='token pointer' id='tok-62-758'>to</span><span class='token pointer' id='tok-62-759'>PNF</span><span class='token pointer' id='tok-62-760'>DLL.</span><span class='token pointer' id='tok-62-761'>The</span><span class='token pointer' id='tok-62-762'>main</span><span class='token pointer' id='tok-62-763'>purpose</span><span class='token pointer' id='tok-62-764'>of</span><span class='token pointer' id='tok-62-765'>the</span><span class='token pointer' id='tok-62-766'>loader</span><span class='token pointer' id='tok-62-767'>is</span><span class='token pointer' id='tok-62-768'>to</span><span class='token pointer' id='tok-62-769'>decompress</span><span class='token pointer' id='tok-62-770'>its</span><span class='token pointer' id='tok-62-771'>".zdata"</span><span class='token pointer' id='tok-62-772'>section</span><span class='token pointer' id='tok-62-773'>and</span><span class='token pointer' id='tok-62-774'>pass</span><span class='token pointer' id='tok-62-775'>execution</span><span class='token pointer' id='tok-62-776'>to</span><span class='token pointer' id='tok-62-777'>the</span><span class='token pointer' id='tok-62-778'>main</span><span class='token pointer' id='tok-62-779'>payload</span><span class='token pointer' id='tok-62-780'>that</span><span class='token pointer' id='tok-62-781'>is</span><span class='token pointer' id='tok-62-782'>contained</span><span class='token pointer' id='tok-62-783'>in</span><span class='token pointer' id='tok-62-784'>decompressed</span><span class='token pointer' id='tok-62-785'>data.</span></p><p id=p786><span class='token pointer' id='tok-62-786'>The</span><span class='token pointer' id='tok-62-787' style='color:red'>.zdata block</span><span class='token pointer' id='tok-62-788'>the</span><span class='token pointer' id='tok-62-789'>header</span><span class='token pointer' id='tok-62-790'>that</span><span class='token pointer' id='tok-62-791'>starts</span><span class='token pointer' id='tok-62-792'>with</span><span class='token pointer' id='tok-62-793'>the</span><span class='token pointer' id='tok-62-794'>magic</span><span class='token pointer' id='tok-62-795'>number</span><span class='token pointer' id='tok-62-796'>0x48747193.</span><span class='token pointer' id='tok-62-797'>It</span><span class='token pointer' id='tok-62-798'>contains</span><span class='token pointer' id='tok-62-799'>the</span><span class='token pointer' id='tok-62-800'>offsets</span><span class='token pointer' id='tok-62-801'>and</span><span class='token pointer' id='tok-62-802'>sizes</span><span class='token pointer' id='tok-62-803'>of</span><span class='token pointer' id='tok-62-804'>the</span><span class='token pointer' id='tok-62-805'>DLL</span><span class='token pointer' id='tok-62-806'>loader,</span><span class='token pointer' id='tok-62-807'>the</span><span class='token pointer' id='tok-62-808'>payload</span><span class='token pointer' id='tok-62-809'>configuration</span><span class='token pointer' id='tok-62-810'>block</span><span class='token pointer' id='tok-62-811'>and</span><span class='token pointer' id='tok-62-812'>the</span><span class='token pointer' id='tok-62-813'>payload</span><span class='token pointer' id='tok-62-814'>DLL.</span></p><p id=p815></p><p id=p815><span class='token pointer' id='tok-62-815'>The</span><span class='token pointer' id='tok-62-816'>configuration</span><span class='token pointer' id='tok-62-817'>block</span><span class='token pointer' id='tok-62-818'>contains</span><span class='token pointer' id='tok-62-819'>the</span><span class='token pointer' id='tok-62-820'>name</span><span class='token pointer' id='tok-62-821'>of</span><span class='token pointer' id='tok-62-822'>the</span><span class='token pointer' id='tok-62-823'>temporary</span><span class='token pointer' id='tok-62-824'>file</span><span class='token pointer' id='tok-62-825'>to</span><span class='token pointer' id='tok-62-826'>use</span><span class='token pointer' id='tok-62-827'>%TEMP%~DR0001.tmp,</span><span class='token pointer' id='tok-62-828'>additional</span><span class='token pointer' id='tok-62-829'>binary</span><span class='token pointer' id='tok-62-830'>data</span><span class='token pointer' id='tok-62-831'>controlling</span><span class='token pointer' id='tok-62-832'>the</span><span class='token pointer' id='tok-62-833'>behavior</span><span class='token pointer' id='tok-62-834'>of</span><span class='token pointer' id='tok-62-835'>the</span><span class='token pointer' id='tok-62-836'>payload</span><span class='token pointer' id='tok-62-837'>and</span><span class='token pointer' id='tok-62-838'>information</span><span class='token pointer' id='tok-62-839'>required</span><span class='token pointer' id='tok-62-840'>to</span><span class='token pointer' id='tok-62-841'>connect</span><span class='token pointer' id='tok-62-842'>to</span><span class='token pointer' id='tok-62-843'>the</span><span class='token pointer' id='tok-62-844' style='color:red'>C&C servers.</span><span class='token pointer' id='tok-62-845'>are</span><span class='token pointer' id='tok-62-846'>two</span><span class='token pointer' id='tok-62-847'>lists</span><span class='token pointer' id='tok-62-848'>of</span><span class='token pointer' id='tok-62-849' style='color:red'>C&C</span><span class='token pointer' id='tok-62-850'>servers,</span><span class='token pointer' id='tok-62-851'>one</span><span class='token pointer' id='tok-62-852'>can</span><span class='token pointer' id='tok-62-853'>contain</span><span class='token pointer' id='tok-62-854'>domain</span><span class='token pointer' id='tok-62-855'>names,</span><span class='token pointer' id='tok-62-856' style='color:red'>IP addresses</span><span class='token pointer' id='tok-62-857'>names</span><span class='token pointer' id='tok-62-858'>of</span><span class='token pointer' id='tok-62-859' style='color:red'>network shares,</span><span class='token pointer' id='tok-62-860'>the</span><span class='token pointer' id='tok-62-861'>other</span><span class='token pointer' id='tok-62-862'>contains</span><span class='token pointer' id='tok-62-863'>IP</span><span class='token pointer' id='tok-62-864'>addresses</span><span class='token pointer' id='tok-62-865'>in</span><span class='token pointer' id='tok-62-866'>binary</span><span class='token pointer' id='tok-62-867'>format</span><span class='token pointer' id='tok-62-868'>and</span><span class='token pointer' id='tok-62-869'>is</span><span class='token pointer' id='tok-62-870'>used</span><span class='token pointer' id='tok-62-871'>to</span><span class='token pointer' id='tok-62-872'>connect</span><span class='token pointer' id='tok-62-873'>using</span><span class='token pointer' id='tok-62-874'>Windows</span><span class='token pointer' id='tok-62-875' style='color:red'>HTTP</span><span class='token pointer' id='tok-62-876' style='color:red'>(winhttp)</span><span class='token pointer' id='tok-62-877'>services.</span><span class='token pointer' id='tok-62-878'>Although</span><span class='token pointer' id='tok-62-879'>the</span><span class='token pointer' id='tok-62-880'>configuration</span><span class='token pointer' id='tok-62-881'>blocks</span><span class='token pointer' id='tok-62-882'>we</span><span class='token pointer' id='tok-62-883'>have</span><span class='token pointer' id='tok-62-884'>found</span><span class='token pointer' id='tok-62-885'>so</span><span class='token pointer' id='tok-62-886'>far</span><span class='token pointer' id='tok-62-887'>are</span><span class='token pointer' id='tok-62-888'>similar</span><span class='token pointer' id='tok-62-889'>and</span><span class='token pointer' id='tok-62-890'>are</span><span class='token pointer' id='tok-62-891'>set</span><span class='token pointer' id='tok-62-892'>up</span><span class='token pointer' id='tok-62-893'>to</span><span class='token pointer' id='tok-62-894'>connect</span><span class='token pointer' id='tok-62-895'>to</span><span class='token pointer' id='tok-62-896'>its</span><span class='token pointer' id='tok-62-897'>C&C</span><span class='token pointer' id='tok-62-898'>using</span><span class='token pointer' id='tok-62-899'>HTTP</span><span class='token pointer' id='tok-62-900'>and</span><span class='token pointer' id='tok-62-901'>HTTPS,</span><span class='token pointer' id='tok-62-902'>the</span><span class='token pointer' id='tok-62-903'>payload</span><span class='token pointer' id='tok-62-904'>DLL</span><span class='token pointer' id='tok-62-905'>is</span><span class='token pointer' id='tok-62-906'>able</span><span class='token pointer' id='tok-62-907'>to</span><span class='token pointer' id='tok-62-908'>connect</span><span class='token pointer' id='tok-62-909'>to</span><span class='token pointer' id='tok-62-910'>a</span><span class='token pointer' id='tok-62-911'>network</span><span class='token pointer' id='tok-62-912'>share</span><span class='token pointer' id='tok-62-913'>and</span><span class='token pointer' id='tok-62-914'>even</span><span class='token pointer' id='tok-62-915'>become</span><span class='token pointer' id='tok-62-916'>a</span><span class='token pointer' id='tok-62-917'>server.</span></p><p id=p918><span class='token pointer' id='tok-62-918'>We</span><span class='token pointer' id='tok-62-919'>are</span><span class='token pointer' id='tok-62-920'>still</span><span class='token pointer' id='tok-62-921'>analyzing</span><span class='token pointer' id='tok-62-922'>the</span><span class='token pointer' id='tok-62-923'>payload.</span><span class='token pointer' id='tok-62-924'>It</span><span class='token pointer' id='tok-62-925'>contains</span><span class='token pointer' id='tok-62-926'>256K</span><span class='token pointer' id='tok-62-927'>of</span><span class='token pointer' id='tok-62-928' style='color:red'>C++ code</span><span class='token pointer' id='tok-62-929'>extensive</span><span class='token pointer' id='tok-62-930'>use</span><span class='token pointer' id='tok-62-931'>of</span><span class='token pointer' id='tok-62-932' style='color:red'>STL</span><span class='token pointer' id='tok-62-933'>and</span><span class='token pointer' id='tok-62-934'>its</span><span class='token pointer' id='tok-62-935'>own</span><span class='token pointer' id='tok-62-936'>complex</span><span class='token pointer' id='tok-62-937'>class</span><span class='token pointer' id='tok-62-938'>hierarchies,</span><span class='token pointer' id='tok-62-939'>probably</span><span class='token pointer' id='tok-62-940'>own</span><span class='token pointer' id='tok-62-941'>framework.</span></p><p id=p942><span class='token pointer' id='tok-62-942'>The</span><span class='token pointer' id='tok-62-943'>payload</span><span class='token pointer' id='tok-62-944'>is</span><span class='token pointer' id='tok-62-945'>able</span><span class='token pointer' id='tok-62-946'>to</span><span class='token pointer' id='tok-62-947'>connect</span><span class='token pointer' id='tok-62-948'>to</span><span class='token pointer' id='tok-62-949'>C&C</span><span class='token pointer' id='tok-62-950'>server</span><span class='token pointer' id='tok-62-951'>using</span><span class='token pointer' id='tok-62-952'>either</span><span class='token pointer' id='tok-62-953'>winhttp</span><span class='token pointer' id='tok-62-954'>library</span><span class='token pointer' id='tok-62-955'>or</span><span class='token pointer' id='tok-62-956'>connection</span><span class='token pointer' id='tok-62-957'>to</span><span class='token pointer' id='tok-62-958'>a</span><span class='token pointer' id='tok-62-959'>network</span><span class='token pointer' id='tok-62-960'>share</span><span class='token pointer' id='tok-62-961' style='color:red'>IPC$ endpoint.</span><span class='token pointer' id='tok-62-962'>is</span><span class='token pointer' id='tok-62-963'>able</span><span class='token pointer' id='tok-62-964'>to</span><span class='token pointer' id='tok-62-965'>connect</span><span class='token pointer' id='tok-62-966'>using</span><span class='token pointer' id='tok-62-967'>proxy</span><span class='token pointer' id='tok-62-968'>server</span><span class='token pointer' id='tok-62-969'>configuration</span><span class='token pointer' id='tok-62-970'>of</span><span class='token pointer' id='tok-62-971'>Internet</span><span class='token pointer' id='tok-62-972'>Explorer.</span><span class='token pointer' id='tok-62-973'>It</span><span class='token pointer' id='tok-62-974'>also</span><span class='token pointer' id='tok-62-975'>contains</span><span class='token pointer' id='tok-62-976'>code</span><span class='token pointer' id='tok-62-977'>for</span><span class='token pointer' id='tok-62-978'>acting</span><span class='token pointer' id='tok-62-979'>as</span><span class='token pointer' id='tok-62-980'>a</span><span class='token pointer' id='tok-62-981'>HTTP</span><span class='token pointer' id='tok-62-982'>server</span><span class='token pointer' id='tok-62-983'>and</span><span class='token pointer' id='tok-62-984'>processing</span><span class='token pointer' id='tok-62-985'>the</span><span class='token pointer' id='tok-62-986'>same</span><span class='token pointer' id='tok-62-987'>requests</span><span class='token pointer' id='tok-62-988'>as</span><span class='token pointer' id='tok-62-989'>served</span><span class='token pointer' id='tok-62-990'>by</span><span class='token pointer' id='tok-62-991'>the</span><span class='token pointer' id='tok-62-992'>C&C.</span></p><p id=p993><span class='token pointer' id='tok-62-993'>The</span><span class='token pointer' id='tok-62-994'>payload</span><span class='token pointer' id='tok-62-995'>is</span><span class='token pointer' id='tok-62-996'>able</span><span class='token pointer' id='tok-62-997'>to</span><span class='token pointer' id='tok-62-998'>load</span><span class='token pointer' id='tok-62-999'>an</span><span class='token pointer' id='tok-62-1000'>external</span><span class='token pointer' id='tok-62-1001'>DLL</span><span class='token pointer' id='tok-62-1002'>module</span><span class='token pointer' id='tok-62-1003'>provided</span><span class='token pointer' id='tok-62-1004'>by</span><span class='token pointer' id='tok-62-1005'>the</span><span class='token pointer' id='tok-62-1006'>C&C</span><span class='token pointer' id='tok-62-1007'>and</span><span class='token pointer' id='tok-62-1008'>interact</span><span class='token pointer' id='tok-62-1009'>with</span><span class='token pointer' id='tok-62-1010'>it</span><span class='token pointer' id='tok-62-1011'>using</span><span class='token pointer' id='tok-62-1012'>a</span><span class='token pointer' id='tok-62-1013'>pre-defined</span><span class='token pointer' id='tok-62-1014'>API.</span><span class='token pointer' id='tok-62-1015'>The</span><span class='token pointer' id='tok-62-1016'>most</span><span class='token pointer' id='tok-62-1017'>noticeable</span><span class='token pointer' id='tok-62-1018'>module</span><span class='token pointer' id='tok-62-1019'>discovered</span><span class='token pointer' id='tok-62-1020'>so</span><span class='token pointer' id='tok-62-1021'>far</span><span class='token pointer' id='tok-62-1022'>is</span><span class='token pointer' id='tok-62-1023'>the</span><span class='token pointer' id='tok-62-1024' style='color:red'>infostealer module.</span><span class='token pointer' id='tok-62-1025'>are</span><span class='token pointer' id='tok-62-1026'>also</span><span class='token pointer' id='tok-62-1027'>modules</span><span class='token pointer' id='tok-62-1028'>for</span><span class='token pointer' id='tok-62-1029'>updating</span><span class='token pointer' id='tok-62-1030'>the</span><span class='token pointer' id='tok-62-1031'>TTL</span><span class='token pointer' id='tok-62-1032'>value</span><span class='token pointer' id='tok-62-1033'>in</span><span class='token pointer' id='tok-62-1034'>the</span><span class='token pointer' id='tok-62-1035'>PNF</span><span class='token pointer' id='tok-62-1036'>DLL</span><span class='token pointer' id='tok-62-1037'>configuration,</span><span class='token pointer' id='tok-62-1038'>for</span><span class='token pointer' id='tok-62-1039'>reading</span><span class='token pointer' id='tok-62-1040'>the</span><span class='token pointer' id='tok-62-1041'>network</span><span class='token pointer' id='tok-62-1042'>and</span><span class='token pointer' id='tok-62-1043'>disk</span><span class='token pointer' id='tok-62-1044'>storage</span><span class='token pointer' id='tok-62-1045'>configuration</span><span class='token pointer' id='tok-62-1046'>from</span><span class='token pointer' id='tok-62-1047'>the</span><span class='token pointer' id='tok-62-1048'>infected</span><span class='token pointer' id='tok-62-1049'>machine.</span></p><p id=p1050><span class='token pointer' id='tok-62-1050'>It</span><span class='token pointer' id='tok-62-1051'>also</span><span class='token pointer' id='tok-62-1052'>can</span><span class='token pointer' id='tok-62-1053'>form</span><span class='token pointer' id='tok-62-1054'>a</span><span class='token pointer' id='tok-62-1055'>PNF</span><span class='token pointer' id='tok-62-1056'>DLL</span><span class='token pointer' id='tok-62-1057'>with</span><span class='token pointer' id='tok-62-1058'>a</span><span class='token pointer' id='tok-62-1059'>configuration</span><span class='token pointer' id='tok-62-1060'>block</span><span class='token pointer' id='tok-62-1061'>and</span><span class='token pointer' id='tok-62-1062'>the</span><span class='token pointer' id='tok-62-1063'>payload</span><span class='token pointer' id='tok-62-1064'>DLL</span><span class='token pointer' id='tok-62-1065'>ready</span><span class='token pointer' id='tok-62-1066'>for</span><span class='token pointer' id='tok-62-1067'>distribution</span><span class='token pointer' id='tok-62-1068'>to</span><span class='token pointer' id='tok-62-1069'>other</span><span class='token pointer' id='tok-62-1070'>machines.
</span></p>