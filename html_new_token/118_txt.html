<p id=p0><span class='token pointer' id='tok-118-0'>In</span><span class='token pointer' id='tok-118-1'>a</span><span class='token pointer' id='tok-118-2'>previous</span><span class='token pointer' id='tok-118-3'>post</span><span class='token pointer' id='tok-118-4'>we</span><span class='token pointer' id='tok-118-5'>discussed</span><span class='token pointer' id='tok-118-6'>the</span><span class='token pointer' id='tok-118-7'>performance</span><span class='token pointer' id='tok-118-8'>limitations</span><span class='token pointer' id='tok-118-9'>of</span><span class='token pointer' id='tok-118-10'>the</span><span class='token pointer' id='tok-118-12' style='color:red'>kernel</span><span class='token pointer' id='tok-118-13' style='color:red'>Linux</span><span class='token pointer' id='tok-118-14'>stack.</span><span class='token pointer' id='tok-118-15'>We</span><span class='token pointer' id='tok-118-16'>detailed</span><span class='token pointer' id='tok-118-17'>the</span><span class='token pointer' id='tok-118-18'>available</span><span class='token pointer' id='tok-118-20' style='color:red'>kernel bypass techniques</span><span class='token pointer' id='tok-118-21'>user</span><span class='token pointer' id='tok-118-22'>space</span><span class='token pointer' id='tok-118-23'>programs</span><span class='token pointer' id='tok-118-24'>to</span><span class='token pointer' id='tok-118-25'>receive</span><span class='token pointer' id='tok-118-26'>packets</span><span class='token pointer' id='tok-118-27'>with</span><span class='token pointer' id='tok-118-28' style='color:red'>high</span><span class='token pointer' id='tok-118-29'>throughput.</span><span class='token pointer' id='tok-118-30'>Unfortunately,</span><span class='token pointer' id='tok-118-31'>none</span><span class='token pointer' id='tok-118-32'>of</span><span class='token pointer' id='tok-118-33'>the</span><span class='token pointer' id='tok-118-34'>discussed</span><span class='token pointer' id='tok-118-35'>open</span><span class='token pointer' id='tok-118-36'>source</span><span class='token pointer' id='tok-118-38' style='color:red'>solutions supported our</span><span class='token pointer' id='tok-118-39'>To</span><span class='token pointer' id='tok-118-40' style='color:red'>improve</span><span class='token pointer' id='tok-118-41'>the</span><span class='token pointer' id='tok-118-42'>situation</span><span class='token pointer' id='tok-118-43'>we</span><span class='token pointer' id='tok-118-44'>decided</span><span class='token pointer' id='tok-118-45'>to</span><span class='token pointer' id='tok-118-46'>contribute</span><span class='token pointer' id='tok-118-47'>to</span><span class='token pointer' id='tok-118-48'>the</span><span class='token pointer' id='tok-118-49'>Netmap</span><span class='token pointer' id='tok-118-50'>project.</span><span class='token pointer' id='tok-118-51'>In</span><span class='token pointer' id='tok-118-52'>this</span><span class='token pointer' id='tok-118-53' style='color:red'>blog</span><span class='token pointer' id='tok-118-54'>post</span><span class='token pointer' id='tok-118-55'>we'll</span><span class='token pointer' id='tok-118-56'>describe</span><span class='token pointer' id='tok-118-57'>our</span><span class='token pointer' id='tok-118-58'>proposed</span><span class='token pointer' id='tok-118-59'>changes.</span></p><p id=p60><span class='token pointer' id='tok-118-60'>CC</span><span class='token pointer' id='tok-118-61'>BY-SA</span><span class='token pointer' id='tok-118-62'>2.0</span><span class='token pointer' id='tok-118-63'>image</span><span class='token pointer' id='tok-118-64'>by</span><span class='token pointer' id='tok-118-65'>Binary</span><span class='token pointer' id='tok-118-66'>Koala</span></p><p id=p67><span class='token pointer' id='tok-118-67'>Our</span><span class='token pointer' id='tok-118-68'>needsAt</span><span class='token pointer' id='tok-118-70' style='color:red'>CloudFlare we</span><span class='token pointer' id='tok-118-71'>constantly</span><span class='token pointer' id='tok-118-72'>dealing</span><span class='token pointer' id='tok-118-73' style='color:red'>with</span><span class='token pointer' id='tok-118-74'>large</span><span class='token pointer' id='tok-118-75'>packet</span><span class='token pointer' id='tok-118-76'>floods.</span><span class='token pointer' id='tok-118-77'>Our</span><span class='token pointer' id='tok-118-78'>network</span><span class='token pointer' id='tok-118-80' style='color:red'>receives</span><span class='token pointer' id='tok-118-81' style='color:red'>constantly</span><span class='token pointer' id='tok-118-82'>large</span><span class='token pointer' id='tok-118-83' style='color:red'>volume</span><span class='token pointer' id='tok-118-84'>of</span><span class='token pointer' id='tok-118-85'>packets,</span><span class='token pointer' id='tok-118-86'>often</span><span class='token pointer' id='tok-118-87'>coming</span><span class='token pointer' id='tok-118-88'>from</span><span class='token pointer' id='tok-118-89'>many,</span><span class='token pointer' id='tok-118-90'>simultaneous</span><span class='token pointer' id='tok-118-91'>attacks.</span><span class='token pointer' id='tok-118-92'>In</span><span class='token pointer' id='tok-118-93'>fact,</span><span class='token pointer' id='tok-118-94'>it</span><span class='token pointer' id='tok-118-95'>is</span><span class='token pointer' id='tok-118-96'>entirely</span><span class='token pointer' id='tok-118-97'>possible</span><span class='token pointer' id='tok-118-98'>that</span><span class='token pointer' id='tok-118-99'>the</span><span class='token pointer' id='tok-118-100'>server</span><span class='token pointer' id='tok-118-101'>which</span><span class='token pointer' id='tok-118-102'>just</span><span class='token pointer' id='tok-118-103'>served</span><span class='token pointer' id='tok-118-104'>you</span><span class='token pointer' id='tok-118-105'>this</span><span class='token pointer' id='tok-118-106'>blog</span><span class='token pointer' id='tok-118-107'>post</span><span class='token pointer' id='tok-118-108'>is</span><span class='token pointer' id='tok-118-109'>dealing</span><span class='token pointer' id='tok-118-110'>with</span><span class='token pointer' id='tok-118-111'>a</span><span class='token pointer' id='tok-118-112'>many-million</span><span class='token pointer' id='tok-118-113'>packets</span><span class='token pointer' id='tok-118-114'>per</span><span class='token pointer' id='tok-118-115'>second</span><span class='token pointer' id='tok-118-116'>flood</span><span class='token pointer' id='tok-118-117'>right</span><span class='token pointer' id='tok-118-118'>now.</span></p><p id=p119><span class='token pointer' id='tok-118-119'>Since</span><span class='token pointer' id='tok-118-120'>the</span><span class='token pointer' id='tok-118-121'>Linux</span><span class='token pointer' id='tok-118-122'>Kernel</span><span class='token pointer' id='tok-118-123'>can't</span><span class='token pointer' id='tok-118-124'>really</span><span class='token pointer' id='tok-118-125'>handle</span><span class='token pointer' id='tok-118-127' style='color:red'>a large</span><span class='token pointer' id='tok-118-128'>of</span><span class='token pointer' id='tok-118-129'>packets,</span><span class='token pointer' id='tok-118-130'>we</span><span class='token pointer' id='tok-118-131'>need</span><span class='token pointer' id='tok-118-132'>to</span><span class='token pointer' id='tok-118-133'>work</span><span class='token pointer' id='tok-118-134'>around</span><span class='token pointer' id='tok-118-135'>it.</span><span class='token pointer' id='tok-118-136'>During</span><span class='token pointer' id='tok-118-137'>packet</span><span class='token pointer' id='tok-118-138'>floods</span><span class='token pointer' id='tok-118-139'>we</span><span class='token pointer' id='tok-118-140'>offload</span><span class='token pointer' id='tok-118-141'>selected</span><span class='token pointer' id='tok-118-142'>network</span><span class='token pointer' id='tok-118-143'>flows</span><span class='token pointer' id='tok-118-144'>(belonging</span><span class='token pointer' id='tok-118-145'>to</span><span class='token pointer' id='tok-118-146' style='color:red'>a</span><span class='token pointer' id='tok-118-147'>flood)</span><span class='token pointer' id='tok-118-148'>to</span><span class='token pointer' id='tok-118-149'>a</span><span class='token pointer' id='tok-118-150'>user</span><span class='token pointer' id='tok-118-151'>space</span><span class='token pointer' id='tok-118-152'>application.</span><span class='token pointer' id='tok-118-153'>This</span><span class='token pointer' id='tok-118-154'>application</span><span class='token pointer' id='tok-118-155'>filters</span><span class='token pointer' id='tok-118-156'>the</span><span class='token pointer' id='tok-118-157'>packets</span><span class='token pointer' id='tok-118-158'>at</span><span class='token pointer' id='tok-118-159'>very</span><span class='token pointer' id='tok-118-160'>high</span><span class='token pointer' id='tok-118-161'>speed.</span><span class='token pointer' id='tok-118-162'>Most</span><span class='token pointer' id='tok-118-163'>of</span><span class='token pointer' id='tok-118-164'>the</span><span class='token pointer' id='tok-118-165'>packets</span><span class='token pointer' id='tok-118-166'>are</span><span class='token pointer' id='tok-118-167'>dropped,</span><span class='token pointer' id='tok-118-168'>as</span><span class='token pointer' id='tok-118-169'>they</span><span class='token pointer' id='tok-118-170'></span><span class='token pointer' id='tok-118-171'>belong</span><span class='token pointer' id='tok-118-172'>to</span><span class='token pointer' id='tok-118-173'>a</span><span class='token pointer' id='tok-118-174'>flood.</span><span class='token pointer' id='tok-118-175'>The</span><span class='token pointer' id='tok-118-176'>small</span><span class='token pointer' id='tok-118-177'>number</span><span class='token pointer' id='tok-118-178'>of</span><span class='token pointer' id='tok-118-179'>"valid"</span><span class='token pointer' id='tok-118-180'>packets</span><span class='token pointer' id='tok-118-181'>are</span><span class='token pointer' id='tok-118-182'>injected</span><span class='token pointer' id='tok-118-183'>back</span><span class='token pointer' id='tok-118-184'>to</span><span class='token pointer' id='tok-118-185'>the</span><span class='token pointer' id='tok-118-186'>kernel</span><span class='token pointer' id='tok-118-187'>and</span><span class='token pointer' id='tok-118-188'>handled</span><span class='token pointer' id='tok-118-189' style='color:red'>in</span><span class='token pointer' id='tok-118-190'>the</span><span class='token pointer' id='tok-118-191'>same</span><span class='token pointer' id='tok-118-192'>way</span><span class='token pointer' id='tok-118-193'>as</span><span class='token pointer' id='tok-118-194'>usual</span><span class='token pointer' id='tok-118-195'>traffic.</span></p><p id=p196><span class='token pointer' id='tok-118-196'>It's</span><span class='token pointer' id='tok-118-197'>important</span><span class='token pointer' id='tok-118-198'>to</span><span class='token pointer' id='tok-118-199'>emphasize</span><span class='token pointer' id='tok-118-200'>that</span><span class='token pointer' id='tok-118-201'>the</span><span class='token pointer' id='tok-118-202'>kernel</span><span class='token pointer' id='tok-118-203'>bypass</span><span class='token pointer' id='tok-118-204'>is</span><span class='token pointer' id='tok-118-205'>enabled</span><span class='token pointer' id='tok-118-206'>only</span><span class='token pointer' id='tok-118-207'>for</span><span class='token pointer' id='tok-118-209' style='color:red'>selected flows,</span><span class='token pointer' id='tok-118-210'>means</span><span class='token pointer' id='tok-118-211'>that</span><span class='token pointer' id='tok-118-212'>all</span><span class='token pointer' id='tok-118-213'>other</span><span class='token pointer' id='tok-118-214'>packets</span><span class='token pointer' id='tok-118-215'>go</span><span class='token pointer' id='tok-118-216'>to</span><span class='token pointer' id='tok-118-217'>the</span><span class='token pointer' id='tok-118-218'>kernel</span><span class='token pointer' id='tok-118-219'>as</span><span class='token pointer' id='tok-118-220'>usual.</span></p><p id=p221><span class='token pointer' id='tok-118-221'>This</span><span class='token pointer' id='tok-118-222'>setup</span><span class='token pointer' id='tok-118-223'>works</span><span class='token pointer' id='tok-118-224'>perfectly</span><span class='token pointer' id='tok-118-225'>on</span><span class='token pointer' id='tok-118-226'>our</span><span class='token pointer' id='tok-118-227'>servers</span><span class='token pointer' id='tok-118-228'>with</span><span class='token pointer' id='tok-118-229'>Solarflare</span><span class='token pointer' id='tok-118-230'>network</span><span class='token pointer' id='tok-118-231'>cards</span><span class='token pointer' id='tok-118-232'>-</span><span class='token pointer' id='tok-118-233'>we</span><span class='token pointer' id='tok-118-234'>can</span><span class='token pointer' id='tok-118-235'>use</span><span class='token pointer' id='tok-118-236' style='color:red'>the</span><span class='token pointer' id='tok-118-237'>ef_vi</span><span class='token pointer' id='tok-118-238'>API</span><span class='token pointer' id='tok-118-239'>to</span><span class='token pointer' id='tok-118-240'>achieve</span><span class='token pointer' id='tok-118-241'>the</span><span class='token pointer' id='tok-118-242'>kernel</span><span class='token pointer' id='tok-118-243'>bypass.</span><span class='token pointer' id='tok-118-244'>Unfortunately,</span><span class='token pointer' id='tok-118-245' style='color:red'>we</span><span class='token pointer' id='tok-118-246'>don't</span><span class='token pointer' id='tok-118-247'>have</span><span class='token pointer' id='tok-118-248'>this</span><span class='token pointer' id='tok-118-249'>functionality</span><span class='token pointer' id='tok-118-250'>on</span><span class='token pointer' id='tok-118-251'>our</span><span class='token pointer' id='tok-118-252'>servers</span><span class='token pointer' id='tok-118-253'>with</span><span class='token pointer' id='tok-118-254'>Intel</span><span class='token pointer' id='tok-118-255'>IXGBE</span><span class='token pointer' id='tok-118-256'>NIC's.</span></p><p id=p257><span class='token pointer' id='tok-118-257'>This</span><span class='token pointer' id='tok-118-258'>is</span><span class='token pointer' id='tok-118-259'>when</span><span class='token pointer' id='tok-118-260'>Netmap</span><span class='token pointer' id='tok-118-261'>comes</span><span class='token pointer' id='tok-118-262'>in.</span></p><p id=p263><span class='token pointer' id='tok-118-263'>NetmapOver</span><span class='token pointer' id='tok-118-264'>the</span><span class='token pointer' id='tok-118-265'>last</span><span class='token pointer' id='tok-118-266'>few</span><span class='token pointer' id='tok-118-267'>months</span><span class='token pointer' id='tok-118-268'>we've</span><span class='token pointer' id='tok-118-269'>been</span><span class='token pointer' id='tok-118-270'>thinking</span><span class='token pointer' id='tok-118-271'>hard</span><span class='token pointer' id='tok-118-272'>about</span><span class='token pointer' id='tok-118-273'>how</span><span class='token pointer' id='tok-118-274'>to</span><span class='token pointer' id='tok-118-275'>achieve</span><span class='token pointer' id='tok-118-276'>bypass</span><span class='token pointer' id='tok-118-277'>for</span><span class='token pointer' id='tok-118-278'>selected</span><span class='token pointer' id='tok-118-279'>flows</span><span class='token pointer' id='tok-118-280'>(aka:</span><span class='token pointer' id='tok-118-281'>bifurcated</span><span class='token pointer' id='tok-118-282'>driver)</span><span class='token pointer' id='tok-118-283'>on</span><span class='token pointer' id='tok-118-284'>non-Solarflare</span><span class='token pointer' id='tok-118-285'>network</span><span class='token pointer' id='tok-118-286'>cards.</span></p><p id=p287><span class='token pointer' id='tok-118-287'>We've</span><span class='token pointer' id='tok-118-289' style='color:red'>considered PF_RING,</span><span class='token pointer' id='tok-118-290'>and</span><span class='token pointer' id='tok-118-291' style='color:red'>other</span><span class='token pointer' id='tok-118-292'>custom</span><span class='token pointer' id='tok-118-293'>solutions,</span><span class='token pointer' id='tok-118-294'>but</span><span class='token pointer' id='tok-118-295'>sadly</span><span class='token pointer' id='tok-118-296' style='color:red'>all</span><span class='token pointer' id='tok-118-297' style='color:red'>of</span><span class='token pointer' id='tok-118-298'>them</span><span class='token pointer' id='tok-118-299'>take</span><span class='token pointer' id='tok-118-300'>over</span><span class='token pointer' id='tok-118-301'>the</span><span class='token pointer' id='tok-118-302'>whole</span><span class='token pointer' id='tok-118-303'>network</span><span class='token pointer' id='tok-118-304'>card.</span><span class='token pointer' id='tok-118-305'>Eventually</span><span class='token pointer' id='tok-118-306'>we</span><span class='token pointer' id='tok-118-307'>decided</span><span class='token pointer' id='tok-118-308'>that</span><span class='token pointer' id='tok-118-309'>the</span><span class='token pointer' id='tok-118-310'>best</span><span class='token pointer' id='tok-118-311'>way</span><span class='token pointer' id='tok-118-312'>would</span><span class='token pointer' id='tok-118-313'>be</span><span class='token pointer' id='tok-118-314'>to</span><span class='token pointer' id='tok-118-315'>patch</span><span class='token pointer' id='tok-118-316'>Netmap</span><span class='token pointer' id='tok-118-317'>with</span><span class='token pointer' id='tok-118-318'>the</span><span class='token pointer' id='tok-118-319'>functionality</span><span class='token pointer' id='tok-118-320'>we</span><span class='token pointer' id='tok-118-321'>need.</span></p><p id=p322><span class='token pointer' id='tok-118-322'>We</span><span class='token pointer' id='tok-118-323'>chose</span><span class='token pointer' id='tok-118-324'>Netmap</span><span class='token pointer' id='tok-118-325'>because:</span></p><p id=p326><span class='token pointer' id='tok-118-326'>It's</span><span class='token pointer' id='tok-118-327'>fully</span><span class='token pointer' id='tok-118-328'>open</span><span class='token pointer' id='tok-118-329'>source</span><span class='token pointer' id='tok-118-330'>and</span><span class='token pointer' id='tok-118-331'>released</span><span class='token pointer' id='tok-118-332'>under</span><span class='token pointer' id='tok-118-333'>a</span><span class='token pointer' id='tok-118-334'>BSD</span><span class='token pointer' id='tok-118-335'>license.It</span><span class='token pointer' id='tok-118-337' style='color:red'>has a</span><span class='token pointer' id='tok-118-338'>NIC-agnostic</span><span class='token pointer' id='tok-118-339'>API.It's</span><span class='token pointer' id='tok-118-340'>very</span><span class='token pointer' id='tok-118-341'>fast:</span><span class='token pointer' id='tok-118-342' style='color:red'>can</span><span class='token pointer' id='tok-118-343'>reach</span><span class='token pointer' id='tok-118-344'>line</span><span class='token pointer' id='tok-118-345'>rate</span><span class='token pointer' id='tok-118-346'>easily.The</span><span class='token pointer' id='tok-118-347' style='color:red'>project</span><span class='token pointer' id='tok-118-348' style='color:red'>is</span><span class='token pointer' id='tok-118-349'>well</span><span class='token pointer' id='tok-118-350'>maintained</span><span class='token pointer' id='tok-118-351'>and</span><span class='token pointer' id='tok-118-352'>reasonably</span><span class='token pointer' id='tok-118-353'>mature.The</span><span class='token pointer' id='tok-118-354'>code</span><span class='token pointer' id='tok-118-355'>is</span><span class='token pointer' id='tok-118-356'>very</span><span class='token pointer' id='tok-118-357'>high</span><span class='token pointer' id='tok-118-358'>quality.The</span><span class='token pointer' id='tok-118-359'>driver-specific</span><span class='token pointer' id='tok-118-360'>modifications</span><span class='token pointer' id='tok-118-361'>are</span><span class='token pointer' id='tok-118-362'>trivial:</span><span class='token pointer' id='tok-118-363'>most</span><span class='token pointer' id='tok-118-364'>of</span><span class='token pointer' id='tok-118-365'>the</span><span class='token pointer' id='tok-118-366'>magic</span><span class='token pointer' id='tok-118-367'>happens</span><span class='token pointer' id='tok-118-368'>in</span><span class='token pointer' id='tok-118-369'>the</span><span class='token pointer' id='tok-118-370'>shared</span><span class='token pointer' id='tok-118-371'>Netmap</span><span class='token pointer' id='tok-118-372'>module.</span><span class='token pointer' id='tok-118-373'>It's</span><span class='token pointer' id='tok-118-374'>easy</span><span class='token pointer' id='tok-118-375'>to</span><span class='token pointer' id='tok-118-376'>add</span><span class='token pointer' id='tok-118-377'>support</span><span class='token pointer' id='tok-118-378'>for</span><span class='token pointer' id='tok-118-379'>new</span><span class='token pointer' id='tok-118-380'>hardware.Introducing</span><span class='token pointer' id='tok-118-381'>the</span><span class='token pointer' id='tok-118-382'>single</span><span class='token pointer' id='tok-118-383'>RX</span><span class='token pointer' id='tok-118-384'>queue</span><span class='token pointer' id='tok-118-385'>modeUsually,</span><span class='token pointer' id='tok-118-386'>when</span><span class='token pointer' id='tok-118-387'>a</span><span class='token pointer' id='tok-118-388'>network</span><span class='token pointer' id='tok-118-389'>card</span><span class='token pointer' id='tok-118-390'>goes</span><span class='token pointer' id='tok-118-391'>into</span><span class='token pointer' id='tok-118-393' style='color:red'>the Netmap</span><span class='token pointer' id='tok-118-394'>all</span><span class='token pointer' id='tok-118-395'>the</span><span class='token pointer' id='tok-118-396'>RX</span><span class='token pointer' id='tok-118-397'>queues</span><span class='token pointer' id='tok-118-398'>get</span><span class='token pointer' id='tok-118-399'>disconnected</span><span class='token pointer' id='tok-118-400'>from</span><span class='token pointer' id='tok-118-401'>the</span><span class='token pointer' id='tok-118-402'>kernel</span><span class='token pointer' id='tok-118-403'>and</span><span class='token pointer' id='tok-118-404'>are</span><span class='token pointer' id='tok-118-405'>available</span><span class='token pointer' id='tok-118-407' style='color:red'>the</span><span class='token pointer' id='tok-118-408' style='color:red'>to</span><span class='token pointer' id='tok-118-409'>applications.</span></p><p id=p410><span class='token pointer' id='tok-118-410'>We</span><span class='token pointer' id='tok-118-411'>don't</span><span class='token pointer' id='tok-118-412'>want</span><span class='token pointer' id='tok-118-413'>that.</span><span class='token pointer' id='tok-118-414'>We</span><span class='token pointer' id='tok-118-415'>want</span><span class='token pointer' id='tok-118-416'>to</span><span class='token pointer' id='tok-118-417'>keep</span><span class='token pointer' id='tok-118-418'>most</span><span class='token pointer' id='tok-118-419'>of</span><span class='token pointer' id='tok-118-420'>the</span><span class='token pointer' id='tok-118-421'>RX</span><span class='token pointer' id='tok-118-422'>queues</span><span class='token pointer' id='tok-118-423'>back</span><span class='token pointer' id='tok-118-424'>in</span><span class='token pointer' id='tok-118-425'>the</span><span class='token pointer' id='tok-118-426'>kernel</span><span class='token pointer' id='tok-118-427'>mode,</span><span class='token pointer' id='tok-118-428'>and</span><span class='token pointer' id='tok-118-429'>enable</span><span class='token pointer' id='tok-118-430'>Netmap</span><span class='token pointer' id='tok-118-431'>mode</span><span class='token pointer' id='tok-118-432'>only</span><span class='token pointer' id='tok-118-433'>on</span><span class='token pointer' id='tok-118-434'>selected</span><span class='token pointer' id='tok-118-435'>RX</span><span class='token pointer' id='tok-118-436'>queues.</span><span class='token pointer' id='tok-118-437'>We</span><span class='token pointer' id='tok-118-438'>call</span><span class='token pointer' id='tok-118-439'>this</span><span class='token pointer' id='tok-118-440'>functionality:</span><span class='token pointer' id='tok-118-441'>"single</span><span class='token pointer' id='tok-118-442'>RX</span><span class='token pointer' id='tok-118-443'>queue</span><span class='token pointer' id='tok-118-444'>mode".</span></p><p id=p445><span class='token pointer' id='tok-118-445'>The</span><span class='token pointer' id='tok-118-446'>intention</span><span class='token pointer' id='tok-118-447'>was</span><span class='token pointer' id='tok-118-448'>to</span><span class='token pointer' id='tok-118-449'>expose</span><span class='token pointer' id='tok-118-450'>a</span><span class='token pointer' id='tok-118-451'>minimal</span><span class='token pointer' id='tok-118-452'>API</span><span class='token pointer' id='tok-118-453'>which</span><span class='token pointer' id='tok-118-454'>could:</span></p><p id=p455><span class='token pointer' id='tok-118-455'>Open</span><span class='token pointer' id='tok-118-456'>a</span><span class='token pointer' id='tok-118-457'>network</span><span class='token pointer' id='tok-118-458'>interface</span><span class='token pointer' id='tok-118-459'>in</span><span class='token pointer' id='tok-118-460'>"a</span><span class='token pointer' id='tok-118-461'>single</span><span class='token pointer' id='tok-118-462'>RX</span><span class='token pointer' id='tok-118-463'>queue</span><span class='token pointer' id='tok-118-464'>mode".This</span><span class='token pointer' id='tok-118-465'>would</span><span class='token pointer' id='tok-118-466'>allow</span><span class='token pointer' id='tok-118-467'>netmap</span><span class='token pointer' id='tok-118-468'>applications</span><span class='token pointer' id='tok-118-469'>to</span><span class='token pointer' id='tok-118-470'>receive</span><span class='token pointer' id='tok-118-471'>packets</span><span class='token pointer' id='tok-118-472'>from</span><span class='token pointer' id='tok-118-473'>that</span><span class='token pointer' id='tok-118-474'>specific</span><span class='token pointer' id='tok-118-475'>RX</span><span class='token pointer' id='tok-118-476'>queue.While</span><span class='token pointer' id='tok-118-477'>leaving</span><span class='token pointer' id='tok-118-478'>all</span><span class='token pointer' id='tok-118-479'>the</span><span class='token pointer' id='tok-118-480'>other</span><span class='token pointer' id='tok-118-481'>queues</span><span class='token pointer' id='tok-118-482'>attached</span><span class='token pointer' id='tok-118-483'>to</span><span class='token pointer' id='tok-118-484'>the</span><span class='token pointer' id='tok-118-486' style='color:red'>host network</span><span class='token pointer' id='tok-118-487'>demand</span><span class='token pointer' id='tok-118-488'>add</span><span class='token pointer' id='tok-118-489'>or</span><span class='token pointer' id='tok-118-490'>remove</span><span class='token pointer' id='tok-118-491'>RX</span><span class='token pointer' id='tok-118-492'>queues</span><span class='token pointer' id='tok-118-493'>from</span><span class='token pointer' id='tok-118-494'>the</span><span class='token pointer' id='tok-118-495'>"single</span><span class='token pointer' id='tok-118-496'>RX</span><span class='token pointer' id='tok-118-497'>queue</span><span class='token pointer' id='tok-118-498'>mode".Eventually</span><span class='token pointer' id='tok-118-499'>remove</span><span class='token pointer' id='tok-118-500'>the</span><span class='token pointer' id='tok-118-501'>interface</span><span class='token pointer' id='tok-118-502'>from</span><span class='token pointer' id='tok-118-503'>the</span><span class='token pointer' id='tok-118-504'>Netmap</span><span class='token pointer' id='tok-118-505'>mode</span><span class='token pointer' id='tok-118-506'>and</span><span class='token pointer' id='tok-118-507'>reattach</span><span class='token pointer' id='tok-118-508'>the</span><span class='token pointer' id='tok-118-509'>RX</span><span class='token pointer' id='tok-118-510'>queues</span><span class='token pointer' id='tok-118-511'>to</span><span class='token pointer' id='tok-118-512'>the</span><span class='token pointer' id='tok-118-513'>host</span><span class='token pointer' id='tok-118-514'>stack.</span></p><p id=p515><span class='token pointer' id='tok-118-515'>Indeed</span><span class='token pointer' id='tok-118-516'>the</span><span class='token pointer' id='tok-118-517'>only</span><span class='token pointer' id='tok-118-518' style='color:red'>difference</span><span class='token pointer' id='tok-118-519'>is</span><span class='token pointer' id='tok-118-520'>the</span><span class='token pointer' id='tok-118-521'>nm_open()</span><span class='token pointer' id='tok-118-522'>call,</span><span class='token pointer' id='tok-118-523'>which</span><span class='token pointer' id='tok-118-524'>uses</span><span class='token pointer' id='tok-118-525'>the</span><span class='token pointer' id='tok-118-526'>new</span><span class='token pointer' id='tok-118-527'>syntax</span><span class='token pointer' id='tok-118-528'>netmap:ifname~queue_number.</span></p><p id=p529><span class='token pointer' id='tok-118-529'>Once</span><span class='token pointer' id='tok-118-530'>again,</span><span class='token pointer' id='tok-118-531'>when</span><span class='token pointer' id='tok-118-532'>running</span><span class='token pointer' id='tok-118-533'>this</span><span class='token pointer' id='tok-118-534'>code</span><span class='token pointer' id='tok-118-535'>only</span><span class='token pointer' id='tok-118-536'>packets</span><span class='token pointer' id='tok-118-537'>arriving</span><span class='token pointer' id='tok-118-538'>on</span><span class='token pointer' id='tok-118-539'>the</span><span class='token pointer' id='tok-118-540'>RX</span><span class='token pointer' id='tok-118-541'>queue</span><span class='token pointer' id='tok-118-542'>#4</span><span class='token pointer' id='tok-118-543'>will</span><span class='token pointer' id='tok-118-544'>go</span><span class='token pointer' id='tok-118-545'>to</span><span class='token pointer' id='tok-118-546'>the</span><span class='token pointer' id='tok-118-547'>netmap</span><span class='token pointer' id='tok-118-548'>program.</span><span class='token pointer' id='tok-118-549'>All</span><span class='token pointer' id='tok-118-550'>other</span><span class='token pointer' id='tok-118-551'>RX</span><span class='token pointer' id='tok-118-552'>and</span><span class='token pointer' id='tok-118-553'>TX</span><span class='token pointer' id='tok-118-554'>queues</span><span class='token pointer' id='tok-118-555'>will</span><span class='token pointer' id='tok-118-556'>be</span><span class='token pointer' id='tok-118-557'>handled</span><span class='token pointer' id='tok-118-558'>by</span><span class='token pointer' id='tok-118-559'>the</span><span class='token pointer' id='tok-118-560'>Linux</span><span class='token pointer' id='tok-118-561'>kernel</span><span class='token pointer' id='tok-118-562'>network</span><span class='token pointer' id='tok-118-563'>stack.</span></p><p id=p564><span class='token pointer' id='tok-118-564'>Isolating</span><span class='token pointer' id='tok-118-565'>a</span><span class='token pointer' id='tok-118-566'>queueIn</span><span class='token pointer' id='tok-118-567'>multiqueue</span><span class='token pointer' id='tok-118-568'>network</span><span class='token pointer' id='tok-118-569'>cards,</span><span class='token pointer' id='tok-118-570'>any</span><span class='token pointer' id='tok-118-571'>packet</span><span class='token pointer' id='tok-118-572'>can</span><span class='token pointer' id='tok-118-573'>end</span><span class='token pointer' id='tok-118-574'>up</span><span class='token pointer' id='tok-118-575'>in</span><span class='token pointer' id='tok-118-576'>almost</span><span class='token pointer' id='tok-118-577'>any</span><span class='token pointer' id='tok-118-578'>RX</span><span class='token pointer' id='tok-118-579'>queue</span><span class='token pointer' id='tok-118-580'>due</span><span class='token pointer' id='tok-118-581'>to</span><span class='token pointer' id='tok-118-582'>RSS.</span><span class='token pointer' id='tok-118-583'>This</span><span class='token pointer' id='tok-118-584'>is</span><span class='token pointer' id='tok-118-585'>why</span><span class='token pointer' id='tok-118-586'>before</span><span class='token pointer' id='tok-118-587'>enabling</span><span class='token pointer' id='tok-118-588'>the</span><span class='token pointer' id='tok-118-589'>single</span><span class='token pointer' id='tok-118-590'>RX</span><span class='token pointer' id='tok-118-591'>mode</span><span class='token pointer' id='tok-118-592'>it</span><span class='token pointer' id='tok-118-593' style='color:red'>is</span><span class='token pointer' id='tok-118-594'>necessary</span><span class='token pointer' id='tok-118-595'>to</span><span class='token pointer' id='tok-118-596'>make</span><span class='token pointer' id='tok-118-597'>sure</span><span class='token pointer' id='tok-118-598'>only</span><span class='token pointer' id='tok-118-599'>the</span><span class='token pointer' id='tok-118-600'>selected</span><span class='token pointer' id='tok-118-601'>flow</span><span class='token pointer' id='tok-118-602'>goes</span><span class='token pointer' id='tok-118-603'>to</span><span class='token pointer' id='tok-118-604'>the</span><span class='token pointer' id='tok-118-605'>Netmap</span><span class='token pointer' id='tok-118-606'>queue.</span></p><p id=p607><span class='token pointer' id='tok-118-607'>To</span><span class='token pointer' id='tok-118-608'>do</span><span class='token pointer' id='tok-118-609'>so</span><span class='token pointer' id='tok-118-610'>it</span><span class='token pointer' id='tok-118-611'>is</span><span class='token pointer' id='tok-118-612'>necessary</span><span class='token pointer' id='tok-118-613'>to:</span></p><p id=p614><span class='token pointer' id='tok-118-614'>Modify</span><span class='token pointer' id='tok-118-615'>the</span><span class='token pointer' id='tok-118-616'>indirection</span><span class='token pointer' id='tok-118-617'>table</span><span class='token pointer' id='tok-118-618'>to</span><span class='token pointer' id='tok-118-619'>ensure</span><span class='token pointer' id='tok-118-620'>no</span><span class='token pointer' id='tok-118-621'>new</span><span class='token pointer' id='tok-118-622'>RSS-hashed</span><span class='token pointer' id='tok-118-623'>packets</span><span class='token pointer' id='tok-118-624'>will</span><span class='token pointer' id='tok-118-625'>go</span><span class='token pointer' id='tok-118-626'>there.Use</span><span class='token pointer' id='tok-118-627'>flow</span><span class='token pointer' id='tok-118-628'>steering</span><span class='token pointer' id='tok-118-629'>to</span><span class='token pointer' id='tok-118-630'>specifically</span><span class='token pointer' id='tok-118-631'>direct</span><span class='token pointer' id='tok-118-632'>some</span><span class='token pointer' id='tok-118-633' style='color:red'>flows</span><span class='token pointer' id='tok-118-634'>to</span><span class='token pointer' id='tok-118-635'>the</span><span class='token pointer' id='tok-118-636'>isolated</span><span class='token pointer' id='tok-118-637'>queue.Work</span><span class='token pointer' id='tok-118-639' style='color:red'>around RFS</span><span class='token pointer' id='tok-118-640'>make</span><span class='token pointer' id='tok-118-641'>sure</span><span class='token pointer' id='tok-118-642'>no</span><span class='token pointer' id='tok-118-643'>other</span><span class='token pointer' id='tok-118-644'>application</span><span class='token pointer' id='tok-118-645'>is</span><span class='token pointer' id='tok-118-646'>running</span><span class='token pointer' id='tok-118-647'>on</span><span class='token pointer' id='tok-118-648'>the</span><span class='token pointer' id='tok-118-649'>CPU</span><span class='token pointer' id='tok-118-650'>Netmap</span><span class='token pointer' id='tok-118-651'>will</span><span class='token pointer' id='tok-118-652'>run</span><span class='token pointer' id='tok-118-653'>on.For</span><span class='token pointer' id='tok-118-654'>example:</span></p><p id=p655><span class='token pointer' id='tok-118-655'>$</span><span class='token pointer' id='tok-118-656'>ethtool</span><span class='token pointer' id='tok-118-657'>-X</span><span class='token pointer' id='tok-118-658'>eth3</span><span class='token pointer' id='tok-118-659'>weight</span><span class='token pointer' id='tok-118-660'>1</span><span class='token pointer' id='tok-118-661'>1</span><span class='token pointer' id='tok-118-662'>1</span><span class='token pointer' id='tok-118-663'>1</span><span class='token pointer' id='tok-118-664'>0</span><span class='token pointer' id='tok-118-665'>1</span><span class='token pointer' id='tok-118-666'>1</span><span class='token pointer' id='tok-118-667'>1</span><span class='token pointer' id='tok-118-668' style='color:red'>1</span><span class='token pointer' id='tok-118-669'>1$</span><span class='token pointer' id='tok-118-670'>ethtool</span><span class='token pointer' id='tok-118-671'>-K</span><span class='token pointer' id='tok-118-672'>eth3</span><span class='token pointer' id='tok-118-673'>ntuple</span><span class='token pointer' id='tok-118-674'>on$</span><span class='token pointer' id='tok-118-675'>ethtool</span><span class='token pointer' id='tok-118-676'>-N</span><span class='token pointer' id='tok-118-677'>eth3</span><span class='token pointer' id='tok-118-678'>flow-type</span><span class='token pointer' id='tok-118-679'>udp4</span><span class='token pointer' id='tok-118-680'>dst-port</span><span class='token pointer' id='tok-118-681'>53</span><span class='token pointer' id='tok-118-682'>action</span><span class='token pointer' id='tok-118-683'>4Here</span><span class='token pointer' id='tok-118-684'>we</span><span class='token pointer' id='tok-118-685'>are</span><span class='token pointer' id='tok-118-686'>setting</span><span class='token pointer' id='tok-118-687'>the</span><span class='token pointer' id='tok-118-688'>indirection</span><span class='token pointer' id='tok-118-689'>table</span><span class='token pointer' id='tok-118-690'>to</span><span class='token pointer' id='tok-118-691'>prevent</span><span class='token pointer' id='tok-118-692' style='color:red'>traffic</span><span class='token pointer' id='tok-118-693'>from</span><span class='token pointer' id='tok-118-694'>going</span><span class='token pointer' id='tok-118-695'>to</span><span class='token pointer' id='tok-118-696'>RX</span><span class='token pointer' id='tok-118-697'>queue</span><span class='token pointer' id='tok-118-698'>#4.</span><span class='token pointer' id='tok-118-699'>Then</span><span class='token pointer' id='tok-118-700'>we</span><span class='token pointer' id='tok-118-701'>are</span><span class='token pointer' id='tok-118-702'>enabling</span><span class='token pointer' id='tok-118-703'>flow</span><span class='token pointer' id='tok-118-704'>steering</span><span class='token pointer' id='tok-118-705'>to</span><span class='token pointer' id='tok-118-706'>enqueue</span><span class='token pointer' id='tok-118-707'>all</span><span class='token pointer' id='tok-118-708'>UDP</span><span class='token pointer' id='tok-118-709'>traffic</span><span class='token pointer' id='tok-118-710'>with</span><span class='token pointer' id='tok-118-711'>destination</span><span class='token pointer' id='tok-118-712'>port</span><span class='token pointer' id='tok-118-713'>53</span><span class='token pointer' id='tok-118-714'>into</span><span class='token pointer' id='tok-118-715'>queue</span><span class='token pointer' id='tok-118-716'>#4.</span></p><p id=p717><span class='token pointer' id='tok-118-717'>Trying</span><span class='token pointer' id='tok-118-718'>it</span><span class='token pointer' id='tok-118-719'>outHere's</span><span class='token pointer' id='tok-118-721' style='color:red'>how to</span><span class='token pointer' id='tok-118-722'>it</span><span class='token pointer' id='tok-118-723'>with</span><span class='token pointer' id='tok-118-724' style='color:red'>the</span><span class='token pointer' id='tok-118-725'>IXGBE</span><span class='token pointer' id='tok-118-726'>NIC.</span><span class='token pointer' id='tok-118-727'>First</span><span class='token pointer' id='tok-118-728'>grab</span><span class='token pointer' id='tok-118-729'>the</span><span class='token pointer' id='tok-118-730'>sources:</span></p><p id=p731><span class='token pointer' id='tok-118-731'>$</span><span class='token pointer' id='tok-118-732'>git</span><span class='token pointer' id='tok-118-733'>clone</span><span class='token pointer' id='tok-118-734'>https://github.com/jibi/netmap.git$</span><span class='token pointer' id='tok-118-735'>cd</span><span class='token pointer' id='tok-118-736'>netmap$</span><span class='token pointer' id='tok-118-737'>git</span><span class='token pointer' id='tok-118-738'>checkout</span><span class='token pointer' id='tok-118-739'>-B</span><span class='token pointer' id='tok-118-740'>single-rx-queue-mode$</span><span class='token pointer' id='tok-118-741'>./configure</span><span class='token pointer' id='tok-118-742'>--drivers=ixgbe</span><span class='token pointer' id='tok-118-743'>--kernel-sources=/path/to/kernelLoad</span><span class='token pointer' id='tok-118-744'>the</span><span class='token pointer' id='tok-118-745'>netmap-patched</span><span class='token pointer' id='tok-118-746'>modules</span><span class='token pointer' id='tok-118-747'>and</span><span class='token pointer' id='tok-118-748'>setup</span><span class='token pointer' id='tok-118-749'>the</span><span class='token pointer' id='tok-118-750'>interface:</span></p><p id=p751><span class='token pointer' id='tok-118-751'>$</span><span class='token pointer' id='tok-118-752'>insmod</span><span class='token pointer' id='tok-118-753'>./LINUX/netmap.ko$</span><span class='token pointer' id='tok-118-754'>insmod</span><span class='token pointer' id='tok-118-755'>./LINUX/ixgbe/ixgbe.ko$</span><span class='token pointer' id='tok-118-756' style='color:red'>#</span><span class='token pointer' id='tok-118-757'>Distribute</span><span class='token pointer' id='tok-118-758'>the</span><span class='token pointer' id='tok-118-759'>interrupts:$</span><span class='token pointer' id='tok-118-760'>(let</span><span class='token pointer' id='tok-118-761'>CPU=0;</span><span class='token pointer' id='tok-118-762'>cd</span><span class='token pointer' id='tok-118-763'>/sys/class/net/eth3/device/msi_irqs/;</span><span class='token pointer' id='tok-118-764'>for</span><span class='token pointer' id='tok-118-765'>IRQ</span><span class='token pointer' id='tok-118-766'>in</span><span class='token pointer' id='tok-118-767'>*;</span><span class='token pointer' id='tok-118-768'>do</span><span class='token pointer' id='tok-118-769'>\</span><span class='token pointer' id='tok-118-770'></span><span class='token pointer' id='tok-118-771'>echo</span><span class='token pointer' id='tok-118-772'>$CPU</span><span class='token pointer' id='tok-118-773'>></span><span class='token pointer' id='tok-118-774'>/proc/irq/$IRQ/smp_affinity_list;</span><span class='token pointer' id='tok-118-775'>let</span><span class='token pointer' id='tok-118-776'>CPU+=1</span><span class='token pointer' id='tok-118-777'></span><span class='token pointer' id='tok-118-778'></span><span class='token pointer' id='tok-118-779'></span><span class='token pointer' id='tok-118-780'></span><span class='token pointer' id='tok-118-781'></span><span class='token pointer' id='tok-118-782'></span><span class='token pointer' id='tok-118-783'></span><span class='token pointer' id='tok-118-784'></span><span class='token pointer' id='tok-118-785'>done)$</span><span class='token pointer' id='tok-118-786'>#</span><span class='token pointer' id='tok-118-787'>Enable</span><span class='token pointer' id='tok-118-788'>RSS:$</span><span class='token pointer' id='tok-118-789'>ethtool</span><span class='token pointer' id='tok-118-790'>-K</span><span class='token pointer' id='tok-118-791'>eth3</span><span class='token pointer' id='tok-118-792'>ntuple</span><span class='token pointer' id='tok-118-793'>onAt</span><span class='token pointer' id='tok-118-794'>this</span><span class='token pointer' id='tok-118-795'>point</span><span class='token pointer' id='tok-118-796'>we</span><span class='token pointer' id='tok-118-797'>started</span><span class='token pointer' id='tok-118-798'>flooding</span><span class='token pointer' id='tok-118-799'>the</span><span class='token pointer' id='tok-118-800'>interface</span><span class='token pointer' id='tok-118-801'>with</span><span class='token pointer' id='tok-118-802'>6M</span><span class='token pointer' id='tok-118-803'>short</span><span class='token pointer' id='tok-118-804'>UDP</span><span class='token pointer' id='tok-118-805'>packets.</span><span class='token pointer' id='tok-118-806'>htop</span><span class='token pointer' id='tok-118-807'>shows</span><span class='token pointer' id='tok-118-808'>the</span><span class='token pointer' id='tok-118-809'>server</span><span class='token pointer' id='tok-118-810'>being</span><span class='token pointer' id='tok-118-811'>totally</span><span class='token pointer' id='tok-118-812'>busy</span><span class='token pointer' id='tok-118-813'>with</span><span class='token pointer' id='tok-118-814'>handling</span><span class='token pointer' id='tok-118-815'>the</span><span class='token pointer' id='tok-118-816'>flood:</span></p><p id=p817><span class='token pointer' id='tok-118-817'>To</span><span class='token pointer' id='tok-118-818'>counter</span><span class='token pointer' id='tok-118-819'>the</span><span class='token pointer' id='tok-118-820'>flood</span><span class='token pointer' id='tok-118-821'>we</span><span class='token pointer' id='tok-118-822'>started</span><span class='token pointer' id='tok-118-823'>Netmap.</span><span class='token pointer' id='tok-118-824' style='color:red'>First,</span><span class='token pointer' id='tok-118-825'>we</span><span class='token pointer' id='tok-118-826'>needed</span><span class='token pointer' id='tok-118-827'>to</span><span class='token pointer' id='tok-118-828'>edit</span><span class='token pointer' id='tok-118-829'>the</span><span class='token pointer' id='tok-118-830'>indirection</span><span class='token pointer' id='tok-118-831'>table,</span><span class='token pointer' id='tok-118-832'>to</span><span class='token pointer' id='tok-118-833'>isolate</span><span class='token pointer' id='tok-118-834'>the</span><span class='token pointer' id='tok-118-835'>RX</span><span class='token pointer' id='tok-118-836'>queue</span><span class='token pointer' id='tok-118-837'>#4:</span></p><p id=p838><span class='token pointer' id='tok-118-838'>$</span><span class='token pointer' id='tok-118-839'>ethtool</span><span class='token pointer' id='tok-118-840'>-X</span><span class='token pointer' id='tok-118-841'>eth3</span><span class='token pointer' id='tok-118-842'>weight</span><span class='token pointer' id='tok-118-843'>1</span><span class='token pointer' id='tok-118-844'>1</span><span class='token pointer' id='tok-118-845'>1</span><span class='token pointer' id='tok-118-846'>1</span><span class='token pointer' id='tok-118-847'>0</span><span class='token pointer' id='tok-118-848'>1</span><span class='token pointer' id='tok-118-849'>1</span><span class='token pointer' id='tok-118-850'>1</span><span class='token pointer' id='tok-118-851'>1</span><span class='token pointer' id='tok-118-852'>1$</span><span class='token pointer' id='tok-118-853'>ethtool</span><span class='token pointer' id='tok-118-854'>-N</span><span class='token pointer' id='tok-118-855'>eth3</span><span class='token pointer' id='tok-118-856'>flow-type</span><span class='token pointer' id='tok-118-857'>udp4</span><span class='token pointer' id='tok-118-858'>dst-port</span><span class='token pointer' id='tok-118-859'>53</span><span class='token pointer' id='tok-118-860'>action</span><span class='token pointer' id='tok-118-861'>4This</span><span class='token pointer' id='tok-118-862'>caused</span><span class='token pointer' id='tok-118-863'>all</span><span class='token pointer' id='tok-118-864'>the</span><span class='token pointer' id='tok-118-865'>flood</span><span class='token pointer' id='tok-118-866'>packets</span><span class='token pointer' id='tok-118-867'>to</span><span class='token pointer' id='tok-118-868'>go</span><span class='token pointer' id='tok-118-869'>to</span><span class='token pointer' id='tok-118-870'>RX</span><span class='token pointer' id='tok-118-871'>queue</span><span class='token pointer' id='tok-118-872'>#4.</span></p><p id=p873><span class='token pointer' id='tok-118-873'>Before</span><span class='token pointer' id='tok-118-874'>putting</span><span class='token pointer' id='tok-118-875'>an</span><span class='token pointer' id='tok-118-876'>interface</span><span class='token pointer' id='tok-118-877'>in</span><span class='token pointer' id='tok-118-878'>Netmap</span><span class='token pointer' id='tok-118-879'>mode</span><span class='token pointer' id='tok-118-880'>it</span><span class='token pointer' id='tok-118-881'>is</span><span class='token pointer' id='tok-118-882'>necessary</span><span class='token pointer' id='tok-118-883'>to</span><span class='token pointer' id='tok-118-884'>turn</span><span class='token pointer' id='tok-118-885'>off</span><span class='token pointer' id='tok-118-886'>hardware</span><span class='token pointer' id='tok-118-887'>offload</span><span class='token pointer' id='tok-118-888'>features:</span></p><p id=p889><span class='token pointer' id='tok-118-889'>$</span><span class='token pointer' id='tok-118-890'>ethtool</span><span class='token pointer' id='tok-118-891'>-K</span><span class='token pointer' id='tok-118-892'>eth3</span><span class='token pointer' id='tok-118-893'>lro</span><span class='token pointer' id='tok-118-894'>off</span><span class='token pointer' id='tok-118-895'>gro</span><span class='token pointer' id='tok-118-896'>offFinally</span><span class='token pointer' id='tok-118-897'>we</span><span class='token pointer' id='tok-118-898'>launched</span><span class='token pointer' id='tok-118-899'>the</span><span class='token pointer' id='tok-118-900'>netmap</span><span class='token pointer' id='tok-118-901'>offload:</span></p><p id=p902><span class='token pointer' id='tok-118-902'>$</span><span class='token pointer' id='tok-118-903'>sudo</span><span class='token pointer' id='tok-118-904'>taskset</span><span class='token pointer' id='tok-118-905'>-c</span><span class='token pointer' id='tok-118-906'>15</span><span class='token pointer' id='tok-118-907'>./nm_offload</span><span class='token pointer' id='tok-118-908'>eth3</span><span class='token pointer' id='tok-118-909'>4[+]</span><span class='token pointer' id='tok-118-910'>starting</span><span class='token pointer' id='tok-118-911'>test02</span><span class='token pointer' id='tok-118-912'>on</span><span class='token pointer' id='tok-118-913'>interface</span><span class='token pointer' id='tok-118-914'>eth3</span><span class='token pointer' id='tok-118-915'>ring</span><span class='token pointer' id='tok-118-916'>4[+]</span><span class='token pointer' id='tok-118-917'>UDP</span><span class='token pointer' id='tok-118-918'>pps:</span><span class='token pointer' id='tok-118-919'>5844714[+]</span><span class='token pointer' id='tok-118-920'>UDP</span><span class='token pointer' id='tok-118-921'>pps:</span><span class='token pointer' id='tok-118-922'>5996166[+]</span><span class='token pointer' id='tok-118-923'>UDP</span><span class='token pointer' id='tok-118-924'>pps:</span><span class='token pointer' id='tok-118-925'>5863214[+]</span><span class='token pointer' id='tok-118-926'>UDP</span><span class='token pointer' id='tok-118-927'>pps:</span><span class='token pointer' id='tok-118-928'>5986365[+]</span><span class='token pointer' id='tok-118-929'>UDP</span><span class='token pointer' id='tok-118-930'>pps:</span><span class='token pointer' id='tok-118-931'>5867302[+]</span><span class='token pointer' id='tok-118-932'>UDP</span><span class='token pointer' id='tok-118-933'>pps:</span><span class='token pointer' id='tok-118-934'>5964911[+]</span><span class='token pointer' id='tok-118-935'>UDP</span><span class='token pointer' id='tok-118-936'>pps:</span><span class='token pointer' id='tok-118-937'>5909715[+]</span><span class='token pointer' id='tok-118-938'>UDP</span><span class='token pointer' id='tok-118-939'>pps:</span><span class='token pointer' id='tok-118-940'>5865769[+]</span><span class='token pointer' id='tok-118-941'>UDP</span><span class='token pointer' id='tok-118-942'>pps:</span><span class='token pointer' id='tok-118-943'>5906668[+]</span><span class='token pointer' id='tok-118-944'>UDP</span><span class='token pointer' id='tok-118-945'>pps:</span><span class='token pointer' id='tok-118-946'>5875486As</span><span class='token pointer' id='tok-118-947'>you</span><span class='token pointer' id='tok-118-948'>see</span><span class='token pointer' id='tok-118-949'>the</span><span class='token pointer' id='tok-118-950'>netmap</span><span class='token pointer' id='tok-118-951'>program</span><span class='token pointer' id='tok-118-952'>on</span><span class='token pointer' id='tok-118-953'>a</span><span class='token pointer' id='tok-118-954'>single</span><span class='token pointer' id='tok-118-955'>RX</span><span class='token pointer' id='tok-118-956'>queue</span><span class='token pointer' id='tok-118-957'>was</span><span class='token pointer' id='tok-118-958'>able</span><span class='token pointer' id='tok-118-959'>to</span><span class='token pointer' id='tok-118-960'>receive</span><span class='token pointer' id='tok-118-961'>about</span><span class='token pointer' id='tok-118-962'>5.8M</span><span class='token pointer' id='tok-118-963'>packets.</span></p><p id=p964><span class='token pointer' id='tok-118-964'>For</span><span class='token pointer' id='tok-118-965'>completeness,</span><span class='token pointer' id='tok-118-966'>here's</span><span class='token pointer' id='tok-118-967'>an</span><span class='token pointer' id='tok-118-968'>htop</span><span class='token pointer' id='tok-118-969'>showing</span><span class='token pointer' id='tok-118-970'>only</span><span class='token pointer' id='tok-118-971'>a</span><span class='token pointer' id='tok-118-972'>single</span><span class='token pointer' id='tok-118-973'>core</span><span class='token pointer' id='tok-118-974'>being</span><span class='token pointer' id='tok-118-975'>busy</span><span class='token pointer' id='tok-118-976'>with</span><span class='token pointer' id='tok-118-977'>Netmap:</span></p><p id=p978><span class='token pointer' id='tok-118-978'>ThanksWe</span><span class='token pointer' id='tok-118-979'>would</span><span class='token pointer' id='tok-118-980'>like</span><span class='token pointer' id='tok-118-981'>to</span><span class='token pointer' id='tok-118-982'>thank</span><span class='token pointer' id='tok-118-983'>Pavel</span><span class='token pointer' id='tok-118-984'>Odintsov</span><span class='token pointer' id='tok-118-985'>who</span><span class='token pointer' id='tok-118-986'>suggested</span><span class='token pointer' id='tok-118-987'>the</span><span class='token pointer' id='tok-118-988'>possibility</span><span class='token pointer' id='tok-118-989'>of</span><span class='token pointer' id='tok-118-990'>using</span><span class='token pointer' id='tok-118-991'>Netmap</span><span class='token pointer' id='tok-118-992'>this</span><span class='token pointer' id='tok-118-993'>way.</span><span class='token pointer' id='tok-118-994'>He</span><span class='token pointer' id='tok-118-995'>even</span><span class='token pointer' id='tok-118-996'>prepared</span><span class='token pointer' id='tok-118-997'>the</span><span class='token pointer' id='tok-118-998'>initial</span><span class='token pointer' id='tok-118-999'>hack</span><span class='token pointer' id='tok-118-1000'>we</span><span class='token pointer' id='tok-118-1001'>based</span><span class='token pointer' id='tok-118-1002'>our</span><span class='token pointer' id='tok-118-1003'>work</span><span class='token pointer' id='tok-118-1004'>on.</span></p><p id=p1005><span class='token pointer' id='tok-118-1005'>We</span><span class='token pointer' id='tok-118-1006'>would</span><span class='token pointer' id='tok-118-1007'>also</span><span class='token pointer' id='tok-118-1008'>like</span><span class='token pointer' id='tok-118-1009'>to</span><span class='token pointer' id='tok-118-1010'>thank</span><span class='token pointer' id='tok-118-1011'>Luigi</span><span class='token pointer' id='tok-118-1012'>Rizzo,</span><span class='token pointer' id='tok-118-1013'>for</span><span class='token pointer' id='tok-118-1014'>his</span><span class='token pointer' id='tok-118-1015'>Netmap</span><span class='token pointer' id='tok-118-1016'>work</span><span class='token pointer' id='tok-118-1017'>and</span><span class='token pointer' id='tok-118-1018'>great</span><span class='token pointer' id='tok-118-1019'>feedback</span><span class='token pointer' id='tok-118-1020'>on</span><span class='token pointer' id='tok-118-1021'>our</span><span class='token pointer' id='tok-118-1022'>patches.</span></p><p id=p1023><span class='token pointer' id='tok-118-1023'>Final</span><span class='token pointer' id='tok-118-1024'>wordsAt</span><span class='token pointer' id='tok-118-1025'>CloudFlare</span><span class='token pointer' id='tok-118-1026'>our</span><span class='token pointer' id='tok-118-1027'>application</span><span class='token pointer' id='tok-118-1028'>stack</span><span class='token pointer' id='tok-118-1029'>is</span><span class='token pointer' id='tok-118-1030'>based</span><span class='token pointer' id='tok-118-1031'>on</span><span class='token pointer' id='tok-118-1032'>open</span><span class='token pointer' id='tok-118-1033'>source</span><span class='token pointer' id='tok-118-1034'>software.</span><span class='token pointer' id='tok-118-1035' style='color:red'>We're</span><span class='token pointer' id='tok-118-1036'>grateful</span><span class='token pointer' id='tok-118-1037'>to</span><span class='token pointer' id='tok-118-1038'>so</span><span class='token pointer' id='tok-118-1039'>many</span><span class='token pointer' id='tok-118-1040'>open</span><span class='token pointer' id='tok-118-1041'>source</span><span class='token pointer' id='tok-118-1042'>programmers</span><span class='token pointer' id='tok-118-1043'>for</span><span class='token pointer' id='tok-118-1044'>their</span><span class='token pointer' id='tok-118-1045'>awesome</span><span class='token pointer' id='tok-118-1046'>work.</span><span class='token pointer' id='tok-118-1047'>Whenever</span><span class='token pointer' id='tok-118-1048'>we</span><span class='token pointer' id='tok-118-1049'>can</span><span class='token pointer' id='tok-118-1050'>we</span><span class='token pointer' id='tok-118-1051'>try</span><span class='token pointer' id='tok-118-1052'>to</span><span class='token pointer' id='tok-118-1053'>contribute</span><span class='token pointer' id='tok-118-1054'>back</span><span class='token pointer' id='tok-118-1055'>to</span><span class='token pointer' id='tok-118-1056'>the</span><span class='token pointer' id='tok-118-1057'>community</span><span class='token pointer' id='tok-118-1058'>-</span><span class='token pointer' id='tok-118-1059'>we</span><span class='token pointer' id='tok-118-1060'>hope</span><span class='token pointer' id='tok-118-1061'>"the</span><span class='token pointer' id='tok-118-1062'>single</span><span class='token pointer' id='tok-118-1063'>RX</span><span class='token pointer' id='tok-118-1064'>Netmap</span><span class='token pointer' id='tok-118-1065'>mode"</span><span class='token pointer' id='tok-118-1066'>will</span><span class='token pointer' id='tok-118-1067'>be</span><span class='token pointer' id='tok-118-1068'>useful</span><span class='token pointer' id='tok-118-1069'>to</span><span class='token pointer' id='tok-118-1070'>others.</span></p><p id=p1071><span class='token pointer' id='tok-118-1071'>You</span><span class='token pointer' id='tok-118-1072'>can</span><span class='token pointer' id='tok-118-1073'>find</span><span class='token pointer' id='tok-118-1074'>more</span><span class='token pointer' id='tok-118-1075'>CloudFlare</span><span class='token pointer' id='tok-118-1076'>open</span><span class='token pointer' id='tok-118-1077'>source</span><span class='token pointer' id='tok-118-1078'>here.
</span></p>