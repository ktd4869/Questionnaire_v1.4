<p id=p0><span id='tok'>In</span><span id='tok'>a</span><span id='tok'>previous</span><span id='tok'>post</span><span id='tok'>we</span><span id='tok'>discussed</span><span id='tok'>the</span><span id='tok'>performance</span><span id='tok'>limitations</span><span id='tok'>of</span><span id='tok'>the</span><span class='token pointer' id='tok-118-0' style='color:red'>kernel</span><span class='token pointer' id='tok-118-1' style='color:red'>Linux</span><span id='tok'>stack.</span><span id='tok'>We</span><span id='tok'>detailed</span><span id='tok'>the</span><span id='tok'>available</span><span class='token pointer' id='tok-118-2' style='color:red'>kernel bypass techniques</span><span id='tok'>user</span><span id='tok'>space</span><span id='tok'>programs</span><span id='tok'>to</span><span id='tok'>receive</span><span class='token pointer' id='tok-118-3' style='color:red'>packets</span><span id='tok'>with</span><span id='tok'>high</span><span id='tok'>throughput.</span><span id='tok'>Unfortunately,</span><span id='tok'>none</span><span id='tok'>of</span><span id='tok'>the</span><span id='tok'>discussed</span><span class='token pointer' id='tok-118-4' style='color:red'>supported</span><span class='token pointer' id='tok-118-5' style='color:red'>open source solutions</span><span id='tok'>needs.</span><span id='tok'>To</span><span id='tok'>improve</span><span id='tok'>the</span><span id='tok'>situation</span><span id='tok'>we</span><span id='tok'>decided</span><span id='tok'>to</span><span id='tok'>contribute</span><span id='tok'>to</span><span id='tok'>the</span><span class='token pointer' id='tok-118-6' style='color:red'>Netmap</span><span id='tok'>project.</span><span id='tok'>In</span><span id='tok'>this</span><span id='tok'>blog</span><span id='tok'>post</span><span id='tok'>we'll</span><span id='tok'>describe</span><span id='tok'>our</span><span id='tok'>proposed</span><span id='tok'>changes.</span></p><p id=p64><span id='tok'>CC</span><span id='tok'>BY-SA</span><span id='tok'>2.0</span><span id='tok'>image</span><span id='tok'>by</span></p><p id=p71><span id='tok'>Our</span><span id='tok'>needsAt</span><span class='token pointer' id='tok-118-7' style='color:red'>CloudFlare</span><span id='tok'>we</span><span id='tok'>are</span><span id='tok'>constantly</span><span id='tok'>dealing</span><span id='tok'>with</span><span class='token pointer' id='tok-118-8' style='color:red'>packet</span><span class='token pointer' id='tok-118-9' style='color:red'>large</span><span id='tok'>Our</span><span class='token pointer' id='tok-118-10' style='color:red'>network</span><span id='tok'>constantly</span><span id='tok'>receives</span><span id='tok'>a</span><span id='tok'>large</span><span id='tok'>volume</span><span id='tok'>of</span><span id='tok'>packets,</span><span id='tok'>often</span><span id='tok'>coming</span><span id='tok'>from</span><span id='tok'>many,</span><span id='tok'>simultaneous</span><span id='tok'>attacks.</span><span id='tok'>In</span><span id='tok'>fact,</span><span id='tok'>it</span><span id='tok'>is</span><span id='tok'>entirely</span><span id='tok'>possible</span><span id='tok'>that</span><span id='tok'>the</span><span id='tok'>server</span><span id='tok'>which</span><span id='tok'>just</span><span id='tok'>served</span><span id='tok'>you</span><span id='tok'>this</span><span id='tok'>blog</span><span id='tok'>post</span><span id='tok'>is</span><span id='tok'>dealing</span><span id='tok'>with</span><span id='tok'>a</span><span id='tok'>many-million</span><span id='tok'>packets</span><span id='tok'>per</span><span id='tok'>second</span><span id='tok'>flood</span><span id='tok'>right</span><span id='tok'>now.</span></p><p id=p124><span id='tok'>Since</span><span id='tok'>the</span><span class='token pointer' id='tok-118-11' style='color:red'>Linux Kernel</span><span id='tok'>really</span><span id='tok'>handle</span><span id='tok'>a</span><span id='tok'>large</span><span id='tok'>volume</span><span id='tok'>of</span><span id='tok'>packets,</span><span id='tok'>we</span><span id='tok'>need</span><span id='tok'>to</span><span id='tok'>work</span><span id='tok'>around</span><span id='tok'>it.</span><span id='tok'>During</span><span id='tok'>packet</span><span id='tok'>floods</span><span id='tok'>we</span><span class='token pointer' id='tok-118-12' style='color:red'>offload</span><span id='tok'>selected</span><span id='tok'>network</span><span id='tok'>flows</span><span id='tok'>(belonging</span><span id='tok'>to</span><span id='tok'>a</span><span id='tok'>flood)</span><span id='tok'>to</span><span id='tok'>a</span><span id='tok'>user</span><span id='tok'>space</span><span id='tok'>application.</span><span id='tok'>This</span><span id='tok'>application</span><span id='tok'>filters</span><span id='tok'>the</span><span id='tok'>packets</span><span id='tok'>at</span><span id='tok'>very</span><span id='tok'>high</span><span id='tok'>speed.</span><span id='tok'>Most</span><span id='tok'>of</span><span id='tok'>the</span><span id='tok'>packets</span><span id='tok'>are</span><span id='tok'>dropped,</span><span id='tok'>as</span><span id='tok'>they</span><span id='tok'></span><span id='tok'>belong</span><span id='tok'>to</span><span id='tok'>a</span><span id='tok'>flood.</span><span id='tok'>The</span><span id='tok'>small</span><span id='tok'>number</span><span id='tok'>of</span><span id='tok'>"valid"</span><span id='tok'>packets</span><span id='tok'>are</span><span id='tok'>injected</span><span class='token pointer' id='tok-118-13' style='color:red'>back</span><span id='tok'>to</span><span id='tok'>the</span><span id='tok'>kernel</span><span id='tok'>and</span><span id='tok'>handled</span><span id='tok'>in</span><span id='tok'>the</span><span id='tok'>same</span><span id='tok'>way</span><span id='tok'>as</span><span id='tok'>usual</span><span id='tok'>traffic.</span></p><p id=p202><span id='tok'>It's</span><span id='tok'>important</span><span id='tok'>to</span><span id='tok'>emphasize</span><span id='tok'>that</span><span id='tok'>the</span><span class='token pointer' id='tok-118-14' style='color:red'>kernel bypass</span><span id='tok'>enabled</span><span id='tok'>only</span><span id='tok'>for</span><span id='tok'>selected</span><span id='tok'>flows,</span><span id='tok'>which</span><span id='tok'>means</span><span id='tok'>that</span><span id='tok'>all</span><span id='tok'>other</span><span id='tok'>packets</span><span id='tok'>go</span><span id='tok'>to</span><span id='tok'>the</span><span id='tok'>kernel</span><span id='tok'>as</span><span id='tok'>usual.</span></p><p id=p228><span id='tok'>This</span><span id='tok'>setup</span><span id='tok'>works</span><span id='tok'>perfectly</span><span id='tok'>on</span><span id='tok'>our</span><span id='tok'>servers</span><span id='tok'>with</span><span class='token pointer' id='tok-118-15' style='color:red'>Solarflare</span><span id='tok'>network</span><span id='tok'>cards</span><span id='tok'>-</span><span id='tok'>we</span><span id='tok'>can</span><span id='tok'>use</span><span id='tok'>the</span><span id='tok'>ef_vi</span><span class='token pointer' id='tok-118-16' style='color:red'>API</span><span id='tok'>to</span><span id='tok'>achieve</span><span id='tok'>the</span><span id='tok'>kernel</span><span id='tok'>bypass.</span><span id='tok'>Unfortunately,</span><span id='tok'>we</span><span id='tok'>don't</span><span id='tok'>have</span><span id='tok'>this</span><span id='tok'>functionality</span><span id='tok'>on</span><span id='tok'>our</span><span id='tok'>servers</span><span id='tok'>with</span><span id='tok'>Intel</span><span id='tok'>IXGBE</span><span id='tok'>NIC's.</span></p><p id=p264><span id='tok'>This</span><span id='tok'>is</span><span id='tok'>when</span><span id='tok'>Netmap</span><span id='tok'>comes</span><span id='tok'>in.</span></p><p id=p270><span id='tok'>NetmapOver</span><span id='tok'>the</span><span id='tok'>last</span><span id='tok'>few</span><span id='tok'>months</span><span id='tok'>we've</span><span id='tok'>been</span><span id='tok'>thinking</span><span id='tok'>hard</span><span id='tok'>about</span><span id='tok'>how</span><span id='tok'>to</span><span id='tok'>achieve</span><span id='tok'>bypass</span><span id='tok'>for</span><span id='tok'>selected</span><span id='tok'>flows</span><span id='tok'>(aka:</span><span class='token pointer' id='tok-118-17' style='color:red'>bifurcated driver)</span><span class='token pointer' id='tok-118-18' style='color:red'>non-Solarflare</span><span id='tok'>network</span><span id='tok'>cards.</span></p><p id=p294><span id='tok'>We've</span><span id='tok'>considered</span><span class='token pointer' id='tok-118-19' style='color:red'>PF_RING,</span><span class='token pointer' id='tok-118-20' style='color:red'>DPDK</span><span id='tok'>and</span><span id='tok'>other</span><span id='tok'>custom</span><span id='tok'>solutions,</span><span id='tok'>but</span><span id='tok'>sadly</span><span id='tok'>all</span><span id='tok'>of</span><span id='tok'>them</span><span id='tok'>take</span><span id='tok'>over</span><span id='tok'>the</span><span id='tok'>whole</span><span id='tok'>network</span><span id='tok'>card.</span><span id='tok'>Eventually</span><span id='tok'>we</span><span id='tok'>decided</span><span id='tok'>that</span><span id='tok'>the</span><span id='tok'>best</span><span id='tok'>way</span><span id='tok'>would</span><span id='tok'>be</span><span id='tok'>to</span><span id='tok'>patch</span><span id='tok'>Netmap</span><span id='tok'>with</span><span id='tok'>the</span><span id='tok'>functionality</span><span id='tok'>we</span><span id='tok'>need.</span></p><p id=p330><span id='tok'>We</span><span id='tok'>chose</span><span id='tok'>Netmap</span><span id='tok'>because:</span></p><p id=p334><span id='tok'>It's</span><span id='tok'>fully</span><span class='token pointer' id='tok-118-21' style='color:red'>open source</span><span id='tok'>released</span><span id='tok'>under</span><span id='tok'>a</span><span class='token pointer' id='tok-118-22' style='color:red'>BSD</span><span id='tok'>license.It</span><span id='tok'>has</span><span id='tok'>a</span><span id='tok'>great</span><span class='token pointer' id='tok-118-23' style='color:red'>NIC-agnostic</span><span class='token pointer' id='tok-118-24' style='color:red'>API.It's</span><span id='tok'>very</span><span id='tok'>fast:</span><span id='tok'>can</span><span id='tok'>reach</span><span id='tok'>line</span><span id='tok'>rate</span><span id='tok'>easily.The</span><span id='tok'>project</span><span id='tok'>is</span><span id='tok'>well</span><span id='tok'>maintained</span><span id='tok'>and</span><span id='tok'>reasonably</span><span id='tok'>mature.The</span><span id='tok'>code</span><span id='tok'>is</span><span id='tok'>very</span><span id='tok'>high</span><span id='tok'>quality.The</span><span id='tok'>driver-specific</span><span id='tok'>modifications</span><span id='tok'>are</span><span id='tok'>trivial:</span><span id='tok'>most</span><span id='tok'>of</span><span id='tok'>the</span><span id='tok'>magic</span><span id='tok'>happens</span><span id='tok'>in</span><span id='tok'>the</span><span id='tok'>shared</span><span id='tok'>Netmap</span><span id='tok'>module.</span><span id='tok'>It's</span><span id='tok'>easy</span><span id='tok'>to</span><span id='tok'>add</span><span id='tok'>support</span><span id='tok'>for</span><span id='tok'>new</span><span id='tok'>hardware.Introducing</span><span id='tok'>the</span><span id='tok'>single</span><span class='token pointer' id='tok-118-25' style='color:red'>RX queue</span><span id='tok'>when</span><span id='tok'>a</span><span id='tok'>network</span><span id='tok'>card</span><span id='tok'>goes</span><span id='tok'>into</span><span id='tok'>the</span><span id='tok'>Netmap</span><span id='tok'>mode,</span><span id='tok'>all</span><span id='tok'>the</span><span class='token pointer' id='tok-118-26' style='color:red'>queues</span><span class='token pointer' id='tok-118-27' style='color:red'>RX</span><span id='tok'>disconnected</span><span id='tok'>from</span><span id='tok'>the</span><span id='tok'>kernel</span><span id='tok'>and</span><span id='tok'>are</span><span id='tok'>available</span><span id='tok'>to</span><span id='tok'>the</span><span id='tok'>Netmap</span><span id='tok'>applications.</span></p><p id=p420><span id='tok'>We</span><span id='tok'>don't</span><span id='tok'>want</span><span id='tok'>that.</span><span id='tok'>We</span><span id='tok'>want</span><span id='tok'>to</span><span id='tok'>keep</span><span id='tok'>most</span><span id='tok'>of</span><span id='tok'>the</span><span id='tok'>RX</span><span id='tok'>queues</span><span id='tok'>back</span><span id='tok'>in</span><span id='tok'>the</span><span id='tok'>kernel</span><span id='tok'>mode,</span><span id='tok'>and</span><span id='tok'>enable</span><span id='tok'>Netmap</span><span id='tok'>mode</span><span id='tok'>only</span><span id='tok'>on</span><span id='tok'>selected</span><span id='tok'>RX</span><span id='tok'>queues.</span><span id='tok'>We</span><span id='tok'>call</span><span id='tok'>this</span><span id='tok'>functionality:</span><span id='tok'>"single</span><span id='tok'>RX</span><span id='tok'>queue</span><span id='tok'>mode".</span></p><p id=p455><span id='tok'>The</span><span id='tok'>intention</span><span id='tok'>was</span><span id='tok'>to</span><span id='tok'>expose</span><span id='tok'>a</span><span id='tok'>minimal</span><span id='tok'>API</span><span id='tok'>which</span><span id='tok'>could:</span></p><p id=p465><span id='tok'>Open</span><span id='tok'>a</span><span id='tok'>network</span><span id='tok'>interface</span><span id='tok'>in</span><span id='tok'>"a</span><span id='tok'>single</span><span id='tok'>RX</span><span id='tok'>queue</span><span id='tok'>mode".This</span><span id='tok'>would</span><span id='tok'>allow</span><span id='tok'>netmap</span><span id='tok'>applications</span><span id='tok'>to</span><span id='tok'>receive</span><span id='tok'>packets</span><span id='tok'>from</span><span id='tok'>that</span><span id='tok'>specific</span><span class='token pointer' id='tok-118-28' style='color:red'>RX queue.While</span><span id='tok'>all</span><span id='tok'>the</span><span id='tok'>other</span><span id='tok'>queues</span><span id='tok'>attached</span><span id='tok'>to</span><span id='tok'>the</span><span id='tok'>host</span><span id='tok'>network</span><span id='tok'>stack.On</span><span id='tok'>demand</span><span id='tok'>add</span><span id='tok'>or</span><span id='tok'>remove</span><span id='tok'>RX</span><span id='tok'>queues</span><span id='tok'>from</span><span id='tok'>the</span><span id='tok'>"single</span><span id='tok'>RX</span><span id='tok'>queue</span><span id='tok'>mode".Eventually</span><span id='tok'>remove</span><span id='tok'>the</span><span id='tok'>interface</span><span id='tok'>from</span><span id='tok'>the</span><span id='tok'>Netmap</span><span id='tok'>mode</span><span id='tok'>and</span><span class='token pointer' id='tok-118-29' style='color:red'>reattach</span><span id='tok'>the</span><span id='tok'>RX</span><span id='tok'>queues</span><span id='tok'>to</span><span id='tok'>the</span><span id='tok'>host</span><span id='tok'>stack.</span></p><p id=p526><span id='tok'>Indeed</span><span id='tok'>the</span><span id='tok'>only</span><span id='tok'>difference</span><span id='tok'>is</span><span id='tok'>the</span><span id='tok'>nm_open()</span><span id='tok'>call,</span><span id='tok'>which</span><span id='tok'>uses</span><span id='tok'>the</span><span id='tok'>new</span><span id='tok'>syntax</span><span id='tok'>netmap:ifname~queue_number.</span></p><p id=p540><span id='tok'>Once</span><span id='tok'>again,</span><span id='tok'>when</span><span id='tok'>running</span><span id='tok'>this</span><span id='tok'>code</span><span id='tok'>only</span><span id='tok'>packets</span><span id='tok'>arriving</span><span id='tok'>on</span><span id='tok'>the</span><span id='tok'>RX</span><span id='tok'>queue</span><span id='tok'>#4</span><span id='tok'>will</span><span id='tok'>go</span><span id='tok'>to</span><span id='tok'>the</span><span id='tok'>netmap</span><span id='tok'>program.</span><span id='tok'>All</span><span id='tok'>other</span><span id='tok'>RX</span><span id='tok'>and</span><span id='tok'>TX</span><span id='tok'>queues</span><span id='tok'>will</span><span id='tok'>be</span><span id='tok'>handled</span><span id='tok'>by</span><span id='tok'>the</span><span id='tok'>Linux</span><span id='tok'>kernel</span><span id='tok'>network</span><span id='tok'>stack.</span></p><p id=p575><span id='tok'>Isolating</span><span id='tok'>a</span><span id='tok'>queueIn</span><span id='tok'>multiqueue</span><span id='tok'>network</span><span id='tok'>cards,</span><span id='tok'>any</span><span id='tok'>packet</span><span id='tok'>can</span><span id='tok'>end</span><span id='tok'>up</span><span id='tok'>in</span><span id='tok'>almost</span><span id='tok'>any</span><span id='tok'>RX</span><span id='tok'>queue</span><span id='tok'>due</span><span id='tok'>to</span><span class='token pointer' id='tok-118-30' style='color:red'>RSS.</span><span id='tok'>This</span><span id='tok'>is</span><span id='tok'>why</span><span id='tok'>before</span><span id='tok'>enabling</span><span id='tok'>the</span><span id='tok'>single</span><span id='tok'>RX</span><span id='tok'>mode</span><span id='tok'>it</span><span id='tok'>is</span><span id='tok'>necessary</span><span id='tok'>to</span><span id='tok'>make</span><span id='tok'>sure</span><span id='tok'>only</span><span id='tok'>the</span><span id='tok'>selected</span><span id='tok'>flow</span><span id='tok'>goes</span><span id='tok'>to</span><span id='tok'>the</span><span id='tok'>Netmap</span><span id='tok'>queue.</span></p><p id=p618><span id='tok'>To</span><span id='tok'>do</span><span id='tok'>so</span><span id='tok'>it</span><span id='tok'>is</span><span id='tok'>necessary</span><span id='tok'>to:</span></p><p id=p625><span id='tok'>Modify</span><span id='tok'>the</span><span id='tok'>indirection</span><span id='tok'>table</span><span id='tok'>to</span><span id='tok'>ensure</span><span id='tok'>no</span><span id='tok'>new</span><span class='token pointer' id='tok-118-31' style='color:red'>RSS-hashed</span><span id='tok'>packets</span><span id='tok'>will</span><span id='tok'>go</span><span id='tok'>there.Use</span><span class='token pointer' id='tok-118-32' style='color:red'>flow steering</span><span id='tok'>specifically</span><span id='tok'>direct</span><span id='tok'>some</span><span id='tok'>flows</span><span id='tok'>to</span><span id='tok'>the</span><span id='tok'>isolated</span><span id='tok'>queue.Work</span><span id='tok'>around</span><span id='tok'>RFS</span><span id='tok'>-</span><span id='tok'>make</span><span id='tok'>sure</span><span id='tok'>no</span><span id='tok'>other</span><span id='tok'>application</span><span id='tok'>is</span><span id='tok'>running</span><span id='tok'>on</span><span id='tok'>the</span><span id='tok'>CPU</span><span id='tok'>Netmap</span><span id='tok'>will</span><span id='tok'>run</span><span id='tok'>on.For</span><span id='tok'>example:</span></p><p id=p667><span id='tok'>$</span><span class='token pointer' id='tok-118-33' style='color:red'>ethtool</span><span id='tok'>-X</span><span id='tok'>eth3</span><span id='tok'>weight</span><span id='tok'>1</span><span id='tok'>1</span><span id='tok'>1</span><span id='tok'>1</span><span id='tok'>0</span><span id='tok'>1</span><span id='tok'>1</span><span id='tok'>1</span><span id='tok'>1</span><span id='tok'>1$</span><span id='tok'>ethtool</span><span id='tok'>-K</span><span id='tok'>eth3</span><span id='tok'>ntuple</span><span id='tok'>on$</span><span id='tok'>ethtool</span><span id='tok'>-N</span><span id='tok'>eth3</span><span id='tok'>flow-type</span><span id='tok'>udp4</span><span class='token pointer' id='tok-118-34' style='color:red'>dst-port</span><span id='tok'>53</span><span id='tok'>action</span><span id='tok'>4Here</span><span id='tok'>we</span><span id='tok'>are</span><span id='tok'>setting</span><span id='tok'>the</span><span id='tok'>indirection</span><span id='tok'>table</span><span id='tok'>to</span><span id='tok'>prevent</span><span id='tok'>traffic</span><span id='tok'>from</span><span id='tok'>going</span><span id='tok'>to</span><span id='tok'>RX</span><span id='tok'>queue</span><span id='tok'>#4.</span><span id='tok'>Then</span><span id='tok'>we</span><span id='tok'>are</span><span id='tok'>enabling</span><span id='tok'>flow</span><span id='tok'>steering</span><span id='tok'>to</span><span id='tok'>enqueue</span><span id='tok'>all</span><span class='token pointer' id='tok-118-35' style='color:red'>UDP traffic</span><span id='tok'>destination</span><span class='token pointer' id='tok-118-36' style='color:red'>port</span><span id='tok'>53</span><span id='tok'>into</span><span id='tok'>queue</span><span id='tok'>#4.</span></p><p id=p729><span id='tok'>Trying</span><span id='tok'>it</span><span id='tok'>outHere's</span><span id='tok'>how</span><span id='tok'>to</span><span id='tok'>run</span><span id='tok'>it</span><span id='tok'>with</span><span id='tok'>the</span><span id='tok'>IXGBE</span><span id='tok'>NIC.</span><span id='tok'>First</span><span id='tok'>grab</span><span id='tok'>the</span><span id='tok'>sources:</span></p><p id=p744><span id='tok'>$</span><span id='tok'>git</span><span id='tok'>clone</span><span id='tok'>https://github.com/jibi/netmap.git$</span><span id='tok'>cd</span><span id='tok'>netmap$</span><span id='tok'>git</span><span id='tok'>checkout</span><span id='tok'>-B</span><span id='tok'>single-rx-queue-mode$</span><span id='tok'>./configure</span><span id='tok'>--drivers=ixgbe</span><span class='token pointer' id='tok-118-37' style='color:red'>--kernel-sources=/path/to/kernelLoad</span><span id='tok'>the</span><span id='tok'>netmap-patched</span><span id='tok'>modules</span><span id='tok'>and</span><span id='tok'>setup</span><span id='tok'>the</span><span id='tok'>interface:</span></p><p id=p764><span id='tok'>$</span><span id='tok'>insmod</span><span id='tok'>./LINUX/netmap.ko$</span><span id='tok'>insmod</span><span id='tok'>./LINUX/ixgbe/ixgbe.ko$</span><span id='tok'>#</span><span id='tok'>Distribute</span><span id='tok'>the</span><span id='tok'>interrupts:$</span><span id='tok'>(let</span><span id='tok'>CPU=0;</span><span id='tok'>cd</span><span id='tok'>/sys/class/net/eth3/device/msi_irqs/;</span><span id='tok'>for</span><span id='tok'>IRQ</span><span id='tok'>in</span><span id='tok'>*;</span><span id='tok'>do</span><span id='tok'>\</span><span id='tok'></span><span id='tok'>echo</span><span id='tok'>$CPU</span><span id='tok'>></span><span id='tok'>/proc/irq/$IRQ/smp_affinity_list;</span><span id='tok'>let</span><span id='tok'>CPU+=1</span><span id='tok'></span><span id='tok'></span><span id='tok'></span><span id='tok'></span><span id='tok'></span><span id='tok'></span><span id='tok'></span><span id='tok'></span><span id='tok'>done)$</span><span id='tok'>#</span><span id='tok'>Enable</span><span id='tok'>RSS:$</span><span id='tok'>ethtool</span><span id='tok'>-K</span><span id='tok'>eth3</span><span id='tok'>ntuple</span><span id='tok'>onAt</span><span id='tok'>this</span><span id='tok'>point</span><span id='tok'>we</span><span id='tok'>started</span><span id='tok'>flooding</span><span id='tok'>the</span><span id='tok'>interface</span><span id='tok'>with</span><span id='tok'>6M</span><span id='tok'>short</span><span id='tok'>UDP</span><span id='tok'>packets.</span><span id='tok'>htop</span><span id='tok'>shows</span><span id='tok'>the</span><span id='tok'>server</span><span id='tok'>being</span><span class='token pointer' id='tok-118-38' style='color:red'>totally</span><span id='tok'>busy</span><span id='tok'>with</span><span id='tok'>handling</span><span id='tok'>the</span><span id='tok'>flood:</span></p><p id=p830><span id='tok'>To</span><span id='tok'>counter</span><span id='tok'>the</span><span id='tok'>flood</span><span id='tok'>we</span><span id='tok'>started</span><span id='tok'>Netmap.</span><span id='tok'>First,</span><span id='tok'>we</span><span id='tok'>needed</span><span id='tok'>to</span><span id='tok'>edit</span><span id='tok'>the</span><span id='tok'>indirection</span><span id='tok'>table,</span><span id='tok'>to</span><span id='tok'>isolate</span><span id='tok'>the</span><span id='tok'>RX</span><span id='tok'>queue</span><span id='tok'>#4:</span></p><p id=p851><span id='tok'>$</span><span id='tok'>ethtool</span><span id='tok'>-X</span><span id='tok'>eth3</span><span id='tok'>weight</span><span id='tok'>1</span><span id='tok'>1</span><span id='tok'>1</span><span id='tok'>1</span><span id='tok'>0</span><span id='tok'>1</span><span id='tok'>1</span><span id='tok'>1</span><span id='tok'>1</span><span id='tok'>1$</span><span id='tok'>ethtool</span><span id='tok'>-N</span><span id='tok'>eth3</span><span id='tok'>flow-type</span><span id='tok'>udp4</span><span id='tok'>dst-port</span><span id='tok'>53</span><span id='tok'>action</span><span id='tok'>4This</span><span id='tok'>caused</span><span id='tok'>all</span><span id='tok'>the</span><span id='tok'>flood</span><span id='tok'>packets</span><span id='tok'>to</span><span id='tok'>go</span><span id='tok'>to</span><span id='tok'>RX</span><span id='tok'>queue</span><span id='tok'>#4.</span></p><p id=p886><span id='tok'>Before</span><span id='tok'>putting</span><span id='tok'>an</span><span id='tok'>interface</span><span id='tok'>in</span><span id='tok'>Netmap</span><span id='tok'>mode</span><span id='tok'>it</span><span id='tok'>is</span><span id='tok'>necessary</span><span id='tok'>to</span><span id='tok'>turn</span><span id='tok'>off</span><span id='tok'>hardware</span><span id='tok'>offload</span><span id='tok'>features:</span></p><p id=p902><span id='tok'>$</span><span id='tok'>ethtool</span><span id='tok'>-K</span><span id='tok'>eth3</span><span id='tok'>lro</span><span id='tok'>off</span><span id='tok'>gro</span><span id='tok'>offFinally</span><span id='tok'>we</span><span id='tok'>launched</span><span id='tok'>the</span><span id='tok'>netmap</span><span id='tok'>offload:</span></p><p id=p915><span id='tok'>$</span><span id='tok'>sudo</span><span id='tok'>taskset</span><span id='tok'>-c</span><span id='tok'>15</span><span id='tok'>./nm_offload</span><span id='tok'>eth3</span><span id='tok'>4[+]</span><span id='tok'>starting</span><span id='tok'>test02</span><span id='tok'>on</span><span id='tok'>interface</span><span id='tok'>eth3</span><span id='tok'>ring</span><span id='tok'>4[+]</span><span id='tok'>UDP</span><span id='tok'>pps:</span><span id='tok'>5844714[+]</span><span id='tok'>UDP</span><span id='tok'>pps:</span><span id='tok'>5996166[+]</span><span id='tok'>UDP</span><span id='tok'>pps:</span><span id='tok'>5863214[+]</span><span id='tok'>UDP</span><span id='tok'>pps:</span><span id='tok'>5986365[+]</span><span id='tok'>UDP</span><span id='tok'>pps:</span><span id='tok'>5867302[+]</span><span id='tok'>UDP</span><span id='tok'>pps:</span><span id='tok'>5964911[+]</span><span id='tok'>UDP</span><span id='tok'>pps:</span><span id='tok'>5909715[+]</span><span id='tok'>UDP</span><span id='tok'>pps:</span><span id='tok'>5865769[+]</span><span id='tok'>UDP</span><span id='tok'>pps:</span><span id='tok'>5906668[+]</span><span id='tok'>UDP</span><span id='tok'>pps:</span><span id='tok'>5875486As</span><span id='tok'>you</span><span id='tok'>see</span><span id='tok'>the</span><span id='tok'>netmap</span><span id='tok'>program</span><span id='tok'>on</span><span id='tok'>a</span><span id='tok'>single</span><span id='tok'>RX</span><span id='tok'>queue</span><span id='tok'>was</span><span id='tok'>able</span><span id='tok'>to</span><span id='tok'>receive</span><span id='tok'>about</span><span id='tok'>5.8M</span><span id='tok'>packets.</span></p><p id=p977><span id='tok'>For</span><span id='tok'>completeness,</span><span id='tok'>here's</span><span id='tok'>an</span><span id='tok'>htop</span><span id='tok'>showing</span><span id='tok'>only</span><span id='tok'>a</span><span id='tok'>single</span><span id='tok'>core</span><span id='tok'>being</span><span id='tok'>busy</span><span id='tok'>with</span><span id='tok'>Netmap:</span></p><p id=p991><span id='tok'>ThanksWe</span><span id='tok'>would</span><span id='tok'>like</span><span id='tok'>to</span><span id='tok'>thank</span><span id='tok'>Pavel</span><span id='tok'>Odintsov</span><span id='tok'>who</span><span id='tok'>suggested</span><span id='tok'>the</span><span id='tok'>possibility</span><span id='tok'>of</span><span id='tok'>using</span><span id='tok'>Netmap</span><span id='tok'>this</span><span id='tok'>way.</span><span id='tok'>He</span><span id='tok'>even</span><span id='tok'>prepared</span><span id='tok'>the</span><span id='tok'>initial</span><span id='tok'>hack</span><span id='tok'>we</span><span id='tok'>based</span><span id='tok'>our</span><span id='tok'>work</span><span id='tok'>on.</span></p><p id=p1018><span id='tok'>We</span><span id='tok'>would</span><span id='tok'>also</span><span id='tok'>like</span><span id='tok'>to</span><span id='tok'>thank</span><span id='tok'>Luigi</span><span id='tok'>Rizzo,</span><span id='tok'>for</span><span id='tok'>his</span><span id='tok'>Netmap</span><span id='tok'>work</span><span id='tok'>and</span><span id='tok'>great</span><span id='tok'>feedback</span><span id='tok'>on</span><span id='tok'>our</span><span class='token pointer' id='tok-118-39' style='color:red'>patches.</span></p><p id=p1036><span id='tok'>Final</span><span id='tok'>wordsAt</span><span id='tok'>CloudFlare</span><span id='tok'>our</span><span id='tok'>application</span><span id='tok'>stack</span><span id='tok'>is</span><span id='tok'>based</span><span id='tok'>on</span><span id='tok'>open</span><span id='tok'>source</span><span id='tok'>software.</span><span id='tok'>We're</span><span id='tok'>grateful</span><span id='tok'>to</span><span id='tok'>so</span><span id='tok'>many</span><span id='tok'>open</span><span id='tok'>source</span><span id='tok'>programmers</span><span id='tok'>for</span><span id='tok'>their</span><span id='tok'>awesome</span><span id='tok'>work.</span><span id='tok'>Whenever</span><span id='tok'>we</span><span id='tok'>can</span><span id='tok'>we</span><span id='tok'>try</span><span id='tok'>to</span><span id='tok'>contribute</span><span id='tok'>back</span><span id='tok'>to</span><span id='tok'>the</span><span id='tok'>community</span><span id='tok'>-</span><span id='tok'>we</span><span id='tok'>hope</span><span id='tok'>"the</span><span id='tok'>single</span><span id='tok'>RX</span><span id='tok'>Netmap</span><span id='tok'>mode"</span><span id='tok'>will</span><span id='tok'>be</span><span id='tok'>useful</span><span id='tok'>to</span><span id='tok'>others.</span></p><p id=p1084><span id='tok'>You</span><span id='tok'>can</span><span id='tok'>find</span><span id='tok'>more</span><span id='tok'>CloudFlare</span><span id='tok'>open</span><span id='tok'>source</span><span id='tok'>here.
</span></p>