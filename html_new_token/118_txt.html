<p id=p0><span class='token pointer' id='tok-118-0'>In</span><span class='token pointer' id='tok-118-1'>a</span><span class='token pointer' id='tok-118-2'>previous</span><span class='token pointer' id='tok-118-3'>post</span><span class='token pointer' id='tok-118-4'>we</span><span class='token pointer' id='tok-118-5'>discussed</span><span class='token pointer' id='tok-118-6'>the</span><span class='token pointer' id='tok-118-7'>performance</span><span class='token pointer' id='tok-118-8'>limitations</span><span class='token pointer' id='tok-118-9'>of</span><span class='token pointer' id='tok-118-10'>the</span><span class='token pointer' id='tok-118-11' style='color:red'>Linux kernel network stack.</span><span class='token pointer' id='tok-118-12'>detailed</span><span class='token pointer' id='tok-118-13'>the</span><span class='token pointer' id='tok-118-14'>available</span><span class='token pointer' id='tok-118-15' style='color:red'>kernel bypass techniques</span><span class='token pointer' id='tok-118-16'>user</span><span class='token pointer' id='tok-118-17'>space</span><span class='token pointer' id='tok-118-18'>programs</span><span class='token pointer' id='tok-118-19'>to</span><span class='token pointer' id='tok-118-20'>receive</span><span class='token pointer' id='tok-118-21' style='color:red'>packets</span><span class='token pointer' id='tok-118-22'>with</span><span class='token pointer' id='tok-118-23'>high</span><span class='token pointer' id='tok-118-24'>throughput.</span><span class='token pointer' id='tok-118-25'>Unfortunately,</span><span class='token pointer' id='tok-118-26'>none</span><span class='token pointer' id='tok-118-27'>of</span><span class='token pointer' id='tok-118-28'>the</span><span class='token pointer' id='tok-118-29'>discussed</span><span class='token pointer' id='tok-118-30' style='color:red'>supported</span><span class='token pointer' id='tok-118-31' style='color:red'>open source solutions</span><span class='token pointer' id='tok-118-32'>needs.</span><span class='token pointer' id='tok-118-33'>To</span><span class='token pointer' id='tok-118-34'>improve</span><span class='token pointer' id='tok-118-35'>the</span><span class='token pointer' id='tok-118-36'>situation</span><span class='token pointer' id='tok-118-37'>we</span><span class='token pointer' id='tok-118-38'>decided</span><span class='token pointer' id='tok-118-39'>to</span><span class='token pointer' id='tok-118-40'>contribute</span><span class='token pointer' id='tok-118-41'>to</span><span class='token pointer' id='tok-118-42'>the</span><span class='token pointer' id='tok-118-43' style='color:red'>Netmap</span><span class='token pointer' id='tok-118-44'>project.</span><span class='token pointer' id='tok-118-45'>In</span><span class='token pointer' id='tok-118-46'>this</span><span class='token pointer' id='tok-118-47'>blog</span><span class='token pointer' id='tok-118-48'>post</span><span class='token pointer' id='tok-118-49'>we'll</span><span class='token pointer' id='tok-118-50'>describe</span><span class='token pointer' id='tok-118-51'>our</span><span class='token pointer' id='tok-118-52'>proposed</span><span class='token pointer' id='tok-118-53'>changes.</span></p><p id=p64><span class='token pointer' id='tok-118-54'>CC</span><span class='token pointer' id='tok-118-55'>BY-SA</span><span class='token pointer' id='tok-118-56'>2.0</span><span class='token pointer' id='tok-118-57'>image</span><span class='token pointer' id='tok-118-58'>by</span></p><p id=p71><span class='token pointer' id='tok-118-59'>Our</span><span class='token pointer' id='tok-118-60'>needsAt</span><span class='token pointer' id='tok-118-61' style='color:red'>CloudFlare</span><span class='token pointer' id='tok-118-62'>we</span><span class='token pointer' id='tok-118-63'>are</span><span class='token pointer' id='tok-118-64'>constantly</span><span class='token pointer' id='tok-118-65'>dealing</span><span class='token pointer' id='tok-118-66'>with</span><span class='token pointer' id='tok-118-67' style='color:red'>large packet floods.</span><span class='token pointer' id='tok-118-68' style='color:red'>network</span><span class='token pointer' id='tok-118-69'>constantly</span><span class='token pointer' id='tok-118-70'>receives</span><span class='token pointer' id='tok-118-71'>a</span><span class='token pointer' id='tok-118-72'>large</span><span class='token pointer' id='tok-118-73'>volume</span><span class='token pointer' id='tok-118-74'>of</span><span class='token pointer' id='tok-118-75'>packets,</span><span class='token pointer' id='tok-118-76'>often</span><span class='token pointer' id='tok-118-77'>coming</span><span class='token pointer' id='tok-118-78'>from</span><span class='token pointer' id='tok-118-79'>many,</span><span class='token pointer' id='tok-118-80'>simultaneous</span><span class='token pointer' id='tok-118-81'>attacks.</span><span class='token pointer' id='tok-118-82'>In</span><span class='token pointer' id='tok-118-83'>fact,</span><span class='token pointer' id='tok-118-84'>it</span><span class='token pointer' id='tok-118-85'>is</span><span class='token pointer' id='tok-118-86'>entirely</span><span class='token pointer' id='tok-118-87'>possible</span><span class='token pointer' id='tok-118-88'>that</span><span class='token pointer' id='tok-118-89'>the</span><span class='token pointer' id='tok-118-90'>server</span><span class='token pointer' id='tok-118-91'>which</span><span class='token pointer' id='tok-118-92'>just</span><span class='token pointer' id='tok-118-93'>served</span><span class='token pointer' id='tok-118-94'>you</span><span class='token pointer' id='tok-118-95'>this</span><span class='token pointer' id='tok-118-96'>blog</span><span class='token pointer' id='tok-118-97'>post</span><span class='token pointer' id='tok-118-98'>is</span><span class='token pointer' id='tok-118-99'>dealing</span><span class='token pointer' id='tok-118-100'>with</span><span class='token pointer' id='tok-118-101'>a</span><span class='token pointer' id='tok-118-102'>many-million</span><span class='token pointer' id='tok-118-103'>packets</span><span class='token pointer' id='tok-118-104'>per</span><span class='token pointer' id='tok-118-105'>second</span><span class='token pointer' id='tok-118-106'>flood</span><span class='token pointer' id='tok-118-107'>right</span><span class='token pointer' id='tok-118-108'>now.</span></p><p id=p124><span class='token pointer' id='tok-118-109'>Since</span><span class='token pointer' id='tok-118-110'>the</span><span class='token pointer' id='tok-118-111' style='color:red'>Linux Kernel</span><span class='token pointer' id='tok-118-112'>really</span><span class='token pointer' id='tok-118-113'>handle</span><span class='token pointer' id='tok-118-114'>a</span><span class='token pointer' id='tok-118-115'>large</span><span class='token pointer' id='tok-118-116'>volume</span><span class='token pointer' id='tok-118-117'>of</span><span class='token pointer' id='tok-118-118'>packets,</span><span class='token pointer' id='tok-118-119'>we</span><span class='token pointer' id='tok-118-120'>need</span><span class='token pointer' id='tok-118-121'>to</span><span class='token pointer' id='tok-118-122'>work</span><span class='token pointer' id='tok-118-123'>around</span><span class='token pointer' id='tok-118-124'>it.</span><span class='token pointer' id='tok-118-125'>During</span><span class='token pointer' id='tok-118-126'>packet</span><span class='token pointer' id='tok-118-127'>floods</span><span class='token pointer' id='tok-118-128'>we</span><span class='token pointer' id='tok-118-129' style='color:red'>offload</span><span class='token pointer' id='tok-118-130'>selected</span><span class='token pointer' id='tok-118-131'>network</span><span class='token pointer' id='tok-118-132'>flows</span><span class='token pointer' id='tok-118-133'>(belonging</span><span class='token pointer' id='tok-118-134'>to</span><span class='token pointer' id='tok-118-135'>a</span><span class='token pointer' id='tok-118-136'>flood)</span><span class='token pointer' id='tok-118-137'>to</span><span class='token pointer' id='tok-118-138'>a</span><span class='token pointer' id='tok-118-139'>user</span><span class='token pointer' id='tok-118-140'>space</span><span class='token pointer' id='tok-118-141'>application.</span><span class='token pointer' id='tok-118-142'>This</span><span class='token pointer' id='tok-118-143'>application</span><span class='token pointer' id='tok-118-144'>filters</span><span class='token pointer' id='tok-118-145'>the</span><span class='token pointer' id='tok-118-146'>packets</span><span class='token pointer' id='tok-118-147'>at</span><span class='token pointer' id='tok-118-148'>very</span><span class='token pointer' id='tok-118-149'>high</span><span class='token pointer' id='tok-118-150'>speed.</span><span class='token pointer' id='tok-118-151'>Most</span><span class='token pointer' id='tok-118-152'>of</span><span class='token pointer' id='tok-118-153'>the</span><span class='token pointer' id='tok-118-154'>packets</span><span class='token pointer' id='tok-118-155'>are</span><span class='token pointer' id='tok-118-156'>dropped,</span><span class='token pointer' id='tok-118-157'>as</span><span class='token pointer' id='tok-118-158'>they</span><span class='token pointer' id='tok-118-159'></span><span class='token pointer' id='tok-118-160'>belong</span><span class='token pointer' id='tok-118-161'>to</span><span class='token pointer' id='tok-118-162'>a</span><span class='token pointer' id='tok-118-163'>flood.</span><span class='token pointer' id='tok-118-164'>The</span><span class='token pointer' id='tok-118-165'>small</span><span class='token pointer' id='tok-118-166'>number</span><span class='token pointer' id='tok-118-167'>of</span><span class='token pointer' id='tok-118-168'>"valid"</span><span class='token pointer' id='tok-118-169'>packets</span><span class='token pointer' id='tok-118-170'>are</span><span class='token pointer' id='tok-118-171'>injected</span><span class='token pointer' id='tok-118-172' style='color:red'>back</span><span class='token pointer' id='tok-118-173'>to</span><span class='token pointer' id='tok-118-174'>the</span><span class='token pointer' id='tok-118-175'>kernel</span><span class='token pointer' id='tok-118-176'>and</span><span class='token pointer' id='tok-118-177'>handled</span><span class='token pointer' id='tok-118-178'>in</span><span class='token pointer' id='tok-118-179'>the</span><span class='token pointer' id='tok-118-180'>same</span><span class='token pointer' id='tok-118-181'>way</span><span class='token pointer' id='tok-118-182'>as</span><span class='token pointer' id='tok-118-183'>usual</span><span class='token pointer' id='tok-118-184'>traffic.</span></p><p id=p202><span class='token pointer' id='tok-118-185'>It's</span><span class='token pointer' id='tok-118-186'>important</span><span class='token pointer' id='tok-118-187'>to</span><span class='token pointer' id='tok-118-188'>emphasize</span><span class='token pointer' id='tok-118-189'>that</span><span class='token pointer' id='tok-118-190'>the</span><span class='token pointer' id='tok-118-191' style='color:red'>kernel bypass</span><span class='token pointer' id='tok-118-192'>enabled</span><span class='token pointer' id='tok-118-193'>only</span><span class='token pointer' id='tok-118-194'>for</span><span class='token pointer' id='tok-118-195'>selected</span><span class='token pointer' id='tok-118-196'>flows,</span><span class='token pointer' id='tok-118-197'>which</span><span class='token pointer' id='tok-118-198'>means</span><span class='token pointer' id='tok-118-199'>that</span><span class='token pointer' id='tok-118-200'>all</span><span class='token pointer' id='tok-118-201'>other</span><span class='token pointer' id='tok-118-202'>packets</span><span class='token pointer' id='tok-118-203'>go</span><span class='token pointer' id='tok-118-204'>to</span><span class='token pointer' id='tok-118-205'>the</span><span class='token pointer' id='tok-118-206'>kernel</span><span class='token pointer' id='tok-118-207'>as</span><span class='token pointer' id='tok-118-208'>usual.</span></p><p id=p228><span class='token pointer' id='tok-118-209'>This</span><span class='token pointer' id='tok-118-210'>setup</span><span class='token pointer' id='tok-118-211'>works</span><span class='token pointer' id='tok-118-212'>perfectly</span><span class='token pointer' id='tok-118-213'>on</span><span class='token pointer' id='tok-118-214'>our</span><span class='token pointer' id='tok-118-215'>servers</span><span class='token pointer' id='tok-118-216'>with</span><span class='token pointer' id='tok-118-217' style='color:red'>Solarflare</span><span class='token pointer' id='tok-118-218'>network</span><span class='token pointer' id='tok-118-219'>cards</span><span class='token pointer' id='tok-118-220'>-</span><span class='token pointer' id='tok-118-221'>we</span><span class='token pointer' id='tok-118-222'>can</span><span class='token pointer' id='tok-118-223'>use</span><span class='token pointer' id='tok-118-224'>the</span><span class='token pointer' id='tok-118-225'>ef_vi</span><span class='token pointer' id='tok-118-226' style='color:red'>API</span><span class='token pointer' id='tok-118-227'>to</span><span class='token pointer' id='tok-118-228'>achieve</span><span class='token pointer' id='tok-118-229'>the</span><span class='token pointer' id='tok-118-230'>kernel</span><span class='token pointer' id='tok-118-231'>bypass.</span><span class='token pointer' id='tok-118-232'>Unfortunately,</span><span class='token pointer' id='tok-118-233'>we</span><span class='token pointer' id='tok-118-234'>don't</span><span class='token pointer' id='tok-118-235'>have</span><span class='token pointer' id='tok-118-236'>this</span><span class='token pointer' id='tok-118-237'>functionality</span><span class='token pointer' id='tok-118-238'>on</span><span class='token pointer' id='tok-118-239'>our</span><span class='token pointer' id='tok-118-240'>servers</span><span class='token pointer' id='tok-118-241'>with</span><span class='token pointer' id='tok-118-242'>Intel</span><span class='token pointer' id='tok-118-243'>IXGBE</span><span class='token pointer' id='tok-118-244'>NIC's.</span></p><p id=p264><span class='token pointer' id='tok-118-245'>This</span><span class='token pointer' id='tok-118-246'>is</span><span class='token pointer' id='tok-118-247'>when</span><span class='token pointer' id='tok-118-248'>Netmap</span><span class='token pointer' id='tok-118-249'>comes</span><span class='token pointer' id='tok-118-250'>in.</span></p><p id=p270><span class='token pointer' id='tok-118-251'>NetmapOver</span><span class='token pointer' id='tok-118-252'>the</span><span class='token pointer' id='tok-118-253'>last</span><span class='token pointer' id='tok-118-254'>few</span><span class='token pointer' id='tok-118-255'>months</span><span class='token pointer' id='tok-118-256'>we've</span><span class='token pointer' id='tok-118-257'>been</span><span class='token pointer' id='tok-118-258'>thinking</span><span class='token pointer' id='tok-118-259'>hard</span><span class='token pointer' id='tok-118-260'>about</span><span class='token pointer' id='tok-118-261'>how</span><span class='token pointer' id='tok-118-262'>to</span><span class='token pointer' id='tok-118-263'>achieve</span><span class='token pointer' id='tok-118-264'>bypass</span><span class='token pointer' id='tok-118-265'>for</span><span class='token pointer' id='tok-118-266'>selected</span><span class='token pointer' id='tok-118-267'>flows</span><span class='token pointer' id='tok-118-268'>(aka:</span><span class='token pointer' id='tok-118-269' style='color:red'>bifurcated driver)</span><span class='token pointer' id='tok-118-270' style='color:red'>non-Solarflare</span><span class='token pointer' id='tok-118-271'>network</span><span class='token pointer' id='tok-118-272'>cards.</span></p><p id=p294><span class='token pointer' id='tok-118-273'>We've</span><span class='token pointer' id='tok-118-274'>considered</span><span class='token pointer' id='tok-118-275' style='color:red'>PF_RING,</span><span class='token pointer' id='tok-118-276' style='color:red'>DPDK</span><span class='token pointer' id='tok-118-277'>and</span><span class='token pointer' id='tok-118-278'>other</span><span class='token pointer' id='tok-118-279'>custom</span><span class='token pointer' id='tok-118-280'>solutions,</span><span class='token pointer' id='tok-118-281'>but</span><span class='token pointer' id='tok-118-282'>sadly</span><span class='token pointer' id='tok-118-283'>all</span><span class='token pointer' id='tok-118-284'>of</span><span class='token pointer' id='tok-118-285'>them</span><span class='token pointer' id='tok-118-286'>take</span><span class='token pointer' id='tok-118-287'>over</span><span class='token pointer' id='tok-118-288'>the</span><span class='token pointer' id='tok-118-289'>whole</span><span class='token pointer' id='tok-118-290'>network</span><span class='token pointer' id='tok-118-291'>card.</span><span class='token pointer' id='tok-118-292'>Eventually</span><span class='token pointer' id='tok-118-293'>we</span><span class='token pointer' id='tok-118-294'>decided</span><span class='token pointer' id='tok-118-295'>that</span><span class='token pointer' id='tok-118-296'>the</span><span class='token pointer' id='tok-118-297'>best</span><span class='token pointer' id='tok-118-298'>way</span><span class='token pointer' id='tok-118-299'>would</span><span class='token pointer' id='tok-118-300'>be</span><span class='token pointer' id='tok-118-301'>to</span><span class='token pointer' id='tok-118-302'>patch</span><span class='token pointer' id='tok-118-303'>Netmap</span><span class='token pointer' id='tok-118-304'>with</span><span class='token pointer' id='tok-118-305'>the</span><span class='token pointer' id='tok-118-306'>functionality</span><span class='token pointer' id='tok-118-307'>we</span><span class='token pointer' id='tok-118-308'>need.</span></p><p id=p330><span class='token pointer' id='tok-118-309'>We</span><span class='token pointer' id='tok-118-310'>chose</span><span class='token pointer' id='tok-118-311'>Netmap</span><span class='token pointer' id='tok-118-312'>because:</span></p><p id=p334><span class='token pointer' id='tok-118-313'>It's</span><span class='token pointer' id='tok-118-314'>fully</span><span class='token pointer' id='tok-118-315' style='color:red'>open source</span><span class='token pointer' id='tok-118-316'>released</span><span class='token pointer' id='tok-118-317'>under</span><span class='token pointer' id='tok-118-318'>a</span><span class='token pointer' id='tok-118-319' style='color:red'>BSD</span><span class='token pointer' id='tok-118-320'>license.It</span><span class='token pointer' id='tok-118-321'>has</span><span class='token pointer' id='tok-118-322'>a</span><span class='token pointer' id='tok-118-323'>great</span><span class='token pointer' id='tok-118-324' style='color:red'>NIC-agnostic</span><span class='token pointer' id='tok-118-325' style='color:red'>API.It's</span><span class='token pointer' id='tok-118-326'>very</span><span class='token pointer' id='tok-118-327'>fast:</span><span class='token pointer' id='tok-118-328'>can</span><span class='token pointer' id='tok-118-329'>reach</span><span class='token pointer' id='tok-118-330'>line</span><span class='token pointer' id='tok-118-331'>rate</span><span class='token pointer' id='tok-118-332'>easily.The</span><span class='token pointer' id='tok-118-333'>project</span><span class='token pointer' id='tok-118-334'>is</span><span class='token pointer' id='tok-118-335'>well</span><span class='token pointer' id='tok-118-336'>maintained</span><span class='token pointer' id='tok-118-337'>and</span><span class='token pointer' id='tok-118-338'>reasonably</span><span class='token pointer' id='tok-118-339'>mature.The</span><span class='token pointer' id='tok-118-340'>code</span><span class='token pointer' id='tok-118-341'>is</span><span class='token pointer' id='tok-118-342'>very</span><span class='token pointer' id='tok-118-343'>high</span><span class='token pointer' id='tok-118-344'>quality.The</span><span class='token pointer' id='tok-118-345'>driver-specific</span><span class='token pointer' id='tok-118-346'>modifications</span><span class='token pointer' id='tok-118-347'>are</span><span class='token pointer' id='tok-118-348'>trivial:</span><span class='token pointer' id='tok-118-349'>most</span><span class='token pointer' id='tok-118-350'>of</span><span class='token pointer' id='tok-118-351'>the</span><span class='token pointer' id='tok-118-352'>magic</span><span class='token pointer' id='tok-118-353'>happens</span><span class='token pointer' id='tok-118-354'>in</span><span class='token pointer' id='tok-118-355'>the</span><span class='token pointer' id='tok-118-356'>shared</span><span class='token pointer' id='tok-118-357'>Netmap</span><span class='token pointer' id='tok-118-358'>module.</span><span class='token pointer' id='tok-118-359'>It's</span><span class='token pointer' id='tok-118-360'>easy</span><span class='token pointer' id='tok-118-361'>to</span><span class='token pointer' id='tok-118-362'>add</span><span class='token pointer' id='tok-118-363'>support</span><span class='token pointer' id='tok-118-364'>for</span><span class='token pointer' id='tok-118-365'>new</span><span class='token pointer' id='tok-118-366'>hardware.Introducing</span><span class='token pointer' id='tok-118-367'>the</span><span class='token pointer' id='tok-118-368'>single</span><span class='token pointer' id='tok-118-369' style='color:red'>RX queue</span><span class='token pointer' id='tok-118-370'>when</span><span class='token pointer' id='tok-118-371'>a</span><span class='token pointer' id='tok-118-372'>network</span><span class='token pointer' id='tok-118-373'>card</span><span class='token pointer' id='tok-118-374'>goes</span><span class='token pointer' id='tok-118-375'>into</span><span class='token pointer' id='tok-118-376'>the</span><span class='token pointer' id='tok-118-377'>Netmap</span><span class='token pointer' id='tok-118-378'>mode,</span><span class='token pointer' id='tok-118-379'>all</span><span class='token pointer' id='tok-118-380'>the</span><span class='token pointer' id='tok-118-381' style='color:red'>RX queues</span><span class='token pointer' id='tok-118-382'>disconnected</span><span class='token pointer' id='tok-118-383'>from</span><span class='token pointer' id='tok-118-384'>the</span><span class='token pointer' id='tok-118-385'>kernel</span><span class='token pointer' id='tok-118-386'>and</span><span class='token pointer' id='tok-118-387'>are</span><span class='token pointer' id='tok-118-388'>available</span><span class='token pointer' id='tok-118-389'>to</span><span class='token pointer' id='tok-118-390'>the</span><span class='token pointer' id='tok-118-391'>Netmap</span><span class='token pointer' id='tok-118-392'>applications.</span></p><p id=p420><span class='token pointer' id='tok-118-393'>We</span><span class='token pointer' id='tok-118-394'>don't</span><span class='token pointer' id='tok-118-395'>want</span><span class='token pointer' id='tok-118-396'>that.</span><span class='token pointer' id='tok-118-397'>We</span><span class='token pointer' id='tok-118-398'>want</span><span class='token pointer' id='tok-118-399'>to</span><span class='token pointer' id='tok-118-400'>keep</span><span class='token pointer' id='tok-118-401'>most</span><span class='token pointer' id='tok-118-402'>of</span><span class='token pointer' id='tok-118-403'>the</span><span class='token pointer' id='tok-118-404'>RX</span><span class='token pointer' id='tok-118-405'>queues</span><span class='token pointer' id='tok-118-406'>back</span><span class='token pointer' id='tok-118-407'>in</span><span class='token pointer' id='tok-118-408'>the</span><span class='token pointer' id='tok-118-409'>kernel</span><span class='token pointer' id='tok-118-410'>mode,</span><span class='token pointer' id='tok-118-411'>and</span><span class='token pointer' id='tok-118-412'>enable</span><span class='token pointer' id='tok-118-413'>Netmap</span><span class='token pointer' id='tok-118-414'>mode</span><span class='token pointer' id='tok-118-415'>only</span><span class='token pointer' id='tok-118-416'>on</span><span class='token pointer' id='tok-118-417'>selected</span><span class='token pointer' id='tok-118-418'>RX</span><span class='token pointer' id='tok-118-419'>queues.</span><span class='token pointer' id='tok-118-420'>We</span><span class='token pointer' id='tok-118-421'>call</span><span class='token pointer' id='tok-118-422'>this</span><span class='token pointer' id='tok-118-423'>functionality:</span><span class='token pointer' id='tok-118-424'>"single</span><span class='token pointer' id='tok-118-425'>RX</span><span class='token pointer' id='tok-118-426'>queue</span><span class='token pointer' id='tok-118-427'>mode".</span></p><p id=p455><span class='token pointer' id='tok-118-428'>The</span><span class='token pointer' id='tok-118-429'>intention</span><span class='token pointer' id='tok-118-430'>was</span><span class='token pointer' id='tok-118-431'>to</span><span class='token pointer' id='tok-118-432'>expose</span><span class='token pointer' id='tok-118-433'>a</span><span class='token pointer' id='tok-118-434'>minimal</span><span class='token pointer' id='tok-118-435'>API</span><span class='token pointer' id='tok-118-436'>which</span><span class='token pointer' id='tok-118-437'>could:</span></p><p id=p465><span class='token pointer' id='tok-118-438'>Open</span><span class='token pointer' id='tok-118-439'>a</span><span class='token pointer' id='tok-118-440'>network</span><span class='token pointer' id='tok-118-441'>interface</span><span class='token pointer' id='tok-118-442'>in</span><span class='token pointer' id='tok-118-443'>"a</span><span class='token pointer' id='tok-118-444'>single</span><span class='token pointer' id='tok-118-445'>RX</span><span class='token pointer' id='tok-118-446'>queue</span><span class='token pointer' id='tok-118-447'>mode".This</span><span class='token pointer' id='tok-118-448'>would</span><span class='token pointer' id='tok-118-449'>allow</span><span class='token pointer' id='tok-118-450'>netmap</span><span class='token pointer' id='tok-118-451'>applications</span><span class='token pointer' id='tok-118-452'>to</span><span class='token pointer' id='tok-118-453'>receive</span><span class='token pointer' id='tok-118-454'>packets</span><span class='token pointer' id='tok-118-455'>from</span><span class='token pointer' id='tok-118-456'>that</span><span class='token pointer' id='tok-118-457'>specific</span><span class='token pointer' id='tok-118-458' style='color:red'>RX queue.While</span><span class='token pointer' id='tok-118-459'>all</span><span class='token pointer' id='tok-118-460'>the</span><span class='token pointer' id='tok-118-461'>other</span><span class='token pointer' id='tok-118-462'>queues</span><span class='token pointer' id='tok-118-463'>attached</span><span class='token pointer' id='tok-118-464'>to</span><span class='token pointer' id='tok-118-465'>the</span><span class='token pointer' id='tok-118-466'>host</span><span class='token pointer' id='tok-118-467'>network</span><span class='token pointer' id='tok-118-468'>stack.On</span><span class='token pointer' id='tok-118-469'>demand</span><span class='token pointer' id='tok-118-470'>add</span><span class='token pointer' id='tok-118-471'>or</span><span class='token pointer' id='tok-118-472'>remove</span><span class='token pointer' id='tok-118-473'>RX</span><span class='token pointer' id='tok-118-474'>queues</span><span class='token pointer' id='tok-118-475'>from</span><span class='token pointer' id='tok-118-476'>the</span><span class='token pointer' id='tok-118-477'>"single</span><span class='token pointer' id='tok-118-478'>RX</span><span class='token pointer' id='tok-118-479'>queue</span><span class='token pointer' id='tok-118-480'>mode".Eventually</span><span class='token pointer' id='tok-118-481'>remove</span><span class='token pointer' id='tok-118-482'>the</span><span class='token pointer' id='tok-118-483'>interface</span><span class='token pointer' id='tok-118-484'>from</span><span class='token pointer' id='tok-118-485'>the</span><span class='token pointer' id='tok-118-486'>Netmap</span><span class='token pointer' id='tok-118-487'>mode</span><span class='token pointer' id='tok-118-488'>and</span><span class='token pointer' id='tok-118-489' style='color:red'>reattach</span><span class='token pointer' id='tok-118-490'>the</span><span class='token pointer' id='tok-118-491'>RX</span><span class='token pointer' id='tok-118-492'>queues</span><span class='token pointer' id='tok-118-493'>to</span><span class='token pointer' id='tok-118-494'>the</span><span class='token pointer' id='tok-118-495'>host</span><span class='token pointer' id='tok-118-496'>stack.</span></p><p id=p526><span class='token pointer' id='tok-118-497'>Indeed</span><span class='token pointer' id='tok-118-498'>the</span><span class='token pointer' id='tok-118-499'>only</span><span class='token pointer' id='tok-118-500'>difference</span><span class='token pointer' id='tok-118-501'>is</span><span class='token pointer' id='tok-118-502'>the</span><span class='token pointer' id='tok-118-503'>nm_open()</span><span class='token pointer' id='tok-118-504'>call,</span><span class='token pointer' id='tok-118-505'>which</span><span class='token pointer' id='tok-118-506'>uses</span><span class='token pointer' id='tok-118-507'>the</span><span class='token pointer' id='tok-118-508'>new</span><span class='token pointer' id='tok-118-509'>syntax</span><span class='token pointer' id='tok-118-510'>netmap:ifname~queue_number.</span></p><p id=p540><span class='token pointer' id='tok-118-511'>Once</span><span class='token pointer' id='tok-118-512'>again,</span><span class='token pointer' id='tok-118-513'>when</span><span class='token pointer' id='tok-118-514'>running</span><span class='token pointer' id='tok-118-515'>this</span><span class='token pointer' id='tok-118-516'>code</span><span class='token pointer' id='tok-118-517'>only</span><span class='token pointer' id='tok-118-518'>packets</span><span class='token pointer' id='tok-118-519'>arriving</span><span class='token pointer' id='tok-118-520'>on</span><span class='token pointer' id='tok-118-521'>the</span><span class='token pointer' id='tok-118-522'>RX</span><span class='token pointer' id='tok-118-523'>queue</span><span class='token pointer' id='tok-118-524'>#4</span><span class='token pointer' id='tok-118-525'>will</span><span class='token pointer' id='tok-118-526'>go</span><span class='token pointer' id='tok-118-527'>to</span><span class='token pointer' id='tok-118-528'>the</span><span class='token pointer' id='tok-118-529'>netmap</span><span class='token pointer' id='tok-118-530'>program.</span><span class='token pointer' id='tok-118-531'>All</span><span class='token pointer' id='tok-118-532'>other</span><span class='token pointer' id='tok-118-533'>RX</span><span class='token pointer' id='tok-118-534'>and</span><span class='token pointer' id='tok-118-535'>TX</span><span class='token pointer' id='tok-118-536'>queues</span><span class='token pointer' id='tok-118-537'>will</span><span class='token pointer' id='tok-118-538'>be</span><span class='token pointer' id='tok-118-539'>handled</span><span class='token pointer' id='tok-118-540'>by</span><span class='token pointer' id='tok-118-541'>the</span><span class='token pointer' id='tok-118-542'>Linux</span><span class='token pointer' id='tok-118-543'>kernel</span><span class='token pointer' id='tok-118-544'>network</span><span class='token pointer' id='tok-118-545'>stack.</span></p><p id=p575><span class='token pointer' id='tok-118-546'>Isolating</span><span class='token pointer' id='tok-118-547'>a</span><span class='token pointer' id='tok-118-548'>queueIn</span><span class='token pointer' id='tok-118-549'>multiqueue</span><span class='token pointer' id='tok-118-550'>network</span><span class='token pointer' id='tok-118-551'>cards,</span><span class='token pointer' id='tok-118-552'>any</span><span class='token pointer' id='tok-118-553'>packet</span><span class='token pointer' id='tok-118-554'>can</span><span class='token pointer' id='tok-118-555'>end</span><span class='token pointer' id='tok-118-556'>up</span><span class='token pointer' id='tok-118-557'>in</span><span class='token pointer' id='tok-118-558'>almost</span><span class='token pointer' id='tok-118-559'>any</span><span class='token pointer' id='tok-118-560'>RX</span><span class='token pointer' id='tok-118-561'>queue</span><span class='token pointer' id='tok-118-562'>due</span><span class='token pointer' id='tok-118-563'>to</span><span class='token pointer' id='tok-118-564' style='color:red'>RSS.</span><span class='token pointer' id='tok-118-565'>This</span><span class='token pointer' id='tok-118-566'>is</span><span class='token pointer' id='tok-118-567'>why</span><span class='token pointer' id='tok-118-568'>before</span><span class='token pointer' id='tok-118-569'>enabling</span><span class='token pointer' id='tok-118-570'>the</span><span class='token pointer' id='tok-118-571'>single</span><span class='token pointer' id='tok-118-572'>RX</span><span class='token pointer' id='tok-118-573'>mode</span><span class='token pointer' id='tok-118-574'>it</span><span class='token pointer' id='tok-118-575'>is</span><span class='token pointer' id='tok-118-576'>necessary</span><span class='token pointer' id='tok-118-577'>to</span><span class='token pointer' id='tok-118-578'>make</span><span class='token pointer' id='tok-118-579'>sure</span><span class='token pointer' id='tok-118-580'>only</span><span class='token pointer' id='tok-118-581'>the</span><span class='token pointer' id='tok-118-582'>selected</span><span class='token pointer' id='tok-118-583'>flow</span><span class='token pointer' id='tok-118-584'>goes</span><span class='token pointer' id='tok-118-585'>to</span><span class='token pointer' id='tok-118-586'>the</span><span class='token pointer' id='tok-118-587'>Netmap</span><span class='token pointer' id='tok-118-588'>queue.</span></p><p id=p618><span class='token pointer' id='tok-118-589'>To</span><span class='token pointer' id='tok-118-590'>do</span><span class='token pointer' id='tok-118-591'>so</span><span class='token pointer' id='tok-118-592'>it</span><span class='token pointer' id='tok-118-593'>is</span><span class='token pointer' id='tok-118-594'>necessary</span><span class='token pointer' id='tok-118-595'>to:</span></p><p id=p625><span class='token pointer' id='tok-118-596'>Modify</span><span class='token pointer' id='tok-118-597'>the</span><span class='token pointer' id='tok-118-598'>indirection</span><span class='token pointer' id='tok-118-599'>table</span><span class='token pointer' id='tok-118-600'>to</span><span class='token pointer' id='tok-118-601'>ensure</span><span class='token pointer' id='tok-118-602'>no</span><span class='token pointer' id='tok-118-603'>new</span><span class='token pointer' id='tok-118-604' style='color:red'>RSS-hashed</span><span class='token pointer' id='tok-118-605'>packets</span><span class='token pointer' id='tok-118-606'>will</span><span class='token pointer' id='tok-118-607'>go</span><span class='token pointer' id='tok-118-608'>there.Use</span><span class='token pointer' id='tok-118-609' style='color:red'>flow steering</span><span class='token pointer' id='tok-118-610'>specifically</span><span class='token pointer' id='tok-118-611'>direct</span><span class='token pointer' id='tok-118-612'>some</span><span class='token pointer' id='tok-118-613'>flows</span><span class='token pointer' id='tok-118-614'>to</span><span class='token pointer' id='tok-118-615'>the</span><span class='token pointer' id='tok-118-616'>isolated</span><span class='token pointer' id='tok-118-617'>queue.Work</span><span class='token pointer' id='tok-118-618'>around</span><span class='token pointer' id='tok-118-619'>RFS</span><span class='token pointer' id='tok-118-620'>-</span><span class='token pointer' id='tok-118-621'>make</span><span class='token pointer' id='tok-118-622'>sure</span><span class='token pointer' id='tok-118-623'>no</span><span class='token pointer' id='tok-118-624'>other</span><span class='token pointer' id='tok-118-625'>application</span><span class='token pointer' id='tok-118-626'>is</span><span class='token pointer' id='tok-118-627'>running</span><span class='token pointer' id='tok-118-628'>on</span><span class='token pointer' id='tok-118-629'>the</span><span class='token pointer' id='tok-118-630'>CPU</span><span class='token pointer' id='tok-118-631'>Netmap</span><span class='token pointer' id='tok-118-632'>will</span><span class='token pointer' id='tok-118-633'>run</span><span class='token pointer' id='tok-118-634'>on.For</span><span class='token pointer' id='tok-118-635'>example:</span></p><p id=p667><span class='token pointer' id='tok-118-636'>$</span><span class='token pointer' id='tok-118-637' style='color:red'>ethtool</span><span class='token pointer' id='tok-118-638'>-X</span><span class='token pointer' id='tok-118-639'>eth3</span><span class='token pointer' id='tok-118-640'>weight</span><span class='token pointer' id='tok-118-641'>1</span><span class='token pointer' id='tok-118-642'>1</span><span class='token pointer' id='tok-118-643'>1</span><span class='token pointer' id='tok-118-644'>1</span><span class='token pointer' id='tok-118-645'>0</span><span class='token pointer' id='tok-118-646'>1</span><span class='token pointer' id='tok-118-647'>1</span><span class='token pointer' id='tok-118-648'>1</span><span class='token pointer' id='tok-118-649'>1</span><span class='token pointer' id='tok-118-650'>1$</span><span class='token pointer' id='tok-118-651'>ethtool</span><span class='token pointer' id='tok-118-652'>-K</span><span class='token pointer' id='tok-118-653'>eth3</span><span class='token pointer' id='tok-118-654'>ntuple</span><span class='token pointer' id='tok-118-655'>on$</span><span class='token pointer' id='tok-118-656'>ethtool</span><span class='token pointer' id='tok-118-657'>-N</span><span class='token pointer' id='tok-118-658'>eth3</span><span class='token pointer' id='tok-118-659'>flow-type</span><span class='token pointer' id='tok-118-660'>udp4</span><span class='token pointer' id='tok-118-661' style='color:red'>dst-port</span><span class='token pointer' id='tok-118-662'>53</span><span class='token pointer' id='tok-118-663'>action</span><span class='token pointer' id='tok-118-664'>4Here</span><span class='token pointer' id='tok-118-665'>we</span><span class='token pointer' id='tok-118-666'>are</span><span class='token pointer' id='tok-118-667'>setting</span><span class='token pointer' id='tok-118-668'>the</span><span class='token pointer' id='tok-118-669'>indirection</span><span class='token pointer' id='tok-118-670'>table</span><span class='token pointer' id='tok-118-671'>to</span><span class='token pointer' id='tok-118-672'>prevent</span><span class='token pointer' id='tok-118-673'>traffic</span><span class='token pointer' id='tok-118-674'>from</span><span class='token pointer' id='tok-118-675'>going</span><span class='token pointer' id='tok-118-676'>to</span><span class='token pointer' id='tok-118-677'>RX</span><span class='token pointer' id='tok-118-678'>queue</span><span class='token pointer' id='tok-118-679'>#4.</span><span class='token pointer' id='tok-118-680'>Then</span><span class='token pointer' id='tok-118-681'>we</span><span class='token pointer' id='tok-118-682'>are</span><span class='token pointer' id='tok-118-683'>enabling</span><span class='token pointer' id='tok-118-684'>flow</span><span class='token pointer' id='tok-118-685'>steering</span><span class='token pointer' id='tok-118-686'>to</span><span class='token pointer' id='tok-118-687'>enqueue</span><span class='token pointer' id='tok-118-688'>all</span><span class='token pointer' id='tok-118-689' style='color:red'>UDP traffic</span><span class='token pointer' id='tok-118-690'>destination</span><span class='token pointer' id='tok-118-691' style='color:red'>port</span><span class='token pointer' id='tok-118-692'>53</span><span class='token pointer' id='tok-118-693'>into</span><span class='token pointer' id='tok-118-694'>queue</span><span class='token pointer' id='tok-118-695'>#4.</span></p><p id=p729><span class='token pointer' id='tok-118-696'>Trying</span><span class='token pointer' id='tok-118-697'>it</span><span class='token pointer' id='tok-118-698'>outHere's</span><span class='token pointer' id='tok-118-699'>how</span><span class='token pointer' id='tok-118-700'>to</span><span class='token pointer' id='tok-118-701'>run</span><span class='token pointer' id='tok-118-702'>it</span><span class='token pointer' id='tok-118-703'>with</span><span class='token pointer' id='tok-118-704'>the</span><span class='token pointer' id='tok-118-705'>IXGBE</span><span class='token pointer' id='tok-118-706'>NIC.</span><span class='token pointer' id='tok-118-707'>First</span><span class='token pointer' id='tok-118-708'>grab</span><span class='token pointer' id='tok-118-709'>the</span><span class='token pointer' id='tok-118-710'>sources:</span></p><p id=p744><span class='token pointer' id='tok-118-711'>$</span><span class='token pointer' id='tok-118-712'>git</span><span class='token pointer' id='tok-118-713'>clone</span><span class='token pointer' id='tok-118-714'>https://github.com/jibi/netmap.git$</span><span class='token pointer' id='tok-118-715'>cd</span><span class='token pointer' id='tok-118-716'>netmap$</span><span class='token pointer' id='tok-118-717'>git</span><span class='token pointer' id='tok-118-718'>checkout</span><span class='token pointer' id='tok-118-719'>-B</span><span class='token pointer' id='tok-118-720'>single-rx-queue-mode$</span><span class='token pointer' id='tok-118-721'>./configure</span><span class='token pointer' id='tok-118-722'>--drivers=ixgbe</span><span class='token pointer' id='tok-118-723' style='color:red'>--kernel-sources=/path/to/kernelLoad</span><span class='token pointer' id='tok-118-724'>the</span><span class='token pointer' id='tok-118-725'>netmap-patched</span><span class='token pointer' id='tok-118-726'>modules</span><span class='token pointer' id='tok-118-727'>and</span><span class='token pointer' id='tok-118-728'>setup</span><span class='token pointer' id='tok-118-729'>the</span><span class='token pointer' id='tok-118-730'>interface:</span></p><p id=p764><span class='token pointer' id='tok-118-731'>$</span><span class='token pointer' id='tok-118-732'>insmod</span><span class='token pointer' id='tok-118-733'>./LINUX/netmap.ko$</span><span class='token pointer' id='tok-118-734'>insmod</span><span class='token pointer' id='tok-118-735'>./LINUX/ixgbe/ixgbe.ko$</span><span class='token pointer' id='tok-118-736'>#</span><span class='token pointer' id='tok-118-737'>Distribute</span><span class='token pointer' id='tok-118-738'>the</span><span class='token pointer' id='tok-118-739'>interrupts:$</span><span class='token pointer' id='tok-118-740'>(let</span><span class='token pointer' id='tok-118-741'>CPU=0;</span><span class='token pointer' id='tok-118-742'>cd</span><span class='token pointer' id='tok-118-743'>/sys/class/net/eth3/device/msi_irqs/;</span><span class='token pointer' id='tok-118-744'>for</span><span class='token pointer' id='tok-118-745'>IRQ</span><span class='token pointer' id='tok-118-746'>in</span><span class='token pointer' id='tok-118-747'>*;</span><span class='token pointer' id='tok-118-748'>do</span><span class='token pointer' id='tok-118-749'>\</span><span class='token pointer' id='tok-118-750'></span><span class='token pointer' id='tok-118-751'>echo</span><span class='token pointer' id='tok-118-752'>$CPU</span><span class='token pointer' id='tok-118-753'>></span><span class='token pointer' id='tok-118-754'>/proc/irq/$IRQ/smp_affinity_list;</span><span class='token pointer' id='tok-118-755'>let</span><span class='token pointer' id='tok-118-756'>CPU+=1</span><span class='token pointer' id='tok-118-757'></span><span class='token pointer' id='tok-118-758'></span><span class='token pointer' id='tok-118-759'></span><span class='token pointer' id='tok-118-760'></span><span class='token pointer' id='tok-118-761'></span><span class='token pointer' id='tok-118-762'></span><span class='token pointer' id='tok-118-763'></span><span class='token pointer' id='tok-118-764'></span><span class='token pointer' id='tok-118-765'>done)$</span><span class='token pointer' id='tok-118-766'>#</span><span class='token pointer' id='tok-118-767'>Enable</span><span class='token pointer' id='tok-118-768'>RSS:$</span><span class='token pointer' id='tok-118-769'>ethtool</span><span class='token pointer' id='tok-118-770'>-K</span><span class='token pointer' id='tok-118-771'>eth3</span><span class='token pointer' id='tok-118-772'>ntuple</span><span class='token pointer' id='tok-118-773'>onAt</span><span class='token pointer' id='tok-118-774'>this</span><span class='token pointer' id='tok-118-775'>point</span><span class='token pointer' id='tok-118-776'>we</span><span class='token pointer' id='tok-118-777'>started</span><span class='token pointer' id='tok-118-778'>flooding</span><span class='token pointer' id='tok-118-779'>the</span><span class='token pointer' id='tok-118-780'>interface</span><span class='token pointer' id='tok-118-781'>with</span><span class='token pointer' id='tok-118-782'>6M</span><span class='token pointer' id='tok-118-783'>short</span><span class='token pointer' id='tok-118-784'>UDP</span><span class='token pointer' id='tok-118-785'>packets.</span><span class='token pointer' id='tok-118-786'>htop</span><span class='token pointer' id='tok-118-787'>shows</span><span class='token pointer' id='tok-118-788'>the</span><span class='token pointer' id='tok-118-789'>server</span><span class='token pointer' id='tok-118-790'>being</span><span class='token pointer' id='tok-118-791' style='color:red'>totally</span><span class='token pointer' id='tok-118-792'>busy</span><span class='token pointer' id='tok-118-793'>with</span><span class='token pointer' id='tok-118-794'>handling</span><span class='token pointer' id='tok-118-795'>the</span><span class='token pointer' id='tok-118-796'>flood:</span></p><p id=p830><span class='token pointer' id='tok-118-797'>To</span><span class='token pointer' id='tok-118-798'>counter</span><span class='token pointer' id='tok-118-799'>the</span><span class='token pointer' id='tok-118-800'>flood</span><span class='token pointer' id='tok-118-801'>we</span><span class='token pointer' id='tok-118-802'>started</span><span class='token pointer' id='tok-118-803'>Netmap.</span><span class='token pointer' id='tok-118-804'>First,</span><span class='token pointer' id='tok-118-805'>we</span><span class='token pointer' id='tok-118-806'>needed</span><span class='token pointer' id='tok-118-807'>to</span><span class='token pointer' id='tok-118-808'>edit</span><span class='token pointer' id='tok-118-809'>the</span><span class='token pointer' id='tok-118-810'>indirection</span><span class='token pointer' id='tok-118-811'>table,</span><span class='token pointer' id='tok-118-812'>to</span><span class='token pointer' id='tok-118-813'>isolate</span><span class='token pointer' id='tok-118-814'>the</span><span class='token pointer' id='tok-118-815'>RX</span><span class='token pointer' id='tok-118-816'>queue</span><span class='token pointer' id='tok-118-817'>#4:</span></p><p id=p851><span class='token pointer' id='tok-118-818'>$</span><span class='token pointer' id='tok-118-819'>ethtool</span><span class='token pointer' id='tok-118-820'>-X</span><span class='token pointer' id='tok-118-821'>eth3</span><span class='token pointer' id='tok-118-822'>weight</span><span class='token pointer' id='tok-118-823'>1</span><span class='token pointer' id='tok-118-824'>1</span><span class='token pointer' id='tok-118-825'>1</span><span class='token pointer' id='tok-118-826'>1</span><span class='token pointer' id='tok-118-827'>0</span><span class='token pointer' id='tok-118-828'>1</span><span class='token pointer' id='tok-118-829'>1</span><span class='token pointer' id='tok-118-830'>1</span><span class='token pointer' id='tok-118-831'>1</span><span class='token pointer' id='tok-118-832'>1$</span><span class='token pointer' id='tok-118-833'>ethtool</span><span class='token pointer' id='tok-118-834'>-N</span><span class='token pointer' id='tok-118-835'>eth3</span><span class='token pointer' id='tok-118-836'>flow-type</span><span class='token pointer' id='tok-118-837'>udp4</span><span class='token pointer' id='tok-118-838'>dst-port</span><span class='token pointer' id='tok-118-839'>53</span><span class='token pointer' id='tok-118-840'>action</span><span class='token pointer' id='tok-118-841'>4This</span><span class='token pointer' id='tok-118-842'>caused</span><span class='token pointer' id='tok-118-843'>all</span><span class='token pointer' id='tok-118-844'>the</span><span class='token pointer' id='tok-118-845'>flood</span><span class='token pointer' id='tok-118-846'>packets</span><span class='token pointer' id='tok-118-847'>to</span><span class='token pointer' id='tok-118-848'>go</span><span class='token pointer' id='tok-118-849'>to</span><span class='token pointer' id='tok-118-850'>RX</span><span class='token pointer' id='tok-118-851'>queue</span><span class='token pointer' id='tok-118-852'>#4.</span></p><p id=p886><span class='token pointer' id='tok-118-853'>Before</span><span class='token pointer' id='tok-118-854'>putting</span><span class='token pointer' id='tok-118-855'>an</span><span class='token pointer' id='tok-118-856'>interface</span><span class='token pointer' id='tok-118-857'>in</span><span class='token pointer' id='tok-118-858'>Netmap</span><span class='token pointer' id='tok-118-859'>mode</span><span class='token pointer' id='tok-118-860'>it</span><span class='token pointer' id='tok-118-861'>is</span><span class='token pointer' id='tok-118-862'>necessary</span><span class='token pointer' id='tok-118-863'>to</span><span class='token pointer' id='tok-118-864'>turn</span><span class='token pointer' id='tok-118-865'>off</span><span class='token pointer' id='tok-118-866'>hardware</span><span class='token pointer' id='tok-118-867'>offload</span><span class='token pointer' id='tok-118-868'>features:</span></p><p id=p902><span class='token pointer' id='tok-118-869'>$</span><span class='token pointer' id='tok-118-870'>ethtool</span><span class='token pointer' id='tok-118-871'>-K</span><span class='token pointer' id='tok-118-872'>eth3</span><span class='token pointer' id='tok-118-873'>lro</span><span class='token pointer' id='tok-118-874'>off</span><span class='token pointer' id='tok-118-875'>gro</span><span class='token pointer' id='tok-118-876'>offFinally</span><span class='token pointer' id='tok-118-877'>we</span><span class='token pointer' id='tok-118-878'>launched</span><span class='token pointer' id='tok-118-879'>the</span><span class='token pointer' id='tok-118-880'>netmap</span><span class='token pointer' id='tok-118-881'>offload:</span></p><p id=p915><span class='token pointer' id='tok-118-882'>$</span><span class='token pointer' id='tok-118-883'>sudo</span><span class='token pointer' id='tok-118-884'>taskset</span><span class='token pointer' id='tok-118-885'>-c</span><span class='token pointer' id='tok-118-886'>15</span><span class='token pointer' id='tok-118-887'>./nm_offload</span><span class='token pointer' id='tok-118-888'>eth3</span><span class='token pointer' id='tok-118-889'>4[+]</span><span class='token pointer' id='tok-118-890'>starting</span><span class='token pointer' id='tok-118-891'>test02</span><span class='token pointer' id='tok-118-892'>on</span><span class='token pointer' id='tok-118-893'>interface</span><span class='token pointer' id='tok-118-894'>eth3</span><span class='token pointer' id='tok-118-895'>ring</span><span class='token pointer' id='tok-118-896'>4[+]</span><span class='token pointer' id='tok-118-897'>UDP</span><span class='token pointer' id='tok-118-898'>pps:</span><span class='token pointer' id='tok-118-899'>5844714[+]</span><span class='token pointer' id='tok-118-900'>UDP</span><span class='token pointer' id='tok-118-901'>pps:</span><span class='token pointer' id='tok-118-902'>5996166[+]</span><span class='token pointer' id='tok-118-903'>UDP</span><span class='token pointer' id='tok-118-904'>pps:</span><span class='token pointer' id='tok-118-905'>5863214[+]</span><span class='token pointer' id='tok-118-906'>UDP</span><span class='token pointer' id='tok-118-907'>pps:</span><span class='token pointer' id='tok-118-908'>5986365[+]</span><span class='token pointer' id='tok-118-909'>UDP</span><span class='token pointer' id='tok-118-910'>pps:</span><span class='token pointer' id='tok-118-911'>5867302[+]</span><span class='token pointer' id='tok-118-912'>UDP</span><span class='token pointer' id='tok-118-913'>pps:</span><span class='token pointer' id='tok-118-914'>5964911[+]</span><span class='token pointer' id='tok-118-915'>UDP</span><span class='token pointer' id='tok-118-916'>pps:</span><span class='token pointer' id='tok-118-917'>5909715[+]</span><span class='token pointer' id='tok-118-918'>UDP</span><span class='token pointer' id='tok-118-919'>pps:</span><span class='token pointer' id='tok-118-920'>5865769[+]</span><span class='token pointer' id='tok-118-921'>UDP</span><span class='token pointer' id='tok-118-922'>pps:</span><span class='token pointer' id='tok-118-923'>5906668[+]</span><span class='token pointer' id='tok-118-924'>UDP</span><span class='token pointer' id='tok-118-925'>pps:</span><span class='token pointer' id='tok-118-926'>5875486As</span><span class='token pointer' id='tok-118-927'>you</span><span class='token pointer' id='tok-118-928'>see</span><span class='token pointer' id='tok-118-929'>the</span><span class='token pointer' id='tok-118-930'>netmap</span><span class='token pointer' id='tok-118-931'>program</span><span class='token pointer' id='tok-118-932'>on</span><span class='token pointer' id='tok-118-933'>a</span><span class='token pointer' id='tok-118-934'>single</span><span class='token pointer' id='tok-118-935'>RX</span><span class='token pointer' id='tok-118-936'>queue</span><span class='token pointer' id='tok-118-937'>was</span><span class='token pointer' id='tok-118-938'>able</span><span class='token pointer' id='tok-118-939'>to</span><span class='token pointer' id='tok-118-940'>receive</span><span class='token pointer' id='tok-118-941'>about</span><span class='token pointer' id='tok-118-942'>5.8M</span><span class='token pointer' id='tok-118-943'>packets.</span></p><p id=p977><span class='token pointer' id='tok-118-944'>For</span><span class='token pointer' id='tok-118-945'>completeness,</span><span class='token pointer' id='tok-118-946'>here's</span><span class='token pointer' id='tok-118-947'>an</span><span class='token pointer' id='tok-118-948'>htop</span><span class='token pointer' id='tok-118-949'>showing</span><span class='token pointer' id='tok-118-950'>only</span><span class='token pointer' id='tok-118-951'>a</span><span class='token pointer' id='tok-118-952'>single</span><span class='token pointer' id='tok-118-953'>core</span><span class='token pointer' id='tok-118-954'>being</span><span class='token pointer' id='tok-118-955'>busy</span><span class='token pointer' id='tok-118-956'>with</span><span class='token pointer' id='tok-118-957'>Netmap:</span></p><p id=p991><span class='token pointer' id='tok-118-958'>ThanksWe</span><span class='token pointer' id='tok-118-959'>would</span><span class='token pointer' id='tok-118-960'>like</span><span class='token pointer' id='tok-118-961'>to</span><span class='token pointer' id='tok-118-962'>thank</span><span class='token pointer' id='tok-118-963'>Pavel</span><span class='token pointer' id='tok-118-964'>Odintsov</span><span class='token pointer' id='tok-118-965'>who</span><span class='token pointer' id='tok-118-966'>suggested</span><span class='token pointer' id='tok-118-967'>the</span><span class='token pointer' id='tok-118-968'>possibility</span><span class='token pointer' id='tok-118-969'>of</span><span class='token pointer' id='tok-118-970'>using</span><span class='token pointer' id='tok-118-971'>Netmap</span><span class='token pointer' id='tok-118-972'>this</span><span class='token pointer' id='tok-118-973'>way.</span><span class='token pointer' id='tok-118-974'>He</span><span class='token pointer' id='tok-118-975'>even</span><span class='token pointer' id='tok-118-976'>prepared</span><span class='token pointer' id='tok-118-977'>the</span><span class='token pointer' id='tok-118-978'>initial</span><span class='token pointer' id='tok-118-979'>hack</span><span class='token pointer' id='tok-118-980'>we</span><span class='token pointer' id='tok-118-981'>based</span><span class='token pointer' id='tok-118-982'>our</span><span class='token pointer' id='tok-118-983'>work</span><span class='token pointer' id='tok-118-984'>on.</span></p><p id=p1018><span class='token pointer' id='tok-118-985'>We</span><span class='token pointer' id='tok-118-986'>would</span><span class='token pointer' id='tok-118-987'>also</span><span class='token pointer' id='tok-118-988'>like</span><span class='token pointer' id='tok-118-989'>to</span><span class='token pointer' id='tok-118-990'>thank</span><span class='token pointer' id='tok-118-991'>Luigi</span><span class='token pointer' id='tok-118-992'>Rizzo,</span><span class='token pointer' id='tok-118-993'>for</span><span class='token pointer' id='tok-118-994'>his</span><span class='token pointer' id='tok-118-995'>Netmap</span><span class='token pointer' id='tok-118-996'>work</span><span class='token pointer' id='tok-118-997'>and</span><span class='token pointer' id='tok-118-998'>great</span><span class='token pointer' id='tok-118-999'>feedback</span><span class='token pointer' id='tok-118-1000'>on</span><span class='token pointer' id='tok-118-1001'>our</span><span class='token pointer' id='tok-118-1002' style='color:red'>patches.</span></p><p id=p1036><span class='token pointer' id='tok-118-1003'>Final</span><span class='token pointer' id='tok-118-1004'>wordsAt</span><span class='token pointer' id='tok-118-1005'>CloudFlare</span><span class='token pointer' id='tok-118-1006'>our</span><span class='token pointer' id='tok-118-1007'>application</span><span class='token pointer' id='tok-118-1008'>stack</span><span class='token pointer' id='tok-118-1009'>is</span><span class='token pointer' id='tok-118-1010'>based</span><span class='token pointer' id='tok-118-1011'>on</span><span class='token pointer' id='tok-118-1012'>open</span><span class='token pointer' id='tok-118-1013'>source</span><span class='token pointer' id='tok-118-1014'>software.</span><span class='token pointer' id='tok-118-1015'>We're</span><span class='token pointer' id='tok-118-1016'>grateful</span><span class='token pointer' id='tok-118-1017'>to</span><span class='token pointer' id='tok-118-1018'>so</span><span class='token pointer' id='tok-118-1019'>many</span><span class='token pointer' id='tok-118-1020'>open</span><span class='token pointer' id='tok-118-1021'>source</span><span class='token pointer' id='tok-118-1022'>programmers</span><span class='token pointer' id='tok-118-1023'>for</span><span class='token pointer' id='tok-118-1024'>their</span><span class='token pointer' id='tok-118-1025'>awesome</span><span class='token pointer' id='tok-118-1026'>work.</span><span class='token pointer' id='tok-118-1027'>Whenever</span><span class='token pointer' id='tok-118-1028'>we</span><span class='token pointer' id='tok-118-1029'>can</span><span class='token pointer' id='tok-118-1030'>we</span><span class='token pointer' id='tok-118-1031'>try</span><span class='token pointer' id='tok-118-1032'>to</span><span class='token pointer' id='tok-118-1033'>contribute</span><span class='token pointer' id='tok-118-1034'>back</span><span class='token pointer' id='tok-118-1035'>to</span><span class='token pointer' id='tok-118-1036'>the</span><span class='token pointer' id='tok-118-1037'>community</span><span class='token pointer' id='tok-118-1038'>-</span><span class='token pointer' id='tok-118-1039'>we</span><span class='token pointer' id='tok-118-1040'>hope</span><span class='token pointer' id='tok-118-1041'>"the</span><span class='token pointer' id='tok-118-1042'>single</span><span class='token pointer' id='tok-118-1043'>RX</span><span class='token pointer' id='tok-118-1044'>Netmap</span><span class='token pointer' id='tok-118-1045'>mode"</span><span class='token pointer' id='tok-118-1046'>will</span><span class='token pointer' id='tok-118-1047'>be</span><span class='token pointer' id='tok-118-1048'>useful</span><span class='token pointer' id='tok-118-1049'>to</span><span class='token pointer' id='tok-118-1050'>others.</span></p><p id=p1084><span class='token pointer' id='tok-118-1051'>You</span><span class='token pointer' id='tok-118-1052'>can</span><span class='token pointer' id='tok-118-1053'>find</span><span class='token pointer' id='tok-118-1054'>more</span><span class='token pointer' id='tok-118-1055'>CloudFlare</span><span class='token pointer' id='tok-118-1056'>open</span><span class='token pointer' id='tok-118-1057'>source</span><span class='token pointer' id='tok-118-1058'>here.
</span></p>