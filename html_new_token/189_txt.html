<p id=p0>Situation Summary This Unit 42 blog provides an update on the <span class='token pointer' id='tok-189-0' style='color:red'>threat</span>situation surrounding attacks using the <span class='token pointer' id='tok-189-1' style='color:red'>Ransomware</span><span class='token pointer' id='tok-189-2' style='color:red'>Petya</span>are impacting organizations in <span class='token pointer' id='tok-189-3' style='color:red'>Ukraine,</span>Russia and to a lesser extent around the world. </p><p id=p34>On June 27th, 2017 we became aware of a new variant of the <span class='token pointer' id='tok-189-4' style='color:red'>Petya</span><span class='token pointer' id='tok-189-5' style='color:red'>malware</span>which is spreading through multiple <span class='token pointer' id='tok-189-6' style='color:red'>lateral movement techniques.</span>technique includes <span class='token pointer' id='tok-189-7' style='color:red'> the ETERNALBLUE exploit</span>tool. This is the same exploit <span class='token pointer' id='tok-189-8' style='color:red'>the WanaCrypt0r/WannaCry</span>malware exploited to spread globally in May, 2017. At least 50 organizations have reported impacts from the malware, including government and critical infrastructure operators. Most <span class='token pointer' id='tok-189-9' style='color:red'>impacted</span>organizations are located in Ukraine, but global organizations with offices in Ukraine have seen the malware spread within their network across national borders. </p><p id=p117>Palo Alto <span class='token pointer' id='tok-189-10' style='color:red'>Networks</span>is documenting our prevention capabilities with regard to this threat in the Palo Alto Networks Protections for Petya Ransomware blog post. Windows users should take the following general steps to protect themselves: </p><p id=p152>Apply security updates in <span class='token pointer' id='tok-189-11' style='color:red'>MS17-010Block</span>inbound connections on <span class='token pointer' id='tok-189-12' style='color:red'>Port</span><span class='token pointer' id='tok-189-13' style='color:red'>445Create</span><span class='token pointer' id='tok-189-14' style='color:red'>TCP</span>maintain good back-ups so that if an infection occurs, you can restore your data.This is a developing situation, we will update this blog as new information becomes available. <span class='token pointer' id='tok-189-15' style='color:red'>AutoFocus</span>users view samples using the Petya tag. </p><p id=p200>Attack OverviewPetya is a <span class='token pointer' id='tok-189-16' style='color:red'>ransomware</span>family that works by <span class='token pointer' id='tok-189-17' style='color:red'>modifying</span>the Window's system's <span class='token pointer' id='tok-189-18' style='color:red'>Boot</span><span class='token pointer' id='tok-189-19' style='color:red'>Record</span><span class='token pointer' id='tok-189-20' style='color:red'>Master</span>causing the system to crash. When the user <span class='token pointer' id='tok-189-21' style='color:red'>reboots</span>their PC, the <span class='token pointer' id='tok-189-22' style='color:red'>modified</span>MBR prevents Windows from loading and displays a fake <span class='token pointer' id='tok-189-23' style='color:red'>"chkdisk"</span>screen which indicates the computer's hard drive is being repaired, but the malware is actually encrypting the user's files.  When this process completes, the malware displays an <span class='token pointer' id='tok-189-24' style='color:red'>ASCII</span>Ransom note demanding payment from the victim . </p><p id=p276>The latest version of the Petya ransomware is spreading over Windows SMB and is reportedly using the <span class='token pointer' id='tok-189-25' style='color:red'>ETERNALBLUE exploit</span>tool, which exploits <span class='token pointer' id='tok-189-26' style='color:red'>CVE-2017-0144</span>and was originally released by the Shadow Brokers group in April 2017. </p><p id=p310>After the system is compromised the victim is asked to send US $300 in <span class='token pointer' id='tok-189-27' style='color:red'>Bitcoin</span>to a specific Bitcoin address and then send an e-mail with the victim's bitcoin wallet ID to wowsmith123456@posteo[.]net to retrieve their individual <span class='token pointer' id='tok-189-28' style='color:red'>decryption</span>key.  Posteo (a free e-mail provider) has already shut down this e-mail address, and as such victims should not even attempt to pay the ransom. As of 13:00 UTC on June 28thth, <span class='token pointer' id='tok-189-29' style='color:red'>approximately</span>4 Bitcoin have been transferred to the attacker's wallet. </p><p id=p390>Unit 42 is unaware of ANY successful recovery after paying the ransom. Additionally, ongoing research by the industry is showing that specific actions this malware takes makes it technically infeasible, if not impossible, for recovery to occur. </p><p id=p427>This means that even though this malware is <span class='token pointer' id='tok-189-30' style='color:red'>functionally</span>ransomware, for threat <span class='token pointer' id='tok-189-31' style='color:red'>assessment</span>purposes, it should be functionally considered a <span class='token pointer' id='tok-189-32' style='color:red'>"wiper".</span></p><p id=p448>Attack LifecycleWe are aware of the following information about how the Petya attack lifecycle works. </p><p id=p463>Delivery/Exploitation </p><p id=p464>We have not yet confirmed the initial <span class='token pointer' id='tok-189-33' style='color:red'>vector</span><span class='token pointer' id='tok-189-34' style='color:red'>infection</span>this new Petya variant. Previous variants were spread through e-mail, but we have not identified this latest sample carried in any e-mail related attacks. </p><p id=p498>While we have not been able to directly confirm the source, we have seen evidence that a Ukrainian software application called MEDoc was used by attackers to deliver the Petya <span class='token pointer' id='tok-189-35' style='color:red'>DLL.</span>The software is heavily used in Ukraine it appears the company's systems may have been <span class='token pointer' id='tok-189-36' style='color:red'>compromised</span>and used to issue a malicious update to systems running the program on the morning of Jun 27th. This infection vector helps explain the high concentration of infections in Ukraine. </p><p id=p575>Installation </p><p id=p576>This variant of Petya is spread as a DLL file, which must be executed by <span class='token pointer' id='tok-189-37' style='color:red'>another</span>process before it takes action on the system. Once executed, it overwrites the <span class='token pointer' id='tok-189-38' style='color:red'>Master</span>Boot Record and creates a scheduled task to reboot the system. Once the system reboots, the malware displays a fake "chkdisk" scan which tricks the victim into believing the program is repairing their hard drive. In reality, the malware is encrypting the <span class='token pointer' id='tok-189-39' style='color:red'>NTFS</span>Master File Table in the background. Once the fake chkdisk completes, the malware displays a ransom note which demands a payment of $300 in bitcoin. </p><p id=p674></p><p id=p677>Petya contains no Command and Control <span class='token pointer' id='tok-189-40' style='color:red'>mechanisms</span>that we know of. After a host is infected, there is no communication from the malware back to the attacker. </p><p id=p704>Lateral Movement </p><p id=p706>Petya uses three mechanisms to spread to additional hosts. </p><p id=p715>Petya scans the <span class='token pointer' id='tok-189-41' style='color:red'>local /24</span>discover enumerate <span class='token pointer' id='tok-189-42' style='color:red'>ADMIN$</span>shares on <span class='token pointer' id='tok-189-43' style='color:red'>other</span>systems, then copies itself to those hosts and executes the malware using <span class='token pointer' id='tok-189-44' style='color:red'>PSEXEC.</span>This is only possible if the infected user has the rights to write files and execute them on system hosting the <span class='token pointer' id='tok-189-45' style='color:red'>share.Petya</span>uses the <span class='token pointer' id='tok-189-46' style='color:red'>Windows Management Instrumentation Command-line</span>tool to connect to hosts on the local subnet and attempts to execute itself <span class='token pointer' id='tok-189-47' style='color:red'>remotely</span>on those hosts. It can use <span class='token pointer' id='tok-189-48' style='color:red'>Mimikatz</span>to extract credentials from the infected system and use them to execute itself on the targeted <span class='token pointer' id='tok-189-49' style='color:red'>host.Petya</span>finally attempts to use the <span class='token pointer' id='tok-189-50' style='color:red'>ETERNALBLUE</span>exploit tool against hosts on the local subnet. This will only be successful if the targeted host does not have the MS17-010 <span class='token pointer' id='tok-189-51' style='color:red'>patches</span>deployed.ConclusionRansomware attacks are very common, but they are rarely coupled with an exploit that allows the malware to spread as a network worm. The <span class='token pointer' id='tok-189-52' style='color:red'>WannaCry</span>attacks in May, 2017 demonstrated that many Windows systems had not been patched for this <span class='token pointer' id='tok-189-53' style='color:red'>vulnerability.</span>The spread of Petya using this vulnerability indicates that many organizations may still be <span class='token pointer' id='tok-189-54' style='color:red'>vulnerable,</span>despite the attention WannaCry received.
 </p>