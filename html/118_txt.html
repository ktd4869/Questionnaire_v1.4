<p id=p0><span class='token pointer' id='tok-118-0'>In</span><span class='token pointer' id='tok-118-1'>a</span><span class='token pointer' id='tok-118-2'>previous</span><span class='token pointer' id='tok-118-3'>post</span><span class='token pointer' id='tok-118-4'>we</span><span class='token pointer' id='tok-118-5'>discussed</span><span class='token pointer' id='tok-118-6'>the</span><span class='token pointer' id='tok-118-7'>performance</span><span class='token pointer' id='tok-118-8'>limitations</span><span class='token pointer' id='tok-118-9'>of</span><span class='token pointer' id='tok-118-10'>the</span><span class='token pointer' id='tok-118-11'>Linux</span><span class='token pointer' id='tok-118-12'>kernel</span><span class='token pointer' id='tok-118-13'>network</span><span class='token pointer' id='tok-118-14'>stack.</span><span class='token pointer' id='tok-118-15'>We</span><span class='token pointer' id='tok-118-16'>detailed</span><span class='token pointer' id='tok-118-17'>the</span><span class='token pointer' id='tok-118-18'>available</span><span class='token pointer' id='tok-118-19'>kernel</span><span class='token pointer' id='tok-118-20'>bypass</span><span class='token pointer' id='tok-118-21'>techniques</span><span class='token pointer' id='tok-118-22'>allowing</span><span class='token pointer' id='tok-118-23'>user</span><span class='token pointer' id='tok-118-24'>space</span><span class='token pointer' id='tok-118-25'>programs</span><span class='token pointer' id='tok-118-26'>to</span><span class='token pointer' id='tok-118-27'>receive</span><span class='token pointer' id='tok-118-28'>packets</span><span class='token pointer' id='tok-118-29'>with</span><span class='token pointer' id='tok-118-30'>high</span><span class='token pointer' id='tok-118-31'>throughput.</span><span class='token pointer' id='tok-118-32'>Unfortunately,</span><span class='token pointer' id='tok-118-33'>none</span><span class='token pointer' id='tok-118-34'>of</span><span class='token pointer' id='tok-118-35'>the</span><span class='token pointer' id='tok-118-36'>discussed</span><span class='token pointer' id='tok-118-37'>open</span><span class='token pointer' id='tok-118-38'>source</span><span class='token pointer' id='tok-118-39'>solutions</span><span class='token pointer' id='tok-118-40'>supported</span><span class='token pointer' id='tok-118-41'>our</span><span class='token pointer' id='tok-118-42'>needs.</span><span class='token pointer' id='tok-118-43'>To</span><span class='token pointer' id='tok-118-44'>improve</span><span class='token pointer' id='tok-118-45'>the</span><span class='token pointer' id='tok-118-46'>situation</span><span class='token pointer' id='tok-118-47'>we</span><span class='token pointer' id='tok-118-48'>decided</span><span class='token pointer' id='tok-118-49'>to</span><span class='token pointer' id='tok-118-50'>contribute</span><span class='token pointer' id='tok-118-51'>to</span><span class='token pointer' id='tok-118-52'>the</span><span class='token pointer' id='tok-118-53'>Netmap</span><span class='token pointer' id='tok-118-54'>project.</span><span class='token pointer' id='tok-118-55'>In</span><span class='token pointer' id='tok-118-56'>this</span><span class='token pointer' id='tok-118-57'>blog</span><span class='token pointer' id='tok-118-58'>post</span><span class='token pointer' id='tok-118-59'>we'll</span><span class='token pointer' id='tok-118-60'>describe</span><span class='token pointer' id='tok-118-61'>our</span><span class='token pointer' id='tok-118-62'>proposed</span><span class='token pointer' id='tok-118-63'>changes.</span></p>
<p id=p64><span class='token pointer' id='tok-118-64'>CC</span><span class='token pointer' id='tok-118-65'>BY-SA</span><span class='token pointer' id='tok-118-66'>2.0</span><span class='token pointer' id='tok-118-67'>image</span><span class='token pointer' id='tok-118-68'>by</span><span class='token pointer' id='tok-118-69'>Binary</span><span class='token pointer' id='tok-118-70'>Koala</span></p>
<p id=p71><span class='token pointer' id='tok-118-71'>Our</span><span class='token pointer' id='tok-118-72'>needsAt</span><span class='token pointer' id='tok-118-73'>CloudFlare</span><span class='token pointer' id='tok-118-74'>we</span><span class='token pointer' id='tok-118-75'>are</span><span class='token pointer' id='tok-118-76'>constantly</span><span class='token pointer' id='tok-118-77'>dealing</span><span class='token pointer' id='tok-118-78'>with</span><span class='token pointer' id='tok-118-79'>large</span><span class='token pointer' id='tok-118-80'>packet</span><span class='token pointer' id='tok-118-81'>floods.</span><span class='token pointer' id='tok-118-82'>Our</span><span class='token pointer' id='tok-118-83'>network</span><span class='token pointer' id='tok-118-84'>constantly</span><span class='token pointer' id='tok-118-85'>receives</span><span class='token pointer' id='tok-118-86'>a</span><span class='token pointer' id='tok-118-87'>large</span><span class='token pointer' id='tok-118-88'>volume</span><span class='token pointer' id='tok-118-89'>of</span><span class='token pointer' id='tok-118-90'>packets,</span><span class='token pointer' id='tok-118-91'>often</span><span class='token pointer' id='tok-118-92'>coming</span><span class='token pointer' id='tok-118-93'>from</span><span class='token pointer' id='tok-118-94'>many,</span><span class='token pointer' id='tok-118-95'>simultaneous</span><span class='token pointer' id='tok-118-96'>attacks.</span><span class='token pointer' id='tok-118-97'>In</span><span class='token pointer' id='tok-118-98'>fact,</span><span class='token pointer' id='tok-118-99'>it</span><span class='token pointer' id='tok-118-100'>is</span><span class='token pointer' id='tok-118-101'>entirely</span><span class='token pointer' id='tok-118-102'>possible</span><span class='token pointer' id='tok-118-103'>that</span><span class='token pointer' id='tok-118-104'>the</span><span class='token pointer' id='tok-118-105'>server</span><span class='token pointer' id='tok-118-106'>which</span><span class='token pointer' id='tok-118-107'>just</span><span class='token pointer' id='tok-118-108'>served</span><span class='token pointer' id='tok-118-109'>you</span><span class='token pointer' id='tok-118-110'>this</span><span class='token pointer' id='tok-118-111'>blog</span><span class='token pointer' id='tok-118-112'>post</span><span class='token pointer' id='tok-118-113'>is</span><span class='token pointer' id='tok-118-114'>dealing</span><span class='token pointer' id='tok-118-115'>with</span><span class='token pointer' id='tok-118-116'>a</span><span class='token pointer' id='tok-118-117'>many-million</span><span class='token pointer' id='tok-118-118'>packets</span><span class='token pointer' id='tok-118-119'>per</span><span class='token pointer' id='tok-118-120'>second</span><span class='token pointer' id='tok-118-121'>flood</span><span class='token pointer' id='tok-118-122'>right</span><span class='token pointer' id='tok-118-123'>now.</span></p>
<p id=p124><span class='token pointer' id='tok-118-124'>Since</span><span class='token pointer' id='tok-118-125'>the</span><span class='token pointer' id='tok-118-126'>Linux</span><span class='token pointer' id='tok-118-127'>Kernel</span><span class='token pointer' id='tok-118-128'>can't</span><span class='token pointer' id='tok-118-129'>really</span><span class='token pointer' id='tok-118-130'>handle</span><span class='token pointer' id='tok-118-131'>a</span><span class='token pointer' id='tok-118-132'>large</span><span class='token pointer' id='tok-118-133'>volume</span><span class='token pointer' id='tok-118-134'>of</span><span class='token pointer' id='tok-118-135'>packets,</span><span class='token pointer' id='tok-118-136'>we</span><span class='token pointer' id='tok-118-137'>need</span><span class='token pointer' id='tok-118-138'>to</span><span class='token pointer' id='tok-118-139'>work</span><span class='token pointer' id='tok-118-140'>around</span><span class='token pointer' id='tok-118-141'>it.</span><span class='token pointer' id='tok-118-142'>During</span><span class='token pointer' id='tok-118-143'>packet</span><span class='token pointer' id='tok-118-144'>floods</span><span class='token pointer' id='tok-118-145'>we</span><span class='token pointer' id='tok-118-146'>offload</span><span class='token pointer' id='tok-118-147'>selected</span><span class='token pointer' id='tok-118-148'>network</span><span class='token pointer' id='tok-118-149'>flows</span><span class='token pointer' id='tok-118-150'>(belonging</span><span class='token pointer' id='tok-118-151'>to</span><span class='token pointer' id='tok-118-152'>a</span><span class='token pointer' id='tok-118-153'>flood)</span><span class='token pointer' id='tok-118-154'>to</span><span class='token pointer' id='tok-118-155'>a</span><span class='token pointer' id='tok-118-156'>user</span><span class='token pointer' id='tok-118-157'>space</span><span class='token pointer' id='tok-118-158'>application.</span><span class='token pointer' id='tok-118-159'>This</span><span class='token pointer' id='tok-118-160'>application</span><span class='token pointer' id='tok-118-161'>filters</span><span class='token pointer' id='tok-118-162'>the</span><span class='token pointer' id='tok-118-163'>packets</span><span class='token pointer' id='tok-118-164'>at</span><span class='token pointer' id='tok-118-165'>very</span><span class='token pointer' id='tok-118-166'>high</span><span class='token pointer' id='tok-118-167'>speed.</span><span class='token pointer' id='tok-118-168'>Most</span><span class='token pointer' id='tok-118-169'>of</span><span class='token pointer' id='tok-118-170'>the</span><span class='token pointer' id='tok-118-171'>packets</span><span class='token pointer' id='tok-118-172'>are</span><span class='token pointer' id='tok-118-173'>dropped,</span><span class='token pointer' id='tok-118-174'>as</span><span class='token pointer' id='tok-118-175'>they</span><span class='token pointer' id='tok-118-176'></span><span class='token pointer' id='tok-118-177'>belong</span><span class='token pointer' id='tok-118-178'>to</span><span class='token pointer' id='tok-118-179'>a</span><span class='token pointer' id='tok-118-180'>flood.</span><span class='token pointer' id='tok-118-181'>The</span><span class='token pointer' id='tok-118-182'>small</span><span class='token pointer' id='tok-118-183'>number</span><span class='token pointer' id='tok-118-184'>of</span><span class='token pointer' id='tok-118-185'>"valid"</span><span class='token pointer' id='tok-118-186'>packets</span><span class='token pointer' id='tok-118-187'>are</span><span class='token pointer' id='tok-118-188'>injected</span><span class='token pointer' id='tok-118-189'>back</span><span class='token pointer' id='tok-118-190'>to</span><span class='token pointer' id='tok-118-191'>the</span><span class='token pointer' id='tok-118-192'>kernel</span><span class='token pointer' id='tok-118-193'>and</span><span class='token pointer' id='tok-118-194'>handled</span><span class='token pointer' id='tok-118-195'>in</span><span class='token pointer' id='tok-118-196'>the</span><span class='token pointer' id='tok-118-197'>same</span><span class='token pointer' id='tok-118-198'>way</span><span class='token pointer' id='tok-118-199'>as</span><span class='token pointer' id='tok-118-200'>usual</span><span class='token pointer' id='tok-118-201'>traffic.</span></p>
<p id=p202><span class='token pointer' id='tok-118-202'>It's</span><span class='token pointer' id='tok-118-203'>important</span><span class='token pointer' id='tok-118-204'>to</span><span class='token pointer' id='tok-118-205'>emphasize</span><span class='token pointer' id='tok-118-206'>that</span><span class='token pointer' id='tok-118-207'>the</span><span class='token pointer' id='tok-118-208'>kernel</span><span class='token pointer' id='tok-118-209'>bypass</span><span class='token pointer' id='tok-118-210'>is</span><span class='token pointer' id='tok-118-211'>enabled</span><span class='token pointer' id='tok-118-212'>only</span><span class='token pointer' id='tok-118-213'>for</span><span class='token pointer' id='tok-118-214'>selected</span><span class='token pointer' id='tok-118-215'>flows,</span><span class='token pointer' id='tok-118-216'>which</span><span class='token pointer' id='tok-118-217'>means</span><span class='token pointer' id='tok-118-218'>that</span><span class='token pointer' id='tok-118-219'>all</span><span class='token pointer' id='tok-118-220'>other</span><span class='token pointer' id='tok-118-221'>packets</span><span class='token pointer' id='tok-118-222'>go</span><span class='token pointer' id='tok-118-223'>to</span><span class='token pointer' id='tok-118-224'>the</span><span class='token pointer' id='tok-118-225'>kernel</span><span class='token pointer' id='tok-118-226'>as</span><span class='token pointer' id='tok-118-227'>usual.</span></p>
<p id=p228><span class='token pointer' id='tok-118-228'>This</span><span class='token pointer' id='tok-118-229'>setup</span><span class='token pointer' id='tok-118-230'>works</span><span class='token pointer' id='tok-118-231'>perfectly</span><span class='token pointer' id='tok-118-232'>on</span><span class='token pointer' id='tok-118-233'>our</span><span class='token pointer' id='tok-118-234'>servers</span><span class='token pointer' id='tok-118-235'>with</span><span class='token pointer' id='tok-118-236'>Solarflare</span><span class='token pointer' id='tok-118-237'>network</span><span class='token pointer' id='tok-118-238'>cards</span><span class='token pointer' id='tok-118-239'>-</span><span class='token pointer' id='tok-118-240'>we</span><span class='token pointer' id='tok-118-241'>can</span><span class='token pointer' id='tok-118-242'>use</span><span class='token pointer' id='tok-118-243'>the</span><span class='token pointer' id='tok-118-244'>ef_vi</span><span class='token pointer' id='tok-118-245'>API</span><span class='token pointer' id='tok-118-246'>to</span><span class='token pointer' id='tok-118-247'>achieve</span><span class='token pointer' id='tok-118-248'>the</span><span class='token pointer' id='tok-118-249'>kernel</span><span class='token pointer' id='tok-118-250'>bypass.</span><span class='token pointer' id='tok-118-251'>Unfortunately,</span><span class='token pointer' id='tok-118-252'>we</span><span class='token pointer' id='tok-118-253'>don't</span><span class='token pointer' id='tok-118-254'>have</span><span class='token pointer' id='tok-118-255'>this</span><span class='token pointer' id='tok-118-256'>functionality</span><span class='token pointer' id='tok-118-257'>on</span><span class='token pointer' id='tok-118-258'>our</span><span class='token pointer' id='tok-118-259'>servers</span><span class='token pointer' id='tok-118-260'>with</span><span class='token pointer' id='tok-118-261'>Intel</span><span class='token pointer' id='tok-118-262'>IXGBE</span><span class='token pointer' id='tok-118-263'>NIC's.</span></p>
<p id=p264><span class='token pointer' id='tok-118-264'>This</span><span class='token pointer' id='tok-118-265'>is</span><span class='token pointer' id='tok-118-266'>when</span><span class='token pointer' id='tok-118-267'>Netmap</span><span class='token pointer' id='tok-118-268'>comes</span><span class='token pointer' id='tok-118-269'>in.</span></p>
<p id=p270><span class='token pointer' id='tok-118-270'>NetmapOver</span><span class='token pointer' id='tok-118-271'>the</span><span class='token pointer' id='tok-118-272'>last</span><span class='token pointer' id='tok-118-273'>few</span><span class='token pointer' id='tok-118-274'>months</span><span class='token pointer' id='tok-118-275'>we've</span><span class='token pointer' id='tok-118-276'>been</span><span class='token pointer' id='tok-118-277'>thinking</span><span class='token pointer' id='tok-118-278'>hard</span><span class='token pointer' id='tok-118-279'>about</span><span class='token pointer' id='tok-118-280'>how</span><span class='token pointer' id='tok-118-281'>to</span><span class='token pointer' id='tok-118-282'>achieve</span><span class='token pointer' id='tok-118-283'>bypass</span><span class='token pointer' id='tok-118-284'>for</span><span class='token pointer' id='tok-118-285'>selected</span><span class='token pointer' id='tok-118-286'>flows</span><span class='token pointer' id='tok-118-287'>(aka:</span><span class='token pointer' id='tok-118-288'>bifurcated</span><span class='token pointer' id='tok-118-289'>driver)</span><span class='token pointer' id='tok-118-290'>on</span><span class='token pointer' id='tok-118-291'>non-Solarflare</span><span class='token pointer' id='tok-118-292'>network</span><span class='token pointer' id='tok-118-293'>cards.</span></p>
<p id=p294><span class='token pointer' id='tok-118-294'>We've</span><span class='token pointer' id='tok-118-295'>considered</span><span class='token pointer' id='tok-118-296'>PF_RING,</span><span class='token pointer' id='tok-118-297'>DPDK</span><span class='token pointer' id='tok-118-298'>and</span><span class='token pointer' id='tok-118-299'>other</span><span class='token pointer' id='tok-118-300'>custom</span><span class='token pointer' id='tok-118-301'>solutions,</span><span class='token pointer' id='tok-118-302'>but</span><span class='token pointer' id='tok-118-303'>sadly</span><span class='token pointer' id='tok-118-304'>all</span><span class='token pointer' id='tok-118-305'>of</span><span class='token pointer' id='tok-118-306'>them</span><span class='token pointer' id='tok-118-307'>take</span><span class='token pointer' id='tok-118-308'>over</span><span class='token pointer' id='tok-118-309'>the</span><span class='token pointer' id='tok-118-310'>whole</span><span class='token pointer' id='tok-118-311'>network</span><span class='token pointer' id='tok-118-312'>card.</span><span class='token pointer' id='tok-118-313'>Eventually</span><span class='token pointer' id='tok-118-314'>we</span><span class='token pointer' id='tok-118-315'>decided</span><span class='token pointer' id='tok-118-316'>that</span><span class='token pointer' id='tok-118-317'>the</span><span class='token pointer' id='tok-118-318'>best</span><span class='token pointer' id='tok-118-319'>way</span><span class='token pointer' id='tok-118-320'>would</span><span class='token pointer' id='tok-118-321'>be</span><span class='token pointer' id='tok-118-322'>to</span><span class='token pointer' id='tok-118-323'>patch</span><span class='token pointer' id='tok-118-324'>Netmap</span><span class='token pointer' id='tok-118-325'>with</span><span class='token pointer' id='tok-118-326'>the</span><span class='token pointer' id='tok-118-327'>functionality</span><span class='token pointer' id='tok-118-328'>we</span><span class='token pointer' id='tok-118-329'>need.</span></p>
<p id=p330><span class='token pointer' id='tok-118-330'>We</span><span class='token pointer' id='tok-118-331'>chose</span><span class='token pointer' id='tok-118-332'>Netmap</span><span class='token pointer' id='tok-118-333'>because:</span></p>
<p id=p334><span class='token pointer' id='tok-118-334'>It's</span><span class='token pointer' id='tok-118-335'>fully</span><span class='token pointer' id='tok-118-336'>open</span><span class='token pointer' id='tok-118-337'>source</span><span class='token pointer' id='tok-118-338'>and</span><span class='token pointer' id='tok-118-339'>released</span><span class='token pointer' id='tok-118-340'>under</span><span class='token pointer' id='tok-118-341'>a</span><span class='token pointer' id='tok-118-342'>BSD</span><span class='token pointer' id='tok-118-343'>license.It</span><span class='token pointer' id='tok-118-344'>has</span><span class='token pointer' id='tok-118-345'>a</span><span class='token pointer' id='tok-118-346'>great</span><span class='token pointer' id='tok-118-347'>NIC-agnostic</span><span class='token pointer' id='tok-118-348'>API.It's</span><span class='token pointer' id='tok-118-349'>very</span><span class='token pointer' id='tok-118-350'>fast:</span><span class='token pointer' id='tok-118-351'>can</span><span class='token pointer' id='tok-118-352'>reach</span><span class='token pointer' id='tok-118-353'>line</span><span class='token pointer' id='tok-118-354'>rate</span><span class='token pointer' id='tok-118-355'>easily.The</span><span class='token pointer' id='tok-118-356'>project</span><span class='token pointer' id='tok-118-357'>is</span><span class='token pointer' id='tok-118-358'>well</span><span class='token pointer' id='tok-118-359'>maintained</span><span class='token pointer' id='tok-118-360'>and</span><span class='token pointer' id='tok-118-361'>reasonably</span><span class='token pointer' id='tok-118-362'>mature.The</span><span class='token pointer' id='tok-118-363'>code</span><span class='token pointer' id='tok-118-364'>is</span><span class='token pointer' id='tok-118-365'>very</span><span class='token pointer' id='tok-118-366'>high</span><span class='token pointer' id='tok-118-367'>quality.The</span><span class='token pointer' id='tok-118-368'>driver-specific</span><span class='token pointer' id='tok-118-369'>modifications</span><span class='token pointer' id='tok-118-370'>are</span><span class='token pointer' id='tok-118-371'>trivial:</span><span class='token pointer' id='tok-118-372'>most</span><span class='token pointer' id='tok-118-373'>of</span><span class='token pointer' id='tok-118-374'>the</span><span class='token pointer' id='tok-118-375'>magic</span><span class='token pointer' id='tok-118-376'>happens</span><span class='token pointer' id='tok-118-377'>in</span><span class='token pointer' id='tok-118-378'>the</span><span class='token pointer' id='tok-118-379'>shared</span><span class='token pointer' id='tok-118-380'>Netmap</span><span class='token pointer' id='tok-118-381'>module.</span><span class='token pointer' id='tok-118-382'>It's</span><span class='token pointer' id='tok-118-383'>easy</span><span class='token pointer' id='tok-118-384'>to</span><span class='token pointer' id='tok-118-385'>add</span><span class='token pointer' id='tok-118-386'>support</span><span class='token pointer' id='tok-118-387'>for</span><span class='token pointer' id='tok-118-388'>new</span><span class='token pointer' id='tok-118-389'>hardware.Introducing</span><span class='token pointer' id='tok-118-390'>the</span><span class='token pointer' id='tok-118-391'>single</span><span class='token pointer' id='tok-118-392'>RX</span><span class='token pointer' id='tok-118-393'>queue</span><span class='token pointer' id='tok-118-394'>modeUsually,</span><span class='token pointer' id='tok-118-395'>when</span><span class='token pointer' id='tok-118-396'>a</span><span class='token pointer' id='tok-118-397'>network</span><span class='token pointer' id='tok-118-398'>card</span><span class='token pointer' id='tok-118-399'>goes</span><span class='token pointer' id='tok-118-400'>into</span><span class='token pointer' id='tok-118-401'>the</span><span class='token pointer' id='tok-118-402'>Netmap</span><span class='token pointer' id='tok-118-403'>mode,</span><span class='token pointer' id='tok-118-404'>all</span><span class='token pointer' id='tok-118-405'>the</span><span class='token pointer' id='tok-118-406'>RX</span><span class='token pointer' id='tok-118-407'>queues</span><span class='token pointer' id='tok-118-408'>get</span><span class='token pointer' id='tok-118-409'>disconnected</span><span class='token pointer' id='tok-118-410'>from</span><span class='token pointer' id='tok-118-411'>the</span><span class='token pointer' id='tok-118-412'>kernel</span><span class='token pointer' id='tok-118-413'>and</span><span class='token pointer' id='tok-118-414'>are</span><span class='token pointer' id='tok-118-415'>available</span><span class='token pointer' id='tok-118-416'>to</span><span class='token pointer' id='tok-118-417'>the</span><span class='token pointer' id='tok-118-418'>Netmap</span><span class='token pointer' id='tok-118-419'>applications.</span></p>
<p id=p420><span class='token pointer' id='tok-118-420'>We</span><span class='token pointer' id='tok-118-421'>don't</span><span class='token pointer' id='tok-118-422'>want</span><span class='token pointer' id='tok-118-423'>that.</span><span class='token pointer' id='tok-118-424'>We</span><span class='token pointer' id='tok-118-425'>want</span><span class='token pointer' id='tok-118-426'>to</span><span class='token pointer' id='tok-118-427'>keep</span><span class='token pointer' id='tok-118-428'>most</span><span class='token pointer' id='tok-118-429'>of</span><span class='token pointer' id='tok-118-430'>the</span><span class='token pointer' id='tok-118-431'>RX</span><span class='token pointer' id='tok-118-432'>queues</span><span class='token pointer' id='tok-118-433'>back</span><span class='token pointer' id='tok-118-434'>in</span><span class='token pointer' id='tok-118-435'>the</span><span class='token pointer' id='tok-118-436'>kernel</span><span class='token pointer' id='tok-118-437'>mode,</span><span class='token pointer' id='tok-118-438'>and</span><span class='token pointer' id='tok-118-439'>enable</span><span class='token pointer' id='tok-118-440'>Netmap</span><span class='token pointer' id='tok-118-441'>mode</span><span class='token pointer' id='tok-118-442'>only</span><span class='token pointer' id='tok-118-443'>on</span><span class='token pointer' id='tok-118-444'>selected</span><span class='token pointer' id='tok-118-445'>RX</span><span class='token pointer' id='tok-118-446'>queues.</span><span class='token pointer' id='tok-118-447'>We</span><span class='token pointer' id='tok-118-448'>call</span><span class='token pointer' id='tok-118-449'>this</span><span class='token pointer' id='tok-118-450'>functionality:</span><span class='token pointer' id='tok-118-451'>"single</span><span class='token pointer' id='tok-118-452'>RX</span><span class='token pointer' id='tok-118-453'>queue</span><span class='token pointer' id='tok-118-454'>mode".</span></p>
<p id=p455><span class='token pointer' id='tok-118-455'>The</span><span class='token pointer' id='tok-118-456'>intention</span><span class='token pointer' id='tok-118-457'>was</span><span class='token pointer' id='tok-118-458'>to</span><span class='token pointer' id='tok-118-459'>expose</span><span class='token pointer' id='tok-118-460'>a</span><span class='token pointer' id='tok-118-461'>minimal</span><span class='token pointer' id='tok-118-462'>API</span><span class='token pointer' id='tok-118-463'>which</span><span class='token pointer' id='tok-118-464'>could:</span></p>
<p id=p465><span class='token pointer' id='tok-118-465'>Open</span><span class='token pointer' id='tok-118-466'>a</span><span class='token pointer' id='tok-118-467'>network</span><span class='token pointer' id='tok-118-468'>interface</span><span class='token pointer' id='tok-118-469'>in</span><span class='token pointer' id='tok-118-470'>"a</span><span class='token pointer' id='tok-118-471'>single</span><span class='token pointer' id='tok-118-472'>RX</span><span class='token pointer' id='tok-118-473'>queue</span><span class='token pointer' id='tok-118-474'>mode".This</span><span class='token pointer' id='tok-118-475'>would</span><span class='token pointer' id='tok-118-476'>allow</span><span class='token pointer' id='tok-118-477'>netmap</span><span class='token pointer' id='tok-118-478'>applications</span><span class='token pointer' id='tok-118-479'>to</span><span class='token pointer' id='tok-118-480'>receive</span><span class='token pointer' id='tok-118-481'>packets</span><span class='token pointer' id='tok-118-482'>from</span><span class='token pointer' id='tok-118-483'>that</span><span class='token pointer' id='tok-118-484'>specific</span><span class='token pointer' id='tok-118-485'>RX</span><span class='token pointer' id='tok-118-486'>queue.While</span><span class='token pointer' id='tok-118-487'>leaving</span><span class='token pointer' id='tok-118-488'>all</span><span class='token pointer' id='tok-118-489'>the</span><span class='token pointer' id='tok-118-490'>other</span><span class='token pointer' id='tok-118-491'>queues</span><span class='token pointer' id='tok-118-492'>attached</span><span class='token pointer' id='tok-118-493'>to</span><span class='token pointer' id='tok-118-494'>the</span><span class='token pointer' id='tok-118-495'>host</span><span class='token pointer' id='tok-118-496'>network</span><span class='token pointer' id='tok-118-497'>stack.On</span><span class='token pointer' id='tok-118-498'>demand</span><span class='token pointer' id='tok-118-499'>add</span><span class='token pointer' id='tok-118-500'>or</span><span class='token pointer' id='tok-118-501'>remove</span><span class='token pointer' id='tok-118-502'>RX</span><span class='token pointer' id='tok-118-503'>queues</span><span class='token pointer' id='tok-118-504'>from</span><span class='token pointer' id='tok-118-505'>the</span><span class='token pointer' id='tok-118-506'>"single</span><span class='token pointer' id='tok-118-507'>RX</span><span class='token pointer' id='tok-118-508'>queue</span><span class='token pointer' id='tok-118-509'>mode".Eventually</span><span class='token pointer' id='tok-118-510'>remove</span><span class='token pointer' id='tok-118-511'>the</span><span class='token pointer' id='tok-118-512'>interface</span><span class='token pointer' id='tok-118-513'>from</span><span class='token pointer' id='tok-118-514'>the</span><span class='token pointer' id='tok-118-515'>Netmap</span><span class='token pointer' id='tok-118-516'>mode</span><span class='token pointer' id='tok-118-517'>and</span><span class='token pointer' id='tok-118-518'>reattach</span><span class='token pointer' id='tok-118-519'>the</span><span class='token pointer' id='tok-118-520'>RX</span><span class='token pointer' id='tok-118-521'>queues</span><span class='token pointer' id='tok-118-522'>to</span><span class='token pointer' id='tok-118-523'>the</span><span class='token pointer' id='tok-118-524'>host</span><span class='token pointer' id='tok-118-525'>stack.</span></p>
<p id=p526><span class='token pointer' id='tok-118-526'>d</span><span class='token pointer' id='tok-118-527'>=</span><span class='token pointer' id='tok-118-528'>nm_open("netmap:eth3~4",</span><span class='token pointer' id='tok-118-529'>NULL,</span><span class='token pointer' id='tok-118-530'>0,</span><span class='token pointer' id='tok-118-531'>0);while</span><span class='token pointer' id='tok-118-532'>(1)</span><span class='token pointer' id='tok-118-533'>{</span><span class='token pointer' id='tok-118-534'></span><span class='token pointer' id='tok-118-535'></span><span class='token pointer' id='tok-118-536'></span><span class='token pointer' id='tok-118-537'>fds</span><span class='token pointer' id='tok-118-538'>=</span><span class='token pointer' id='tok-118-539'>{fds:</span><span class='token pointer' id='tok-118-540'>d-&gt;fd,</span><span class='token pointer' id='tok-118-541'>events:</span><span class='token pointer' id='tok-118-542'>POLLIN};</span><span class='token pointer' id='tok-118-543'></span><span class='token pointer' id='tok-118-544'></span><span class='token pointer' id='tok-118-545'></span><span class='token pointer' id='tok-118-546'>poll(&amp;fds,</span><span class='token pointer' id='tok-118-547'>1,</span><span class='token pointer' id='tok-118-548'>-1);</span><span class='token pointer' id='tok-118-549'></span><span class='token pointer' id='tok-118-550'></span><span class='token pointer' id='tok-118-551'></span><span class='token pointer' id='tok-118-552'>ring</span><span class='token pointer' id='tok-118-553'>=</span><span class='token pointer' id='tok-118-554'>NETMAP_RXRING(d-&gt;nifp,</span><span class='token pointer' id='tok-118-555'>4);</span><span class='token pointer' id='tok-118-556'></span><span class='token pointer' id='tok-118-557'></span><span class='token pointer' id='tok-118-558'></span><span class='token pointer' id='tok-118-559'>while</span><span class='token pointer' id='tok-118-560'>(!nm_ring_empty(ring))</span><span class='token pointer' id='tok-118-561'>{</span><span class='token pointer' id='tok-118-562'></span><span class='token pointer' id='tok-118-563'></span><span class='token pointer' id='tok-118-564'></span><span class='token pointer' id='tok-118-565'></span><span class='token pointer' id='tok-118-566'></span><span class='token pointer' id='tok-118-567'></span><span class='token pointer' id='tok-118-568'></span><span class='token pointer' id='tok-118-569'>i</span><span class='token pointer' id='tok-118-570'></span><span class='token pointer' id='tok-118-571'></span><span class='token pointer' id='tok-118-572'>=</span><span class='token pointer' id='tok-118-573'>ring-&gt;cur;</span><span class='token pointer' id='tok-118-574'></span><span class='token pointer' id='tok-118-575'></span><span class='token pointer' id='tok-118-576'></span><span class='token pointer' id='tok-118-577'></span><span class='token pointer' id='tok-118-578'></span><span class='token pointer' id='tok-118-579'></span><span class='token pointer' id='tok-118-580'></span><span class='token pointer' id='tok-118-581'>buf</span><span class='token pointer' id='tok-118-582'>=</span><span class='token pointer' id='tok-118-583'>NETMAP_BUF(ring,</span><span class='token pointer' id='tok-118-584'>ring-&gt;slot[i].buf_idx);</span><span class='token pointer' id='tok-118-585'></span><span class='token pointer' id='tok-118-586'></span><span class='token pointer' id='tok-118-587'></span><span class='token pointer' id='tok-118-588'></span><span class='token pointer' id='tok-118-589'></span><span class='token pointer' id='tok-118-590'></span><span class='token pointer' id='tok-118-591'></span><span class='token pointer' id='tok-118-592'>len</span><span class='token pointer' id='tok-118-593'>=</span><span class='token pointer' id='tok-118-594'>ring-&gt;slot[i].len;</span><span class='token pointer' id='tok-118-595'></span><span class='token pointer' id='tok-118-596'></span><span class='token pointer' id='tok-118-597'></span><span class='token pointer' id='tok-118-598'></span><span class='token pointer' id='tok-118-599'></span><span class='token pointer' id='tok-118-600'></span><span class='token pointer' id='tok-118-601'></span><span class='token pointer' id='tok-118-602'>//process(buf,</span><span class='token pointer' id='tok-118-603'>len)</span><span class='token pointer' id='tok-118-604'></span><span class='token pointer' id='tok-118-605'></span><span class='token pointer' id='tok-118-606'></span><span class='token pointer' id='tok-118-607'></span><span class='token pointer' id='tok-118-608'></span><span class='token pointer' id='tok-118-609'></span><span class='token pointer' id='tok-118-610'></span><span class='token pointer' id='tok-118-611'>ring-&gt;head</span><span class='token pointer' id='tok-118-612'>=</span><span class='token pointer' id='tok-118-613'>ring-&gt;cur</span><span class='token pointer' id='tok-118-614'>=</span><span class='token pointer' id='tok-118-615'>nm_ring_next(ring,</span><span class='token pointer' id='tok-118-616'>i);</span><span class='token pointer' id='tok-118-617'></span><span class='token pointer' id='tok-118-618'></span><span class='token pointer' id='tok-118-619'></span><span class='token pointer' id='tok-118-620'>}}This</span><span class='token pointer' id='tok-118-621'>code</span><span class='token pointer' id='tok-118-622'>is</span><span class='token pointer' id='tok-118-623'>very</span><span class='token pointer' id='tok-118-624'>close</span><span class='token pointer' id='tok-118-625'>to</span><span class='token pointer' id='tok-118-626'>a</span><span class='token pointer' id='tok-118-627'>Netmap</span><span class='token pointer' id='tok-118-628'>example</span><span class='token pointer' id='tok-118-629'>program.</span><span class='token pointer' id='tok-118-630'>Indeed</span><span class='token pointer' id='tok-118-631'>the</span><span class='token pointer' id='tok-118-632'>only</span><span class='token pointer' id='tok-118-633'>difference</span><span class='token pointer' id='tok-118-634'>is</span><span class='token pointer' id='tok-118-635'>the</span><span class='token pointer' id='tok-118-636'>nm_open()</span><span class='token pointer' id='tok-118-637'>call,</span><span class='token pointer' id='tok-118-638'>which</span><span class='token pointer' id='tok-118-639'>uses</span><span class='token pointer' id='tok-118-640'>the</span><span class='token pointer' id='tok-118-641'>new</span><span class='token pointer' id='tok-118-642'>syntax</span><span class='token pointer' id='tok-118-643'>netmap:ifname~queue_number.</span></p>
<p id=p644><span class='token pointer' id='tok-118-644'>Once</span><span class='token pointer' id='tok-118-645'>again,</span><span class='token pointer' id='tok-118-646'>when</span><span class='token pointer' id='tok-118-647'>running</span><span class='token pointer' id='tok-118-648'>this</span><span class='token pointer' id='tok-118-649'>code</span><span class='token pointer' id='tok-118-650'>only</span><span class='token pointer' id='tok-118-651'>packets</span><span class='token pointer' id='tok-118-652'>arriving</span><span class='token pointer' id='tok-118-653'>on</span><span class='token pointer' id='tok-118-654'>the</span><span class='token pointer' id='tok-118-655'>RX</span><span class='token pointer' id='tok-118-656'>queue</span><span class='token pointer' id='tok-118-657'>#4</span><span class='token pointer' id='tok-118-658'>will</span><span class='token pointer' id='tok-118-659'>go</span><span class='token pointer' id='tok-118-660'>to</span><span class='token pointer' id='tok-118-661'>the</span><span class='token pointer' id='tok-118-662'>netmap</span><span class='token pointer' id='tok-118-663'>program.</span><span class='token pointer' id='tok-118-664'>All</span><span class='token pointer' id='tok-118-665'>other</span><span class='token pointer' id='tok-118-666'>RX</span><span class='token pointer' id='tok-118-667'>and</span><span class='token pointer' id='tok-118-668'>TX</span><span class='token pointer' id='tok-118-669'>queues</span><span class='token pointer' id='tok-118-670'>will</span><span class='token pointer' id='tok-118-671'>be</span><span class='token pointer' id='tok-118-672'>handled</span><span class='token pointer' id='tok-118-673'>by</span><span class='token pointer' id='tok-118-674'>the</span><span class='token pointer' id='tok-118-675'>Linux</span><span class='token pointer' id='tok-118-676'>kernel</span><span class='token pointer' id='tok-118-677'>network</span><span class='token pointer' id='tok-118-678'>stack.</span></p>
<p id=p679><span class='token pointer' id='tok-118-679'>Isolating</span><span class='token pointer' id='tok-118-680'>a</span><span class='token pointer' id='tok-118-681'>queueIn</span><span class='token pointer' id='tok-118-682'>multiqueue</span><span class='token pointer' id='tok-118-683'>network</span><span class='token pointer' id='tok-118-684'>cards,</span><span class='token pointer' id='tok-118-685'>any</span><span class='token pointer' id='tok-118-686'>packet</span><span class='token pointer' id='tok-118-687'>can</span><span class='token pointer' id='tok-118-688'>end</span><span class='token pointer' id='tok-118-689'>up</span><span class='token pointer' id='tok-118-690'>in</span><span class='token pointer' id='tok-118-691'>almost</span><span class='token pointer' id='tok-118-692'>any</span><span class='token pointer' id='tok-118-693'>RX</span><span class='token pointer' id='tok-118-694'>queue</span><span class='token pointer' id='tok-118-695'>due</span><span class='token pointer' id='tok-118-696'>to</span><span class='token pointer' id='tok-118-697'>RSS.</span><span class='token pointer' id='tok-118-698'>This</span><span class='token pointer' id='tok-118-699'>is</span><span class='token pointer' id='tok-118-700'>why</span><span class='token pointer' id='tok-118-701'>before</span><span class='token pointer' id='tok-118-702'>enabling</span><span class='token pointer' id='tok-118-703'>the</span><span class='token pointer' id='tok-118-704'>single</span><span class='token pointer' id='tok-118-705'>RX</span><span class='token pointer' id='tok-118-706'>mode</span><span class='token pointer' id='tok-118-707'>it</span><span class='token pointer' id='tok-118-708'>is</span><span class='token pointer' id='tok-118-709'>necessary</span><span class='token pointer' id='tok-118-710'>to</span><span class='token pointer' id='tok-118-711'>make</span><span class='token pointer' id='tok-118-712'>sure</span><span class='token pointer' id='tok-118-713'>only</span><span class='token pointer' id='tok-118-714'>the</span><span class='token pointer' id='tok-118-715'>selected</span><span class='token pointer' id='tok-118-716'>flow</span><span class='token pointer' id='tok-118-717'>goes</span><span class='token pointer' id='tok-118-718'>to</span><span class='token pointer' id='tok-118-719'>the</span><span class='token pointer' id='tok-118-720'>Netmap</span><span class='token pointer' id='tok-118-721'>queue.</span></p>
<p id=p722><span class='token pointer' id='tok-118-722'>To</span><span class='token pointer' id='tok-118-723'>do</span><span class='token pointer' id='tok-118-724'>so</span><span class='token pointer' id='tok-118-725'>it</span><span class='token pointer' id='tok-118-726'>is</span><span class='token pointer' id='tok-118-727'>necessary</span><span class='token pointer' id='tok-118-728'>to:</span></p>
<p id=p729><span class='token pointer' id='tok-118-729'>Modify</span><span class='token pointer' id='tok-118-730'>the</span><span class='token pointer' id='tok-118-731'>indirection</span><span class='token pointer' id='tok-118-732'>table</span><span class='token pointer' id='tok-118-733'>to</span><span class='token pointer' id='tok-118-734'>ensure</span><span class='token pointer' id='tok-118-735'>no</span><span class='token pointer' id='tok-118-736'>new</span><span class='token pointer' id='tok-118-737'>RSS-hashed</span><span class='token pointer' id='tok-118-738'>packets</span><span class='token pointer' id='tok-118-739'>will</span><span class='token pointer' id='tok-118-740'>go</span><span class='token pointer' id='tok-118-741'>there.Use</span><span class='token pointer' id='tok-118-742'>flow</span><span class='token pointer' id='tok-118-743'>steering</span><span class='token pointer' id='tok-118-744'>to</span><span class='token pointer' id='tok-118-745'>specifically</span><span class='token pointer' id='tok-118-746'>direct</span><span class='token pointer' id='tok-118-747'>some</span><span class='token pointer' id='tok-118-748'>flows</span><span class='token pointer' id='tok-118-749'>to</span><span class='token pointer' id='tok-118-750'>the</span><span class='token pointer' id='tok-118-751'>isolated</span><span class='token pointer' id='tok-118-752'>queue.Work</span><span class='token pointer' id='tok-118-753'>around</span><span class='token pointer' id='tok-118-754'>RFS</span><span class='token pointer' id='tok-118-755'>-</span><span class='token pointer' id='tok-118-756'>make</span><span class='token pointer' id='tok-118-757'>sure</span><span class='token pointer' id='tok-118-758'>no</span><span class='token pointer' id='tok-118-759'>other</span><span class='token pointer' id='tok-118-760'>application</span><span class='token pointer' id='tok-118-761'>is</span><span class='token pointer' id='tok-118-762'>running</span><span class='token pointer' id='tok-118-763'>on</span><span class='token pointer' id='tok-118-764'>the</span><span class='token pointer' id='tok-118-765'>CPU</span><span class='token pointer' id='tok-118-766'>Netmap</span><span class='token pointer' id='tok-118-767'>will</span><span class='token pointer' id='tok-118-768'>run</span><span class='token pointer' id='tok-118-769'>on.For</span><span class='token pointer' id='tok-118-770'>example:</span></p>
<p id=p771><span class='token pointer' id='tok-118-771'>$</span><span class='token pointer' id='tok-118-772'>ethtool</span><span class='token pointer' id='tok-118-773'>-X</span><span class='token pointer' id='tok-118-774'>eth3</span><span class='token pointer' id='tok-118-775'>weight</span><span class='token pointer' id='tok-118-776'>1</span><span class='token pointer' id='tok-118-777'>1</span><span class='token pointer' id='tok-118-778'>1</span><span class='token pointer' id='tok-118-779'>1</span><span class='token pointer' id='tok-118-780'>0</span><span class='token pointer' id='tok-118-781'>1</span><span class='token pointer' id='tok-118-782'>1</span><span class='token pointer' id='tok-118-783'>1</span><span class='token pointer' id='tok-118-784'>1</span><span class='token pointer' id='tok-118-785'>1$</span><span class='token pointer' id='tok-118-786'>ethtool</span><span class='token pointer' id='tok-118-787'>-K</span><span class='token pointer' id='tok-118-788'>eth3</span><span class='token pointer' id='tok-118-789'>ntuple</span><span class='token pointer' id='tok-118-790'>on$</span><span class='token pointer' id='tok-118-791'>ethtool</span><span class='token pointer' id='tok-118-792'>-N</span><span class='token pointer' id='tok-118-793'>eth3</span><span class='token pointer' id='tok-118-794'>flow-type</span><span class='token pointer' id='tok-118-795'>udp4</span><span class='token pointer' id='tok-118-796'>dst-port</span><span class='token pointer' id='tok-118-797'>53</span><span class='token pointer' id='tok-118-798'>action</span><span class='token pointer' id='tok-118-799'>4Here</span><span class='token pointer' id='tok-118-800'>we</span><span class='token pointer' id='tok-118-801'>are</span><span class='token pointer' id='tok-118-802'>setting</span><span class='token pointer' id='tok-118-803'>the</span><span class='token pointer' id='tok-118-804'>indirection</span><span class='token pointer' id='tok-118-805'>table</span><span class='token pointer' id='tok-118-806'>to</span><span class='token pointer' id='tok-118-807'>prevent</span><span class='token pointer' id='tok-118-808'>traffic</span><span class='token pointer' id='tok-118-809'>from</span><span class='token pointer' id='tok-118-810'>going</span><span class='token pointer' id='tok-118-811'>to</span><span class='token pointer' id='tok-118-812'>RX</span><span class='token pointer' id='tok-118-813'>queue</span><span class='token pointer' id='tok-118-814'>#4.</span><span class='token pointer' id='tok-118-815'>Then</span><span class='token pointer' id='tok-118-816'>we</span><span class='token pointer' id='tok-118-817'>are</span><span class='token pointer' id='tok-118-818'>enabling</span><span class='token pointer' id='tok-118-819'>flow</span><span class='token pointer' id='tok-118-820'>steering</span><span class='token pointer' id='tok-118-821'>to</span><span class='token pointer' id='tok-118-822'>enqueue</span><span class='token pointer' id='tok-118-823'>all</span><span class='token pointer' id='tok-118-824'>UDP</span><span class='token pointer' id='tok-118-825'>traffic</span><span class='token pointer' id='tok-118-826'>with</span><span class='token pointer' id='tok-118-827'>destination</span><span class='token pointer' id='tok-118-828'>port</span><span class='token pointer' id='tok-118-829'>53</span><span class='token pointer' id='tok-118-830'>into</span><span class='token pointer' id='tok-118-831'>queue</span><span class='token pointer' id='tok-118-832'>#4.</span></p>
<p id=p833><span class='token pointer' id='tok-118-833'>Trying</span><span class='token pointer' id='tok-118-834'>it</span><span class='token pointer' id='tok-118-835'>outHere's</span><span class='token pointer' id='tok-118-836'>how</span><span class='token pointer' id='tok-118-837'>to</span><span class='token pointer' id='tok-118-838'>run</span><span class='token pointer' id='tok-118-839'>it</span><span class='token pointer' id='tok-118-840'>with</span><span class='token pointer' id='tok-118-841'>the</span><span class='token pointer' id='tok-118-842'>IXGBE</span><span class='token pointer' id='tok-118-843'>NIC.</span><span class='token pointer' id='tok-118-844'>First</span><span class='token pointer' id='tok-118-845'>grab</span><span class='token pointer' id='tok-118-846'>the</span><span class='token pointer' id='tok-118-847'>sources:</span></p>
<p id=p848><span class='token pointer' id='tok-118-848'>$</span><span class='token pointer' id='tok-118-849'>git</span><span class='token pointer' id='tok-118-850'>clone</span><span class='token pointer' id='tok-118-851'>https://github.com/jibi/netmap.git$</span><span class='token pointer' id='tok-118-852'>cd</span><span class='token pointer' id='tok-118-853'>netmap$</span><span class='token pointer' id='tok-118-854'>git</span><span class='token pointer' id='tok-118-855'>checkout</span><span class='token pointer' id='tok-118-856'>-B</span><span class='token pointer' id='tok-118-857'>single-rx-queue-mode$</span><span class='token pointer' id='tok-118-858'>./configure</span><span class='token pointer' id='tok-118-859'>--drivers=ixgbe</span><span class='token pointer' id='tok-118-860'>--kernel-sources=/path/to/kernelLoad</span><span class='token pointer' id='tok-118-861'>the</span><span class='token pointer' id='tok-118-862'>netmap-patched</span><span class='token pointer' id='tok-118-863'>modules</span><span class='token pointer' id='tok-118-864'>and</span><span class='token pointer' id='tok-118-865'>setup</span><span class='token pointer' id='tok-118-866'>the</span><span class='token pointer' id='tok-118-867'>interface:</span></p>
<p id=p868><span class='token pointer' id='tok-118-868'>$</span><span class='token pointer' id='tok-118-869'>insmod</span><span class='token pointer' id='tok-118-870'>./LINUX/netmap.ko$</span><span class='token pointer' id='tok-118-871'>insmod</span><span class='token pointer' id='tok-118-872'>./LINUX/ixgbe/ixgbe.ko$</span><span class='token pointer' id='tok-118-873'>#</span><span class='token pointer' id='tok-118-874'>Distribute</span><span class='token pointer' id='tok-118-875'>the</span><span class='token pointer' id='tok-118-876'>interrupts:$</span><span class='token pointer' id='tok-118-877'>(let</span><span class='token pointer' id='tok-118-878'>CPU=0;</span><span class='token pointer' id='tok-118-879'>cd</span><span class='token pointer' id='tok-118-880'>/sys/class/net/eth3/device/msi_irqs/;</span><span class='token pointer' id='tok-118-881'>for</span><span class='token pointer' id='tok-118-882'>IRQ</span><span class='token pointer' id='tok-118-883'>in</span><span class='token pointer' id='tok-118-884'>*;</span><span class='token pointer' id='tok-118-885'>do</span><span class='token pointer' id='tok-118-886'>\</span><span class='token pointer' id='tok-118-887'></span><span class='token pointer' id='tok-118-888'>echo</span><span class='token pointer' id='tok-118-889'>$CPU</span><span class='token pointer' id='tok-118-890'>&gt;</span><span class='token pointer' id='tok-118-891'>/proc/irq/$IRQ/smp_affinity_list;</span><span class='token pointer' id='tok-118-892'>let</span><span class='token pointer' id='tok-118-893'>CPU+=1</span><span class='token pointer' id='tok-118-894'></span><span class='token pointer' id='tok-118-895'></span><span class='token pointer' id='tok-118-896'></span><span class='token pointer' id='tok-118-897'></span><span class='token pointer' id='tok-118-898'></span><span class='token pointer' id='tok-118-899'></span><span class='token pointer' id='tok-118-900'></span><span class='token pointer' id='tok-118-901'></span><span class='token pointer' id='tok-118-902'>done)$</span><span class='token pointer' id='tok-118-903'>#</span><span class='token pointer' id='tok-118-904'>Enable</span><span class='token pointer' id='tok-118-905'>RSS:$</span><span class='token pointer' id='tok-118-906'>ethtool</span><span class='token pointer' id='tok-118-907'>-K</span><span class='token pointer' id='tok-118-908'>eth3</span><span class='token pointer' id='tok-118-909'>ntuple</span><span class='token pointer' id='tok-118-910'>onAt</span><span class='token pointer' id='tok-118-911'>this</span><span class='token pointer' id='tok-118-912'>point</span><span class='token pointer' id='tok-118-913'>we</span><span class='token pointer' id='tok-118-914'>started</span><span class='token pointer' id='tok-118-915'>flooding</span><span class='token pointer' id='tok-118-916'>the</span><span class='token pointer' id='tok-118-917'>interface</span><span class='token pointer' id='tok-118-918'>with</span><span class='token pointer' id='tok-118-919'>6M</span><span class='token pointer' id='tok-118-920'>short</span><span class='token pointer' id='tok-118-921'>UDP</span><span class='token pointer' id='tok-118-922'>packets.</span><span class='token pointer' id='tok-118-923'>htop</span><span class='token pointer' id='tok-118-924'>shows</span><span class='token pointer' id='tok-118-925'>the</span><span class='token pointer' id='tok-118-926'>server</span><span class='token pointer' id='tok-118-927'>being</span><span class='token pointer' id='tok-118-928'>totally</span><span class='token pointer' id='tok-118-929'>busy</span><span class='token pointer' id='tok-118-930'>with</span><span class='token pointer' id='tok-118-931'>handling</span><span class='token pointer' id='tok-118-932'>the</span><span class='token pointer' id='tok-118-933'>flood:</span></p>
<p id=p934><span class='token pointer' id='tok-118-934'>To</span><span class='token pointer' id='tok-118-935'>counter</span><span class='token pointer' id='tok-118-936'>the</span><span class='token pointer' id='tok-118-937'>flood</span><span class='token pointer' id='tok-118-938'>we</span><span class='token pointer' id='tok-118-939'>started</span><span class='token pointer' id='tok-118-940'>Netmap.</span><span class='token pointer' id='tok-118-941'>First,</span><span class='token pointer' id='tok-118-942'>we</span><span class='token pointer' id='tok-118-943'>needed</span><span class='token pointer' id='tok-118-944'>to</span><span class='token pointer' id='tok-118-945'>edit</span><span class='token pointer' id='tok-118-946'>the</span><span class='token pointer' id='tok-118-947'>indirection</span><span class='token pointer' id='tok-118-948'>table,</span><span class='token pointer' id='tok-118-949'>to</span><span class='token pointer' id='tok-118-950'>isolate</span><span class='token pointer' id='tok-118-951'>the</span><span class='token pointer' id='tok-118-952'>RX</span><span class='token pointer' id='tok-118-953'>queue</span><span class='token pointer' id='tok-118-954'>#4:</span></p>
<p id=p955><span class='token pointer' id='tok-118-955'>$</span><span class='token pointer' id='tok-118-956'>ethtool</span><span class='token pointer' id='tok-118-957'>-X</span><span class='token pointer' id='tok-118-958'>eth3</span><span class='token pointer' id='tok-118-959'>weight</span><span class='token pointer' id='tok-118-960'>1</span><span class='token pointer' id='tok-118-961'>1</span><span class='token pointer' id='tok-118-962'>1</span><span class='token pointer' id='tok-118-963'>1</span><span class='token pointer' id='tok-118-964'>0</span><span class='token pointer' id='tok-118-965'>1</span><span class='token pointer' id='tok-118-966'>1</span><span class='token pointer' id='tok-118-967'>1</span><span class='token pointer' id='tok-118-968'>1</span><span class='token pointer' id='tok-118-969'>1$</span><span class='token pointer' id='tok-118-970'>ethtool</span><span class='token pointer' id='tok-118-971'>-N</span><span class='token pointer' id='tok-118-972'>eth3</span><span class='token pointer' id='tok-118-973'>flow-type</span><span class='token pointer' id='tok-118-974'>udp4</span><span class='token pointer' id='tok-118-975'>dst-port</span><span class='token pointer' id='tok-118-976'>53</span><span class='token pointer' id='tok-118-977'>action</span><span class='token pointer' id='tok-118-978'>4This</span><span class='token pointer' id='tok-118-979'>caused</span><span class='token pointer' id='tok-118-980'>all</span><span class='token pointer' id='tok-118-981'>the</span><span class='token pointer' id='tok-118-982'>flood</span><span class='token pointer' id='tok-118-983'>packets</span><span class='token pointer' id='tok-118-984'>to</span><span class='token pointer' id='tok-118-985'>go</span><span class='token pointer' id='tok-118-986'>to</span><span class='token pointer' id='tok-118-987'>RX</span><span class='token pointer' id='tok-118-988'>queue</span><span class='token pointer' id='tok-118-989'>#4.</span></p>
<p id=p990><span class='token pointer' id='tok-118-990'>Before</span><span class='token pointer' id='tok-118-991'>putting</span><span class='token pointer' id='tok-118-992'>an</span><span class='token pointer' id='tok-118-993'>interface</span><span class='token pointer' id='tok-118-994'>in</span><span class='token pointer' id='tok-118-995'>Netmap</span><span class='token pointer' id='tok-118-996'>mode</span><span class='token pointer' id='tok-118-997'>it</span><span class='token pointer' id='tok-118-998'>is</span><span class='token pointer' id='tok-118-999'>necessary</span><span class='token pointer' id='tok-118-1000'>to</span><span class='token pointer' id='tok-118-1001'>turn</span><span class='token pointer' id='tok-118-1002'>off</span><span class='token pointer' id='tok-118-1003'>hardware</span><span class='token pointer' id='tok-118-1004'>offload</span><span class='token pointer' id='tok-118-1005'>features:</span></p>
<p id=p1006><span class='token pointer' id='tok-118-1006'>$</span><span class='token pointer' id='tok-118-1007'>ethtool</span><span class='token pointer' id='tok-118-1008'>-K</span><span class='token pointer' id='tok-118-1009'>eth3</span><span class='token pointer' id='tok-118-1010'>lro</span><span class='token pointer' id='tok-118-1011'>off</span><span class='token pointer' id='tok-118-1012'>gro</span><span class='token pointer' id='tok-118-1013'>offFinally</span><span class='token pointer' id='tok-118-1014'>we</span><span class='token pointer' id='tok-118-1015'>launched</span><span class='token pointer' id='tok-118-1016'>the</span><span class='token pointer' id='tok-118-1017'>netmap</span><span class='token pointer' id='tok-118-1018'>offload:</span></p>
<p id=p1019><span class='token pointer' id='tok-118-1019'>$</span><span class='token pointer' id='tok-118-1020'>sudo</span><span class='token pointer' id='tok-118-1021'>taskset</span><span class='token pointer' id='tok-118-1022'>-c</span><span class='token pointer' id='tok-118-1023'>15</span><span class='token pointer' id='tok-118-1024'>./nm_offload</span><span class='token pointer' id='tok-118-1025'>eth3</span><span class='token pointer' id='tok-118-1026'>4[+]</span><span class='token pointer' id='tok-118-1027'>starting</span><span class='token pointer' id='tok-118-1028'>test02</span><span class='token pointer' id='tok-118-1029'>on</span><span class='token pointer' id='tok-118-1030'>interface</span><span class='token pointer' id='tok-118-1031'>eth3</span><span class='token pointer' id='tok-118-1032'>ring</span><span class='token pointer' id='tok-118-1033'>4[+]</span><span class='token pointer' id='tok-118-1034'>UDP</span><span class='token pointer' id='tok-118-1035'>pps:</span><span class='token pointer' id='tok-118-1036'>5844714[+]</span><span class='token pointer' id='tok-118-1037'>UDP</span><span class='token pointer' id='tok-118-1038'>pps:</span><span class='token pointer' id='tok-118-1039'>5996166[+]</span><span class='token pointer' id='tok-118-1040'>UDP</span><span class='token pointer' id='tok-118-1041'>pps:</span><span class='token pointer' id='tok-118-1042'>5863214[+]</span><span class='token pointer' id='tok-118-1043'>UDP</span><span class='token pointer' id='tok-118-1044'>pps:</span><span class='token pointer' id='tok-118-1045'>5986365[+]</span><span class='token pointer' id='tok-118-1046'>UDP</span><span class='token pointer' id='tok-118-1047'>pps:</span><span class='token pointer' id='tok-118-1048'>5867302[+]</span><span class='token pointer' id='tok-118-1049'>UDP</span><span class='token pointer' id='tok-118-1050'>pps:</span><span class='token pointer' id='tok-118-1051'>5964911[+]</span><span class='token pointer' id='tok-118-1052'>UDP</span><span class='token pointer' id='tok-118-1053'>pps:</span><span class='token pointer' id='tok-118-1054'>5909715[+]</span><span class='token pointer' id='tok-118-1055'>UDP</span><span class='token pointer' id='tok-118-1056'>pps:</span><span class='token pointer' id='tok-118-1057'>5865769[+]</span><span class='token pointer' id='tok-118-1058'>UDP</span><span class='token pointer' id='tok-118-1059'>pps:</span><span class='token pointer' id='tok-118-1060'>5906668[+]</span><span class='token pointer' id='tok-118-1061'>UDP</span><span class='token pointer' id='tok-118-1062'>pps:</span><span class='token pointer' id='tok-118-1063'>5875486As</span><span class='token pointer' id='tok-118-1064'>you</span><span class='token pointer' id='tok-118-1065'>see</span><span class='token pointer' id='tok-118-1066'>the</span><span class='token pointer' id='tok-118-1067'>netmap</span><span class='token pointer' id='tok-118-1068'>program</span><span class='token pointer' id='tok-118-1069'>on</span><span class='token pointer' id='tok-118-1070'>a</span><span class='token pointer' id='tok-118-1071'>single</span><span class='token pointer' id='tok-118-1072'>RX</span><span class='token pointer' id='tok-118-1073'>queue</span><span class='token pointer' id='tok-118-1074'>was</span><span class='token pointer' id='tok-118-1075'>able</span><span class='token pointer' id='tok-118-1076'>to</span><span class='token pointer' id='tok-118-1077'>receive</span><span class='token pointer' id='tok-118-1078'>about</span><span class='token pointer' id='tok-118-1079'>5.8M</span><span class='token pointer' id='tok-118-1080'>packets.</span></p>
<p id=p1081><span class='token pointer' id='tok-118-1081'>For</span><span class='token pointer' id='tok-118-1082'>completeness,</span><span class='token pointer' id='tok-118-1083'>here's</span><span class='token pointer' id='tok-118-1084'>an</span><span class='token pointer' id='tok-118-1085'>htop</span><span class='token pointer' id='tok-118-1086'>showing</span><span class='token pointer' id='tok-118-1087'>only</span><span class='token pointer' id='tok-118-1088'>a</span><span class='token pointer' id='tok-118-1089'>single</span><span class='token pointer' id='tok-118-1090'>core</span><span class='token pointer' id='tok-118-1091'>being</span><span class='token pointer' id='tok-118-1092'>busy</span><span class='token pointer' id='tok-118-1093'>with</span><span class='token pointer' id='tok-118-1094'>Netmap:</span></p>
<p id=p1095><span class='token pointer' id='tok-118-1095'>ThanksWe</span><span class='token pointer' id='tok-118-1096'>would</span><span class='token pointer' id='tok-118-1097'>like</span><span class='token pointer' id='tok-118-1098'>to</span><span class='token pointer' id='tok-118-1099'>thank</span><span class='token pointer' id='tok-118-1100'>Pavel</span><span class='token pointer' id='tok-118-1101'>Odintsov</span><span class='token pointer' id='tok-118-1102'>who</span><span class='token pointer' id='tok-118-1103'>suggested</span><span class='token pointer' id='tok-118-1104'>the</span><span class='token pointer' id='tok-118-1105'>possibility</span><span class='token pointer' id='tok-118-1106'>of</span><span class='token pointer' id='tok-118-1107'>using</span><span class='token pointer' id='tok-118-1108'>Netmap</span><span class='token pointer' id='tok-118-1109'>this</span><span class='token pointer' id='tok-118-1110'>way.</span><span class='token pointer' id='tok-118-1111'>He</span><span class='token pointer' id='tok-118-1112'>even</span><span class='token pointer' id='tok-118-1113'>prepared</span><span class='token pointer' id='tok-118-1114'>the</span><span class='token pointer' id='tok-118-1115'>initial</span><span class='token pointer' id='tok-118-1116'>hack</span><span class='token pointer' id='tok-118-1117'>we</span><span class='token pointer' id='tok-118-1118'>based</span><span class='token pointer' id='tok-118-1119'>our</span><span class='token pointer' id='tok-118-1120'>work</span><span class='token pointer' id='tok-118-1121'>on.</span></p>
<p id=p1122><span class='token pointer' id='tok-118-1122'>We</span><span class='token pointer' id='tok-118-1123'>would</span><span class='token pointer' id='tok-118-1124'>also</span><span class='token pointer' id='tok-118-1125'>like</span><span class='token pointer' id='tok-118-1126'>to</span><span class='token pointer' id='tok-118-1127'>thank</span><span class='token pointer' id='tok-118-1128'>Luigi</span><span class='token pointer' id='tok-118-1129'>Rizzo,</span><span class='token pointer' id='tok-118-1130'>for</span><span class='token pointer' id='tok-118-1131'>his</span><span class='token pointer' id='tok-118-1132'>Netmap</span><span class='token pointer' id='tok-118-1133'>work</span><span class='token pointer' id='tok-118-1134'>and</span><span class='token pointer' id='tok-118-1135'>great</span><span class='token pointer' id='tok-118-1136'>feedback</span><span class='token pointer' id='tok-118-1137'>on</span><span class='token pointer' id='tok-118-1138'>our</span><span class='token pointer' id='tok-118-1139'>patches.</span></p>
<p id=p1140><span class='token pointer' id='tok-118-1140'>Final</span><span class='token pointer' id='tok-118-1141'>wordsAt</span><span class='token pointer' id='tok-118-1142'>CloudFlare</span><span class='token pointer' id='tok-118-1143'>our</span><span class='token pointer' id='tok-118-1144'>application</span><span class='token pointer' id='tok-118-1145'>stack</span><span class='token pointer' id='tok-118-1146'>is</span><span class='token pointer' id='tok-118-1147'>based</span><span class='token pointer' id='tok-118-1148'>on</span><span class='token pointer' id='tok-118-1149'>open</span><span class='token pointer' id='tok-118-1150'>source</span><span class='token pointer' id='tok-118-1151'>software.</span><span class='token pointer' id='tok-118-1152'>We're</span><span class='token pointer' id='tok-118-1153'>grateful</span><span class='token pointer' id='tok-118-1154'>to</span><span class='token pointer' id='tok-118-1155'>so</span><span class='token pointer' id='tok-118-1156'>many</span><span class='token pointer' id='tok-118-1157'>open</span><span class='token pointer' id='tok-118-1158'>source</span><span class='token pointer' id='tok-118-1159'>programmers</span><span class='token pointer' id='tok-118-1160'>for</span><span class='token pointer' id='tok-118-1161'>their</span><span class='token pointer' id='tok-118-1162'>awesome</span><span class='token pointer' id='tok-118-1163'>work.</span><span class='token pointer' id='tok-118-1164'>Whenever</span><span class='token pointer' id='tok-118-1165'>we</span><span class='token pointer' id='tok-118-1166'>can</span><span class='token pointer' id='tok-118-1167'>we</span><span class='token pointer' id='tok-118-1168'>try</span><span class='token pointer' id='tok-118-1169'>to</span><span class='token pointer' id='tok-118-1170'>contribute</span><span class='token pointer' id='tok-118-1171'>back</span><span class='token pointer' id='tok-118-1172'>to</span><span class='token pointer' id='tok-118-1173'>the</span><span class='token pointer' id='tok-118-1174'>community</span><span class='token pointer' id='tok-118-1175'>-</span><span class='token pointer' id='tok-118-1176'>we</span><span class='token pointer' id='tok-118-1177'>hope</span><span class='token pointer' id='tok-118-1178'>"the</span><span class='token pointer' id='tok-118-1179'>single</span><span class='token pointer' id='tok-118-1180'>RX</span><span class='token pointer' id='tok-118-1181'>Netmap</span><span class='token pointer' id='tok-118-1182'>mode"</span><span class='token pointer' id='tok-118-1183'>will</span><span class='token pointer' id='tok-118-1184'>be</span><span class='token pointer' id='tok-118-1185'>useful</span><span class='token pointer' id='tok-118-1186'>to</span><span class='token pointer' id='tok-118-1187'>others.</span></p>
<p id=p1188><span class='token pointer' id='tok-118-1188'>You</span><span class='token pointer' id='tok-118-1189'>can</span><span class='token pointer' id='tok-118-1190'>find</span><span class='token pointer' id='tok-118-1191'>more</span><span class='token pointer' id='tok-118-1192'>CloudFlare</span><span class='token pointer' id='tok-118-1193'>open</span><span class='token pointer' id='tok-118-1194'>source</span><span class='token pointer' id='tok-118-1195'>here.
