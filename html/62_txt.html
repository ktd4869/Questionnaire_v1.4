<p id=p0><span class='token pointer' id='tok-62-0'>Driver</span></p>
<p id=p1><span class='token pointer' id='tok-62-1'>The</span><span class='token pointer' id='tok-62-2'>driver</span><span class='token pointer' id='tok-62-3'>is</span><span class='token pointer' id='tok-62-4'>the</span><span class='token pointer' id='tok-62-5'>first</span><span class='token pointer' id='tok-62-6'>component</span><span class='token pointer' id='tok-62-7'>of</span><span class='token pointer' id='tok-62-8'>Duqu</span><span class='token pointer' id='tok-62-9'>to</span><span class='token pointer' id='tok-62-10'>be</span><span class='token pointer' id='tok-62-11'>loaded</span><span class='token pointer' id='tok-62-12'>in</span><span class='token pointer' id='tok-62-13'>the</span><span class='token pointer' id='tok-62-14'>system.</span><span class='token pointer' id='tok-62-15'>As</span><span class='token pointer' id='tok-62-16'>we</span><span class='token pointer' id='tok-62-17'>discovered,</span><span class='token pointer' id='tok-62-18'>the</span><span class='token pointer' id='tok-62-19'>driver</span><span class='token pointer' id='tok-62-20'>and</span><span class='token pointer' id='tok-62-21'>other</span><span class='token pointer' id='tok-62-22'>components</span><span class='token pointer' id='tok-62-23'>of</span><span class='token pointer' id='tok-62-24'>malware</span><span class='token pointer' id='tok-62-25'>are</span><span class='token pointer' id='tok-62-26'>installed</span><span class='token pointer' id='tok-62-27'>with</span><span class='token pointer' id='tok-62-28'>a</span><span class='token pointer' id='tok-62-29'>dropper</span><span class='token pointer' id='tok-62-30'>exploiting</span><span class='token pointer' id='tok-62-31'>a</span><span class='token pointer' id='tok-62-32'>0-day</span><span class='token pointer' id='tok-62-33'>vulnerability</span><span class='token pointer' id='tok-62-34'>(CVE-2011-3402).</span><span class='token pointer' id='tok-62-35'>The</span><span class='token pointer' id='tok-62-36'>driver</span><span class='token pointer' id='tok-62-37'>is</span><span class='token pointer' id='tok-62-38'>registered</span><span class='token pointer' id='tok-62-39'>in</span><span class='token pointer' id='tok-62-40'>the</span><span class='token pointer' id='tok-62-41'>HKLMSystemCurrentControlSetServices</span><span class='token pointer' id='tok-62-42'>registry</span><span class='token pointer' id='tok-62-43'>path.</span><span class='token pointer' id='tok-62-44'>The</span><span class='token pointer' id='tok-62-45'>exact</span><span class='token pointer' id='tok-62-46'>name</span><span class='token pointer' id='tok-62-47'>of</span><span class='token pointer' id='tok-62-48'>the</span><span class='token pointer' id='tok-62-49'>registry</span><span class='token pointer' id='tok-62-50'>key</span><span class='token pointer' id='tok-62-51'>varies</span><span class='token pointer' id='tok-62-52'>in</span><span class='token pointer' id='tok-62-53'>different</span><span class='token pointer' id='tok-62-54'>versions</span><span class='token pointer' id='tok-62-55'>of</span><span class='token pointer' id='tok-62-56'>Duqu</span><span class='token pointer' id='tok-62-57'>drivers.</span></p>
<p id=p58><span class='token pointer' id='tok-62-58'>Once</span><span class='token pointer' id='tok-62-59'>the</span><span class='token pointer' id='tok-62-60'>driver</span><span class='token pointer' id='tok-62-61'>is</span><span class='token pointer' id='tok-62-62'>loaded,</span><span class='token pointer' id='tok-62-63'>it</span><span class='token pointer' id='tok-62-64'>decrypts</span><span class='token pointer' id='tok-62-65'>a</span><span class='token pointer' id='tok-62-66'>small</span><span class='token pointer' id='tok-62-67'>block</span><span class='token pointer' id='tok-62-68'>that</span><span class='token pointer' id='tok-62-69'>contains</span><span class='token pointer' id='tok-62-70'>its</span><span class='token pointer' id='tok-62-71'>registry</span><span class='token pointer' id='tok-62-72'>key</span><span class='token pointer' id='tok-62-73'>and</span><span class='token pointer' id='tok-62-74'>the</span><span class='token pointer' id='tok-62-75'>name</span><span class='token pointer' id='tok-62-76'>of</span><span class='token pointer' id='tok-62-77'>the</span><span class='token pointer' id='tok-62-78'>registry</span><span class='token pointer' id='tok-62-79'>value</span><span class='token pointer' id='tok-62-80'>to</span><span class='token pointer' id='tok-62-81'>be</span><span class='token pointer' id='tok-62-82'>read</span><span class='token pointer' id='tok-62-83'>from</span><span class='token pointer' id='tok-62-84'>that</span><span class='token pointer' id='tok-62-85'>key.</span><span class='token pointer' id='tok-62-86'>It</span><span class='token pointer' id='tok-62-87'>also</span><span class='token pointer' id='tok-62-88'>contains</span><span class='token pointer' id='tok-62-89'>the</span><span class='token pointer' id='tok-62-90'>name</span><span class='token pointer' id='tok-62-91'>of</span><span class='token pointer' id='tok-62-92'>the</span><span class='token pointer' id='tok-62-93'>driver</span><span class='token pointer' id='tok-62-94'>object</span><span class='token pointer' id='tok-62-95'>to</span><span class='token pointer' id='tok-62-96'>create.</span></p>
<p id=p97><span class='token pointer' id='tok-62-97'>All</span><span class='token pointer' id='tok-62-98'>versions</span><span class='token pointer' id='tok-62-99'>of</span><span class='token pointer' id='tok-62-100'>the</span><span class='token pointer' id='tok-62-101'>driver</span><span class='token pointer' id='tok-62-102'>available</span><span class='token pointer' id='tok-62-103'>at</span><span class='token pointer' id='tok-62-104'>the</span><span class='token pointer' id='tok-62-105'>moment</span><span class='token pointer' id='tok-62-106'>have</span><span class='token pointer' id='tok-62-107'>the</span><span class='token pointer' id='tok-62-108'>same</span><span class='token pointer' id='tok-62-109'>registry</span><span class='token pointer' id='tok-62-110'>value</span><span class='token pointer' id='tok-62-111'>name,</span><span class='token pointer' id='tok-62-112'>"FILTER".</span></p>
<p id=p113><span class='token pointer' id='tok-62-113'>The</span><span class='token pointer' id='tok-62-114'>driver</span><span class='token pointer' id='tok-62-115'>then</span><span class='token pointer' id='tok-62-116'>registers</span><span class='token pointer' id='tok-62-117'>the</span><span class='token pointer' id='tok-62-118'>DriverReinitializationRoutine</span><span class='token pointer' id='tok-62-119'>that</span><span class='token pointer' id='tok-62-120'>queues</span><span class='token pointer' id='tok-62-121'>the</span><span class='token pointer' id='tok-62-122'>WorkerRoutine</span><span class='token pointer' id='tok-62-123'>where</span><span class='token pointer' id='tok-62-124'>actual</span><span class='token pointer' id='tok-62-125'>driver</span><span class='token pointer' id='tok-62-126'>initialization</span><span class='token pointer' id='tok-62-127'>is</span><span class='token pointer' id='tok-62-128'>performed.</span><span class='token pointer' id='tok-62-129'>In</span><span class='token pointer' id='tok-62-130'>the</span><span class='token pointer' id='tok-62-131'>WorkerRoutine</span><span class='token pointer' id='tok-62-132'>the</span><span class='token pointer' id='tok-62-133'>driver</span><span class='token pointer' id='tok-62-134'>reads</span><span class='token pointer' id='tok-62-135'>the</span><span class='token pointer' id='tok-62-136'>"FILTER"</span><span class='token pointer' id='tok-62-137'>value</span><span class='token pointer' id='tok-62-138'>from</span><span class='token pointer' id='tok-62-139'>registry</span><span class='token pointer' id='tok-62-140'>and</span><span class='token pointer' id='tok-62-141'>decrypts</span><span class='token pointer' id='tok-62-142'>it</span><span class='token pointer' id='tok-62-143'>with</span><span class='token pointer' id='tok-62-144'>a</span><span class='token pointer' id='tok-62-145'>hard-coded</span><span class='token pointer' id='tok-62-146'>encryption</span><span class='token pointer' id='tok-62-147'>key.</span><span class='token pointer' id='tok-62-148'>There</span><span class='token pointer' id='tok-62-149'>are</span><span class='token pointer' id='tok-62-150'>two</span><span class='token pointer' id='tok-62-151'>known</span><span class='token pointer' id='tok-62-152'>versions</span><span class='token pointer' id='tok-62-153'>of</span><span class='token pointer' id='tok-62-154'>decryption</span><span class='token pointer' id='tok-62-155'>routine</span><span class='token pointer' id='tok-62-156'>and</span><span class='token pointer' id='tok-62-157'>two</span><span class='token pointer' id='tok-62-158'>corresponding</span><span class='token pointer' id='tok-62-159'>decryption</span><span class='token pointer' id='tok-62-160'>keys.</span><span class='token pointer' id='tok-62-161'>The</span><span class='token pointer' id='tok-62-162'>driver</span><span class='token pointer' id='tok-62-163'>also</span><span class='token pointer' id='tok-62-164'>locates</span><span class='token pointer' id='tok-62-165'>the</span><span class='token pointer' id='tok-62-166'>NTOSKRNL.EXE</span><span class='token pointer' id='tok-62-167'>or</span><span class='token pointer' id='tok-62-168'>NTKRNLPA.EXE</span><span class='token pointer' id='tok-62-169'>module</span><span class='token pointer' id='tok-62-170'>and</span><span class='token pointer' id='tok-62-171'>gets</span><span class='token pointer' id='tok-62-172'>the</span><span class='token pointer' id='tok-62-173'>addresses</span><span class='token pointer' id='tok-62-174'>of</span><span class='token pointer' id='tok-62-175'>API</span><span class='token pointer' id='tok-62-176'>functions</span><span class='token pointer' id='tok-62-177'>for</span><span class='token pointer' id='tok-62-178'>further</span><span class='token pointer' id='tok-62-179'>usage.</span></p>
<p id=p180><span class='token pointer' id='tok-62-180'>The</span><span class='token pointer' id='tok-62-181'>decrypted</span><span class='token pointer' id='tok-62-182'>"FILTER"</span><span class='token pointer' id='tok-62-183'>value</span><span class='token pointer' id='tok-62-184'>from</span><span class='token pointer' id='tok-62-185'>registry</span><span class='token pointer' id='tok-62-186'>contains</span><span class='token pointer' id='tok-62-187'>the</span><span class='token pointer' id='tok-62-188'>list</span><span class='token pointer' id='tok-62-189'>of</span><span class='token pointer' id='tok-62-190'>records</span><span class='token pointer' id='tok-62-191'>that</span><span class='token pointer' id='tok-62-192'>contain</span><span class='token pointer' id='tok-62-193'>the</span><span class='token pointer' id='tok-62-194'>name</span><span class='token pointer' id='tok-62-195'>of</span><span class='token pointer' id='tok-62-196'>the</span><span class='token pointer' id='tok-62-197'>process</span><span class='token pointer' id='tok-62-198'>("services.exe"),</span><span class='token pointer' id='tok-62-199'>the</span><span class='token pointer' id='tok-62-200'>path</span><span class='token pointer' id='tok-62-201'>to</span><span class='token pointer' id='tok-62-202'>corresponding</span><span class='token pointer' id='tok-62-203'>PNF</span><span class='token pointer' id='tok-62-204'>DLL</span><span class='token pointer' id='tok-62-205'>file</span><span class='token pointer' id='tok-62-206'>that</span><span class='token pointer' id='tok-62-207'>will</span><span class='token pointer' id='tok-62-208'>be</span><span class='token pointer' id='tok-62-209'>injected</span><span class='token pointer' id='tok-62-210'>in</span><span class='token pointer' id='tok-62-211'>that</span><span class='token pointer' id='tok-62-212'>process</span><span class='token pointer' id='tok-62-213'>and</span><span class='token pointer' id='tok-62-214'>the</span><span class='token pointer' id='tok-62-215'>decryption</span><span class='token pointer' id='tok-62-216'>key</span><span class='token pointer' id='tok-62-217'>(0xAE240682)</span><span class='token pointer' id='tok-62-218'>that</span><span class='token pointer' id='tok-62-219'>is</span><span class='token pointer' id='tok-62-220'>used</span><span class='token pointer' id='tok-62-221'>to</span><span class='token pointer' id='tok-62-222'>decrypt</span><span class='token pointer' id='tok-62-223'>the</span><span class='token pointer' id='tok-62-224'>PNF</span><span class='token pointer' id='tok-62-225'>DLL</span><span class='token pointer' id='tok-62-226'>file.</span></p>
<p id=p227><span class='token pointer' id='tok-62-227'>After</span><span class='token pointer' id='tok-62-228'>initialization</span><span class='token pointer' id='tok-62-229'>the</span><span class='token pointer' id='tok-62-230'>driver</span><span class='token pointer' id='tok-62-231'>registers</span><span class='token pointer' id='tok-62-232'></span><span class='token pointer' id='tok-62-233'>LoadImageNotifyRoutine</span><span class='token pointer' id='tok-62-234'>that</span><span class='token pointer' id='tok-62-235'>will</span><span class='token pointer' id='tok-62-236'>be</span><span class='token pointer' id='tok-62-237'>then</span><span class='token pointer' id='tok-62-238'>called</span><span class='token pointer' id='tok-62-239'>by</span><span class='token pointer' id='tok-62-240'>Windows</span><span class='token pointer' id='tok-62-241'>each</span><span class='token pointer' id='tok-62-242'>time</span><span class='token pointer' id='tok-62-243'>a</span><span class='token pointer' id='tok-62-244'>new</span><span class='token pointer' id='tok-62-245'>module</span><span class='token pointer' id='tok-62-246'>is</span><span class='token pointer' id='tok-62-247'>loaded.</span><span class='token pointer' id='tok-62-248'>The</span><span class='token pointer' id='tok-62-249'>routine</span><span class='token pointer' id='tok-62-250'>checks</span><span class='token pointer' id='tok-62-251'>if</span><span class='token pointer' id='tok-62-252'>the</span><span class='token pointer' id='tok-62-253'>name</span><span class='token pointer' id='tok-62-254'>of</span><span class='token pointer' id='tok-62-255'>image</span><span class='token pointer' id='tok-62-256'>matches</span><span class='token pointer' id='tok-62-257'>one</span><span class='token pointer' id='tok-62-258'>of</span><span class='token pointer' id='tok-62-259'>these</span><span class='token pointer' id='tok-62-260'>specified</span><span class='token pointer' id='tok-62-261'>in</span><span class='token pointer' id='tok-62-262'>"FILTER"</span><span class='token pointer' id='tok-62-263'>value</span><span class='token pointer' id='tok-62-264'>and</span><span class='token pointer' id='tok-62-265'>if</span><span class='token pointer' id='tok-62-266'>it</span><span class='token pointer' id='tok-62-267'>does,</span><span class='token pointer' id='tok-62-268'>starts</span><span class='token pointer' id='tok-62-269'>the</span><span class='token pointer' id='tok-62-270'>injection:</span><span class='token pointer' id='tok-62-271'>it</span><span class='token pointer' id='tok-62-272'>decrypts</span><span class='token pointer' id='tok-62-273'>and</span><span class='token pointer' id='tok-62-274'>copies</span><span class='token pointer' id='tok-62-275'>the</span><span class='token pointer' id='tok-62-276'>PNF</span><span class='token pointer' id='tok-62-277'>DLL</span><span class='token pointer' id='tok-62-278'>file</span><span class='token pointer' id='tok-62-279'>into</span><span class='token pointer' id='tok-62-280'>an</span><span class='token pointer' id='tok-62-281'>allocate</span><span class='token pointer' id='tok-62-282'>memory</span><span class='token pointer' id='tok-62-283'>region</span><span class='token pointer' id='tok-62-284'>on</span><span class='token pointer' id='tok-62-285'>that</span><span class='token pointer' id='tok-62-286'>process.</span><span class='token pointer' id='tok-62-287'>It</span><span class='token pointer' id='tok-62-288'>also</span><span class='token pointer' id='tok-62-289'>builds</span><span class='token pointer' id='tok-62-290'>an</span><span class='token pointer' id='tok-62-291'>copies</span><span class='token pointer' id='tok-62-292'>a</span><span class='token pointer' id='tok-62-293'>stub</span><span class='token pointer' id='tok-62-294'>EXE</span><span class='token pointer' id='tok-62-295'>file</span><span class='token pointer' id='tok-62-296'>into</span><span class='token pointer' id='tok-62-297'>that</span><span class='token pointer' id='tok-62-298'>process</span><span class='token pointer' id='tok-62-299'>that</span><span class='token pointer' id='tok-62-300'>is</span><span class='token pointer' id='tok-62-301'>then</span><span class='token pointer' id='tok-62-302'>used</span><span class='token pointer' id='tok-62-303'>as</span><span class='token pointer' id='tok-62-304'>a</span><span class='token pointer' id='tok-62-305'>loader</span><span class='token pointer' id='tok-62-306'>for</span><span class='token pointer' id='tok-62-307'>the</span><span class='token pointer' id='tok-62-308'>PNF</span><span class='token pointer' id='tok-62-309'>DLL.</span></p>
<p id=p310><span class='token pointer' id='tok-62-310'>As</span><span class='token pointer' id='tok-62-311'>soon</span><span class='token pointer' id='tok-62-312'>as</span><span class='token pointer' id='tok-62-313'>"KERNEL32.DLL"</span><span class='token pointer' id='tok-62-314'>is</span><span class='token pointer' id='tok-62-315'>loaded</span><span class='token pointer' id='tok-62-316'>in</span><span class='token pointer' id='tok-62-317'>the</span><span class='token pointer' id='tok-62-318'>same</span><span class='token pointer' id='tok-62-319'>process,</span><span class='token pointer' id='tok-62-320'>it</span><span class='token pointer' id='tok-62-321'>locates</span><span class='token pointer' id='tok-62-322'>addresses</span><span class='token pointer' id='tok-62-323'>of</span><span class='token pointer' id='tok-62-324'>API</span><span class='token pointer' id='tok-62-325'>functions</span><span class='token pointer' id='tok-62-326'>required</span><span class='token pointer' id='tok-62-327'>by</span><span class='token pointer' id='tok-62-328'>the</span><span class='token pointer' id='tok-62-329'>loader</span><span class='token pointer' id='tok-62-330'>EXE</span><span class='token pointer' id='tok-62-331'>and</span><span class='token pointer' id='tok-62-332'>modifies</span><span class='token pointer' id='tok-62-333'>the</span><span class='token pointer' id='tok-62-334'>original</span><span class='token pointer' id='tok-62-335'>entry</span><span class='token pointer' id='tok-62-336'>point</span><span class='token pointer' id='tok-62-337'>of</span><span class='token pointer' id='tok-62-338'>the</span><span class='token pointer' id='tok-62-339'>main</span><span class='token pointer' id='tok-62-340'>process</span><span class='token pointer' id='tok-62-341'>module</span><span class='token pointer' id='tok-62-342'>so</span><span class='token pointer' id='tok-62-343'>that</span><span class='token pointer' id='tok-62-344'>it</span><span class='token pointer' id='tok-62-345'>passes</span><span class='token pointer' id='tok-62-346'>execution</span><span class='token pointer' id='tok-62-347'>to</span><span class='token pointer' id='tok-62-348'>the</span><span class='token pointer' id='tok-62-349'>loader</span><span class='token pointer' id='tok-62-350'>EXE</span><span class='token pointer' id='tok-62-351'>code.</span></p>
<p id=p352><span class='token pointer' id='tok-62-352'>The</span><span class='token pointer' id='tok-62-353'>loader</span><span class='token pointer' id='tok-62-354'>EXE</span><span class='token pointer' id='tok-62-355'>module</span><span class='token pointer' id='tok-62-356'>performs</span><span class='token pointer' id='tok-62-357'>initial</span><span class='token pointer' id='tok-62-358'>initialization</span><span class='token pointer' id='tok-62-359'>of</span><span class='token pointer' id='tok-62-360'>the</span><span class='token pointer' id='tok-62-361'>PNF</span><span class='token pointer' id='tok-62-362'>DLL</span><span class='token pointer' id='tok-62-363'>module</span><span class='token pointer' id='tok-62-364'>and</span><span class='token pointer' id='tok-62-365'>then</span><span class='token pointer' id='tok-62-366'>executes</span><span class='token pointer' id='tok-62-367'>the</span><span class='token pointer' id='tok-62-368'>export</span><span class='token pointer' id='tok-62-369'>as</span><span class='token pointer' id='tok-62-370'>specified</span><span class='token pointer' id='tok-62-371'>in</span><span class='token pointer' id='tok-62-372'>the</span><span class='token pointer' id='tok-62-373'>configuration</span><span class='token pointer' id='tok-62-374'>("FILTER").</span><span class='token pointer' id='tok-62-375'>After</span><span class='token pointer' id='tok-62-376'>that</span><span class='token pointer' id='tok-62-377'>it</span><span class='token pointer' id='tok-62-378'>restores</span><span class='token pointer' id='tok-62-379'>the</span><span class='token pointer' id='tok-62-380'>code</span><span class='token pointer' id='tok-62-381'>of</span><span class='token pointer' id='tok-62-382'>the</span><span class='token pointer' id='tok-62-383'>original</span><span class='token pointer' id='tok-62-384'>entry</span><span class='token pointer' id='tok-62-385'>point</span><span class='token pointer' id='tok-62-386'>and</span><span class='token pointer' id='tok-62-387'>returns</span><span class='token pointer' id='tok-62-388'>execution</span><span class='token pointer' id='tok-62-389'>to</span><span class='token pointer' id='tok-62-390'>the</span><span class='token pointer' id='tok-62-391'>original</span><span class='token pointer' id='tok-62-392'>process</span><span class='token pointer' id='tok-62-393'>module.</span><span class='token pointer' id='tok-62-394'>The</span><span class='token pointer' id='tok-62-395'>loader</span><span class='token pointer' id='tok-62-396'>also</span><span class='token pointer' id='tok-62-397'>interacts</span><span class='token pointer' id='tok-62-398'>with</span><span class='token pointer' id='tok-62-399'>the</span><span class='token pointer' id='tok-62-400'>driver</span><span class='token pointer' id='tok-62-401'>module</span><span class='token pointer' id='tok-62-402'>using</span><span class='token pointer' id='tok-62-403'>a</span><span class='token pointer' id='tok-62-404'>custom</span><span class='token pointer' id='tok-62-405'>IOCTL</span><span class='token pointer' id='tok-62-406'>code</span><span class='token pointer' id='tok-62-407'>to</span><span class='token pointer' id='tok-62-408'>change</span><span class='token pointer' id='tok-62-409'>memory</span><span class='token pointer' id='tok-62-410'>protection</span><span class='token pointer' id='tok-62-411'>of</span><span class='token pointer' id='tok-62-412'>the</span><span class='token pointer' id='tok-62-413'>original</span><span class='token pointer' id='tok-62-414'>entry</span><span class='token pointer' id='tok-62-415'>point</span><span class='token pointer' id='tok-62-416'>code.</span></p>
<p id=p417><span class='token pointer' id='tok-62-417'>PNF</span><span class='token pointer' id='tok-62-418'>DLL</span><span class='token pointer' id='tok-62-419'>file</span></p>
<p id=p420><span class='token pointer' id='tok-62-420'>This</span><span class='token pointer' id='tok-62-421'>module</span><span class='token pointer' id='tok-62-422'>is</span><span class='token pointer' id='tok-62-423'>stored</span><span class='token pointer' id='tok-62-424'>on</span><span class='token pointer' id='tok-62-425'>disk</span><span class='token pointer' id='tok-62-426'>as</span><span class='token pointer' id='tok-62-427'>an</span><span class='token pointer' id='tok-62-428'>encrypted</span><span class='token pointer' id='tok-62-429'>block</span><span class='token pointer' id='tok-62-430'>of</span><span class='token pointer' id='tok-62-431'>data.</span><span class='token pointer' id='tok-62-432'>As</span><span class='token pointer' id='tok-62-433'>soon</span><span class='token pointer' id='tok-62-434'>as</span><span class='token pointer' id='tok-62-435'>it</span><span class='token pointer' id='tok-62-436'>is</span><span class='token pointer' id='tok-62-437'>decrypted,</span><span class='token pointer' id='tok-62-438'>it</span><span class='token pointer' id='tok-62-439'>turns</span><span class='token pointer' id='tok-62-440'>out</span><span class='token pointer' id='tok-62-441'>to</span><span class='token pointer' id='tok-62-442'>be</span><span class='token pointer' id='tok-62-443'>a</span><span class='token pointer' id='tok-62-444'>DLL</span><span class='token pointer' id='tok-62-445'>packed</span><span class='token pointer' id='tok-62-446'>with</span><span class='token pointer' id='tok-62-447'>UPX.</span><span class='token pointer' id='tok-62-448'></span><span class='token pointer' id='tok-62-449'>Known</span><span class='token pointer' id='tok-62-450'>versions</span><span class='token pointer' id='tok-62-451'>of</span><span class='token pointer' id='tok-62-452'>PNF</span><span class='token pointer' id='tok-62-453'>DLL</span><span class='token pointer' id='tok-62-454'>modules</span><span class='token pointer' id='tok-62-455'>export</span><span class='token pointer' id='tok-62-456'>8</span><span class='token pointer' id='tok-62-457'>or</span><span class='token pointer' id='tok-62-458'>6</span><span class='token pointer' id='tok-62-459'>different</span><span class='token pointer' id='tok-62-460'>functions</span><span class='token pointer' id='tok-62-461'>by</span><span class='token pointer' id='tok-62-462'>ordinal</span><span class='token pointer' id='tok-62-463'>numbers.</span></p>
<p id=p464><span class='token pointer' id='tok-62-464'>Export</span><span class='token pointer' id='tok-62-465'>2</span><span class='token pointer' id='tok-62-466'>runs</span><span class='token pointer' id='tok-62-467'>export</span><span class='token pointer' id='tok-62-468'>6</span><span class='token pointer' id='tok-62-469'>in</span><span class='token pointer' id='tok-62-470'>a</span><span class='token pointer' id='tok-62-471'>separate</span><span class='token pointer' id='tok-62-472'>process.</span></p>
<p id=p473><span class='token pointer' id='tok-62-473'>Export</span><span class='token pointer' id='tok-62-474'>4</span><span class='token pointer' id='tok-62-475'>runs</span><span class='token pointer' id='tok-62-476'>export</span><span class='token pointer' id='tok-62-477'>5</span><span class='token pointer' id='tok-62-478'>in</span><span class='token pointer' id='tok-62-479'>a</span><span class='token pointer' id='tok-62-480'>separate</span><span class='token pointer' id='tok-62-481'>process.</span></p>
<p id=p482><span class='token pointer' id='tok-62-482'>Export</span><span class='token pointer' id='tok-62-483'>5</span><span class='token pointer' id='tok-62-484'>starts</span><span class='token pointer' id='tok-62-485'>a</span><span class='token pointer' id='tok-62-486'>thread</span><span class='token pointer' id='tok-62-487'>in</span><span class='token pointer' id='tok-62-488'>"services.exe"</span><span class='token pointer' id='tok-62-489'>process</span><span class='token pointer' id='tok-62-490'>that</span><span class='token pointer' id='tok-62-491'>loaded</span><span class='token pointer' id='tok-62-492'>the</span><span class='token pointer' id='tok-62-493'>302</span><span class='token pointer' id='tok-62-494'>resource</span><span class='token pointer' id='tok-62-495'>(see</span><span class='token pointer' id='tok-62-496'>below)</span><span class='token pointer' id='tok-62-497'>and,</span><span class='token pointer' id='tok-62-498'>if</span><span class='token pointer' id='tok-62-499'>provided</span><span class='token pointer' id='tok-62-500'>with</span><span class='token pointer' id='tok-62-501'>correct</span><span class='token pointer' id='tok-62-502'>information</span><span class='token pointer' id='tok-62-503'>by</span><span class='token pointer' id='tok-62-504'>the</span><span class='token pointer' id='tok-62-505'>callee,</span><span class='token pointer' id='tok-62-506'>installs</span><span class='token pointer' id='tok-62-507'>a</span><span class='token pointer' id='tok-62-508'>complete</span><span class='token pointer' id='tok-62-509'>new</span><span class='token pointer' id='tok-62-510'>set</span><span class='token pointer' id='tok-62-511'>of</span><span class='token pointer' id='tok-62-512'>Duqu</span><span class='token pointer' id='tok-62-513'>components.</span></p>
<p id=p514><span class='token pointer' id='tok-62-514'>Export</span><span class='token pointer' id='tok-62-515'>6</span><span class='token pointer' id='tok-62-516'>stops</span><span class='token pointer' id='tok-62-517'>the</span><span class='token pointer' id='tok-62-518'>driver</span><span class='token pointer' id='tok-62-519'>and</span><span class='token pointer' id='tok-62-520'>completely</span><span class='token pointer' id='tok-62-521'>uninstalls</span><span class='token pointer' id='tok-62-522'>all</span><span class='token pointer' id='tok-62-523'>components</span><span class='token pointer' id='tok-62-524'>of</span><span class='token pointer' id='tok-62-525'>Duqu.</span></p>
<p id=p526><span class='token pointer' id='tok-62-526'>Export</span><span class='token pointer' id='tok-62-527'>8</span><span class='token pointer' id='tok-62-528'>and</span><span class='token pointer' id='tok-62-529'>1</span><span class='token pointer' id='tok-62-530'>initialize</span><span class='token pointer' id='tok-62-531'>the</span><span class='token pointer' id='tok-62-532'>PNF</span><span class='token pointer' id='tok-62-533'>DLL</span><span class='token pointer' id='tok-62-534'>module</span><span class='token pointer' id='tok-62-535'>and</span><span class='token pointer' id='tok-62-536'>start</span><span class='token pointer' id='tok-62-537'>main</span><span class='token pointer' id='tok-62-538'>threads.</span></p>
<p id=p539><span class='token pointer' id='tok-62-539'>It</span><span class='token pointer' id='tok-62-540'>seems</span><span class='token pointer' id='tok-62-541'>that</span><span class='token pointer' id='tok-62-542'>ordinal</span><span class='token pointer' id='tok-62-543'>1</span><span class='token pointer' id='tok-62-544'>is</span><span class='token pointer' id='tok-62-545'>intended</span><span class='token pointer' id='tok-62-546'>to</span><span class='token pointer' id='tok-62-547'>export</span><span class='token pointer' id='tok-62-548'>primary</span><span class='token pointer' id='tok-62-549'>functionality</span><span class='token pointer' id='tok-62-550'>of</span><span class='token pointer' id='tok-62-551'>the</span><span class='token pointer' id='tok-62-552'>DLL.</span><span class='token pointer' id='tok-62-553'>First,</span><span class='token pointer' id='tok-62-554'>it</span><span class='token pointer' id='tok-62-555'>loads</span><span class='token pointer' id='tok-62-556'>the</span><span class='token pointer' id='tok-62-557'>configuration</span><span class='token pointer' id='tok-62-558'>information</span><span class='token pointer' id='tok-62-559'>from</span><span class='token pointer' id='tok-62-560'>another</span><span class='token pointer' id='tok-62-561'>PNF</span><span class='token pointer' id='tok-62-562'>file,</span><span class='token pointer' id='tok-62-563'>the</span><span class='token pointer' id='tok-62-564'>PNF</span><span class='token pointer' id='tok-62-565'>Config</span><span class='token pointer' id='tok-62-566'>file.</span><span class='token pointer' id='tok-62-567'>If</span><span class='token pointer' id='tok-62-568'>the</span><span class='token pointer' id='tok-62-569'>file</span><span class='token pointer' id='tok-62-570'>is</span><span class='token pointer' id='tok-62-571'>not</span><span class='token pointer' id='tok-62-572'>present,</span><span class='token pointer' id='tok-62-573'>it</span><span class='token pointer' id='tok-62-574'>is</span><span class='token pointer' id='tok-62-575'>created</span><span class='token pointer' id='tok-62-576'>from</span><span class='token pointer' id='tok-62-577'>an</span><span class='token pointer' id='tok-62-578'>encrypted</span><span class='token pointer' id='tok-62-579'>hard-coded</span><span class='token pointer' id='tok-62-580'>copy</span><span class='token pointer' id='tok-62-581'>that</span><span class='token pointer' id='tok-62-582'>is</span><span class='token pointer' id='tok-62-583'>stored</span><span class='token pointer' id='tok-62-584'>in</span><span class='token pointer' id='tok-62-585'>the</span><span class='token pointer' id='tok-62-586'>PNF</span><span class='token pointer' id='tok-62-587'>DLL</span><span class='token pointer' id='tok-62-588'>file.</span></p>
<p id=p589><span class='token pointer' id='tok-62-589'>The</span><span class='token pointer' id='tok-62-590'>name</span><span class='token pointer' id='tok-62-591'>of</span><span class='token pointer' id='tok-62-592'>the</span><span class='token pointer' id='tok-62-593'>configuration</span><span class='token pointer' id='tok-62-594'>file</span><span class='token pointer' id='tok-62-595'>is</span><span class='token pointer' id='tok-62-596'>different</span><span class='token pointer' id='tok-62-597'>for</span><span class='token pointer' id='tok-62-598'>every</span><span class='token pointer' id='tok-62-599'>version</span><span class='token pointer' id='tok-62-600'>of</span><span class='token pointer' id='tok-62-601'>Duqu.</span><span class='token pointer' id='tok-62-602'>The</span><span class='token pointer' id='tok-62-603'>PNF</span><span class='token pointer' id='tok-62-604'>Config</span><span class='token pointer' id='tok-62-605'>contains</span><span class='token pointer' id='tok-62-606'>the</span><span class='token pointer' id='tok-62-607'>name</span><span class='token pointer' id='tok-62-608'>and</span><span class='token pointer' id='tok-62-609'>path</span><span class='token pointer' id='tok-62-610'>to</span><span class='token pointer' id='tok-62-611'>the</span><span class='token pointer' id='tok-62-612'>driver</span><span class='token pointer' id='tok-62-613'>component,</span><span class='token pointer' id='tok-62-614'>to</span><span class='token pointer' id='tok-62-615'>the</span><span class='token pointer' id='tok-62-616'>PNF</span><span class='token pointer' id='tok-62-617'>DLL</span><span class='token pointer' id='tok-62-618'>and</span><span class='token pointer' id='tok-62-619'>PNF</span><span class='token pointer' id='tok-62-620'>Config</span><span class='token pointer' id='tok-62-621'>itself.</span></p>
<p id=p622><span class='token pointer' id='tok-62-622'>When</span><span class='token pointer' id='tok-62-623'>the</span><span class='token pointer' id='tok-62-624'>PNF</span><span class='token pointer' id='tok-62-625'>Config</span><span class='token pointer' id='tok-62-626'>is</span><span class='token pointer' id='tok-62-627'>created,</span><span class='token pointer' id='tok-62-628'>the</span><span class='token pointer' id='tok-62-629'>date</span><span class='token pointer' id='tok-62-630'>of</span><span class='token pointer' id='tok-62-631'>creation</span><span class='token pointer' id='tok-62-632'>is</span><span class='token pointer' id='tok-62-633'>written</span><span class='token pointer' id='tok-62-634'>into</span><span class='token pointer' id='tok-62-635'>the</span><span class='token pointer' id='tok-62-636'>file.</span><span class='token pointer' id='tok-62-637'>The</span><span class='token pointer' id='tok-62-638'>file</span><span class='token pointer' id='tok-62-639'>also</span><span class='token pointer' id='tok-62-640'>contains</span><span class='token pointer' id='tok-62-641'>the</span><span class='token pointer' id='tok-62-642'>TTL</span><span class='token pointer' id='tok-62-643'>("time</span><span class='token pointer' id='tok-62-644'>to</span><span class='token pointer' id='tok-62-645'>live")</span><span class='token pointer' id='tok-62-646'>value:</span><span class='token pointer' id='tok-62-647'>a</span><span class='token pointer' id='tok-62-648'>separate</span><span class='token pointer' id='tok-62-649'>thread</span><span class='token pointer' id='tok-62-650'>started</span><span class='token pointer' id='tok-62-651'>by</span><span class='token pointer' id='tok-62-652'>PNF</span><span class='token pointer' id='tok-62-653'>DLL</span><span class='token pointer' id='tok-62-654'>monitors</span><span class='token pointer' id='tok-62-655'>if</span><span class='token pointer' id='tok-62-656'>TTL</span><span class='token pointer' id='tok-62-657'>days</span><span class='token pointer' id='tok-62-658'>passed</span><span class='token pointer' id='tok-62-659'>since</span><span class='token pointer' id='tok-62-660'>the</span><span class='token pointer' id='tok-62-661'>creation</span><span class='token pointer' id='tok-62-662'>date,</span><span class='token pointer' id='tok-62-663'>and</span><span class='token pointer' id='tok-62-664'>after</span><span class='token pointer' id='tok-62-665'>that</span><span class='token pointer' id='tok-62-666'>runs</span><span class='token pointer' id='tok-62-667'>the</span><span class='token pointer' id='tok-62-668'>uninstallation</span><span class='token pointer' id='tok-62-669'>routine.</span></p>
<p id=p670><span class='token pointer' id='tok-62-670'>Some</span><span class='token pointer' id='tok-62-671'>versions</span><span class='token pointer' id='tok-62-672'>of</span><span class='token pointer' id='tok-62-673'>the</span><span class='token pointer' id='tok-62-674'>PNF</span><span class='token pointer' id='tok-62-675'>DLL</span><span class='token pointer' id='tok-62-676'>also</span><span class='token pointer' id='tok-62-677'>start</span><span class='token pointer' id='tok-62-678'>an</span><span class='token pointer' id='tok-62-679'>RPC</span><span class='token pointer' id='tok-62-680'>server</span><span class='token pointer' id='tok-62-681'>similar</span><span class='token pointer' id='tok-62-682'>to</span><span class='token pointer' id='tok-62-683'>the</span><span class='token pointer' id='tok-62-684'>one</span><span class='token pointer' id='tok-62-685'>found</span><span class='token pointer' id='tok-62-686'>in</span><span class='token pointer' id='tok-62-687'>Stuxnet.</span></p>
<p id=p688><span class='token pointer' id='tok-62-688'>The</span><span class='token pointer' id='tok-62-689'>PNF</span><span class='token pointer' id='tok-62-690'>DLL</span><span class='token pointer' id='tok-62-691'>also</span><span class='token pointer' id='tok-62-692'>provides</span><span class='token pointer' id='tok-62-693'>API</span><span class='token pointer' id='tok-62-694'>for</span><span class='token pointer' id='tok-62-695'>manipulating</span><span class='token pointer' id='tok-62-696'>the</span><span class='token pointer' id='tok-62-697'>configuration</span><span class='token pointer' id='tok-62-698'>file</span><span class='token pointer' id='tok-62-699'>from</span><span class='token pointer' id='tok-62-700'>external</span><span class='token pointer' id='tok-62-701'>modules</span><span class='token pointer' id='tok-62-702'>using</span><span class='token pointer' id='tok-62-703'>globally</span><span class='token pointer' id='tok-62-704'>available</span><span class='token pointer' id='tok-62-705'>events.</span></p>
<p id=p706><span class='token pointer' id='tok-62-706'>Depending</span><span class='token pointer' id='tok-62-707'>on</span><span class='token pointer' id='tok-62-708'>the</span><span class='token pointer' id='tok-62-709'>flags</span><span class='token pointer' id='tok-62-710'>in</span><span class='token pointer' id='tok-62-711'>the</span><span class='token pointer' id='tok-62-712'>PNF</span><span class='token pointer' id='tok-62-713'>Config,</span><span class='token pointer' id='tok-62-714'>the</span><span class='token pointer' id='tok-62-715'>PNF</span><span class='token pointer' id='tok-62-716'>DLL</span><span class='token pointer' id='tok-62-717'>code</span><span class='token pointer' id='tok-62-718'>looks</span><span class='token pointer' id='tok-62-719'>for</span><span class='token pointer' id='tok-62-720'>specific</span><span class='token pointer' id='tok-62-721'>processes:</span><span class='token pointer' id='tok-62-722'>the</span><span class='token pointer' id='tok-62-723'>list</span><span class='token pointer' id='tok-62-724'>of</span><span class='token pointer' id='tok-62-725'>process</span><span class='token pointer' id='tok-62-726'>names</span><span class='token pointer' id='tok-62-727'>in</span><span class='token pointer' id='tok-62-728'>the</span><span class='token pointer' id='tok-62-729'>PNF</span><span class='token pointer' id='tok-62-730'>Config,</span><span class='token pointer' id='tok-62-731'>"explorer.exe",</span><span class='token pointer' id='tok-62-732'>"svchost.exe"</span><span class='token pointer' id='tok-62-733'>and</span><span class='token pointer' id='tok-62-734'>then</span><span class='token pointer' id='tok-62-735'>injects</span><span class='token pointer' id='tok-62-736'>code</span><span class='token pointer' id='tok-62-737'>in</span><span class='token pointer' id='tok-62-738'>them.</span><span class='token pointer' id='tok-62-739'>The</span><span class='token pointer' id='tok-62-740'>code</span><span class='token pointer' id='tok-62-741'>to</span><span class='token pointer' id='tok-62-742'>be</span><span class='token pointer' id='tok-62-743'>injected</span><span class='token pointer' id='tok-62-744'>is</span><span class='token pointer' id='tok-62-745'>stored</span><span class='token pointer' id='tok-62-746'>in</span><span class='token pointer' id='tok-62-747'>binary</span><span class='token pointer' id='tok-62-748'>resource</span><span class='token pointer' id='tok-62-749'>302</span><span class='token pointer' id='tok-62-750'>found</span><span class='token pointer' id='tok-62-751'>in</span><span class='token pointer' id='tok-62-752'>PNF</span><span class='token pointer' id='tok-62-753'>DLL.</span></p>
<p id=p754><span class='token pointer' id='tok-62-754'>302</span><span class='token pointer' id='tok-62-755'>resource</span></p>
<p id=p756><span class='token pointer' id='tok-62-756'>Depending</span><span class='token pointer' id='tok-62-757'>on</span><span class='token pointer' id='tok-62-758'>the</span><span class='token pointer' id='tok-62-759'>flag</span><span class='token pointer' id='tok-62-760'>in</span><span class='token pointer' id='tok-62-761'>the</span><span class='token pointer' id='tok-62-762'>PNF</span><span class='token pointer' id='tok-62-763'>configuration</span><span class='token pointer' id='tok-62-764'>file,</span><span class='token pointer' id='tok-62-765'>it</span><span class='token pointer' id='tok-62-766'>is</span><span class='token pointer' id='tok-62-767'>either</span><span class='token pointer' id='tok-62-768'>a</span><span class='token pointer' id='tok-62-769'>DLL</span><span class='token pointer' id='tok-62-770'>loader</span><span class='token pointer' id='tok-62-771'>module</span><span class='token pointer' id='tok-62-772'>or</span><span class='token pointer' id='tok-62-773'>a</span><span class='token pointer' id='tok-62-774'>block</span><span class='token pointer' id='tok-62-775'>of</span><span class='token pointer' id='tok-62-776'>data</span><span class='token pointer' id='tok-62-777'>(equivalent</span><span class='token pointer' id='tok-62-778'>of</span><span class='token pointer' id='tok-62-779'>decompressed</span><span class='token pointer' id='tok-62-780'>".zdata",</span><span class='token pointer' id='tok-62-781'>see</span><span class='token pointer' id='tok-62-782'>below).</span><span class='token pointer' id='tok-62-783'>Both</span><span class='token pointer' id='tok-62-784'>configuration</span><span class='token pointer' id='tok-62-785'>have</span><span class='token pointer' id='tok-62-786'>been</span><span class='token pointer' id='tok-62-787'>found</span><span class='token pointer' id='tok-62-788'>in</span><span class='token pointer' id='tok-62-789'>different</span><span class='token pointer' id='tok-62-790'>Duqu</span><span class='token pointer' id='tok-62-791'>versions.</span><span class='token pointer' id='tok-62-792'>The</span><span class='token pointer' id='tok-62-793'>PNF</span><span class='token pointer' id='tok-62-794'>DLL</span><span class='token pointer' id='tok-62-795'>checks</span><span class='token pointer' id='tok-62-796'>a</span><span class='token pointer' id='tok-62-797'>flag</span><span class='token pointer' id='tok-62-798'>in</span><span class='token pointer' id='tok-62-799'>PNF</span><span class='token pointer' id='tok-62-800'>Config</span><span class='token pointer' id='tok-62-801'>and</span><span class='token pointer' id='tok-62-802'>determines</span><span class='token pointer' id='tok-62-803'>whether</span><span class='token pointer' id='tok-62-804'>to</span><span class='token pointer' id='tok-62-805'>pass</span><span class='token pointer' id='tok-62-806'>execution</span><span class='token pointer' id='tok-62-807'>to</span><span class='token pointer' id='tok-62-808'>the</span><span class='token pointer' id='tok-62-809'>DLL</span><span class='token pointer' id='tok-62-810'>loader</span><span class='token pointer' id='tok-62-811'>or</span><span class='token pointer' id='tok-62-812'>to</span><span class='token pointer' id='tok-62-813'>locate</span><span class='token pointer' id='tok-62-814'>the</span><span class='token pointer' id='tok-62-815'>payload</span><span class='token pointer' id='tok-62-816'>DLL</span><span class='token pointer' id='tok-62-817'>and</span><span class='token pointer' id='tok-62-818'>call</span><span class='token pointer' id='tok-62-819'>it</span><span class='token pointer' id='tok-62-820'>directly.</span></p>
<p id=p821><span class='token pointer' id='tok-62-821'>The</span><span class='token pointer' id='tok-62-822'>loader</span><span class='token pointer' id='tok-62-823'>DLL</span><span class='token pointer' id='tok-62-824'>module</span><span class='token pointer' id='tok-62-825'>is</span><span class='token pointer' id='tok-62-826'>similar</span><span class='token pointer' id='tok-62-827'>to</span><span class='token pointer' id='tok-62-828'>PNF</span><span class='token pointer' id='tok-62-829'>DLL.</span><span class='token pointer' id='tok-62-830'>The</span><span class='token pointer' id='tok-62-831'>main</span><span class='token pointer' id='tok-62-832'>purpose</span><span class='token pointer' id='tok-62-833'>of</span><span class='token pointer' id='tok-62-834'>the</span><span class='token pointer' id='tok-62-835'>loader</span><span class='token pointer' id='tok-62-836'>is</span><span class='token pointer' id='tok-62-837'>to</span><span class='token pointer' id='tok-62-838'>decompress</span><span class='token pointer' id='tok-62-839'>its</span><span class='token pointer' id='tok-62-840'>".zdata"</span><span class='token pointer' id='tok-62-841'>section</span><span class='token pointer' id='tok-62-842'>and</span><span class='token pointer' id='tok-62-843'>pass</span><span class='token pointer' id='tok-62-844'>execution</span><span class='token pointer' id='tok-62-845'>to</span><span class='token pointer' id='tok-62-846'>the</span><span class='token pointer' id='tok-62-847'>main</span><span class='token pointer' id='tok-62-848'>payload</span><span class='token pointer' id='tok-62-849'>that</span><span class='token pointer' id='tok-62-850'>is</span><span class='token pointer' id='tok-62-851'>contained</span><span class='token pointer' id='tok-62-852'>in</span><span class='token pointer' id='tok-62-853'>decompressed</span><span class='token pointer' id='tok-62-854'>data.</span></p>
<p id=p855><span class='token pointer' id='tok-62-855'>The</span><span class='token pointer' id='tok-62-856'>.zdata</span><span class='token pointer' id='tok-62-857'>block</span><span class='token pointer' id='tok-62-858'>contains</span><span class='token pointer' id='tok-62-859'>the</span><span class='token pointer' id='tok-62-860'>header</span><span class='token pointer' id='tok-62-861'>that</span><span class='token pointer' id='tok-62-862'>starts</span><span class='token pointer' id='tok-62-863'>with</span><span class='token pointer' id='tok-62-864'>the</span><span class='token pointer' id='tok-62-865'>magic</span><span class='token pointer' id='tok-62-866'>number</span><span class='token pointer' id='tok-62-867'>0x48747193.</span><span class='token pointer' id='tok-62-868'>It</span><span class='token pointer' id='tok-62-869'>contains</span><span class='token pointer' id='tok-62-870'>the</span><span class='token pointer' id='tok-62-871'>offsets</span><span class='token pointer' id='tok-62-872'>and</span><span class='token pointer' id='tok-62-873'>sizes</span><span class='token pointer' id='tok-62-874'>of</span><span class='token pointer' id='tok-62-875'>the</span><span class='token pointer' id='tok-62-876'>DLL</span><span class='token pointer' id='tok-62-877'>loader,</span><span class='token pointer' id='tok-62-878'>the</span><span class='token pointer' id='tok-62-879'>payload</span><span class='token pointer' id='tok-62-880'>configuration</span><span class='token pointer' id='tok-62-881'>block</span><span class='token pointer' id='tok-62-882'>and</span><span class='token pointer' id='tok-62-883'>the</span><span class='token pointer' id='tok-62-884'>payload</span><span class='token pointer' id='tok-62-885'>DLL.</span></p>
<p id=p886><span class='token pointer' id='tok-62-886'>Configuration</span><span class='token pointer' id='tok-62-887'>block</span></p>
<p id=p888><span class='token pointer' id='tok-62-888'>The</span><span class='token pointer' id='tok-62-889'>configuration</span><span class='token pointer' id='tok-62-890'>block</span><span class='token pointer' id='tok-62-891'>contains</span><span class='token pointer' id='tok-62-892'>the</span><span class='token pointer' id='tok-62-893'>name</span><span class='token pointer' id='tok-62-894'>of</span><span class='token pointer' id='tok-62-895'>the</span><span class='token pointer' id='tok-62-896'>temporary</span><span class='token pointer' id='tok-62-897'>file</span><span class='token pointer' id='tok-62-898'>to</span><span class='token pointer' id='tok-62-899'>use</span><span class='token pointer' id='tok-62-900'>%TEMP%~DR0001.tmp,</span><span class='token pointer' id='tok-62-901'>additional</span><span class='token pointer' id='tok-62-902'>binary</span><span class='token pointer' id='tok-62-903'>data</span><span class='token pointer' id='tok-62-904'>controlling</span><span class='token pointer' id='tok-62-905'>the</span><span class='token pointer' id='tok-62-906'>behavior</span><span class='token pointer' id='tok-62-907'>of</span><span class='token pointer' id='tok-62-908'>the</span><span class='token pointer' id='tok-62-909'>payload</span><span class='token pointer' id='tok-62-910'>and</span><span class='token pointer' id='tok-62-911'>information</span><span class='token pointer' id='tok-62-912'>required</span><span class='token pointer' id='tok-62-913'>to</span><span class='token pointer' id='tok-62-914'>connect</span><span class='token pointer' id='tok-62-915'>to</span><span class='token pointer' id='tok-62-916'>the</span><span class='token pointer' id='tok-62-917'>C&amp;C</span><span class='token pointer' id='tok-62-918'>servers.</span><span class='token pointer' id='tok-62-919'>There</span><span class='token pointer' id='tok-62-920'>are</span><span class='token pointer' id='tok-62-921'>two</span><span class='token pointer' id='tok-62-922'>lists</span><span class='token pointer' id='tok-62-923'>of</span><span class='token pointer' id='tok-62-924'>C&amp;C</span><span class='token pointer' id='tok-62-925'>servers,</span><span class='token pointer' id='tok-62-926'>one</span><span class='token pointer' id='tok-62-927'>can</span><span class='token pointer' id='tok-62-928'>contain</span><span class='token pointer' id='tok-62-929'>domain</span><span class='token pointer' id='tok-62-930'>names,</span><span class='token pointer' id='tok-62-931'>IP</span><span class='token pointer' id='tok-62-932'>addresses</span><span class='token pointer' id='tok-62-933'>or</span><span class='token pointer' id='tok-62-934'>names</span><span class='token pointer' id='tok-62-935'>of</span><span class='token pointer' id='tok-62-936'>network</span><span class='token pointer' id='tok-62-937'>shares,</span><span class='token pointer' id='tok-62-938'>and</span><span class='token pointer' id='tok-62-939'>the</span><span class='token pointer' id='tok-62-940'>other</span><span class='token pointer' id='tok-62-941'>contains</span><span class='token pointer' id='tok-62-942'>IP</span><span class='token pointer' id='tok-62-943'>addresses</span><span class='token pointer' id='tok-62-944'>in</span><span class='token pointer' id='tok-62-945'>binary</span><span class='token pointer' id='tok-62-946'>format</span><span class='token pointer' id='tok-62-947'>and</span><span class='token pointer' id='tok-62-948'>is</span><span class='token pointer' id='tok-62-949'>used</span><span class='token pointer' id='tok-62-950'>to</span><span class='token pointer' id='tok-62-951'>connect</span><span class='token pointer' id='tok-62-952'>using</span><span class='token pointer' id='tok-62-953'>Windows</span><span class='token pointer' id='tok-62-954'>HTTP</span><span class='token pointer' id='tok-62-955'>(winhttp)</span><span class='token pointer' id='tok-62-956'>services.</span><span class='token pointer' id='tok-62-957'>Although</span><span class='token pointer' id='tok-62-958'>the</span><span class='token pointer' id='tok-62-959'>configuration</span><span class='token pointer' id='tok-62-960'>blocks</span><span class='token pointer' id='tok-62-961'>we</span><span class='token pointer' id='tok-62-962'>have</span><span class='token pointer' id='tok-62-963'>found</span><span class='token pointer' id='tok-62-964'>so</span><span class='token pointer' id='tok-62-965'>far</span><span class='token pointer' id='tok-62-966'>are</span><span class='token pointer' id='tok-62-967'>similar</span><span class='token pointer' id='tok-62-968'>and</span><span class='token pointer' id='tok-62-969'>are</span><span class='token pointer' id='tok-62-970'>set</span><span class='token pointer' id='tok-62-971'>up</span><span class='token pointer' id='tok-62-972'>to</span><span class='token pointer' id='tok-62-973'>connect</span><span class='token pointer' id='tok-62-974'>to</span><span class='token pointer' id='tok-62-975'>its</span><span class='token pointer' id='tok-62-976'>C&amp;C</span><span class='token pointer' id='tok-62-977'>using</span><span class='token pointer' id='tok-62-978'>HTTP</span><span class='token pointer' id='tok-62-979'>and</span><span class='token pointer' id='tok-62-980'>HTTPS,</span><span class='token pointer' id='tok-62-981'>the</span><span class='token pointer' id='tok-62-982'>payload</span><span class='token pointer' id='tok-62-983'>DLL</span><span class='token pointer' id='tok-62-984'>is</span><span class='token pointer' id='tok-62-985'>able</span><span class='token pointer' id='tok-62-986'>to</span><span class='token pointer' id='tok-62-987'>connect</span><span class='token pointer' id='tok-62-988'>to</span><span class='token pointer' id='tok-62-989'>a</span><span class='token pointer' id='tok-62-990'>network</span><span class='token pointer' id='tok-62-991'>share</span><span class='token pointer' id='tok-62-992'>and</span><span class='token pointer' id='tok-62-993'>even</span><span class='token pointer' id='tok-62-994'>become</span><span class='token pointer' id='tok-62-995'>a</span><span class='token pointer' id='tok-62-996'>server.</span></p>
<p id=p997><span class='token pointer' id='tok-62-997'>Payload</span></p>
<p id=p998><span class='token pointer' id='tok-62-998'>We</span><span class='token pointer' id='tok-62-999'>are</span><span class='token pointer' id='tok-62-1000'>still</span><span class='token pointer' id='tok-62-1001'>analyzing</span><span class='token pointer' id='tok-62-1002'>the</span><span class='token pointer' id='tok-62-1003'>payload.</span><span class='token pointer' id='tok-62-1004'>It</span><span class='token pointer' id='tok-62-1005'>contains</span><span class='token pointer' id='tok-62-1006'>256K</span><span class='token pointer' id='tok-62-1007'>of</span><span class='token pointer' id='tok-62-1008'>C++</span><span class='token pointer' id='tok-62-1009'>code</span><span class='token pointer' id='tok-62-1010'>with</span><span class='token pointer' id='tok-62-1011'>extensive</span><span class='token pointer' id='tok-62-1012'>use</span><span class='token pointer' id='tok-62-1013'>of</span><span class='token pointer' id='tok-62-1014'>STL</span><span class='token pointer' id='tok-62-1015'>and</span><span class='token pointer' id='tok-62-1016'>its</span><span class='token pointer' id='tok-62-1017'>own</span><span class='token pointer' id='tok-62-1018'>complex</span><span class='token pointer' id='tok-62-1019'>class</span><span class='token pointer' id='tok-62-1020'>hierarchies,</span><span class='token pointer' id='tok-62-1021'>probably</span><span class='token pointer' id='tok-62-1022'>own</span><span class='token pointer' id='tok-62-1023'>framework.</span></p>
<p id=p1024><span class='token pointer' id='tok-62-1024'>The</span><span class='token pointer' id='tok-62-1025'>payload</span><span class='token pointer' id='tok-62-1026'>is</span><span class='token pointer' id='tok-62-1027'>able</span><span class='token pointer' id='tok-62-1028'>to</span><span class='token pointer' id='tok-62-1029'>connect</span><span class='token pointer' id='tok-62-1030'>to</span><span class='token pointer' id='tok-62-1031'>C&amp;C</span><span class='token pointer' id='tok-62-1032'>server</span><span class='token pointer' id='tok-62-1033'>using</span><span class='token pointer' id='tok-62-1034'>either</span><span class='token pointer' id='tok-62-1035'>winhttp</span><span class='token pointer' id='tok-62-1036'>library</span><span class='token pointer' id='tok-62-1037'>or</span><span class='token pointer' id='tok-62-1038'>connection</span><span class='token pointer' id='tok-62-1039'>to</span><span class='token pointer' id='tok-62-1040'>a</span><span class='token pointer' id='tok-62-1041'>network</span><span class='token pointer' id='tok-62-1042'>share</span><span class='token pointer' id='tok-62-1043'>IPC$</span><span class='token pointer' id='tok-62-1044'>endpoint.</span><span class='token pointer' id='tok-62-1045'>It</span><span class='token pointer' id='tok-62-1046'>is</span><span class='token pointer' id='tok-62-1047'>able</span><span class='token pointer' id='tok-62-1048'>to</span><span class='token pointer' id='tok-62-1049'>connect</span><span class='token pointer' id='tok-62-1050'>using</span><span class='token pointer' id='tok-62-1051'>proxy</span><span class='token pointer' id='tok-62-1052'>server</span><span class='token pointer' id='tok-62-1053'>configuration</span><span class='token pointer' id='tok-62-1054'>of</span><span class='token pointer' id='tok-62-1055'>Internet</span><span class='token pointer' id='tok-62-1056'>Explorer.</span><span class='token pointer' id='tok-62-1057'>It</span><span class='token pointer' id='tok-62-1058'>also</span><span class='token pointer' id='tok-62-1059'>contains</span><span class='token pointer' id='tok-62-1060'>code</span><span class='token pointer' id='tok-62-1061'>for</span><span class='token pointer' id='tok-62-1062'>acting</span><span class='token pointer' id='tok-62-1063'>as</span><span class='token pointer' id='tok-62-1064'>a</span><span class='token pointer' id='tok-62-1065'>HTTP</span><span class='token pointer' id='tok-62-1066'>server</span><span class='token pointer' id='tok-62-1067'>and</span><span class='token pointer' id='tok-62-1068'>processing</span><span class='token pointer' id='tok-62-1069'>the</span><span class='token pointer' id='tok-62-1070'>same</span><span class='token pointer' id='tok-62-1071'>requests</span><span class='token pointer' id='tok-62-1072'>as</span><span class='token pointer' id='tok-62-1073'>served</span><span class='token pointer' id='tok-62-1074'>by</span><span class='token pointer' id='tok-62-1075'>the</span><span class='token pointer' id='tok-62-1076'>C&amp;C.</span></p>
<p id=p1077><span class='token pointer' id='tok-62-1077'>The</span><span class='token pointer' id='tok-62-1078'>payload</span><span class='token pointer' id='tok-62-1079'>is</span><span class='token pointer' id='tok-62-1080'>able</span><span class='token pointer' id='tok-62-1081'>to</span><span class='token pointer' id='tok-62-1082'>load</span><span class='token pointer' id='tok-62-1083'>an</span><span class='token pointer' id='tok-62-1084'>external</span><span class='token pointer' id='tok-62-1085'>DLL</span><span class='token pointer' id='tok-62-1086'>module</span><span class='token pointer' id='tok-62-1087'>provided</span><span class='token pointer' id='tok-62-1088'>by</span><span class='token pointer' id='tok-62-1089'>the</span><span class='token pointer' id='tok-62-1090'>C&amp;C</span><span class='token pointer' id='tok-62-1091'>and</span><span class='token pointer' id='tok-62-1092'>interact</span><span class='token pointer' id='tok-62-1093'>with</span><span class='token pointer' id='tok-62-1094'>it</span><span class='token pointer' id='tok-62-1095'>using</span><span class='token pointer' id='tok-62-1096'>a</span><span class='token pointer' id='tok-62-1097'>pre-defined</span><span class='token pointer' id='tok-62-1098'>API.</span><span class='token pointer' id='tok-62-1099'>The</span><span class='token pointer' id='tok-62-1100'>most</span><span class='token pointer' id='tok-62-1101'>noticeable</span><span class='token pointer' id='tok-62-1102'>module</span><span class='token pointer' id='tok-62-1103'>discovered</span><span class='token pointer' id='tok-62-1104'>so</span><span class='token pointer' id='tok-62-1105'>far</span><span class='token pointer' id='tok-62-1106'>is</span><span class='token pointer' id='tok-62-1107'>the</span><span class='token pointer' id='tok-62-1108'>infostealer</span><span class='token pointer' id='tok-62-1109'>module.</span><span class='token pointer' id='tok-62-1110'>There</span><span class='token pointer' id='tok-62-1111'>are</span><span class='token pointer' id='tok-62-1112'>also</span><span class='token pointer' id='tok-62-1113'>modules</span><span class='token pointer' id='tok-62-1114'>for</span><span class='token pointer' id='tok-62-1115'>updating</span><span class='token pointer' id='tok-62-1116'>the</span><span class='token pointer' id='tok-62-1117'>TTL</span><span class='token pointer' id='tok-62-1118'>value</span><span class='token pointer' id='tok-62-1119'>in</span><span class='token pointer' id='tok-62-1120'>the</span><span class='token pointer' id='tok-62-1121'>PNF</span><span class='token pointer' id='tok-62-1122'>DLL</span><span class='token pointer' id='tok-62-1123'>configuration,</span><span class='token pointer' id='tok-62-1124'>for</span><span class='token pointer' id='tok-62-1125'>reading</span><span class='token pointer' id='tok-62-1126'>the</span><span class='token pointer' id='tok-62-1127'>network</span><span class='token pointer' id='tok-62-1128'>and</span><span class='token pointer' id='tok-62-1129'>disk</span><span class='token pointer' id='tok-62-1130'>storage</span><span class='token pointer' id='tok-62-1131'>configuration</span><span class='token pointer' id='tok-62-1132'>from</span><span class='token pointer' id='tok-62-1133'>the</span><span class='token pointer' id='tok-62-1134'>infected</span><span class='token pointer' id='tok-62-1135'>machine.</span></p>
<p id=p1136><span class='token pointer' id='tok-62-1136'>It</span><span class='token pointer' id='tok-62-1137'>also</span><span class='token pointer' id='tok-62-1138'>can</span><span class='token pointer' id='tok-62-1139'>form</span><span class='token pointer' id='tok-62-1140'>a</span><span class='token pointer' id='tok-62-1141'>PNF</span><span class='token pointer' id='tok-62-1142'>DLL</span><span class='token pointer' id='tok-62-1143'>with</span><span class='token pointer' id='tok-62-1144'>a</span><span class='token pointer' id='tok-62-1145'>configuration</span><span class='token pointer' id='tok-62-1146'>block</span><span class='token pointer' id='tok-62-1147'>and</span><span class='token pointer' id='tok-62-1148'>the</span><span class='token pointer' id='tok-62-1149'>payload</span><span class='token pointer' id='tok-62-1150'>DLL</span><span class='token pointer' id='tok-62-1151'>ready</span><span class='token pointer' id='tok-62-1152'>for</span><span class='token pointer' id='tok-62-1153'>distribution</span><span class='token pointer' id='tok-62-1154'>to</span><span class='token pointer' id='tok-62-1155'>other</span><span class='token pointer' id='tok-62-1156'>machines.
